import e from"@agconnect/api";import"@agconnect/instance";import{ObserverUtil as t}from"@agconnect/util";import"@agconnect/auth";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function n(e,t,n,r){return new(n||(n=Promise))((function(o,i){function a(e){try{c(r.next(e))}catch(e){i(e)}}function s(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(a,s)}c((r=r.apply(e,t||[])).next())}))}function r(e,t){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}var o=function(){function e(e,t){this.code_=i(e),this.message_="Agconnect Storage: "+t,this.serverResponse_=null,this.name_="AgconnectError"}return e.prototype.codeProp=function(){return this.code},e.prototype.codeEquals=function(e){return i(e)===this.codeProp()},e.prototype.serverResponseProp=function(){return this.serverResponse_},e.prototype.setServerResponseProp=function(e){this.serverResponse_=e},Object.defineProperty(e.prototype,"name",{get:function(){return this.name_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"code",{get:function(){return this.code_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"message",{get:function(){return this.message_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverResponse",{get:function(){return this.serverResponse_},enumerable:!0,configurable:!0}),e}();function i(e){return"storage/"+e}function a(){return new o(g.UNKNOWN,"An unknown error occurred, please check the serverResponse information")}function s(){return new o(g.INCALID_CONFIG,"Get CloudStorage configuration failed. Please check it again.")}function c(){return new o(g.INVALID_URL,"Invalid url")}function u(){return new o(g.NO_DEFAULT_BUCKET,"No default bucket found. Please set the default_storage property when initializing the configuration.")}function l(){return new o(g.CANNOT_SLICE_BLOB,"Failed to slice blob for upload. Please retry the upload.")}function h(e,t){return new o(g.INVALID_FORMAT,"String format does not match supported format")}function f(e){throw new o(g.INTERNAL_ERROR,"Internal error: "+e)}function p(e,t,n){var r="Invalid argument in `"+t+"` at index "+e+": "+n;return new o(g.INVALID_ARGUMENT,r)}function d(){return new o(g.INCALID_CONFIG,"Can not find any valid urls, please check your SDK code copied from website again.")}var g={UNKNOWN:"unknown",OBJECT_NOT_FOUND:"object-not-found",QUOTA_EXCEEDED:"quota-exceeded",UNAUTHENTICATED:"unauthenticated",NO_PERMISSION:"noPermission",RETRY_LIMIT_EXCEEDED:"retry-limit-exceeded",INVALID_CHECKSUM:"invalid-checksum",CANCELED:"canceled",NO_AGCCONNECT_INSTANCE:"no-agcconnect-instance",INCALID_CONFIG:"invalid-config",INVALID_URL:"invalid-url",INVALID_DEFAULT_BUCKET:"invalid-default-bucket",NO_DEFAULT_BUCKET:"no-default-bucket",CANNOT_SLICE_BLOB:"cannot-slice-blob",SERVER_FILE_WRONG_SIZE:"server-file-wrong-size",NO_DOWNLOAD_URL:"no-download-url",INVALID_ARGUMENT:"invalid-argument",INVALID_ARGUMENT_COUNT:"invalid-argument-count",APP_DELETED:"app-deleted",INVALID_ROOT_OPERATION:"invalid-root-operation",INVALID_OPERATION:"invalid-operation",INVALID_FORMAT:"invalid-format",INTERNAL_ERROR:"internal-error"},_={RAW:"raw",BASE64:"base64",BASE64URL:"base64url",DATA_URL:"data_url"},m=function(e,t){this.data=e,this.contentType=t||null};function v(e,t){switch(e){case _.RAW:return new m(y(t));case _.BASE64:case _.BASE64URL:return new m(b(e,t));case _.DATA_URL:return new m((n=new w(t)).base64?b(_.BASE64,n.rest):function(e){var t;try{t=decodeURIComponent(e)}catch(e){throw h()}return y(t)}(n.rest),function(e){return new w(e).contentType}(t))}var n;throw a()}function y(e){for(var t=[],n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<=127)t.push(r);else if(r<=2047)t.push(192|r>>6,128|63&r);else if(55296==(64512&r))if(n<e.length-1&&56320==(64512&e.charCodeAt(n+1)))r=65536|(1023&r)<<10|1023&e.charCodeAt(++n),t.push(240|r>>18,128|r>>12&63,128|r>>6&63,128|63&r);else t.push(239,191,189);else 56320==(64512&r)?t.push(239,191,189):t.push(224|r>>12,128|r>>6&63,128|63&r)}return new Uint8Array(t)}function b(e,t){switch(e){case _.BASE64:var n=-1!==t.indexOf("-"),r=-1!==t.indexOf("_");if(n||r)throw h();break;case _.BASE64URL:var o=-1!==t.indexOf("+"),i=-1!==t.indexOf("/");if(o||i)throw h();t=t.replace(/-/g,"+").replace(/_/g,"/")}var a;try{a=function(e){var t,n,r,o,i,a,s,c="",u=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(;u<e.length;)t=T.indexOf(e.charAt(u++)),n=T.indexOf(e.charAt(u++)),r=T.indexOf(e.charAt(u++)),o=T.indexOf(e.charAt(u++)),i=t<<2|n>>4,a=(15&n)<<4|r>>2,s=(3&r)<<6|o,c+=String.fromCharCode(i),64!=r&&(c+=String.fromCharCode(a)),64!=o&&(c+=String.fromCharCode(s));return c}(t)}catch(e){throw h()}for(var s=new Uint8Array(a.length),c=0;c<a.length;c++)s[c]=a.charCodeAt(c);return s}var w=function(e){this.base64=!1,this.contentType=null;var t=e.match(/^data:([^,]+)?,/);if(null===t)throw h();var n=t[1]||null;null!=n&&(this.base64=(r=n,o=";base64",r.length>=o.length&&r.substring(r.length-o.length)===o),this.contentType=this.base64?n.substring(0,n.length-";base64".length):n),this.rest=e.substring(e.indexOf(",")+1);var r,o};var T="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function R(e){return null!=e}function A(e){return void 0!==e}function E(e){return"object"==typeof e}function k(e){return"string"==typeof e||e instanceof String}function I(e){return S(e)&&Number.isInteger(e)}function S(e){return"number"==typeof e||e instanceof Number}function O(e){return C()&&e instanceof Blob}function C(){return"undefined"!=typeof Blob}var x=require("crypto-js"),U=function(){function e(e,t){this.sha256_="";var n=0,r="";O(e)?(this.data_=e,n=this.data_.size,r=this.data_.type):e instanceof ArrayBuffer?(t?this.data_=new Uint8Array(e):(this.data_=new Uint8Array(e.byteLength),this.data_.set(new Uint8Array(e))),n=this.data_.length):(t?this.data_=e:(this.data_=new Uint8Array(e.length),this.data_.set(e)),n=e.length),this.size_=n,this.type_=r}return e.prototype.computeSha256=function(e){O(this.data_)?this.computeNativeBlob(e):this.computeUint8Array(e)},e.prototype.computeUint8Array=function(e){var t=this.data_,n=x.lib.WordArray.create(t,t.length);this.sha256_=x.SHA256(n).toString(),e()},e.prototype.computeNativeBlob=function(e){var t=this,n=0,r=Math.ceil(t.size_/10240),o=x.algo.SHA256.create(),i=new FileReader,a=File.prototype.slice;function s(){var e=10240*n,r=e+10240>=t.size_?t.size_:e+10240;i.readAsArrayBuffer(a.call(t.data_,e,r))}s(),i.onload=function(i){if(i&&i.target){var a=x.lib.WordArray.create(i.target.result);o.update(a),++n<r?s():(t.sha256_=o.finalize().toString(),e())}}},e.prototype.sha256=function(){return this.sha256_},e.prototype.size=function(){return this.size_},e.prototype.type=function(){return this.type_},e.prototype.slice=function(t,n){if(O(this.data_)){var r=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,o=this.data_,i=r.call(o,t,n);return null===i?null:new e(i)}return new e(new Uint8Array(this.data_.buffer,t,n-t),!1)},e.getBlob=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];if(C()){var r=t.map((function(t){return t instanceof e?t.data_:t}));return new e(new Blob(r))}var o=t.map((function(e){return k(e)?v(_.RAW,e).data:e.data_})),i=0;o.forEach((function(e){i+=e.byteLength}));var a=new Uint8Array(i),s=0;return o.forEach((function(e){for(var t=0;t<e.length;t++)a[s++]=e[t]})),new e(a,!0)},e.prototype.uploadData=function(){return this.data_},e}(),N=function(){function e(e,t){this.bucket=e,this.path_=t}return e.makeFromUrl=function(t){if(null==t||0==t.length)throw c();var n=null,r="",o="";if(t.startsWith("https://")||t.startsWith("http://")){var i;(i=new RegExp("^https?://([a-z.\\-]+)/(v[0-9]+)/([a-z0-9-]+)(/(.*))?$","i").exec(t))&&(r=i[3],(o=i[5])||(o=""),n=new e(r,decodeURIComponent(o)))}t.startsWith("grs://")&&((i=new RegExp("^grs://([a-z0-9-]+)(/(.*))?$").exec(t))&&(r=i[1],(o=i[3])||(o=""),"/"===o.charAt(o.length-1)&&(o=o.slice(0,-1)),n=new e(r,o)));if(null==n)throw c();return n},e.makeFromBucket=function(t){var n;try{n=e.makeFromUrl(t)}catch(n){return new e(t,"")}if(""===n.path)return n;throw new o(g.INVALID_DEFAULT_BUCKET,"Invalid default bucket")},Object.defineProperty(e.prototype,"path",{get:function(){return this.path_},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isRoot",{get:function(){return 0===this.path.length},enumerable:!0,configurable:!0}),e.prototype.fullUrl=function(){return"/"+encodeURIComponent(this.bucket)+"/"+encodeURIComponent(this.path)},e.prototype.bucketUrl=function(){return"/"+encodeURIComponent(this.bucket)},e}();function P(e,t){if(!t||0===t.length)return e;var n=t.split("/").filter((function(e){return e.length>0})).join("/");return t.endsWith("/")&&(n+="/"),0===e.length?n:e+n}var D=function(e){this.uri=e},M=function(e,t,n,r){this.url=e,this.files=t,this.header=n,this.method=r},L=function(e){this.timeout=e},j=function(e,t,n,r,o,i,a,s){void 0===n&&(n={}),void 0===o&&(o=null),this.url=e,this.method=t,this.headers=n,this.handler=r,this.errorHandler=o,this.timeout=i,this.maxRetryTimes=a,this.area=s,this.urlParams={},this.body=null,this.successCodes=[200],this.uri=""};function F(e,t){t&&(e.productId=t)}function B(e,t){t&&(e.client_id=t)}function z(e,t){t&&(e.app_id=t)}function H(e){return"/v0"+e}function q(e){var t={};if(e.cacheControl&&(t["X-Agc-Cache-Control"]=e.cacheControl),e.contentDisposition&&(t["X-Agc-Content-Disposition"]=e.contentDisposition),e.contentEncoding&&(t["X-Agc-Content-Encoding"]=e.contentEncoding),e.contentLanguage&&(t["X-Agc-Content-Language"]=e.contentLanguage),e.contentType&&(t["X-Agc-Content-Type"]=e.contentType),e.sha256Hash&&(t["X-Agc-Sha256"]=e.sha256Hash),e.customMetadata)for(var n in e.customMetadata){if(e.customMetadata[n])t["X-Agc-meta-"+n]=e.customMetadata[n]}return t}var G=function(){function e(e){if(this._storageHosts={},this._addressThreshold=3,this._agcInstance=e,null==this._agcInstance)throw new o(g.NO_AGCCONNECT_INSTANCE,"Find no AGCConnect instance. Please init it at first.");var t=this._agcInstance.config();if(!t||!t.region)throw this._defaultRegion="",s();if(this._defaultRegion=t.region,!(t&&t.service&&t.service.cloudstorage&&t.service.cloudstorage.default_storage))throw this._defaultBucket="",s();this._defaultBucket=t.service.cloudstorage.default_storage;var n=require("../agconnect-cloudstorage.json");if(!n||!n.storage_all)throw s();if(this.generateUrl(n.storage_all),!(t.client&&t.client.app_id&&t.client.client_id&&t.client.product_id))throw this._productId="",this._clientId="",this._appId="",s();this._productId=t.client.product_id,this._clientId=t.client.client_id,this._appId=t.client.app_id}return e.initInstance=function(t){return this.instance=new e(t),this.instance},e.getInstance=function(){return this.instance},e.prototype.getHostByRegion=function(e){e=e||this._defaultRegion;for(var t=this._storageHosts[e],n=0;n<2;n++){var r=t[String(n)];if(!r)throw d();if(r.count<this._addressThreshold)return r;if(1===n)return r}throw d()},e.prototype.clearHostCount=function(e,t){var n=this._storageHosts[e];n[t].count=0,this._storageHosts[e]=n},e.prototype.setHostCount=function(e,t){if(1!==t){var n=this._storageHosts[e];n[t].count+=1,this._storageHosts[e]=n}},Object.defineProperty(e.prototype,"defaultBucket",{get:function(){return this._defaultBucket},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"productId",{get:function(){return this._productId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clientId",{get:function(){return this._clientId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"appId",{get:function(){return this._appId},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"defaultRegion",{get:function(){return this._defaultRegion},enumerable:!0,configurable:!0}),e.prototype.generateUrl=function(e){for(var t=0,n=["CN","SG","RU","DE"];t<n.length;t++){var r=n[t],o={};for(var i in e)i===r?o=Object.assign({0:{url:e[i],index:0,count:0}},o):-1!==i.indexOf(r)&&(o=Object.assign({1:{url:e[i],index:1,count:0}},o));this._storageHosts[r]=o}},e}();function W(e,t,n){return function(r,o){var i=function(e,t,n,r){if(null===r.data)return null;var o=r.data,i={dirList:[],fileList:[],pageMarker:o.nextMarker};if(o.contents)for(var a=0,s=o.contents;a<s.length;a++){var c=s[a],u=e.makeStorageReference(new N(t.bucket,c.key),n);c.key.endsWith("/")?i.dirList.push(u):i.fileList.push(u)}if(o.commonPrefixes)for(var l=0,h=o.commonPrefixes;l<h.length;l++){var f=h[l];u=e.makeStorageReference(new N(t.bucket,f.prefix),n);i.dirList.push(u)}return i}(e,t,n,o);if(null===i)throw a();return i}}function K(e,t,n,r,o,i){var a=new j(H(t.bucketUrl()),"GET",{"x-agc-nsp-js":"JSSDK"},W(e,t,n),V(),e.maxRequestTimeout,e.maxRetryTimes,n),s={};return t.isRoot?s.prefix="":s.prefix=t.path,r&&r.length>0&&(s.delimiter=r),o&&(s.marker=o),i&&(s["max-keys"]=i),a.urlParams=s,a}function V(){return function(e,t){var n;switch(e){case 401:n=new o(g.UNAUTHENTICATED,"Identity authentication failed. Please login again and try again.");break;case 402:n=new o(g.QUOTA_EXCEEDED,"The quota of the bucket has been used up. Please check the payment plan.");break;case 403:n=new o(g.NO_PERMISSION,"User does not have permission to access the file or directory.");break;case 404:n=new o(g.OBJECT_NOT_FOUND,"Object does not exist.");break;default:n=t.__CANCEL__?new o(g.CANCELED,t.message):new o(g.UNKNOWN,t.message)}return t.response&&t.response.data?("string"==typeof t.response.data?n.setServerResponseProp(t.response.data):n.setServerResponseProp(JSON.stringify(t.response.data)),n):(n.setServerResponseProp("error request response is null or undefined."),n)}}function X(e,t,n,r,o){var i=q(Object.assign({},o)),a=Object.assign({"x-agc-nsp-js":"JSSDK"},i),s=new j(H(t.fullUrl()),"POST",a,(function(e,t){return Z()(e,{data:t.data.fileInfo})}),V(),e.maxUploadTimeout,e.maxRetryTimes,r);return s.uri=n,s}var J=function(e,t,n,r){this.current=e,this.total=t,this.finalized=!!n,this.metadata=r||null};function Q(e,t,n){return new j(H(t.fullUrl())+"?token=create","GET",{"x-agc-nsp-js":"JSSDK"},function(e,t,n){return function(e,r){return G.getInstance().getHostByRegion(n).url+H(t.fullUrl())+"?token="+r.data[0]}}(0,t,n),V(),e.maxRequestTimeout,e.maxRetryTimes,n)}function Z(){return function(e,t){var n=function(e){if(null===e.data)return null;var t=e.data;return{bucket:t.bucket,path:t.path,name:t.name,size:t.size,ctime:t.createTime,mtime:t.updateTime,contentLanguage:t.contentLanguage,contentEncoding:t.contentEncoding,contentDisposition:t.contentDisposition,contentType:t.contentType,cacheControl:t.cacheControl,customMetadata:t.metadata,sha256Hash:t.sha256,ref:void 0}}(t);if(null==n)throw a();return n}}function $(e,t,n){return new j(H(t.fullUrl())+"?metadata=query","GET",{"x-agc-nsp-js":"JSSDK"},Z(),V(),e.maxRequestTimeout,e.maxRetryTimes,n)}function Y(e,t,n){var r=Object.assign({},n);return r.metadata=q(r),r.path=e.path,r.size=t.size(),r.contentType||(r.contentType=function(e,t){return e&&e.contentType||t&&t.type()||"application/octet-stream"}(null,t)),r}function ee(e,t){var n=null;try{e&&e.data&&(n=e.data.uploadStatus)}catch(e){throw a()}if(!n||-1==(t||["active"]).indexOf(n))throw a();return n}function te(e,t,n,r){var o=Object.assign({"x-agc-nsp-js":"JSSDK"},q(n));return new j(H(t.fullUrl())+"?metadata=update","GET",o,Z(),V(),e.maxRequestTimeout,e.maxRetryTimes,r)}function ne(e,t,n,r,i,a,s,c,u){var h;if(h=s?new J(s.current,s.total):new J(0,r.size()),r.size()!==h.total)throw new o(g.SERVER_FILE_WRONG_SIZE,"Server recorded incorrect upload file size, please retry the upload.");var f=h.total-h.current;i>0&&(f=Math.min(f,i));var p=h.current,d=p+f,_=r.slice(p,d);if(null===_)throw l();var m={"x-agc-nsp-js":"JSSDK","X-Agc-File-Size":h.total,"X-Agc-File-Offset":h.current,"X-Agc-Sha256":r.sha256()},v=Y(e,r,c);m=Object.assign(m,v.metadata);var y=new j(n,"PUT",m,(function(e,t){var n,o=ee(t,["resumable","active","finalize"]),i=h.current+f,a=r.size();return n="finalize"===o?Z()(e,{data:t.data.fileInfo}):null,new J(i,a,"finalize"===o,n)}),V(),t.maxUploadTimeout,t.maxRetryTimes,a);return y.body=_.uploadData(),y.progressCallback=u,y}var re=function(e,t,n,r,o,i){this.bytesTransferred=e,this.totalByteCount=t,this.state=n,this.metadata=r,this.task=o,this.reference=i},oe={STATE_CHANGED:"state_changed"},ie="running",ae="pausing",se="paused",ce="success",ue="canceling",le="canceled",he="error",fe={RUNNING:"running",PAUSED:"paused",SUCCESS:"success",CANCELED:"canceled",ERROR:"error"};function pe(e){switch(e){case ie:case ae:case ue:return fe.RUNNING;case se:return fe.PAUSED;case ce:return fe.SUCCESS;case le:return fe.CANCELED;case he:default:return fe.ERROR}}function de(e,t,n){for(var r=t.length,i=t.length,a=0;a<t.length;a++)if(t[a].optional){r=a;break}if(!(r<=n.length&&n.length<=i))throw function(e,t,n,r){var i="between "+e+" and "+t,a="arguments";e===t&&(i=e.toString()),1===e&&1===t&&(a="argument");var s="Invalid argument count in `"+n+"`: Expected "+i+" "+a+", received "+r+".";return new o(g.INVALID_ARGUMENT_COUNT,s)}(r,i,e,n.length);for(a=0;a<n.length;a++)try{t[a].validator(n[a])}catch(t){throw t instanceof Error?p(a,e,t.message):p(a,e,t)}}var ge=function(e,t){var n=this;this.validator=function(t){n.optional&&!A(t)||e(t)},this.optional=!!t};function _e(e,t){return function(n){e(n),t(n)}}function me(e,t){function n(e){if(!k(e))throw"Expected string."}var r;return r=e?_e(n,e):n,new ge(r,t)}function ve(e,t){function n(e){if(!k(e))throw"Expected string.";if(e.length>1024)throw"Path length should not exceed 1024."}var r;return r=e?_e(n,e):n,new ge(r,t)}function ye(){return new ge((function(e){if(!(e instanceof Uint8Array||e instanceof ArrayBuffer||C()&&e instanceof Blob))throw"Expected Blob or File."}))}function be(e){return new ge(Ie,e)}function we(e){return new ge(ke,e)}function Te(){return new ge((function(e){if(!(S(e)&&e>=0))throw"Expected a number 0 or greater."}))}function Re(e,t){return new ge((function(t){if(!(null===t||R(t)&&t instanceof Object))throw"Expected an Object.";null!=e&&e(t)}),t)}function Ae(e){return new ge((function(e){if(!(null===e||function(e){return"function"==typeof e}(e)))throw"Expected a Function."}),e)}function Ee(e){if("string"!=typeof e)throw"Expected string.";for(var t=e,n=0;n<t.length;n++)if(-1!=="#*:?'\"<>|[]".indexOf(t[n]))throw"Unexpected symbol: # * : ? ' \" < > | [ ]"}function ke(e){if(!E(e)||!e)throw"Expected ListOptions object.";for(var t in e)if("maxResults"===t){if(!I(e.maxResults)||e.maxResults<=0)throw"Expected maxResults to be a positive number.";if(e.maxResults>1e3)throw"Expected maxResults to be less than or equal to 1000."}else{if("pageMarker"!==t)throw"Unknown option: "+t;if(e.pageMarker&&!k(e.pageMarker))throw"Expected pageMarker to be string."}}function Ie(e){if(!E(e)||!e)throw"Expected Metadata object."}function Se(e){switch(e){case _.RAW:case _.BASE64:case _.BASE64URL:case _.DATA_URL:return;default:throw"Expected one of the following types: ["+_.RAW+", "+_.BASE64+", "+_.BASE64URL+", "+_.DATA_URL+"]."}}var Oe=function(){function e(e,t,n,r,o,i){var a=this;void 0===o&&(o=null),this.transferred_=0,this.needToFetchStatus_=!1,this.needToFetchMetadata_=!1,this.observers_=[],this.error_=null,this.source_=null,this.chunkMultiplier_=1,this.resolve_=null,this.reject_=null,this.ref_=e,this.service_=t,this.location_=n,this.blob_=r,this.metadata_=o,this.resumable_=this.shouldDoResumable_(this.blob_),this.state_=ie,this.area_=i,this.errorHandler_=function(e){a.source_=null,a.chunkMultiplier_=1,e.codeEquals(g.CANCELED)?(a.needToFetchStatus_=!0,a.completeTransitions_()):(a.error_=e,a.transition_(he))},this.metadataErrorHandler_=function(e){a.source_=null,e.codeEquals(g.CANCELED)?a.completeTransitions_():(a.error_=e,a.transition_(he))},this.promise_=new Promise((function(e,t){a.resolve_=e,a.reject_=t,a.blob_.computeSha256((function(){a.start_()}))})),this.promise_.then(null,(function(){}))}return e.prototype.makeProgressCallback_=function(){var e=this;return function(t){return e.updateProgress_(e.transferred_+t.loaded)}},e.prototype.shouldDoResumable_=function(e){return e.size()>102400},e.prototype.start_=function(){this.state_===ie&&null===this.source_&&(this.resumable_?this.needToFetchStatus_?this.fetchStatus_():this.needToFetchMetadata_?this.fetchMetadata_():this.continueUpload_():this.oneShotUpload_())},e.prototype.resolveToken_=function(e){var t=this;this.service_.getAuthToken().then((function(n){switch(t.state_){case ie:e(n);break;case ue:t.transition_(le);break;case ae:t.transition_(se)}}))},e.prototype.fetchStatus_=function(){var e=this;this.resolveToken_((function(t){var n,r,o,i,s,c=(n=e.service_,e.location_,r=H(e.location_.fullUrl()),o=e.blob_,i=e.area_,s={"x-agc-nsp-js":"JSSDK","X-Agc-Upload-Protocol":"resumable","X-Agc-File-Size":o.size(),"X-Agc-Sha256":o.sha256()},new j(r,"POST",s,(function(e,t){if(!t||!t.data)throw a();var n=ee(t,["resumable","active","finalize"]);if("finalize"===n)return new J(o.size(),o.size(),"finalize"===n);var r=t.data.receiveBytes;if(!r)throw a();var i=Number(r);if(isNaN(i))throw a();return new J(i,o.size(),"finalize"===n)}),V(),n.maxUploadTimeout,n.maxRetryTimes,i)),u=e.service_._agcInstance.getService("AGCNetworkService");if(!u)throw"get agcFileTransload service failed.";c.source=u.CancelToken.source();var l=e.service_.makeRequest(c,t);e.source_=c.source,l.then((function(t){t=t,e.source_=null,e.updateProgress_(t.current),e.needToFetchStatus_=!1,t.finalized&&(e.needToFetchMetadata_=!0),e.completeTransitions_()}),e.errorHandler_)}))},e.prototype.continueUpload_=function(){var e=this,t=102400*this.chunkMultiplier_,n=new J(this.transferred_,this.blob_.size());this.resolveToken_((function(r){var o;try{o=ne(e.location_,e.service_,H(e.location_.fullUrl()),e.blob_,t,e.area_,n,e.metadata_,e.makeProgressCallback_())}catch(t){return e.error_=t,void e.transition_(he)}var i=e.service_._agcInstance.getService("AGCNetworkService");if(!i)throw"get agcFileTransload service failed.";o.source=i.CancelToken.source();var a=e.service_.makeRequest(o,r);e.source_=o.source,a.then((function(t){e.source_=null,e.updateProgress_(t.current),t.finalized?(e.metadata_=t.metadata,e.transition_(ce)):e.completeTransitions_()}),e.errorHandler_)}))},e.prototype.increaseMultiplier_=function(){102400*this.chunkMultiplier_<33554432&&(this.chunkMultiplier_*=2)},e.prototype.fetchMetadata_=function(){var e=this;this.resolveToken_((function(t){var n=$(e.service_,e.location_,e.area_),r=e.service_._agcInstance.getService("AGCNetworkService");if(!r)throw"get agcFileTransload service failed.";n.source=r.CancelToken.source();var o=e.service_.makeRequest(n,t);e.source_=n.source,o.then((function(t){e.source_=null,e.metadata_=t,e.transition_(ce)}),e.metadataErrorHandler_)}))},e.prototype.oneShotUpload_=function(){var e=this;this.resolveToken_((function(t){var n=function(e,t,n,r,o){var i=U.getBlob(n);if(null===i)throw l();var a=Y(t,n,o),s=Object.assign({"x-agc-nsp-js":"JSSDK"},a.metadata),c=new j(H(t.fullUrl()),"PUT",s,(function(e,t){return Z()(e,{data:t.data.fileInfo})}),V(),e.maxUploadTimeout,e.maxRetryTimes,r);return c.body=i.uploadData(),c}(e.service_,e.location_,e.blob_,e.area_,e.metadata_),r=e.service_._agcInstance.getService("AGCNetworkService");if(!r)throw"get agcFileTransload service failed.";n.source=r.CancelToken.source();var o=e.service_.makeRequest(n,t);e.source_=n.source,o.then((function(t){e.source_=null,e.metadata_=t,e.updateProgress_(e.blob_.size()),e.transition_(ce)}),e.errorHandler_)}))},e.prototype.updateProgress_=function(e){var t=this.transferred_;this.transferred_=e,this.transferred_!==t&&this.notifyObservers_()},e.prototype.transition_=function(e){if(this.state_!==e)switch(e){case ue:case ae:this.state_=e,null!==this.source_&&this.source_.cancel();break;case ie:var t=this.state_===se;this.state_=e,t&&(this.notifyObservers_(),this.start_());break;case se:this.state_=e,this.notifyObservers_();break;case le:this.error_=new o(g.CANCELED,"The operation was cancelled."),this.state_=e,this.notifyObservers_();break;case he:case ce:this.state_=e,this.notifyObservers_()}},e.prototype.completeTransitions_=function(){switch(this.state_){case ae:this.transition_(se);break;case ue:this.transition_(le);break;case ie:this.start_()}},Object.defineProperty(e.prototype,"snapshot",{get:function(){var e=pe(this.state_);return new re(this.transferred_,this.blob_.size(),e,this.metadata_,this,this.ref_)},enumerable:!0,configurable:!0}),e.prototype.on=function(e,n,r,o){function i(){if(e!==oe.STATE_CHANGED)throw"Expected one of the event types: ["+oe.STATE_CHANGED+"]."}var a="Expected a function or an Object with one of `next`, `error`, `complete` properties.",s=Ae(!0).validator,c=Re(null,!0).validator;function u(e){try{return void s(e)}catch(e){}try{if(c(e),!(A(e.next)||A(e.error)||A(e.complete)))throw"";return}catch(e){throw a}}var l=[me(i),Re(u,!0),Ae(!0),Ae(!0)];de("on",l,arguments);var h=this;function f(e){return function(n,r,i){null!==e&&de("on",e,arguments);var a=new t.ObserverImpl(n,r,o);return h.addObserver_(a),function(){h.removeObserver_(a)}}}function p(e){if(null===e)throw a;u(e)}var d=[Re(p),Ae(!0),Ae(!0)],g=!(A(n)||A(r)||A(o));return g?f(d):f(null)(n,r,o)},e.prototype.then=function(e,t){return this.promise_.then(e,t)},e.prototype.catch=function(e){return this.then(null,e)},e.prototype.addObserver_=function(e){this.observers_.push(e),this.notifyObserver_(e)},e.prototype.removeObserver_=function(e){var t=this.observers_.indexOf(e);-1!==t&&this.observers_.splice(t,1)},e.prototype.notifyObservers_=function(){var e=this;this.finishPromise_(),this.observers_.slice().forEach((function(t){e.notifyObserver_(t)}))},e.prototype.finishPromise_=function(){if(null!==this.resolve_){var e=!0;switch(pe(this.state_)){case fe.SUCCESS:Ce(this.resolve_.bind(null,this.snapshot))();break;case fe.CANCELED:case fe.ERROR:Ce(this.reject_.bind(null,this.error_))();break;default:e=!1}e&&(this.resolve_=null,this.reject_=null)}},e.prototype.notifyObserver_=function(e){switch(pe(this.state_)){case fe.RUNNING:case fe.PAUSED:e.next&&Ce(e.next.bind(e,this.snapshot))();break;case fe.SUCCESS:e.complete&&Ce(e.complete.bind(e))();break;case fe.CANCELED:case fe.ERROR:e.error&&Ce(e.error.bind(e,this.error_))();break;default:e.error&&Ce(e.error.bind(e,this.error_))()}},e.prototype.resume=function(){de("resume",[],arguments);var e=this.state_===se||this.state_===ae;return e&&this.transition_(ie),e},e.prototype.pause=function(){de("pause",[],arguments);var e=this.state_===ie;return e&&this.transition_(ae),e},e.prototype.cancel=function(){de("cancel",[],arguments);var e=this.state_===ie||this.state_===ae;return e&&this.transition_(ue),e},e}();function Ce(e){return function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];Promise.resolve().then((function(){return e.apply(void 0,t)}))}}var xe,Ue=function(){function e(e,t,n){this.storageManagement=e,this._area=t,this.location=n instanceof N?n:N.makeFromUrl(n)}return Object.defineProperty(e.prototype,"parent",{get:function(){var e=function(e){if(0===e.length)return null;var t=e.replace(/\/$/,""),n=t.lastIndexOf("/");return-1===n?"":t.slice(0,n)+"/"}(this.location.path);if(null===e)return null;var t=new N(this.location.bucket,e);return this.newRef(this.storageManagement,this._area,t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"root",{get:function(){var e=new N(this.location.bucket,"");return this.newRef(this.storageManagement,this._area,e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bucket",{get:function(){return this.location.bucket},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this.location.path},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return e=this.location.path,-1===(t=e.lastIndexOf("/",e.length-2))?e:e.slice(t+1);var e,t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"storage",{get:function(){return this.storageManagement},enumerable:!0,configurable:!0}),e.prototype.newRef=function(t,n,r){return new e(this.storageManagement,n,r)},e.prototype.child=function(e){de("storagereference.child",[ve(Ee)],arguments);var t=P(this.location.path,e),n=new N(this.location.bucket,t);return this.newRef(this.storageManagement,this._area,n)},e.prototype.delete=function(){var e=this;return this.throwIfDirectory_("be deleted","delete"),this.storageManagement.getAuthToken().then((function(t){var n=function(e,t,n){var r=new j(H(t.fullUrl()),"DELETE",{"x-agc-nsp-js":"JSSDK"},(function(e,t){}),V(),e.maxRequestTimeout,e.maxRetryTimes,n);return r.successCodes=[200,204],r}(e.storageManagement,e.location,e._area);return e.storageManagement.makeRequest(n,t)}))},e.prototype.getDownloadURL=function(){var e=this;return this.throwIfDirectory_("get download url","getDownloadURL"),this.storageManagement.getAuthToken().then((function(t){var n=Q(e.storageManagement,e.location,e._area);return e.storageManagement.makeRequest(n,t).then((function(e){if(null===e)throw new o(g.NO_DOWNLOAD_URL,"The given file does not have any download URLs.");return e}))}))},e.prototype.getFileMetadata=function(){var e=this;return this.throwIfRoot_("getFileMetadata"),this.throwIfDirectory_("get metadata","getFileMetadata"),this.storageManagement.getAuthToken().then((function(t){var n=$(e.storageManagement,e.location,e._area);return e.storageManagement.makeRequest(n,t)}))},e.prototype.listAll=function(){var e={dirList:[],fileList:[]};return this.listAllHelper(e).then((function(){return e}))},e.prototype.listAllHelper=function(e,t){return n(this,void 0,void 0,(function(){var n,o,i,a;return r(this,(function(r){switch(r.label){case 0:return n={pageMarker:t},[4,this.list(n)];case 1:return o=r.sent(),(i=e.dirList).push.apply(i,o.dirList),(a=e.fileList).push.apply(a,o.fileList),null==o.pageMarker?[3,3]:[4,this.listAllHelper(e,o.pageMarker)];case 2:r.sent(),r.label=3;case 3:return[2]}}))}))},e.prototype.list=function(e){var t=this;de("storagereference.list",[we()],arguments);var n=this;return this.storageManagement.getAuthToken().then((function(r){var o=e||{},i=K(n.storageManagement,n.location,t._area,"/",o.pageMarker,o.maxResults);return n.storageManagement.makeRequest(i,r)}))},e.prototype.put=function(e,t){return void 0===t&&(t=null),this.throwIfDirectory_("put file","put"),de("storagereference.put",[ye(),be(!0)],arguments),this.throwIfRoot_("put"),new Oe(this,this.storageManagement,this.location,new U(e),t,this._area)},e.prototype.put4QuickApp=function(e,t){var n=this;return void 0===t&&(t=null),this.throwIfDirectory_("put file","put4QuickApp"),de("storagereference.put4QuickApp",[me(),be(!0)],arguments),this.throwIfRoot_("put4QuickApp"),this.storageManagement.getAuthToken().then((function(r){var o=X(n.storageManagement,n.location,e,n._area,t);return n.storageManagement.makeUploadRequest(o,r)}))},e.prototype.putString=function(e,t,n){void 0===t&&(t=_.RAW),this.throwIfDirectory_("put string","putString"),de("storagereference.putString",[me(),me(Se,!0),be(!0)],arguments),this.throwIfRoot_("putString");var r=v(t,e),o=Object.assign({},n);return!R(o.contentType)&&R(r.contentType)&&(o.contentType=r.contentType),new Oe(this,this.storageManagement,this.location,new U(r.data,!0),o,this._area)},e.prototype.toString=function(){return"grs://"+this.location.bucket+"/"+this.location.path},e.prototype.updateFileMetadata=function(e){var t=this;return this.throwIfDirectory_("be updated FileMetadata","updateFileMetadata"),de("storagereference.updateFileMetadata",[be()],arguments),this.storageManagement.getAuthToken().then((function(n){var r=te(t.storageManagement,t.location,e,t._area);return t.storageManagement.makeRequest(r,n)}))},e.prototype.throwIfRoot_=function(e){if(""===this.location.path)throw function(e){var t="The operation"+e+"cannot be performed on a root reference.";return new o(g.INVALID_ROOT_OPERATION,t)}(e)},e.prototype.throwIfDirectory_=function(e,t){if(""===this.location.path||this.location.path.endsWith("/"))throw function(e,t){var n="Only file can "+e+" and "+t+"() don't supported at the root of bucket";return new o(g.INVALID_OPERATION,n)}(e,t)},e}();function Ne(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){return[2,new Promise((function(t,n){setTimeout((function(){t()}),e)}))]}))}))}!function(e){e.CN="CN",e.DE="DE",e.RU="RU",e.SG="SG"}(xe||(xe={}));var Pe,De=function(){function e(e,t){this._bucket="",this._maxRequestTimeout=12e4,this._maxUploadTimeout=6e5,this._maxRetryTimes=3,this._config=G.initInstance(e),this._agcInstance=e,this._bucket=null!=t?N.makeFromBucket(t):N.makeFromBucket(this._config.defaultBucket)}return e.prototype.storageReference=function(e,t){var n,r=void 0,o=this._agcInstance.option?this._agcInstance.option.routePolicy:null;if(null==e?n=o:"string"==typeof e?(de("storagemanagement.storageReference",[me(Ee,!0)],arguments),n=o,r=e):void 0!==t?(de("storagemanagement.storageReference",[Re(),me(Ee,!0)],arguments),n=e.routePolicy?e.routePolicy:o,r=t):(de("storagemanagement.storageReference",[Re()],arguments),n=e.routePolicy?e.routePolicy:o),r&&/^[A-Za-z]+:\/\//.test(r))throw p(0,"path","Expected path but got url, please use storageReferenceFromUrl instead.");if(null===this._bucket)throw u();var i=this.getAreaByPolicy(n),a=new Ue(this,i,this._bucket);return r?a.child(r):a},e.prototype.storageReferenceFromUrl=function(e,t){function n(e){if("string"!=typeof e)throw"Expected a string";if(!/^[A-Za-z]+:\/\//.test(e))throw"Expected a url string but got path, use storageReference instead";try{N.makeFromUrl(e)}catch(t){throw"Invalid url: "+e}}var r,o,i=this._agcInstance.option?this._agcInstance.option.routePolicy:null;return null==t?(o=i,de("storageManagement.storageReferenceFromUrl",[me(n)],arguments)):(o=t.routePolicy?t.routePolicy:i,de("storageManagement.storageReferenceFromUrl",[me(n),Re()],arguments)),r=this.getAreaByPolicy(o),new Ue(this,r,e)},Object.defineProperty(e.prototype,"maxUploadTimeout",{get:function(){return this._maxUploadTimeout},enumerable:!0,configurable:!0}),e.prototype.setMaxUploadTimeout=function(e){de("storageManagement.setMaxUploadTimeout",[Te()],arguments),this._maxUploadTimeout=e},Object.defineProperty(e.prototype,"maxRequestTimeout",{get:function(){return this._maxRequestTimeout},enumerable:!0,configurable:!0}),e.prototype.setMaxRequestTimeout=function(e){de("storageManagement.setMaxRequestTimeout",[Te()],arguments),this._maxRequestTimeout=e},Object.defineProperty(e.prototype,"maxRetryTimes",{get:function(){return this._maxRetryTimes},enumerable:!0,configurable:!0}),e.prototype.setMaxRetryTimes=function(e){de("storageManagement.setMaxRetryTimes",[Te()],arguments),this._maxRetryTimes=e},e.prototype.getAuthToken=function(){return n(this,void 0,void 0,(function(){var e,t,n,o;return r(this,(function(r){switch(r.label){case 0:return(e=this._agcInstance.getService("CredentialsService"))?(t="",[4,e.getToken().then((function(e){t="Bearer "+e.tokenString}))]):[2,Promise.reject(f("get credentialProvider service failed."))];case 1:return r.sent(),n="",(o=this._agcInstance.getService("AuthProviderService"))?[4,o.getToken(!1).then((function(e){e&&(n=e.getToken())}))]:[2,Promise.reject(f("get authProvider service failed."))];case 2:return r.sent(),[2,{Authorization:t,access_token:n}]}}))}))},e.prototype.makeStorageReference=function(e,t){return new Ue(this,t,e)},e.prototype.makeUploadRequest=function(e,t){var n=Object.assign(e.headers,t,{"Content-Type":"text/plain"}),r=G.getInstance();z(n,r.appId),B(n,r.clientId),F(n,r.productId);var o=new D(e.uri),i=new M(r.getHostByRegion(e.area).url+e.url,[o],n,e.method),a=this._agcInstance.getService("AGCFileTransloadService");if(!a){return Promise.reject(f("Get agcconnect network service failed. Please check it again."))}return i.validateStatus=function(t){return-1!==e.successCodes.indexOf(t)},a.upload(i).then((function(t){if(!t)return Promise.reject(f("upload file return null."));var n=e.handler(t.status,t);return Promise.resolve(n)})).catch((function(t){var n=e.errorHandler&&e.errorHandler(t.code,t);return Promise.reject(n)}))},e.prototype.makeRequest=function(e,t,n,r){var o=this;void 0===n&&(n=1);var i=function(e){var t="?";for(var n in e){if(Object.prototype.hasOwnProperty.call(e,n))t=t+(encodeURIComponent(n)+"="+encodeURIComponent(e[n]))+"&"}return t=t.slice(0,-1)}(e.urlParams),a=G.getInstance(),s=a.getHostByRegion(e.area),c=s.url+e.url+i,u=Object.assign(e.headers,t,{"Content-Type":"text/plain"});z(u,a.appId),B(u,a.clientId),F(u,a.productId);var l=this._agcInstance.getService("AGCNetworkService");if(!l){return Promise.reject(f("Get agcconnect network service failed. Please check it again."))}var h=new L(e.timeout);return e.source&&(h.cancelToken=e.source.token),h.onUploadProgress=e.progressCallback,h.validateStatus=function(t){return-1!==e.successCodes.indexOf(t)},"GET"===e.method?l.get(c,e.body,u,h).then((function(r){return o.doThen(e,r,t,n,s)})).catch((function(i){return o.doCatch(e,i,t,n,s.url,r===s.url?s:void 0)})):"POST"===e.method?l.post(c,e.body,u,h).then((function(r){return o.doThen(e,r,t,n,s)})).catch((function(i){return o.doCatch(e,i,t,n,s.url,r===s.url?s:void 0)})):"PUT"===e.method?l.put(c,e.body,u,h).then((function(r){return o.doThen(e,r,t,n,s)})).catch((function(i){return o.doCatch(e,i,t,n,s.url,r===s.url?s:void 0)})):"DELETE"===e.method?l.delete(c,e.body,u,h).then((function(r){return o.doThen(e,r,t,n,s)})).catch((function(i){return o.doCatch(e,i,t,n,s.url,r===s.url?s:void 0)})):Promise.reject(f("illegal request method."))},e.prototype.doThen=function(e,t,n,r,o){if(!t)return Promise.reject(f("network request return null."));if(-1===e.successCodes.indexOf(t.status))return Promise.reject(f("network request return status illegal."));G.getInstance().clearHostCount(e.area,o.index);var i=e.handler(t.status,t);return Promise.resolve(i)},e.prototype.doCatch=function(e,t,o,i,a,s){var c,u;return n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:return s&&(null===(u=null===(c=t)||void 0===c?void 0:c.message)||void 0===u?void 0:u.toLowerCase())==="NetWork Error".toLowerCase()&&G.getInstance().setHostCount(e.area,s.index),i>=e.maxRetryTimes?(t.respons&&(t.data=t.response.data),n=e.errorHandler&&e.errorHandler(t.code,t),[2,Promise.reject(n)]):[3,1];case 1:return[4,Ne(1e3*(i<6?Math.pow(2,i+1):64))];case 2:return r.sent(),[2,this.makeRequest(e,o,i+1,a)]}}))}))},e.prototype.getAreaByPolicy=function(e){if(!e)return this._config.defaultRegion;switch(e){case 0:return this._config.defaultRegion;case 1:return xe.CN;case 2:return xe.DE;case 3:return xe.RU;case 4:return xe.SG;default:return this._config.defaultRegion}},e}(),Me=function(){function e(e){this.factory=e}return e.prototype.get=function(e){return this.factory(e)},e}(),Le=new Me((function(t){var n,r=void 0;return t&&t[0]&&"object"==typeof t[0]?(n=t[0],r=t[1]):t?(n=e.instance(),r=t[1]):n=e.instance(),new De(n,r)}));Pe={TaskState:fe,TaskEvent:oe,StringFormat:_,Storage:De,Reference:Ue},e.registerApiProvider("cloudStorage",(function(e){return Le.get(e)}),Pe);
