"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}global&&global.process&&global.process.versions&&global.process.versions.node||(global.process=global.process||{},global.process.versions=global.process.versions||{},global.process.versions.node=global.process.versions.node||"node"),Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@agconnect/log"),n=e(require("@agconnect/api"));require("@agconnect/auth"),require("@agconnect/instance");var r=e(require("protobufjs")),o=e(require("long"));require("@agconnect/network");var s=e(require("@protobufjs/base64")),i=e(require("bignumber.js")),a=e(require("crypto-js")),u=function(e,t){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function c(e,t){function n(){this.constructor=e}u(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function l(e,t,n,r){return new(n||(n=Promise))((function(o,s){function i(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){e.done?o(e.value):new n((function(t){t(e.value)})).then(i,a)}u((r=r.apply(e,t||[])).next())}))}function d(e,t){var n,r,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}function p(e){var t="function"==typeof Symbol&&e[Symbol.iterator],n=0;return t?t.call(e):{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}function f(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,s=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=s.next()).done;)i.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=s.return)&&n.call(s)}finally{if(o)throw o.error}}return i}function h(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(f(arguments[t]));return e}var y,b=function(){function e(e,t){this.message=e,this.code=t}return e.prototype.getCode=function(){return this.code},e.prototype.getMessage=function(){return this.message},e}();(y=exports.AGConnectCloudDBExceptionCode||(exports.AGConnectCloudDBExceptionCode={}))[y.Ok=0]="Ok",y[y.ResourceExhausted=1]="ResourceExhausted",y[y.Timeout=2]="Timeout",y[y.FailedPrecondition=3]="FailedPrecondition",y[y.PermissionDenied=4]="PermissionDenied",y[y.Unknown=5]="Unknown",y[y.DataSizeOverflow=6]="DataSizeOverflow",y[y.UserKeyIllegality=7]="UserKeyIllegality",y[y.DataEncryptionKeyChanged=8]="DataEncryptionKeyChanged";var g,v,S,m,T=function(){function e(e){this.logger=t.Logger.createLogger(e)}return e.prototype.debug=function(e){this.logger.debug(e)},e.prototype.log=function(e){this.logger.log(e)},e.prototype.error=function(e){this.logger.error(e)},e.prototype.warn=function(e){this.logger.warn(e)},e.prototype.info=function(e){this.logger.info(e)},e}(),I=new T("BasicException"),R=function(){function e(e){this.exceptionCode=0,this.msg="",this.check(e)}return e.prototype.getCode=function(){return this.exceptionCode},e.prototype.check=function(t){e.ErrorMessageMapper.has(t)?(this.exceptionCode=t,this.msg=e.ErrorMessageMapper.get(t)||""):(this.exceptionCode=1,this.msg="",I.warn("Unknown exception code "+t+"."))},e.prototype.getMsg=function(){return this.msg},e.prototype.toString=function(){return"exceptionCode:"+this.exceptionCode+",msg:"+this.msg},e.ErrorMessageMapper=new Map([[0,""],[1,"internal error."],[4,"CloudDBZone init failed."],[5,"CloudDBZone does not exist."],[6,"the count of CloudDBZone exceeds the limit."],[7,"CloudDBZone is busy."],[8,"please close CloudDBZone first."],[9,"please open CloudDBZone first."],[10,"please remove subscriber first."],[11,"query policy is illegal."],[13,"the count of snapshot exceeds the limit."],[14,"sdk version error."],[15,"permission denied."],[16,"object type does not exist."],[17,"object type info is invalid."],[18,"CloudDBZone config is invalid."],[19,"no data was found in CloudDBZone."],[20,"transfer data is unfinished."],[21,"downgrade object type version is illegal."],[50,"user key is invalid."],[51,"data encryption key is invalid."],[52,"encrypt failed."],[53,"decrypt failed."],[54,"please set user key first."],[1e3,"Connect to server failed."],[1001,"Object type negotiating."],[1002,"Object type negotiation exception."],[1003,"Internal error."],[1004,"Internal error."],[1005,"Connect to server failed."],[1006,"Internal error."],[1007,"Request timeout."],[1008,"Internal error."],[1009,"Internal error."],[1010,"Internal error."],[1011,"Request failed."],[1012,"Get verify info failed."],[1013,"Get verify info failed."],[1014,"Illegal application context."],[1e6,"verify token failed."],[1000001,"permission denied."],[1001e3,"the count of product subscriber exceeds the limit."],[1001001,"the count of client subscriber exceeds the limit."],[1001002,"the count of condition for subscription exceeds the limit."],[1001003,"unsupported subscription condition type."],[1001004,"unsupported subscription field type."],[1001005,"the length of subscription field value exceeds the limit."],[1001006,"the count of transaction record exceeds the limit."],[1001007,'"query %s with pagination from the cloud database failed: %s no such index for query.'],[1001008,"subscription condition objectType contains autoIncrement field."],[1002e3,"execution parameter is illegal."],[1002001,"execution parameter is illegal."],[1002002,"execution parameter is illegal."],[1002003,"illegal subscription condition."],[1002004,"internal error."],[1003e3,"internal error."],[1003001,"internal error."],[1003002,"internal error."],[1004e3,"product arrears."],[1004001,"insufficient read quota."],[1004002,"insufficient write quota."],[1004003,"insufficient delete quota."],[1004004,"insufficient network quota."],[1004005,"insufficient storage quota."],[1004006,"resources are exhausted."],[1004007,"resources are exhausted."],[1004008,"resources are exhausted."],[1004009,"resources are exhausted."],[1004010,"resources are exhausted."],[1004011,"resources are exhausted."],[1004012,"resources are exhausted."],[1005e3,"the system status does not meet the operation execution conditions."],[1005001,"invalid operation argument."],[1005002,"rejected by data re-encrypting."],[1005003,"illegal request."],[1005004,"illegal request."],[1006e3,"object type is empty."],[1006001,"object type is not found."],[1006002,"the count of object type field mismatched."],[1006003,"object type field mismatched."],[1006004,"the type of object type field mismatched."],[1006005,"the null property of object type field mismatched."],[1006006,"the primary key of object type field mismatched."],[1006007,"the default value of object type field mismatched."],[1006008,"the encryption property of object type field mismatched."],[2e6,"system error."],[2001e3,"operation is illegal."],[2001001,"product status is not created."],[2001002,"the count of DB Zones exceeds the limit."],[2001003,"object type is not allowed to delete."],[2001004,"object type is not allowed to modify while import."],[2001005,"the count of object type exceeds the limit."],[2001006,"primary key is not allowed to modify."],[2001007,"the field is not allowed to modify."],[2001008,"the field is not allowed to delete."],[2001009,"the count of field exceeds the limit."],[2001010,"the index is not allowed to modify."],[2001011,"the index is not allowed to delete."],[2001012,"the count of index exceeds the limit."],[2001013,"the count of fields in a index exceeds the limit."],[2001014,"no permission found."],[2001015,"permission denied."],[2001016,"encrypted field does not support this query."],[2001017,"the capacity of objects exceeds the limit."],[2001018,"the size of object list exceeds the limit."],[2001019,"write is prohibited."],[2001020,"the size of the data to be written exceeds the limit."],[2001021,"the size of a string data to be written exceeds the limit."],[2001022,"operation is illegal."],[2001023,"operation is illegal."],[2001024,"user is locked."],[2001025,"user authentication failed."],[2001026,"the service is unavailable currently."],[2001027,"operation is denied while key is updating."],[2001028,"the count of string field exceeds the limit."],[2002e3,"invalid parameter."],[2002001,"product id is invalid."],[2002002,"product type is invalid."],[2002003,"store id is invalid."],[2002004,"unsupported operation for object type."],[2002005,"original object type is changed."],[2002006,"object type already exists."],[2002007,"object type does not exist."],[2002008,"object type is duplicate."],[2002009,"object type name is invalid."],[2002010,"no field in the object type."],[2002011,"object type is invalid."],[2002012,"field name is duplicate."],[2002013,"field name is invalid."],[2002014,"field type is invalid."],[2002015,"field value is invalid."],[2002016,"encrypt field type error."],[2002017,"index name is invalid."],[2002018,"index name is duplicate."],[2002019,"field in an index does not exist."],[2002020,"role type is invalid."],[2002021,"index is invalid while query by cursor."],[2002022,"invalid cache-changed message."],[2002023,"invalid input."],[2002024,"default value is absent."],[2002025,"primary key does not set not null."],[2002026,"primary key does not support setting default value."],[2002027,"primary key does not support setting encrypted."],[2002028,"primary key does not support the type."],[2002029,"primary key can not be found."],[2002030,"the count of primary key exceeds the limit."],[2002031,"filed type does not support setting not null."],[2002032,"filed type does not support setting default value."],[2002033,"filed type does not support setting encrypt."],[2002034,"object type does not support modifying concurrently."],[2002035,"field of default value can not set as null."],[2002036,"not null field can not be null."],[2002037,"CloudDBZone does not exist."],[2003e3,"runtime error."],[2003001,"getting usage of the storage failed."],[2003002,"getting size of the storage failed."],[2003003,"creating app failed."],[2003004,"deleting app failed."],[2003005,"creating database failed."],[2003006,"error occurred while checking the existence of a database instance."],[2003007,"occupying node group failed."],[2003008,"freeing node group failed."],[2003009,"querying node information failed."],[2003010,"querying the mapping between products and node groups failed."],[2003011,"querying the products in cluster failed."],[2003012,"querying available clusters failed."],[2003013,"occupying cluster failed."],[2003014,"querying cluster failed."],[2003015,"inserting config of product mapping failed."],[2003016,"error occurred while checking the existence of a DB zone."],[2003017,"creating DB zone failed."],[2003018,"dropping DB zone failed."],[2003019,"initializing system tables failed."],[2003020,"upgrading schema failed."],[2003021,"generating a new schema version failed."],[2003022,"setting permission for schemas failed."],[2003023,"field type error."],[2003024,"creating table failed."],[2003025,"upgrading table failed."],[2003026,"dropping object type failed."],[2003027,"error occurred while checking the existence of a table."],[2003028,"locking table failed."],[2003029,"querying product mapping failed."],[2003030,"upserting product mapping failed."],[2003031,"deleting product mapping failed."],[2003032,"querying product key failed."],[2003033,"inserting product key failed."],[2003034,"deleting product key failed."],[2003035,"querying product status failed."],[2003036,"updating product status failed."],[2003037,"querying all the products failed."],[2003038,"saving product info failed."],[2003039,"deleting product info failed."],[2003040,"querying the mapping between product and DB ID failed."],[2003041,"querying all IDs of the products failed."],[2003042,"generate ID failed."],[2003043,"locking the ID failed."],[2003044,"value type of the ID is incorrect."],[2003045,"updating ID failed."],[2003046,"initializing counter failed."],[2003047,"querying counter failed."],[2003048,"update counter failed."],[2003049,"cached plan changed."],[2003050,"invalid prepared statement."],[2003051,"bind value to statement failed."],[2003052,"value convert failed."],[2003053,"numeric value out of range."],[2003054,"getting DB connection failed."],[2003055,"initializing DB connection failed."],[2003056,"invalid DB connection."],[2003057,"invalid group id for DB."],[2003058,"use database for connection failed."],[2003059,"verifying the config of product mapping failed."],[2003060,"getting config in DB failed."],[2003061,"modifying config in DB failed."],[2003062,"item does not exist in config."],[2003063,"transaction execute failed."],[2003064,"transaction start failed."],[2003065,"transaction commit failed."],[2003066,"transaction rollback failed."],[2003067,"sql execute failed."],[2003068,"querying execute failed."],[2003069,"inserting execute failed."],[2003070,"updating execute failed."],[2003071,"deleting execute failed."],[2003072,"truncating execute failed."],[2003073,"upsert failed."],[2003074,"batch upsert failed."],[2003075,"batch delete failed."],[2003076,"querying by row failed."],[2003077,"upserting by row failed."],[2003078,"deleting by row failed."],[2003079,"extracting data from result set failed."],[2003080,"extracting data from result set failed."],[2003081,"extracting data failed."],[2003082,"extracting version failed."],[2003083,"expected value does not exist."],[2003084,"modifying the database connection limit failed."],[2003085,"unsupported."],[2003086,"querying object type failed."],[2003087,"object type conversion failed."],[2003088,"instance id getting error."],[2003089,"no valid product mapping info."],[2003090,"no free cluster."],[2003091,"group is not empty."],[2003092,"no free node group."],[2003093,"node group has not been allocated."],[2003094,"length of index field exceeds the limit."]]),e}(),E=function(){function e(){}return e.build=function(e){return"string"==typeof e?{message:e}:this.parseException(new R(e))},e.parseException=function(e){return new b(e.getMsg(),e.getCode())},e}(),w=require("crypto-js"),O=function(){function e(){}return e.isFunction=function(e){return"function"==typeof e},e.isArray=function(e){return"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e)},e.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},e.isNotNullObject=function(e){return null!==e&&"object"==typeof e},e.isNullOrUndefined=function(e){return null==e},e.checkNotNull=function(t,n){if(e.isNullOrUndefined(t))throw E.build(n)},e.isClass=function(t){if(e.isFunction(t)){var n=t.prototype;if(!e.isNotNullObject(n))return!1;var r=n.constructor;if(e.isFunction(r))return!0}return!1},e.isErrorObject=function(t){return!!(t instanceof b||e.isObject(t)&&Object.prototype.hasOwnProperty.call(t,"message")&&1===Object.getOwnPropertyNames(t).length)},e.isArrayBuffer=function(e){if(!e)return!1;var t=Object.prototype.toString.call(e);return"[object ArrayBuffer]"===t||"[object Uint8Array]"===t},e.isEmpty=function(){for(var e,t,n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];if(0===n.length)return!0;try{for(var o=p(n),s=o.next();!s.done;s=o.next()){var i=s.value;if(!i)return!0}}catch(t){e={error:t}}finally{try{s&&!s.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}return!1},e.isValidObject=function(e){return!(!e||"object"!=typeof e||"Object"===e.constructor.name)},e.isSameObjectType=function(t){var n,r;if(e.checkNotNull(t,"The object list is invalid."),e.isEmptyArray(t))return!0;var o=this.getClassName(t[0]);try{for(var s=p(t),i=s.next();!i.done;i=s.next()){var a=i.value;if(this.getClassName(a)!==o)return!1}}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return!0},e.isEmptyArray=function(e){return 0===e.length},e.getClassName=function(t){if(e.isNullOrUndefined(t))return t;var n=t;return e.isClass(n)||(n=t.constructor),n.className?n.className:n.name},e.deepCopy=function(e){var t,n,r=[];try{for(var o=p(e),s=o.next();!s.done;s=o.next()){var i=s.value;if("object"==typeof i)if(i.constructor!==Date)if(i.constructor!==RegExp)if(i.clone)r.push(i.clone());else{var a=new i.constructor;for(var u in i)if(Object.hasOwnProperty.call(i,u)){var c=i[u];a[u]=c}r.push(a)}else r.push(new RegExp(i));else r.push(new Date(i));else r.push(i)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r},e.deepCopyNumber=function(e){var t=new Set;return e.forEach((function(e){t.add(e)})),t},e.hash=function(e){for(var t=""+e,n=5381,r=t.length;r;)n=33*n^t.charCodeAt(--r);return""+(n>>>0)},e.generateUUID=function(){for(var e=(new Date).getTime(),t="",n=1;n<15;n+=2){t+="abcdefghijklmnopqrstuvwxyz1234567890".charAt((e>>>n)%36)}return t},e.uint8ArrayToString=function(e){return decodeURIComponent(escape(String.fromCharCode.apply(String,h(e))))},e.stringToUint8Array=function(e){var t=unescape(encodeURIComponent(e)).split("").map((function(e){return e.charCodeAt(0)}));return new Uint8Array(t)},e.wordArrayToUint8Array=function(e){for(var t=e.sigBytes,n=e.words,r=new Uint8Array(t),o=0,s=0;o!==t;){var i=n[s++];if(r[o++]=(4278190080&i)>>>24,o===t)break;if(r[o++]=(16711680&i)>>>16,o===t)break;if(r[o++]=(65280&i)>>>8,o===t)break;r[o++]=255&i}return r},e.uint8ArrayToWordArray=function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e[r])<<24-r%4*8;return w.lib.WordArray.create(n,t)},e.encode=function(e){return w.enc.Base64.stringify(e)},e.decode=function(e){return w.enc.Base64.parse(e)},e.convertArray=function(t){return e.isArray(t)?t:[t]},e.isStringEmpty=function(e){return null==e||""===e},e}(),C=new Set(["Limit","OrderBy"]),N=function(){function e(e){this.queryConditions=[],this.clazz=e,this.depth=0}return e.where=function(t){return O.checkNotNull(t,"Entity class must not be null."),new e(t)},e.prototype.addCondition=function(e,t,n){if(this.queryConditions.length>=30)throw E.build("Query type exceeds the limit.");var r={conditionType:e,fieldName:t,value:n};return this.queryConditions.push(r),this},e.prototype.equalTo=function(e,t){return this.checkFieldValidity(e,t),this.addCondition("EqualTo",e,t)},e.prototype.count=function(e){return this.checkFieldValidity(e),this.addCondition("Count",e)},e.prototype.beginsWith=function(e,t){return this.checkFieldValidity(e,t),this.addCondition("BeginWith",e,t)},e.prototype.endsWith=function(e,t){return this.checkFieldValidity(e,t),this.addCondition("EndWith",e,t)},e.prototype.contains=function(e,t){return this.checkFieldValidity(e,t),this.addCondition("Contain",e,t)},e.prototype.notEqualTo=function(e,t){return this.checkFieldValidity(e,t),this.addCondition("NotEqualTo",e,t)},e.prototype.greaterThan=function(e,t){return this.checkFieldValidity(e,t),this.addCondition("GreaterThan",e,t)},e.prototype.greaterThanOrEqualTo=function(e,t){return this.checkFieldValidity(e,t),this.addCondition("GreaterThanOrEqualTo",e,t)},e.prototype.lessThan=function(e,t){return this.checkFieldValidity(e,t),this.addCondition("LessThan",e,t)},e.prototype.lessThanOrEqualTo=function(e,t){return this.checkFieldValidity(e,t),this.addCondition("LessThanOrEqualTo",e,t)},e.prototype.in=function(e,t){if(!O.isArray(t))throw E.build("The values must be array.");return this.checkFieldValidity.apply(this,h([e],t)),this.addCondition("In",e,t)},e.prototype.isNull=function(e){return this.checkFieldValidity(e),this.addCondition("IsNull",e)},e.prototype.isNotNull=function(e){return this.checkFieldValidity(e),this.addCondition("IsNotNull",e)},e.prototype.orderByAsc=function(e){return this.checkFieldValidity(e),this.isValidCloudDBQuery("OrderBy","ASC"),this.addCondition("OrderBy",e,"ASC")},e.prototype.orderByDesc=function(e){return this.checkFieldValidity(e),this.isValidCloudDBQuery("OrderBy","DESC"),this.addCondition("OrderBy",e,"DESC")},e.prototype.limit=function(e,t){if("number"!=typeof e||Math.floor(e)!==e||e<=0)throw E.build("The Count is invalid.");if(O.isNullOrUndefined(t)&&(t=0),"number"!=typeof t||Math.floor(t)!==t||t<0)throw E.build("The Offset is invalid.");return this.isValidCloudDBQuery("Limit"),this.addCondition("Limit",void 0,{offset:void 0!==t?t:0,number:e})},e.prototype.beginGroup=function(){return this.isValidCloudDBQuery("BeginGroup"),this.depth++,this.addCondition("BeginGroup",void 0)},e.prototype.endGroup=function(){return this.isValidCloudDBQuery("EndGroup"),this.depth--,this.addCondition("EndGroup",void 0)},e.prototype.or=function(){return this.isValidCloudDBQuery("Or"),this.addCondition("Or",void 0)},e.prototype.and=function(){return this.isValidCloudDBQuery("And"),this.addCondition("And",void 0)},e.prototype.getClassName=function(){var e;if(this.tableName)return this.tableName;var t=this.clazz.className;return t||(null===(e=this.clazz)||void 0===e?void 0:e.name)},e.prototype.getClazz=function(){return this.clazz},e.prototype.getQueryConditions=function(){return this.queryConditions},e.prototype.getDepth=function(){return this.depth},e.prototype.checkFieldValidity=function(e){for(var t,n,r=[],o=1;o<arguments.length;o++)r[o-1]=arguments[o];O.checkNotNull(e,"The field name must not be null.");try{for(var s=p(r),i=s.next();!i.done;i=s.next()){var a=i.value;O.checkNotNull(a,"The value is invalid.")}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}},e.prototype.isValidCloudDBQuery=function(e,t){var n=this.queryConditions.length,r=0===n?null:this.queryConditions[n-1].conditionType;if(C.has(e)&&(0!==this.depth||"Or"===r||"And"===r)){if("OrderBy"===e)throw E.build('near "'+t+'": syntax error.');throw E.build('near "'+e+'": syntax error.')}if(("Or"===e||"And"===e)&&(0===n||"BeginGroup"===r||C.has(r)||"Or"===r||"And"===r))throw E.build('near "'+e+'": syntax error.');if("EndGroup"===e){if(this.depth<=0)throw E.build("The query beginGroup and endGroup should come in pairs with right direction.");if(0===n||"BeginGroup"===r||"Or"===r||"And"===r)throw E.build('near "'+e+'": syntax error.')}},e}(),A=function(){function e(e,t,n){this.snapshotObjects=e,this.upsertedObjects=t,this.deletedObjects=n}return e.prototype.getSnapshotObjects=function(){return this.snapshotObjects},e.prototype.setSnapshotObjects=function(e){this.snapshotObjects=e},e.prototype.getUpsertedObjects=function(){return this.upsertedObjects},e.prototype.setUpsertedObjects=function(e){this.upsertedObjects=e},e.prototype.getDeletedObjects=function(){return this.deletedObjects},e.prototype.setDeletedObjects=function(e){this.deletedObjects=e},e}(),D=function(){function e(e){this.capacity_=-1,this.cacheNodeMap=new Map,this.primaryKeys=e}return Object.defineProperty(e.prototype,"capacity",{get:function(){return this.capacity_},enumerable:!1,configurable:!0}),e.prototype.hash=function(e){for(var t=""+e,n=5381,r=t.length;r;)n=33*n^t.charCodeAt(--r);return""+(n>>>0)},e.prototype.getRecordHash=function(e){var t="R";return this.primaryKeys.forEach((function(n){t=t+"-"+e[n]})),this.hash(t)},e}(),_=function(e){this.versionId=e},P=function(e){function t(t){var n=e.call(this,t)||this;return n.capacity_=-1,n}return c(t,e),t.prototype.cache=function(e,t){var n=this.cacheNodeMap.get(t);return n||(n=new _(t),this.cacheNodeMap.set(t,n)),n.record=e,n},t.prototype.remove=function(e){e&&(this.cacheNodeMap.get(e)&&this.cacheNodeMap.delete(e))},t.prototype.get=function(e){if(e)return this.cacheNodeMap.get(e)},t}(D),k=function(){function e(e){this.value_=void 0,this.actions={},this.value_=e}return Object.defineProperty(e.prototype,"value",{get:function(){return this.value_},set:function(e){var t,n;this.value_=e;var r=Object.getOwnPropertyNames(this.actions);try{for(var o=p(r),s=o.next();!s.done;s=o.next()){var i=s.value,a=this.actions[i];(null==a?void 0:a.isMeetCondition(this))&&a.execute(this)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}},enumerable:!1,configurable:!0}),e.prototype.register=function(e){this.actions[e.id]=e},e.prototype.unregister=function(e){delete this.actions[e]},e.prototype.hasNoAction=function(){return 0===Object.getOwnPropertyNames(this.actions).length},e.prototype.release=function(){this.actions={},this.value_=void 0},e}(),M=function(){function e(e,t,n,r){this.isTimeout=!1,this.executed=!1,this.isRegistered=!1,this.isOnce=e,this.id=n,this.func=t,this.condition=r||function(e){return!0}}return Object.defineProperty(e.prototype,"isExecuted",{get:function(){return this.executed},enumerable:!1,configurable:!0}),e.prototype.isMeetCondition=function(e){return!1===this.isTimeout&&this.condition(e)},e.prototype.withTimeout=function(e,t){var n=this;return setTimeout((function(){n.isExecuted||(n.isTimeout=!0,t&&t())}),e),this},e.prototype.execute=function(e){this.isTimeout||(this.isRegistered||e.register(this),this.condition(e)&&this.executeAndTryUnregister(e))},e.prototype.executeAndTryUnregister=function(e){this.executed=!0;try{this.func(e)}catch(e){setTimeout((function(){throw e}),Math.floor(0))}this.isOnce&&e.unregister(this.id)},e}();!function(e){e[e.EMPTY=0]="EMPTY",e[e.SCHEMA_NEGOTIATE=1]="SCHEMA_NEGOTIATE",e[e.CACHE_UPDATE=2]="CACHE_UPDATE",e[e.OBJECT_UPDATE=3]="OBJECT_UPDATE",e[e.TRANSACTION=4]="TRANSACTION",e[e.OBJECT_QUERY=5]="OBJECT_QUERY",e[e.QUERY_SUB=6]="QUERY_SUB",e[e.QUERY_UNSUB=7]="QUERY_UNSUB",e[e.QUERY_SUB_PUSH=8]="QUERY_SUB_PUSH",e[e.ENCRYPTION_TASK=9]="ENCRYPTION_TASK",e[e.USER_DATA_QUERY=10]="USER_DATA_QUERY",e[e.STORE_CLOSING=11]="STORE_CLOSING"}(g||(g={})),function(e){e[e.EMPTY=0]="EMPTY",e[e.QUERY_SALT_VALUE=1]="QUERY_SALT_VALUE",e[e.QUERY_CIPHER_TEST=2]="QUERY_CIPHER_TEST",e[e.UPDATE_CIPHER_TEXT=3]="UPDATE_CIPHER_TEXT",e[e.INSERT_ENCRYPTION_INFO=4]="INSERT_ENCRYPTION_INFO",e[e.UPDATE_ENCRYPTION_INFO=5]="UPDATE_ENCRYPTION_INFO",e[e.NOTIFY_ENCRYPTION_COMMAND_CHANGED=6]="NOTIFY_ENCRYPTION_COMMAND_CHANGED",e[e.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_NORMAL=7]="NOTIFY_ENCRYPTION_KEY_CHANGE_TO_NORMAL",e[e.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATING=8]="NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATING",e[e.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATE_INTERRUPT=9]="NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATE_INTERRUPT",e[e.MONITOR_USER_COMMAND_CHANGE=10]="MONITOR_USER_COMMAND_CHANGE",e[e.MONITOR_DATA_KEY_CHANGE=11]="MONITOR_DATA_KEY_CHANGE"}(v||(v={})),function(e){e[e.SYNC_UPSERT=1]="SYNC_UPSERT",e[e.SYNC_DELETE=2]="SYNC_DELETE",e[e.VERIFY=3]="VERIFY"}(S||(S={})),function(e){e[e.ALL=0]="ALL",e[e.UPSERT=1]="UPSERT",e[e.DELETE=2]="DELETE"}(m||(m={}));var j=new T("SequenceTaskQueue"),x=function(){function e(){this.tasks=[],this.isExecuting=!1}return e.prototype.scheduleProcess=function(e){j.debug("scheduleProcess start: "+this.isExecuting),this.tasks.push(e),this.isExecuting||this.process()},e.prototype.process=function(){var e=this;if(this.isExecuting=!0,j.debug("process start length: "+this.tasks.length),this.tasks.length){var t=this.tasks.shift();null==t||t.execute().then((function(){e.process()}))}else this.isExecuting=!1},e}(),U=function(){function e(e){this.func=e}return e.prototype.execute=function(){return this.func.call(null)},e}(),q=new T("SnapshotGenerator"),L=function(){function e(e,t,n){this.snapshotVersionIds=new Set,this.upsertedVersionIds=new Set,this.deletedVersionIds=new Set,this.version=new k(0),this.taskQueue=new x,this.clz=e,this.cloudDBZoneQuery=t,this.naturalBaseRef=n}return e.prototype.initialize=function(e){this.snapshotCache=new P(e)},e.prototype.getVersion=function(){return this.version},e.prototype.increaseVersion=function(){this.version.value=this.version.value+1},e.prototype.cacheSnapshotObjects=function(e,t,n){var r=this,o=new U((function(){return l(r,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.processPushData(e,t,n)];case 1:return[2,r.sent()]}}))}))}));this.taskQueue.scheduleProcess(o)},e.prototype.processPushData=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s,i=this;return d(this,(function(a){switch(a.label){case 0:return q.info("processPushData start:"+e.length+" "+this.snapshotVersionIds.size+"             "+this.upsertedVersionIds.size+" "+this.deletedVersionIds.size),0!==t?[3,5]:(this.deletedVersionIds.forEach((function(e){i.snapshotCache.remove(e)})),this.clearSnapshotVersionIds(),r=e.map((function(e){return e})).filter((function(e){return e.operationType===m.DELETE&&e.isValidVersion()})),o=e.map((function(e){return e})).filter((function(e){return e.operationType===m.UPSERT})),s=e.map((function(e){return e})).filter((function(e){return e.operationType===m.ALL})),q.info("processPushData on: "+o.length+", "+r.length+", "+s.length),n!==m.DELETE&&n!==m.UPSERT?[3,2]:[4,this.handleIncrementalData(r,o)]);case 1:return a.sent(),[3,4];case 2:return[4,this.handlePushAllData(s)];case 3:a.sent(),a.label=4;case 4:q.info("processPushData done: "+e.length+" "+this.snapshotVersionIds.size+"                 "+this.upsertedVersionIds.size+" "+this.deletedVersionIds.size),a.label=5;case 5:return this.increaseVersion(),[2,Promise.resolve(0)]}}))}))},e.prototype.handleIncrementalData=function(e,t){var n;return l(this,void 0,void 0,(function(){var r,o,s,i,a,u,c,l,f,h,y,b,g,v,S,m;return d(this,(function(d){switch(d.label){case 0:r=new Map;try{for(o=p(e),s=o.next();!s.done;s=o.next())l=s.value,(i=null===(n=this.snapshotCache.get(l.objectVersion))||void 0===n?void 0:n.record)&&(f=this.generateRecord(i),r.set(this.snapshotCache.getRecordHash(f),l.objectVersion),this.deletedVersionIds.add(l.objectVersion),this.snapshotVersionIds.delete(l.objectVersion))}catch(e){g={error:e}}finally{try{s&&!s.done&&(v=o.return)&&v.call(o)}finally{if(g)throw g.error}}a=this.getSnapshotCacheVersionIds(),d.label=1;case 1:d.trys.push([1,6,7,8]),u=p(t),c=u.next(),d.label=2;case 2:if(c.done)return[3,5];if(l=c.value,f=this.generateRecord(l),h=this.snapshotCache.getRecordHash(f),y=r.get(h))this.deletedVersionIds.delete(y);else if(a.has(h)&&a.get(h)===l.objectVersion)return[3,4];return[4,this.naturalBaseRef.getEntireEncryption().decryptEntireEncryptedFields(this.cloudDBZoneQuery,[l])];case 3:d.sent(),this.snapshotCache.cache(l,l.objectVersion),this.snapshotVersionIds.add(l.objectVersion),this.upsertedVersionIds.add(l.objectVersion),d.label=4;case 4:return c=u.next(),[3,2];case 5:return[3,8];case 6:return b=d.sent(),S={error:b},[3,8];case 7:try{c&&!c.done&&(m=u.return)&&m.call(u)}finally{if(S)throw S.error}return[7];case 8:return[2]}}))}))},e.prototype.handlePushAllData=function(e){var t,n,r,o;return l(this,void 0,void 0,(function(){var s,i,a,u,c,l,f,h,y,b,g,v,S=this;return d(this,(function(d){switch(d.label){case 0:s=new Set(this.snapshotVersionIds),i=this.getSnapshotCacheVersionIds(),d.label=1;case 1:d.trys.push([1,7,8,9]),a=p(e),u=a.next(),d.label=2;case 2:return u.done?[3,6]:(c=u.value,l=this.generateRecord(c),f=this.snapshotCache.getRecordHash(l),h=i.get(f),y=h&&(!(null===(n=null===(t=this.snapshotCache.get(h))||void 0===t?void 0:t.record)||void 0===n?void 0:n.objectVersion)||(null===(o=null===(r=this.snapshotCache.get(h))||void 0===r?void 0:r.record)||void 0===o?void 0:o.objectVersion)!==c.objectVersion),h&&!y?[3,4]:[4,this.naturalBaseRef.getEntireEncryption().decryptEntireEncryptedFields(this.cloudDBZoneQuery,[c])]);case 3:d.sent(),this.upsertedVersionIds.add(c.objectVersion),this.snapshotVersionIds.add(c.objectVersion),this.snapshotCache.cache(c,c.objectVersion),d.label=4;case 4:h&&s.delete(h),y&&(this.snapshotVersionIds.delete(h),this.snapshotCache.remove(h)),d.label=5;case 5:return u=a.next(),[3,2];case 6:return[3,9];case 7:return b=d.sent(),g={error:b},[3,9];case 8:try{u&&!u.done&&(v=a.return)&&v.call(a)}finally{if(g)throw g.error}return[7];case 9:return s.forEach((function(e){S.deletedVersionIds.add(e),S.snapshotVersionIds.delete(e)})),[2]}}))}))},e.prototype.clearSnapshotVersionIds=function(){this.upsertedVersionIds.clear(),this.deletedVersionIds.clear()},e.prototype.generateSnapshot=function(e,t){if(t){var n=O.deepCopyNumber(this.snapshotVersionIds),r=this.buildSnapshotObjects(e,n);return new A(r,r,[])}var o=O.deepCopyNumber(this.snapshotVersionIds),s=O.deepCopyNumber(this.upsertedVersionIds),i=O.deepCopyNumber(this.deletedVersionIds),a=this.buildSnapshotObjects(e,o),u=this.buildSnapshotObjects(e,s),c=this.buildSnapshotObjects(e,i);return new A(a,u,c)},e.prototype.buildSnapshotObjects=function(e,t){var n,r,o,s=[];try{for(var i=p(t),a=i.next();!a.done;a=i.next()){var u=a.value,c=null===(o=this.snapshotCache.get(u))||void 0===o?void 0:o.record;if(void 0!==c){var l=O.deepCopy([c.getUserObject()]);s.push(l[0])}}}catch(e){n={error:e}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return s},e.prototype.getSnapshotCache=function(){var e=this;return h(this.snapshotVersionIds).map((function(t){var n;return null===(n=e.snapshotCache.get(t))||void 0===n?void 0:n.record}))},e.prototype.getSnapshotCacheVersionIds=function(){var e=this,t=new Map;return this.getSnapshotCache().forEach((function(n){var r=e.generateRecord(n);t.set(e.snapshotCache.getRecordHash(r),n.objectVersion)})),t},e.prototype.generateRecord=function(e){return e.setObjectTypeName(this.clz),this.naturalBaseRef.getDataModelHelper().deserialize(this.clz,e.getObject())},e}(),K=new T("SubscribeManager"),B=function(){function e(e,t,n,r,o){this.exceptionCode=0,this.cloudSubRecordId="",this.cloudSubKey=-1,this.pushSeq=0,this.queryId=e,this.conditionSignature=t,this.naturalStoreName=n,this.cloudDBZoneQuery=r,this.naturalBaseRef=o,this.snapshotGenerator=new L(this.cloudDBZoneQuery.getClazz(),this.cloudDBZoneQuery,o)}return e.prototype.initialize=function(e){this.snapshotGenerator.initialize(e)},e.prototype.addListener=function(e,t){var n=this;new V((function(e){return l(n,void 0,void 0,(function(){var n;return d(this,(function(r){if(0!==this.exceptionCode)t.onSnapshot(void 0,E.build(this.exceptionCode));else{if(n=this.snapshotGenerator.generateSnapshot(this.cloudDBZoneQuery.getClazz(),e),!e&&0===n.getUpsertedObjects().length&&0===n.getDeletedObjects().length)return K.info("addListener: skip snapShot notify when first snapShot has nothing update!"),[2];t.onSnapshot(n,void 0)}return[2]}))}))}),e,(function(){var e=n.snapshotGenerator.getVersion().value;return void 0!==e&&e>0})).execute(this.snapshotGenerator.getVersion())},e.prototype.removeListener=function(e){return this.snapshotGenerator.getVersion().unregister(e.toString()),this.snapshotGenerator.getVersion().hasNoAction()},e.prototype.subscribe=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return K.info("start subscribe!"),this.pushSeq=0,[4,this.naturalBaseRef.getNaturalCloudStorage().onSubscribe(At.DEFAULT_SUBSCRIBE,this.naturalBaseRef.getNaturalStore(this.naturalStoreName),[this.queryId,this.cloudDBZoneQuery.getClassName(),e])];case 1:return t.sent(),[2]}}))}))},e.prototype.unsubscribe=function(){var e;return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return K.info("start unsubscribe!"),[4,this.naturalBaseRef.getNaturalCloudStorage().onUnSubscribe(At.DEFAULT_SUBSCRIBE,this.naturalBaseRef.getNaturalStore(this.naturalStoreName),[this.queryId,null===(e=this.cloudSubRecordId)||void 0===e?void 0:e.toString(),this.cloudSubKey,this.cloudDBZoneQuery.getClassName()])];case 1:return t.sent(),[2]}}))}))},e.prototype.notify=function(e,t,n){this.exceptionCode=e,this.snapshotGenerator.cacheSnapshotObjects(t||[],e,n)},e.prototype.isErrorStatus=function(){return 0!==this.exceptionCode},e.prototype.getSnapshotCache=function(){return this.snapshotGenerator.getSnapshotCache()},e}(),V=function(e){function t(t,n,r){var o=e.call(this,!1,(function(){return o.executeCallback()}),n.toString(),r)||this;return o.isFirstSnapshot=!0,o.callback=t,o}return c(t,e),t.prototype.executeCallback=function(){var e=this.isFirstSnapshot;this.isFirstSnapshot=!1,this.callback(e)},t}(M),F=new T("ListenerManager"),z=function(){function e(e,t){this.listenerCount=0,this.queryId=0,this.subscribeInfoMap=new Map,this.queryHashMap=new Map,this.listenerIdMap=new Map,this.naturalBaseRef=e,this.naturalStoreName=t}return e.prototype.generateSignature=function(e){var t=this,n=e.getQueryConditions();return n.sort((function(e,n){var r=t.compareValue(e.conditionType,n.conditionType);return 0!==r||0!==(r=t.compareValue(e.fieldName,n.fieldName))?r:t.compareValue(e.value,n.value)})),O.hash(e.getClassName()+JSON.stringify(n))},e.prototype.hasListener=function(e){return O.isNullOrUndefined(e)?0!==this.listenerIdMap.size:this.listenerIdMap.has(e)},e.prototype.addListener=function(e,t,n,r){return l(this,void 0,void 0,(function(){var o,s,i,a;return d(this,(function(u){switch(u.label){case 0:return this.listenerCount>=16?(F.warn("AddListener: failed to add listener.\n             Too many snapshot. max size: 16."),[2,13]):(o=this.generateSignature(e),s=0,F.info("addListener: listenerId:"+r),this.queryHashMap.has(o)?(s=this.queryHashMap.get(o),null==(i=this.subscribeInfoMap.get(s))||i.addListener(r,n),(null==i?void 0:i.isErrorStatus())?[4,i.subscribe(t)]:[3,2]):[3,3]);case 1:u.sent(),u.label=2;case 2:return[3,5];case 3:return this.queryId=this.queryId+1,s=this.queryId,i=new B(s,o,this.naturalStoreName,e,this.naturalBaseRef),a=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(e.getClassName()).getPrimaryKeys(),i.initialize(a),i.addListener(r,n),this.subscribeInfoMap.set(s,i),this.queryHashMap.set(o,s),[4,i.subscribe(t)];case 4:u.sent(),u.label=5;case 5:return this.listenerIdMap.set(r,s),this.listenerCount=this.listenerCount+1,[2,0]}}))}))},e.prototype.removeListener=function(e){return l(this,void 0,void 0,(function(){var t,n;return d(this,(function(r){switch(r.label){case 0:return void 0===(t=this.listenerIdMap.get(e))?[2,Promise.resolve(0)]:(this.listenerIdMap.delete(e),(n=this.subscribeInfoMap.get(t))&&(this.listenerCount=this.listenerCount-1),(null==n?void 0:n.removeListener(e))?[4,null==n?void 0:n.unsubscribe()]:[3,2]);case 1:r.sent(),this.cleanSubscription(t),r.label=2;case 2:return[2,Promise.resolve(0)]}}))}))},e.prototype.cleanSubscribeInfo=function(e){var t=this;h(this.subscribeInfoMap.values()).filter((function(t){return t.cloudSubRecordId===e})).map((function(e){return e.queryId})).forEach((function(e){t.cleanSubscription(e)}))},e.prototype.cleanSubscription=function(e){var t,n;F.info("cleanSubscription queryId:"+e),this.subscribeInfoMap.delete(e);try{for(var r=p(this.queryHashMap.keys()),o=r.next();!o.done;o=r.next()){var s=o.value;if(this.queryHashMap.get(s)===e)return void this.queryHashMap.delete(s)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}},e.prototype.getAllSubscribeInfo=function(){var e,t,n=new Map;try{for(var r=p(this.subscribeInfoMap.values()),o=r.next();!o.done;o=r.next()){var s=o.value;n.set(s.cloudSubRecordId,s)}}catch(t){e={error:t}}finally{try{o&&!o.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}return n},e.prototype.getSubscribeInfoByRecordId=function(e){var t=h(this.subscribeInfoMap.values()).filter((function(t){return t.cloudSubRecordId===e}));return 0===t.length?void 0:t[0]},e.prototype.isSubscribeNotResponsed=function(e){var t=this.subscribeInfoMap.get(e);return!(!t||""!==t.cloudSubRecordId)},e.prototype.getSubscribeInfo=function(e){return this.subscribeInfoMap.get(e)},e.prototype.compareValue=function(e,t){return e>t?1:e<t?-1:0},e}();let G=r;G.util.Long=o,G.configure();const Y=G.Reader,Q=G.Writer,H=G.util,W=G.roots.default||(G.roots.default={}),X=W.naturalcloudsyncv2=(()=>{const e={};return e.Schema=function(){function e(e){if(this.fs=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.n="",e.prototype.fs=H.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Q.create()),null!=e.n&&Object.hasOwnProperty.call(e,"n")&&t.uint32(10).string(e.n),null!=e.fs&&e.fs.length)for(let n=0;n<e.fs.length;++n)W.naturalcloudsyncv2.SchemaField.encode(e.fs[n],t.uint32(18).fork()).ldelim();return t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.Schema;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.n=e.string();break;case 2:r.fs&&r.fs.length||(r.fs=[]),r.fs.push(W.naturalcloudsyncv2.SchemaField.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.n&&e.hasOwnProperty("n")&&!H.isString(e.n))return"n: string expected";if(null!=e.fs&&e.hasOwnProperty("fs")){if(!Array.isArray(e.fs))return"fs: array expected";for(let t=0;t<e.fs.length;++t){let n=W.naturalcloudsyncv2.SchemaField.verify(e.fs[t]);if(n)return"fs."+n}}return null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.Schema)return e;let t=new W.naturalcloudsyncv2.Schema;if(null!=e.n&&(t.n=String(e.n)),e.fs){if(!Array.isArray(e.fs))throw TypeError(".naturalcloudsyncv2.Schema.fs: array expected");t.fs=[];for(let n=0;n<e.fs.length;++n){if("object"!=typeof e.fs[n])throw TypeError(".naturalcloudsyncv2.Schema.fs: object expected");t.fs[n]=W.naturalcloudsyncv2.SchemaField.fromObject(e.fs[n])}}return t},e.toObject=function(e,t){t||(t={});let n={};if((t.arrays||t.defaults)&&(n.fs=[]),t.defaults&&(n.n=""),null!=e.n&&e.hasOwnProperty("n")&&(n.n=e.n),e.fs&&e.fs.length){n.fs=[];for(let r=0;r<e.fs.length;++r)n.fs[r]=W.naturalcloudsyncv2.SchemaField.toObject(e.fs[r],t)}return n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.SchemaField=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.n="",e.prototype.t=0,e.prototype.p=!1,e.prototype.e=!1,e.prototype.nn=!1,e.prototype.df=!1,e.prototype.bl=!1,e.prototype.b=0,e.prototype.st=0,e.prototype.i=0,e.prototype.l=H.Long?H.Long.fromBits(0,0,!1):0,e.prototype.f=0,e.prototype.d=0,e.prototype.ba=H.newBuffer([]),e.prototype.s="",Object.defineProperty(e.prototype,"defaultValue",{get:H.oneOfGetter(t=["bl","b","st","i","l","f","d","ba","s"]),set:H.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.n&&Object.hasOwnProperty.call(e,"n")&&t.uint32(10).string(e.n),null!=e.t&&Object.hasOwnProperty.call(e,"t")&&t.uint32(16).int32(e.t),null!=e.p&&Object.hasOwnProperty.call(e,"p")&&t.uint32(24).bool(e.p),null!=e.e&&Object.hasOwnProperty.call(e,"e")&&t.uint32(32).bool(e.e),null!=e.nn&&Object.hasOwnProperty.call(e,"nn")&&t.uint32(40).bool(e.nn),null!=e.df&&Object.hasOwnProperty.call(e,"df")&&t.uint32(48).bool(e.df),null!=e.bl&&Object.hasOwnProperty.call(e,"bl")&&t.uint32(56).bool(e.bl),null!=e.b&&Object.hasOwnProperty.call(e,"b")&&t.uint32(64).int32(e.b),null!=e.st&&Object.hasOwnProperty.call(e,"st")&&t.uint32(72).int32(e.st),null!=e.i&&Object.hasOwnProperty.call(e,"i")&&t.uint32(80).int32(e.i),null!=e.l&&Object.hasOwnProperty.call(e,"l")&&t.uint32(88).int64(e.l),null!=e.f&&Object.hasOwnProperty.call(e,"f")&&t.uint32(101).float(e.f),null!=e.d&&Object.hasOwnProperty.call(e,"d")&&t.uint32(105).double(e.d),null!=e.ba&&Object.hasOwnProperty.call(e,"ba")&&t.uint32(114).bytes(e.ba),null!=e.s&&Object.hasOwnProperty.call(e,"s")&&t.uint32(122).string(e.s),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.SchemaField;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.n=e.string();break;case 2:r.t=e.int32();break;case 3:r.p=e.bool();break;case 4:r.e=e.bool();break;case 5:r.nn=e.bool();break;case 6:r.df=e.bool();break;case 7:r.bl=e.bool();break;case 8:r.b=e.int32();break;case 9:r.st=e.int32();break;case 10:r.i=e.int32();break;case 11:r.l=e.int64();break;case 12:r.f=e.float();break;case 13:r.d=e.double();break;case 14:r.ba=e.bytes();break;case 15:r.s=e.string();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";let t={};if(null!=e.n&&e.hasOwnProperty("n")&&!H.isString(e.n))return"n: string expected";if(null!=e.t&&e.hasOwnProperty("t"))switch(e.t){default:return"t: enum value expected";case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:}if(null!=e.p&&e.hasOwnProperty("p")&&"boolean"!=typeof e.p)return"p: boolean expected";if(null!=e.e&&e.hasOwnProperty("e")&&"boolean"!=typeof e.e)return"e: boolean expected";if(null!=e.nn&&e.hasOwnProperty("nn")&&"boolean"!=typeof e.nn)return"nn: boolean expected";if(null!=e.df&&e.hasOwnProperty("df")&&"boolean"!=typeof e.df)return"df: boolean expected";if(null!=e.bl&&e.hasOwnProperty("bl")&&(t.defaultValue=1,"boolean"!=typeof e.bl))return"bl: boolean expected";if(null!=e.b&&e.hasOwnProperty("b")){if(1===t.defaultValue)return"defaultValue: multiple values";if(t.defaultValue=1,!H.isInteger(e.b))return"b: integer expected"}if(null!=e.st&&e.hasOwnProperty("st")){if(1===t.defaultValue)return"defaultValue: multiple values";if(t.defaultValue=1,!H.isInteger(e.st))return"st: integer expected"}if(null!=e.i&&e.hasOwnProperty("i")){if(1===t.defaultValue)return"defaultValue: multiple values";if(t.defaultValue=1,!H.isInteger(e.i))return"i: integer expected"}if(null!=e.l&&e.hasOwnProperty("l")){if(1===t.defaultValue)return"defaultValue: multiple values";if(t.defaultValue=1,!(H.isInteger(e.l)||e.l&&H.isInteger(e.l.low)&&H.isInteger(e.l.high)))return"l: integer|Long expected"}if(null!=e.f&&e.hasOwnProperty("f")){if(1===t.defaultValue)return"defaultValue: multiple values";if(t.defaultValue=1,"number"!=typeof e.f)return"f: number expected"}if(null!=e.d&&e.hasOwnProperty("d")){if(1===t.defaultValue)return"defaultValue: multiple values";if(t.defaultValue=1,"number"!=typeof e.d)return"d: number expected"}if(null!=e.ba&&e.hasOwnProperty("ba")){if(1===t.defaultValue)return"defaultValue: multiple values";if(t.defaultValue=1,!(e.ba&&"number"==typeof e.ba.length||H.isString(e.ba)))return"ba: buffer expected"}if(null!=e.s&&e.hasOwnProperty("s")){if(1===t.defaultValue)return"defaultValue: multiple values";if(t.defaultValue=1,!H.isString(e.s))return"s: string expected"}return null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.SchemaField)return e;let t=new W.naturalcloudsyncv2.SchemaField;switch(null!=e.n&&(t.n=String(e.n)),e.t){case"TYPE_DEFAULT":case 0:t.t=0;break;case"TYPE_BOOLEAN":case 1:t.t=1;break;case"TYPE_BYTE":case 2:t.t=2;break;case"TYPE_SHORT":case 3:t.t=3;break;case"TYPE_INT32":case 4:t.t=4;break;case"TYPE_LONG":case 5:t.t=5;break;case"TYPE_FLOAT":case 6:t.t=6;break;case"TYPE_DOUBLE":case 7:t.t=7;break;case"TYPE_BYTE_ARRAY":case 8:t.t=8;break;case"TYPE_STRING":case 9:t.t=9;break;case"TYPE_DATE":case 10:t.t=10;break;case"TYPE_TEXT":case 11:t.t=11;break;case"TYPE_AUTO_INCREMENT_INT":case 12:t.t=12;break;case"TYPE_AUTO_INCREMENT_LONG":case 13:t.t=13}return null!=e.p&&(t.p=Boolean(e.p)),null!=e.e&&(t.e=Boolean(e.e)),null!=e.nn&&(t.nn=Boolean(e.nn)),null!=e.df&&(t.df=Boolean(e.df)),null!=e.bl&&(t.bl=Boolean(e.bl)),null!=e.b&&(t.b=0|e.b),null!=e.st&&(t.st=0|e.st),null!=e.i&&(t.i=0|e.i),null!=e.l&&(H.Long?(t.l=H.Long.fromValue(e.l)).unsigned=!1:"string"==typeof e.l?t.l=parseInt(e.l,10):"number"==typeof e.l?t.l=e.l:"object"==typeof e.l&&(t.l=new H.LongBits(e.l.low>>>0,e.l.high>>>0).toNumber())),null!=e.f&&(t.f=Number(e.f)),null!=e.d&&(t.d=Number(e.d)),null!=e.ba&&("string"==typeof e.ba?H.base64.decode(e.ba,t.ba=H.newBuffer(H.base64.length(e.ba)),0):e.ba.length&&(t.ba=e.ba)),null!=e.s&&(t.s=String(e.s)),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.n="",n.t=t.enums===String?"TYPE_DEFAULT":0,n.p=!1,n.e=!1,n.nn=!1,n.df=!1),null!=e.n&&e.hasOwnProperty("n")&&(n.n=e.n),null!=e.t&&e.hasOwnProperty("t")&&(n.t=t.enums===String?W.naturalcloudsyncv2.FieldType[e.t]:e.t),null!=e.p&&e.hasOwnProperty("p")&&(n.p=e.p),null!=e.e&&e.hasOwnProperty("e")&&(n.e=e.e),null!=e.nn&&e.hasOwnProperty("nn")&&(n.nn=e.nn),null!=e.df&&e.hasOwnProperty("df")&&(n.df=e.df),null!=e.bl&&e.hasOwnProperty("bl")&&(n.bl=e.bl,t.oneofs&&(n.defaultValue="bl")),null!=e.b&&e.hasOwnProperty("b")&&(n.b=e.b,t.oneofs&&(n.defaultValue="b")),null!=e.st&&e.hasOwnProperty("st")&&(n.st=e.st,t.oneofs&&(n.defaultValue="st")),null!=e.i&&e.hasOwnProperty("i")&&(n.i=e.i,t.oneofs&&(n.defaultValue="i")),null!=e.l&&e.hasOwnProperty("l")&&("number"==typeof e.l?n.l=t.longs===String?String(e.l):e.l:n.l=t.longs===String?H.Long.prototype.toString.call(e.l):t.longs===Number?new H.LongBits(e.l.low>>>0,e.l.high>>>0).toNumber():e.l,t.oneofs&&(n.defaultValue="l")),null!=e.f&&e.hasOwnProperty("f")&&(n.f=t.json&&!isFinite(e.f)?String(e.f):e.f,t.oneofs&&(n.defaultValue="f")),null!=e.d&&e.hasOwnProperty("d")&&(n.d=t.json&&!isFinite(e.d)?String(e.d):e.d,t.oneofs&&(n.defaultValue="d")),null!=e.ba&&e.hasOwnProperty("ba")&&(n.ba=t.bytes===String?H.base64.encode(e.ba,0,e.ba.length):t.bytes===Array?Array.prototype.slice.call(e.ba):e.ba,t.oneofs&&(n.defaultValue="ba")),null!=e.s&&e.hasOwnProperty("s")&&(n.s=e.s,t.oneofs&&(n.defaultValue="s")),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.FieldType=function(){const e={},t=Object.create(e);return t[e[0]="TYPE_DEFAULT"]=0,t[e[1]="TYPE_BOOLEAN"]=1,t[e[2]="TYPE_BYTE"]=2,t[e[3]="TYPE_SHORT"]=3,t[e[4]="TYPE_INT32"]=4,t[e[5]="TYPE_LONG"]=5,t[e[6]="TYPE_FLOAT"]=6,t[e[7]="TYPE_DOUBLE"]=7,t[e[8]="TYPE_BYTE_ARRAY"]=8,t[e[9]="TYPE_STRING"]=9,t[e[10]="TYPE_DATE"]=10,t[e[11]="TYPE_TEXT"]=11,t[e[12]="TYPE_AUTO_INCREMENT_INT"]=12,t[e[13]="TYPE_AUTO_INCREMENT_LONG"]=13,t}(),e.OperationData=function(){function e(e){if(this.os=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.os=H.emptyArray,e.prototype.t=0,e.prototype.i=0,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Q.create()),null!=e.os&&e.os.length)for(let n=0;n<e.os.length;++n)W.naturalcloudsyncv2.Obj.encode(e.os[n],t.uint32(10).fork()).ldelim();return null!=e.t&&Object.hasOwnProperty.call(e,"t")&&t.uint32(16).int32(e.t),null!=e.i&&Object.hasOwnProperty.call(e,"i")&&t.uint32(24).int32(e.i),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.OperationData;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.os&&r.os.length||(r.os=[]),r.os.push(W.naturalcloudsyncv2.Obj.decode(e,e.uint32()));break;case 2:r.t=e.int32();break;case 3:r.i=e.int32();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.os&&e.hasOwnProperty("os")){if(!Array.isArray(e.os))return"os: array expected";for(let t=0;t<e.os.length;++t){let n=W.naturalcloudsyncv2.Obj.verify(e.os[t]);if(n)return"os."+n}}return null!=e.t&&e.hasOwnProperty("t")&&!H.isInteger(e.t)?"t: integer expected":null!=e.i&&e.hasOwnProperty("i")&&!H.isInteger(e.i)?"i: integer expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.OperationData)return e;let t=new W.naturalcloudsyncv2.OperationData;if(e.os){if(!Array.isArray(e.os))throw TypeError(".naturalcloudsyncv2.OperationData.os: array expected");t.os=[];for(let n=0;n<e.os.length;++n){if("object"!=typeof e.os[n])throw TypeError(".naturalcloudsyncv2.OperationData.os: object expected");t.os[n]=W.naturalcloudsyncv2.Obj.fromObject(e.os[n])}}return null!=e.t&&(t.t=0|e.t),null!=e.i&&(t.i=0|e.i),t},e.toObject=function(e,t){t||(t={});let n={};if((t.arrays||t.defaults)&&(n.os=[]),t.defaults&&(n.t=0,n.i=0),e.os&&e.os.length){n.os=[];for(let r=0;r<e.os.length;++r)n.os[r]=W.naturalcloudsyncv2.Obj.toObject(e.os[r],t)}return null!=e.t&&e.hasOwnProperty("t")&&(n.t=e.t),null!=e.i&&e.hasOwnProperty("i")&&(n.i=e.i),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.Obj=function(){function e(e){if(this.fs=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.fs=H.emptyArray,e.prototype.i=0,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Q.create()),null!=e.fs&&e.fs.length)for(let n=0;n<e.fs.length;++n)W.naturalcloudsyncv2.Field.encode(e.fs[n],t.uint32(10).fork()).ldelim();return null!=e.i&&Object.hasOwnProperty.call(e,"i")&&t.uint32(16).int32(e.i),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.Obj;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.fs&&r.fs.length||(r.fs=[]),r.fs.push(W.naturalcloudsyncv2.Field.decode(e,e.uint32()));break;case 2:r.i=e.int32();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.fs&&e.hasOwnProperty("fs")){if(!Array.isArray(e.fs))return"fs: array expected";for(let t=0;t<e.fs.length;++t){let n=W.naturalcloudsyncv2.Field.verify(e.fs[t]);if(n)return"fs."+n}}return null!=e.i&&e.hasOwnProperty("i")&&!H.isInteger(e.i)?"i: integer expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.Obj)return e;let t=new W.naturalcloudsyncv2.Obj;if(e.fs){if(!Array.isArray(e.fs))throw TypeError(".naturalcloudsyncv2.Obj.fs: array expected");t.fs=[];for(let n=0;n<e.fs.length;++n){if("object"!=typeof e.fs[n])throw TypeError(".naturalcloudsyncv2.Obj.fs: object expected");t.fs[n]=W.naturalcloudsyncv2.Field.fromObject(e.fs[n])}}return null!=e.i&&(t.i=0|e.i),t},e.toObject=function(e,t){t||(t={});let n={};if((t.arrays||t.defaults)&&(n.fs=[]),t.defaults&&(n.i=0),e.fs&&e.fs.length){n.fs=[];for(let r=0;r<e.fs.length;++r)n.fs[r]=W.naturalcloudsyncv2.Field.toObject(e.fs[r],t)}return null!=e.i&&e.hasOwnProperty("i")&&(n.i=e.i),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.Field=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.n=!1,e.prototype.bl=!1,e.prototype.b=0,e.prototype.st=0,e.prototype.i=0,e.prototype.l=H.Long?H.Long.fromBits(0,0,!1):0,e.prototype.f=0,e.prototype.d=0,e.prototype.ba=H.newBuffer([]),e.prototype.s="",Object.defineProperty(e.prototype,"value",{get:H.oneOfGetter(t=["bl","b","st","i","l","f","d","ba","s"]),set:H.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.n&&Object.hasOwnProperty.call(e,"n")&&t.uint32(8).bool(e.n),null!=e.bl&&Object.hasOwnProperty.call(e,"bl")&&t.uint32(16).bool(e.bl),null!=e.b&&Object.hasOwnProperty.call(e,"b")&&t.uint32(24).int32(e.b),null!=e.st&&Object.hasOwnProperty.call(e,"st")&&t.uint32(32).int32(e.st),null!=e.i&&Object.hasOwnProperty.call(e,"i")&&t.uint32(40).int32(e.i),null!=e.l&&Object.hasOwnProperty.call(e,"l")&&t.uint32(48).int64(e.l),null!=e.f&&Object.hasOwnProperty.call(e,"f")&&t.uint32(61).float(e.f),null!=e.d&&Object.hasOwnProperty.call(e,"d")&&t.uint32(65).double(e.d),null!=e.ba&&Object.hasOwnProperty.call(e,"ba")&&t.uint32(74).bytes(e.ba),null!=e.s&&Object.hasOwnProperty.call(e,"s")&&t.uint32(82).string(e.s),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.Field;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.n=e.bool();break;case 2:r.bl=e.bool();break;case 3:r.b=e.int32();break;case 4:r.st=e.int32();break;case 5:r.i=e.int32();break;case 6:r.l=e.int64();break;case 7:r.f=e.float();break;case 8:r.d=e.double();break;case 9:r.ba=e.bytes();break;case 10:r.s=e.string();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";let t={};if(null!=e.n&&e.hasOwnProperty("n")&&"boolean"!=typeof e.n)return"n: boolean expected";if(null!=e.bl&&e.hasOwnProperty("bl")&&(t.value=1,"boolean"!=typeof e.bl))return"bl: boolean expected";if(null!=e.b&&e.hasOwnProperty("b")){if(1===t.value)return"value: multiple values";if(t.value=1,!H.isInteger(e.b))return"b: integer expected"}if(null!=e.st&&e.hasOwnProperty("st")){if(1===t.value)return"value: multiple values";if(t.value=1,!H.isInteger(e.st))return"st: integer expected"}if(null!=e.i&&e.hasOwnProperty("i")){if(1===t.value)return"value: multiple values";if(t.value=1,!H.isInteger(e.i))return"i: integer expected"}if(null!=e.l&&e.hasOwnProperty("l")){if(1===t.value)return"value: multiple values";if(t.value=1,!(H.isInteger(e.l)||e.l&&H.isInteger(e.l.low)&&H.isInteger(e.l.high)))return"l: integer|Long expected"}if(null!=e.f&&e.hasOwnProperty("f")){if(1===t.value)return"value: multiple values";if(t.value=1,"number"!=typeof e.f)return"f: number expected"}if(null!=e.d&&e.hasOwnProperty("d")){if(1===t.value)return"value: multiple values";if(t.value=1,"number"!=typeof e.d)return"d: number expected"}if(null!=e.ba&&e.hasOwnProperty("ba")){if(1===t.value)return"value: multiple values";if(t.value=1,!(e.ba&&"number"==typeof e.ba.length||H.isString(e.ba)))return"ba: buffer expected"}if(null!=e.s&&e.hasOwnProperty("s")){if(1===t.value)return"value: multiple values";if(t.value=1,!H.isString(e.s))return"s: string expected"}return null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.Field)return e;let t=new W.naturalcloudsyncv2.Field;return null!=e.n&&(t.n=Boolean(e.n)),null!=e.bl&&(t.bl=Boolean(e.bl)),null!=e.b&&(t.b=0|e.b),null!=e.st&&(t.st=0|e.st),null!=e.i&&(t.i=0|e.i),null!=e.l&&(H.Long?(t.l=H.Long.fromValue(e.l)).unsigned=!1:"string"==typeof e.l?t.l=parseInt(e.l,10):"number"==typeof e.l?t.l=e.l:"object"==typeof e.l&&(t.l=new H.LongBits(e.l.low>>>0,e.l.high>>>0).toNumber())),null!=e.f&&(t.f=Number(e.f)),null!=e.d&&(t.d=Number(e.d)),null!=e.ba&&("string"==typeof e.ba?H.base64.decode(e.ba,t.ba=H.newBuffer(H.base64.length(e.ba)),0):e.ba.length&&(t.ba=e.ba)),null!=e.s&&(t.s=String(e.s)),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.n=!1),null!=e.n&&e.hasOwnProperty("n")&&(n.n=e.n),null!=e.bl&&e.hasOwnProperty("bl")&&(n.bl=e.bl,t.oneofs&&(n.value="bl")),null!=e.b&&e.hasOwnProperty("b")&&(n.b=e.b,t.oneofs&&(n.value="b")),null!=e.st&&e.hasOwnProperty("st")&&(n.st=e.st,t.oneofs&&(n.value="st")),null!=e.i&&e.hasOwnProperty("i")&&(n.i=e.i,t.oneofs&&(n.value="i")),null!=e.l&&e.hasOwnProperty("l")&&("number"==typeof e.l?n.l=t.longs===String?String(e.l):e.l:n.l=t.longs===String?H.Long.prototype.toString.call(e.l):t.longs===Number?new H.LongBits(e.l.low>>>0,e.l.high>>>0).toNumber():e.l,t.oneofs&&(n.value="l")),null!=e.f&&e.hasOwnProperty("f")&&(n.f=t.json&&!isFinite(e.f)?String(e.f):e.f,t.oneofs&&(n.value="f")),null!=e.d&&e.hasOwnProperty("d")&&(n.d=t.json&&!isFinite(e.d)?String(e.d):e.d,t.oneofs&&(n.value="d")),null!=e.ba&&e.hasOwnProperty("ba")&&(n.ba=t.bytes===String?H.base64.encode(e.ba,0,e.ba.length):t.bytes===Array?Array.prototype.slice.call(e.ba):e.ba,t.oneofs&&(n.value="ba")),null!=e.s&&e.hasOwnProperty("s")&&(n.s=e.s,t.oneofs&&(n.value="s")),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.MessageInfo=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.id=H.Long?H.Long.fromBits(0,0,!1):0,e.prototype.type=0,e.prototype.subType=0,e.prototype.opStore=null,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.id&&Object.hasOwnProperty.call(e,"id")&&t.uint32(8).int64(e.id),null!=e.type&&Object.hasOwnProperty.call(e,"type")&&t.uint32(16).int32(e.type),null!=e.subType&&Object.hasOwnProperty.call(e,"subType")&&t.uint32(24).int32(e.subType),null!=e.opStore&&Object.hasOwnProperty.call(e,"opStore")&&W.naturalcloudsyncv2.Store.encode(e.opStore,t.uint32(34).fork()).ldelim(),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.MessageInfo;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.id=e.int64();break;case 2:r.type=e.int32();break;case 3:r.subType=e.int32();break;case 4:r.opStore=W.naturalcloudsyncv2.Store.decode(e,e.uint32());break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.id&&e.hasOwnProperty("id")&&!(H.isInteger(e.id)||e.id&&H.isInteger(e.id.low)&&H.isInteger(e.id.high)))return"id: integer|Long expected";if(null!=e.type&&e.hasOwnProperty("type")&&!H.isInteger(e.type))return"type: integer expected";if(null!=e.subType&&e.hasOwnProperty("subType")&&!H.isInteger(e.subType))return"subType: integer expected";if(null!=e.opStore&&e.hasOwnProperty("opStore")){let t=W.naturalcloudsyncv2.Store.verify(e.opStore);if(t)return"opStore."+t}return null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.MessageInfo)return e;let t=new W.naturalcloudsyncv2.MessageInfo;if(null!=e.id&&(H.Long?(t.id=H.Long.fromValue(e.id)).unsigned=!1:"string"==typeof e.id?t.id=parseInt(e.id,10):"number"==typeof e.id?t.id=e.id:"object"==typeof e.id&&(t.id=new H.LongBits(e.id.low>>>0,e.id.high>>>0).toNumber())),null!=e.type&&(t.type=0|e.type),null!=e.subType&&(t.subType=0|e.subType),null!=e.opStore){if("object"!=typeof e.opStore)throw TypeError(".naturalcloudsyncv2.MessageInfo.opStore: object expected");t.opStore=W.naturalcloudsyncv2.Store.fromObject(e.opStore)}return t},e.toObject=function(e,t){t||(t={});let n={};if(t.defaults){if(H.Long){let e=new H.Long(0,0,!1);n.id=t.longs===String?e.toString():t.longs===Number?e.toNumber():e}else n.id=t.longs===String?"0":0;n.type=0,n.subType=0,n.opStore=null}return null!=e.id&&e.hasOwnProperty("id")&&("number"==typeof e.id?n.id=t.longs===String?String(e.id):e.id:n.id=t.longs===String?H.Long.prototype.toString.call(e.id):t.longs===Number?new H.LongBits(e.id.low>>>0,e.id.high>>>0).toNumber():e.id),null!=e.type&&e.hasOwnProperty("type")&&(n.type=e.type),null!=e.subType&&e.hasOwnProperty("subType")&&(n.subType=e.subType),null!=e.opStore&&e.hasOwnProperty("opStore")&&(n.opStore=W.naturalcloudsyncv2.Store.toObject(e.opStore,t)),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.Store=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.storeName="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.storeName&&Object.hasOwnProperty.call(e,"storeName")&&t.uint32(10).string(e.storeName),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.Store;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.storeName=e.string();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.storeName&&e.hasOwnProperty("storeName")&&!H.isString(e.storeName)?"storeName: string expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.Store)return e;let t=new W.naturalcloudsyncv2.Store;return null!=e.storeName&&(t.storeName=String(e.storeName)),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.storeName=""),null!=e.storeName&&e.hasOwnProperty("storeName")&&(n.storeName=e.storeName),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.EncryptionInfo=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.keyStatus=0,e.prototype.firstSalt=H.newBuffer([]),e.prototype.secondSalt=H.newBuffer([]),e.prototype.rootToken=H.newBuffer([]),e.prototype.cipherText=H.newBuffer([]),e.prototype.oldCipherText=H.newBuffer([]),e.prototype.keyVer=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.keyStatus&&Object.hasOwnProperty.call(e,"keyStatus")&&t.uint32(8).int32(e.keyStatus),null!=e.firstSalt&&Object.hasOwnProperty.call(e,"firstSalt")&&t.uint32(18).bytes(e.firstSalt),null!=e.secondSalt&&Object.hasOwnProperty.call(e,"secondSalt")&&t.uint32(26).bytes(e.secondSalt),null!=e.rootToken&&Object.hasOwnProperty.call(e,"rootToken")&&t.uint32(34).bytes(e.rootToken),null!=e.cipherText&&Object.hasOwnProperty.call(e,"cipherText")&&t.uint32(42).bytes(e.cipherText),null!=e.oldCipherText&&Object.hasOwnProperty.call(e,"oldCipherText")&&t.uint32(50).bytes(e.oldCipherText),null!=e.keyVer&&Object.hasOwnProperty.call(e,"keyVer")&&t.uint32(56).int32(e.keyVer),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.EncryptionInfo;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.keyStatus=e.int32();break;case 2:r.firstSalt=e.bytes();break;case 3:r.secondSalt=e.bytes();break;case 4:r.rootToken=e.bytes();break;case 5:r.cipherText=e.bytes();break;case 6:r.oldCipherText=e.bytes();break;case 7:r.keyVer=e.int32();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.keyStatus&&e.hasOwnProperty("keyStatus")&&!H.isInteger(e.keyStatus)?"keyStatus: integer expected":null!=e.firstSalt&&e.hasOwnProperty("firstSalt")&&!(e.firstSalt&&"number"==typeof e.firstSalt.length||H.isString(e.firstSalt))?"firstSalt: buffer expected":null!=e.secondSalt&&e.hasOwnProperty("secondSalt")&&!(e.secondSalt&&"number"==typeof e.secondSalt.length||H.isString(e.secondSalt))?"secondSalt: buffer expected":null!=e.rootToken&&e.hasOwnProperty("rootToken")&&!(e.rootToken&&"number"==typeof e.rootToken.length||H.isString(e.rootToken))?"rootToken: buffer expected":null!=e.cipherText&&e.hasOwnProperty("cipherText")&&!(e.cipherText&&"number"==typeof e.cipherText.length||H.isString(e.cipherText))?"cipherText: buffer expected":null!=e.oldCipherText&&e.hasOwnProperty("oldCipherText")&&!(e.oldCipherText&&"number"==typeof e.oldCipherText.length||H.isString(e.oldCipherText))?"oldCipherText: buffer expected":null!=e.keyVer&&e.hasOwnProperty("keyVer")&&!H.isInteger(e.keyVer)?"keyVer: integer expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.EncryptionInfo)return e;let t=new W.naturalcloudsyncv2.EncryptionInfo;return null!=e.keyStatus&&(t.keyStatus=0|e.keyStatus),null!=e.firstSalt&&("string"==typeof e.firstSalt?H.base64.decode(e.firstSalt,t.firstSalt=H.newBuffer(H.base64.length(e.firstSalt)),0):e.firstSalt.length&&(t.firstSalt=e.firstSalt)),null!=e.secondSalt&&("string"==typeof e.secondSalt?H.base64.decode(e.secondSalt,t.secondSalt=H.newBuffer(H.base64.length(e.secondSalt)),0):e.secondSalt.length&&(t.secondSalt=e.secondSalt)),null!=e.rootToken&&("string"==typeof e.rootToken?H.base64.decode(e.rootToken,t.rootToken=H.newBuffer(H.base64.length(e.rootToken)),0):e.rootToken.length&&(t.rootToken=e.rootToken)),null!=e.cipherText&&("string"==typeof e.cipherText?H.base64.decode(e.cipherText,t.cipherText=H.newBuffer(H.base64.length(e.cipherText)),0):e.cipherText.length&&(t.cipherText=e.cipherText)),null!=e.oldCipherText&&("string"==typeof e.oldCipherText?H.base64.decode(e.oldCipherText,t.oldCipherText=H.newBuffer(H.base64.length(e.oldCipherText)),0):e.oldCipherText.length&&(t.oldCipherText=e.oldCipherText)),null!=e.keyVer&&(t.keyVer=0|e.keyVer),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.keyStatus=0,t.bytes===String?n.firstSalt="":(n.firstSalt=[],t.bytes!==Array&&(n.firstSalt=H.newBuffer(n.firstSalt))),t.bytes===String?n.secondSalt="":(n.secondSalt=[],t.bytes!==Array&&(n.secondSalt=H.newBuffer(n.secondSalt))),t.bytes===String?n.rootToken="":(n.rootToken=[],t.bytes!==Array&&(n.rootToken=H.newBuffer(n.rootToken))),t.bytes===String?n.cipherText="":(n.cipherText=[],t.bytes!==Array&&(n.cipherText=H.newBuffer(n.cipherText))),t.bytes===String?n.oldCipherText="":(n.oldCipherText=[],t.bytes!==Array&&(n.oldCipherText=H.newBuffer(n.oldCipherText))),n.keyVer=0),null!=e.keyStatus&&e.hasOwnProperty("keyStatus")&&(n.keyStatus=e.keyStatus),null!=e.firstSalt&&e.hasOwnProperty("firstSalt")&&(n.firstSalt=t.bytes===String?H.base64.encode(e.firstSalt,0,e.firstSalt.length):t.bytes===Array?Array.prototype.slice.call(e.firstSalt):e.firstSalt),null!=e.secondSalt&&e.hasOwnProperty("secondSalt")&&(n.secondSalt=t.bytes===String?H.base64.encode(e.secondSalt,0,e.secondSalt.length):t.bytes===Array?Array.prototype.slice.call(e.secondSalt):e.secondSalt),null!=e.rootToken&&e.hasOwnProperty("rootToken")&&(n.rootToken=t.bytes===String?H.base64.encode(e.rootToken,0,e.rootToken.length):t.bytes===Array?Array.prototype.slice.call(e.rootToken):e.rootToken),null!=e.cipherText&&e.hasOwnProperty("cipherText")&&(n.cipherText=t.bytes===String?H.base64.encode(e.cipherText,0,e.cipherText.length):t.bytes===Array?Array.prototype.slice.call(e.cipherText):e.cipherText),null!=e.oldCipherText&&e.hasOwnProperty("oldCipherText")&&(n.oldCipherText=t.bytes===String?H.base64.encode(e.oldCipherText,0,e.oldCipherText.length):t.bytes===Array?Array.prototype.slice.call(e.oldCipherText):e.oldCipherText),null!=e.keyVer&&e.hasOwnProperty("keyVer")&&(n.keyVer=e.keyVer),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.SyncRequestMessage=function(){function e(e){if(this.schemas=[],this.opData=[],this.subReqMsg=[],this.unSubReqMsg=[],this.enReqInfo=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.msgInfo=null,e.prototype.clientInfo=null,e.prototype.schemas=H.emptyArray,e.prototype.opData=H.emptyArray,e.prototype.queryReqMsg=null,e.prototype.subReqMsg=H.emptyArray,e.prototype.unSubReqMsg=H.emptyArray,e.prototype.enReqInfo=H.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Q.create()),null!=e.msgInfo&&Object.hasOwnProperty.call(e,"msgInfo")&&W.naturalcloudsyncv2.MessageInfo.encode(e.msgInfo,t.uint32(10).fork()).ldelim(),null!=e.clientInfo&&Object.hasOwnProperty.call(e,"clientInfo")&&W.naturalcloudsyncv2.ClientInfo.encode(e.clientInfo,t.uint32(18).fork()).ldelim(),null!=e.schemas&&e.schemas.length)for(let n=0;n<e.schemas.length;++n)W.naturalcloudsyncv2.Schema.encode(e.schemas[n],t.uint32(26).fork()).ldelim();if(null!=e.opData&&e.opData.length)for(let n=0;n<e.opData.length;++n)W.naturalcloudsyncv2.OperationData.encode(e.opData[n],t.uint32(34).fork()).ldelim();if(null!=e.queryReqMsg&&Object.hasOwnProperty.call(e,"queryReqMsg")&&W.naturalcloudsyncv2.QueryRequestMessage.encode(e.queryReqMsg,t.uint32(42).fork()).ldelim(),null!=e.subReqMsg&&e.subReqMsg.length)for(let n=0;n<e.subReqMsg.length;++n)W.naturalcloudsyncv2.SubscribeRequestMessage.encode(e.subReqMsg[n],t.uint32(50).fork()).ldelim();if(null!=e.unSubReqMsg&&e.unSubReqMsg.length)for(let n=0;n<e.unSubReqMsg.length;++n)W.naturalcloudsyncv2.UnsubscribeRequestMessage.encode(e.unSubReqMsg[n],t.uint32(58).fork()).ldelim();if(null!=e.enReqInfo&&e.enReqInfo.length)for(let n=0;n<e.enReqInfo.length;++n)W.naturalcloudsyncv2.EncryptionInfo.encode(e.enReqInfo[n],t.uint32(66).fork()).ldelim();return t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.SyncRequestMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.msgInfo=W.naturalcloudsyncv2.MessageInfo.decode(e,e.uint32());break;case 2:r.clientInfo=W.naturalcloudsyncv2.ClientInfo.decode(e,e.uint32());break;case 3:r.schemas&&r.schemas.length||(r.schemas=[]),r.schemas.push(W.naturalcloudsyncv2.Schema.decode(e,e.uint32()));break;case 4:r.opData&&r.opData.length||(r.opData=[]),r.opData.push(W.naturalcloudsyncv2.OperationData.decode(e,e.uint32()));break;case 5:r.queryReqMsg=W.naturalcloudsyncv2.QueryRequestMessage.decode(e,e.uint32());break;case 6:r.subReqMsg&&r.subReqMsg.length||(r.subReqMsg=[]),r.subReqMsg.push(W.naturalcloudsyncv2.SubscribeRequestMessage.decode(e,e.uint32()));break;case 7:r.unSubReqMsg&&r.unSubReqMsg.length||(r.unSubReqMsg=[]),r.unSubReqMsg.push(W.naturalcloudsyncv2.UnsubscribeRequestMessage.decode(e,e.uint32()));break;case 8:r.enReqInfo&&r.enReqInfo.length||(r.enReqInfo=[]),r.enReqInfo.push(W.naturalcloudsyncv2.EncryptionInfo.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.msgInfo&&e.hasOwnProperty("msgInfo")){let t=W.naturalcloudsyncv2.MessageInfo.verify(e.msgInfo);if(t)return"msgInfo."+t}if(null!=e.clientInfo&&e.hasOwnProperty("clientInfo")){let t=W.naturalcloudsyncv2.ClientInfo.verify(e.clientInfo);if(t)return"clientInfo."+t}if(null!=e.schemas&&e.hasOwnProperty("schemas")){if(!Array.isArray(e.schemas))return"schemas: array expected";for(let t=0;t<e.schemas.length;++t){let n=W.naturalcloudsyncv2.Schema.verify(e.schemas[t]);if(n)return"schemas."+n}}if(null!=e.opData&&e.hasOwnProperty("opData")){if(!Array.isArray(e.opData))return"opData: array expected";for(let t=0;t<e.opData.length;++t){let n=W.naturalcloudsyncv2.OperationData.verify(e.opData[t]);if(n)return"opData."+n}}if(null!=e.queryReqMsg&&e.hasOwnProperty("queryReqMsg")){let t=W.naturalcloudsyncv2.QueryRequestMessage.verify(e.queryReqMsg);if(t)return"queryReqMsg."+t}if(null!=e.subReqMsg&&e.hasOwnProperty("subReqMsg")){if(!Array.isArray(e.subReqMsg))return"subReqMsg: array expected";for(let t=0;t<e.subReqMsg.length;++t){let n=W.naturalcloudsyncv2.SubscribeRequestMessage.verify(e.subReqMsg[t]);if(n)return"subReqMsg."+n}}if(null!=e.unSubReqMsg&&e.hasOwnProperty("unSubReqMsg")){if(!Array.isArray(e.unSubReqMsg))return"unSubReqMsg: array expected";for(let t=0;t<e.unSubReqMsg.length;++t){let n=W.naturalcloudsyncv2.UnsubscribeRequestMessage.verify(e.unSubReqMsg[t]);if(n)return"unSubReqMsg."+n}}if(null!=e.enReqInfo&&e.hasOwnProperty("enReqInfo")){if(!Array.isArray(e.enReqInfo))return"enReqInfo: array expected";for(let t=0;t<e.enReqInfo.length;++t){let n=W.naturalcloudsyncv2.EncryptionInfo.verify(e.enReqInfo[t]);if(n)return"enReqInfo."+n}}return null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.SyncRequestMessage)return e;let t=new W.naturalcloudsyncv2.SyncRequestMessage;if(null!=e.msgInfo){if("object"!=typeof e.msgInfo)throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.msgInfo: object expected");t.msgInfo=W.naturalcloudsyncv2.MessageInfo.fromObject(e.msgInfo)}if(null!=e.clientInfo){if("object"!=typeof e.clientInfo)throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.clientInfo: object expected");t.clientInfo=W.naturalcloudsyncv2.ClientInfo.fromObject(e.clientInfo)}if(e.schemas){if(!Array.isArray(e.schemas))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.schemas: array expected");t.schemas=[];for(let n=0;n<e.schemas.length;++n){if("object"!=typeof e.schemas[n])throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.schemas: object expected");t.schemas[n]=W.naturalcloudsyncv2.Schema.fromObject(e.schemas[n])}}if(e.opData){if(!Array.isArray(e.opData))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.opData: array expected");t.opData=[];for(let n=0;n<e.opData.length;++n){if("object"!=typeof e.opData[n])throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.opData: object expected");t.opData[n]=W.naturalcloudsyncv2.OperationData.fromObject(e.opData[n])}}if(null!=e.queryReqMsg){if("object"!=typeof e.queryReqMsg)throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.queryReqMsg: object expected");t.queryReqMsg=W.naturalcloudsyncv2.QueryRequestMessage.fromObject(e.queryReqMsg)}if(e.subReqMsg){if(!Array.isArray(e.subReqMsg))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.subReqMsg: array expected");t.subReqMsg=[];for(let n=0;n<e.subReqMsg.length;++n){if("object"!=typeof e.subReqMsg[n])throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.subReqMsg: object expected");t.subReqMsg[n]=W.naturalcloudsyncv2.SubscribeRequestMessage.fromObject(e.subReqMsg[n])}}if(e.unSubReqMsg){if(!Array.isArray(e.unSubReqMsg))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.unSubReqMsg: array expected");t.unSubReqMsg=[];for(let n=0;n<e.unSubReqMsg.length;++n){if("object"!=typeof e.unSubReqMsg[n])throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.unSubReqMsg: object expected");t.unSubReqMsg[n]=W.naturalcloudsyncv2.UnsubscribeRequestMessage.fromObject(e.unSubReqMsg[n])}}if(e.enReqInfo){if(!Array.isArray(e.enReqInfo))throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.enReqInfo: array expected");t.enReqInfo=[];for(let n=0;n<e.enReqInfo.length;++n){if("object"!=typeof e.enReqInfo[n])throw TypeError(".naturalcloudsyncv2.SyncRequestMessage.enReqInfo: object expected");t.enReqInfo[n]=W.naturalcloudsyncv2.EncryptionInfo.fromObject(e.enReqInfo[n])}}return t},e.toObject=function(e,t){t||(t={});let n={};if((t.arrays||t.defaults)&&(n.schemas=[],n.opData=[],n.subReqMsg=[],n.unSubReqMsg=[],n.enReqInfo=[]),t.defaults&&(n.msgInfo=null,n.clientInfo=null,n.queryReqMsg=null),null!=e.msgInfo&&e.hasOwnProperty("msgInfo")&&(n.msgInfo=W.naturalcloudsyncv2.MessageInfo.toObject(e.msgInfo,t)),null!=e.clientInfo&&e.hasOwnProperty("clientInfo")&&(n.clientInfo=W.naturalcloudsyncv2.ClientInfo.toObject(e.clientInfo,t)),e.schemas&&e.schemas.length){n.schemas=[];for(let r=0;r<e.schemas.length;++r)n.schemas[r]=W.naturalcloudsyncv2.Schema.toObject(e.schemas[r],t)}if(e.opData&&e.opData.length){n.opData=[];for(let r=0;r<e.opData.length;++r)n.opData[r]=W.naturalcloudsyncv2.OperationData.toObject(e.opData[r],t)}if(null!=e.queryReqMsg&&e.hasOwnProperty("queryReqMsg")&&(n.queryReqMsg=W.naturalcloudsyncv2.QueryRequestMessage.toObject(e.queryReqMsg,t)),e.subReqMsg&&e.subReqMsg.length){n.subReqMsg=[];for(let r=0;r<e.subReqMsg.length;++r)n.subReqMsg[r]=W.naturalcloudsyncv2.SubscribeRequestMessage.toObject(e.subReqMsg[r],t)}if(e.unSubReqMsg&&e.unSubReqMsg.length){n.unSubReqMsg=[];for(let r=0;r<e.unSubReqMsg.length;++r)n.unSubReqMsg[r]=W.naturalcloudsyncv2.UnsubscribeRequestMessage.toObject(e.unSubReqMsg[r],t)}if(e.enReqInfo&&e.enReqInfo.length){n.enReqInfo=[];for(let r=0;r<e.enReqInfo.length;++r)n.enReqInfo[r]=W.naturalcloudsyncv2.EncryptionInfo.toObject(e.enReqInfo[r],t)}return n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.ClientInfo=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.uid="",e.prototype.pid="",e.prototype.cid="",e.prototype.aid="",e.prototype.appVer=H.Long?H.Long.fromBits(0,0,!1):0,e.prototype.msgVer=0,e.prototype.enVer=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.uid&&Object.hasOwnProperty.call(e,"uid")&&t.uint32(10).string(e.uid),null!=e.pid&&Object.hasOwnProperty.call(e,"pid")&&t.uint32(18).string(e.pid),null!=e.cid&&Object.hasOwnProperty.call(e,"cid")&&t.uint32(26).string(e.cid),null!=e.aid&&Object.hasOwnProperty.call(e,"aid")&&t.uint32(34).string(e.aid),null!=e.appVer&&Object.hasOwnProperty.call(e,"appVer")&&t.uint32(40).int64(e.appVer),null!=e.msgVer&&Object.hasOwnProperty.call(e,"msgVer")&&t.uint32(48).int32(e.msgVer),null!=e.enVer&&Object.hasOwnProperty.call(e,"enVer")&&t.uint32(56).int32(e.enVer),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.ClientInfo;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.uid=e.string();break;case 2:r.pid=e.string();break;case 3:r.cid=e.string();break;case 4:r.aid=e.string();break;case 5:r.appVer=e.int64();break;case 6:r.msgVer=e.int32();break;case 7:r.enVer=e.int32();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.uid&&e.hasOwnProperty("uid")&&!H.isString(e.uid)?"uid: string expected":null!=e.pid&&e.hasOwnProperty("pid")&&!H.isString(e.pid)?"pid: string expected":null!=e.cid&&e.hasOwnProperty("cid")&&!H.isString(e.cid)?"cid: string expected":null!=e.aid&&e.hasOwnProperty("aid")&&!H.isString(e.aid)?"aid: string expected":null!=e.appVer&&e.hasOwnProperty("appVer")&&!(H.isInteger(e.appVer)||e.appVer&&H.isInteger(e.appVer.low)&&H.isInteger(e.appVer.high))?"appVer: integer|Long expected":null!=e.msgVer&&e.hasOwnProperty("msgVer")&&!H.isInteger(e.msgVer)?"msgVer: integer expected":null!=e.enVer&&e.hasOwnProperty("enVer")&&!H.isInteger(e.enVer)?"enVer: integer expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.ClientInfo)return e;let t=new W.naturalcloudsyncv2.ClientInfo;return null!=e.uid&&(t.uid=String(e.uid)),null!=e.pid&&(t.pid=String(e.pid)),null!=e.cid&&(t.cid=String(e.cid)),null!=e.aid&&(t.aid=String(e.aid)),null!=e.appVer&&(H.Long?(t.appVer=H.Long.fromValue(e.appVer)).unsigned=!1:"string"==typeof e.appVer?t.appVer=parseInt(e.appVer,10):"number"==typeof e.appVer?t.appVer=e.appVer:"object"==typeof e.appVer&&(t.appVer=new H.LongBits(e.appVer.low>>>0,e.appVer.high>>>0).toNumber())),null!=e.msgVer&&(t.msgVer=0|e.msgVer),null!=e.enVer&&(t.enVer=0|e.enVer),t},e.toObject=function(e,t){t||(t={});let n={};if(t.defaults){if(n.uid="",n.pid="",n.cid="",n.aid="",H.Long){let e=new H.Long(0,0,!1);n.appVer=t.longs===String?e.toString():t.longs===Number?e.toNumber():e}else n.appVer=t.longs===String?"0":0;n.msgVer=0,n.enVer=0}return null!=e.uid&&e.hasOwnProperty("uid")&&(n.uid=e.uid),null!=e.pid&&e.hasOwnProperty("pid")&&(n.pid=e.pid),null!=e.cid&&e.hasOwnProperty("cid")&&(n.cid=e.cid),null!=e.aid&&e.hasOwnProperty("aid")&&(n.aid=e.aid),null!=e.appVer&&e.hasOwnProperty("appVer")&&("number"==typeof e.appVer?n.appVer=t.longs===String?String(e.appVer):e.appVer:n.appVer=t.longs===String?H.Long.prototype.toString.call(e.appVer):t.longs===Number?new H.LongBits(e.appVer.low>>>0,e.appVer.high>>>0).toNumber():e.appVer),null!=e.msgVer&&e.hasOwnProperty("msgVer")&&(n.msgVer=e.msgVer),null!=e.enVer&&e.hasOwnProperty("enVer")&&(n.enVer=e.enVer),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.QueryRequestMessage=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.queryType=0,e.prototype.queryTable="",e.prototype.queryCond="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.queryType&&Object.hasOwnProperty.call(e,"queryType")&&t.uint32(8).int32(e.queryType),null!=e.queryTable&&Object.hasOwnProperty.call(e,"queryTable")&&t.uint32(18).string(e.queryTable),null!=e.queryCond&&Object.hasOwnProperty.call(e,"queryCond")&&t.uint32(26).string(e.queryCond),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.QueryRequestMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.queryType=e.int32();break;case 2:r.queryTable=e.string();break;case 3:r.queryCond=e.string();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.queryType&&e.hasOwnProperty("queryType")&&!H.isInteger(e.queryType)?"queryType: integer expected":null!=e.queryTable&&e.hasOwnProperty("queryTable")&&!H.isString(e.queryTable)?"queryTable: string expected":null!=e.queryCond&&e.hasOwnProperty("queryCond")&&!H.isString(e.queryCond)?"queryCond: string expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.QueryRequestMessage)return e;let t=new W.naturalcloudsyncv2.QueryRequestMessage;return null!=e.queryType&&(t.queryType=0|e.queryType),null!=e.queryTable&&(t.queryTable=String(e.queryTable)),null!=e.queryCond&&(t.queryCond=String(e.queryCond)),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.queryType=0,n.queryTable="",n.queryCond=""),null!=e.queryType&&e.hasOwnProperty("queryType")&&(n.queryType=e.queryType),null!=e.queryTable&&e.hasOwnProperty("queryTable")&&(n.queryTable=e.queryTable),null!=e.queryCond&&e.hasOwnProperty("queryCond")&&(n.queryCond=e.queryCond),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.SubscribeRequestMessage=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.subId="",e.prototype.subStore="",e.prototype.subTable="",e.prototype.subCond="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.subId&&Object.hasOwnProperty.call(e,"subId")&&t.uint32(10).string(e.subId),null!=e.subStore&&Object.hasOwnProperty.call(e,"subStore")&&t.uint32(18).string(e.subStore),null!=e.subTable&&Object.hasOwnProperty.call(e,"subTable")&&t.uint32(26).string(e.subTable),null!=e.subCond&&Object.hasOwnProperty.call(e,"subCond")&&t.uint32(34).string(e.subCond),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.SubscribeRequestMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.subId=e.string();break;case 2:r.subStore=e.string();break;case 3:r.subTable=e.string();break;case 4:r.subCond=e.string();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.subId&&e.hasOwnProperty("subId")&&!H.isString(e.subId)?"subId: string expected":null!=e.subStore&&e.hasOwnProperty("subStore")&&!H.isString(e.subStore)?"subStore: string expected":null!=e.subTable&&e.hasOwnProperty("subTable")&&!H.isString(e.subTable)?"subTable: string expected":null!=e.subCond&&e.hasOwnProperty("subCond")&&!H.isString(e.subCond)?"subCond: string expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.SubscribeRequestMessage)return e;let t=new W.naturalcloudsyncv2.SubscribeRequestMessage;return null!=e.subId&&(t.subId=String(e.subId)),null!=e.subStore&&(t.subStore=String(e.subStore)),null!=e.subTable&&(t.subTable=String(e.subTable)),null!=e.subCond&&(t.subCond=String(e.subCond)),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.subId="",n.subStore="",n.subTable="",n.subCond=""),null!=e.subId&&e.hasOwnProperty("subId")&&(n.subId=e.subId),null!=e.subStore&&e.hasOwnProperty("subStore")&&(n.subStore=e.subStore),null!=e.subTable&&e.hasOwnProperty("subTable")&&(n.subTable=e.subTable),null!=e.subCond&&e.hasOwnProperty("subCond")&&(n.subCond=e.subCond),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.UnsubscribeRequestMessage=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.subRecId="",e.prototype.unSubStore="",e.prototype.unSubTable="",e.prototype.subKey=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.subRecId&&Object.hasOwnProperty.call(e,"subRecId")&&t.uint32(10).string(e.subRecId),null!=e.unSubStore&&Object.hasOwnProperty.call(e,"unSubStore")&&t.uint32(18).string(e.unSubStore),null!=e.unSubTable&&Object.hasOwnProperty.call(e,"unSubTable")&&t.uint32(26).string(e.unSubTable),null!=e.subKey&&Object.hasOwnProperty.call(e,"subKey")&&t.uint32(32).int32(e.subKey),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.UnsubscribeRequestMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.subRecId=e.string();break;case 2:r.unSubStore=e.string();break;case 3:r.unSubTable=e.string();break;case 4:r.subKey=e.int32();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.subRecId&&e.hasOwnProperty("subRecId")&&!H.isString(e.subRecId)?"subRecId: string expected":null!=e.unSubStore&&e.hasOwnProperty("unSubStore")&&!H.isString(e.unSubStore)?"unSubStore: string expected":null!=e.unSubTable&&e.hasOwnProperty("unSubTable")&&!H.isString(e.unSubTable)?"unSubTable: string expected":null!=e.subKey&&e.hasOwnProperty("subKey")&&!H.isInteger(e.subKey)?"subKey: integer expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.UnsubscribeRequestMessage)return e;let t=new W.naturalcloudsyncv2.UnsubscribeRequestMessage;return null!=e.subRecId&&(t.subRecId=String(e.subRecId)),null!=e.unSubStore&&(t.unSubStore=String(e.unSubStore)),null!=e.unSubTable&&(t.unSubTable=String(e.unSubTable)),null!=e.subKey&&(t.subKey=0|e.subKey),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.subRecId="",n.unSubStore="",n.unSubTable="",n.subKey=0),null!=e.subRecId&&e.hasOwnProperty("subRecId")&&(n.subRecId=e.subRecId),null!=e.unSubStore&&e.hasOwnProperty("unSubStore")&&(n.unSubStore=e.unSubStore),null!=e.unSubTable&&e.hasOwnProperty("unSubTable")&&(n.unSubTable=e.unSubTable),null!=e.subKey&&e.hasOwnProperty("subKey")&&(n.subKey=e.subKey),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.SyncResponseMessage=function(){function e(e){if(this.schemas=[],this.opData=[],this.permRecs=[],this.subResMsg=[],this.unSubResMsg=[],this.enResInfo=[],e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.msgInfo=null,e.prototype.resInfo=null,e.prototype.schemas=H.emptyArray,e.prototype.opData=H.emptyArray,e.prototype.permRecs=H.emptyArray,e.prototype.updateResMsg=null,e.prototype.queryResMsg=null,e.prototype.subResMsg=H.emptyArray,e.prototype.unSubResMsg=H.emptyArray,e.prototype.subPushMsg=null,e.prototype.enResInfo=H.emptyArray,e.create=function(t){return new e(t)},e.encode=function(e,t){if(t||(t=Q.create()),null!=e.msgInfo&&Object.hasOwnProperty.call(e,"msgInfo")&&W.naturalcloudsyncv2.MessageInfo.encode(e.msgInfo,t.uint32(10).fork()).ldelim(),null!=e.resInfo&&Object.hasOwnProperty.call(e,"resInfo")&&W.naturalcloudsyncv2.ResponseInfo.encode(e.resInfo,t.uint32(18).fork()).ldelim(),null!=e.schemas&&e.schemas.length)for(let n=0;n<e.schemas.length;++n)W.naturalcloudsyncv2.Schema.encode(e.schemas[n],t.uint32(26).fork()).ldelim();if(null!=e.opData&&e.opData.length)for(let n=0;n<e.opData.length;++n)W.naturalcloudsyncv2.OperationData.encode(e.opData[n],t.uint32(34).fork()).ldelim();if(null!=e.permRecs&&e.permRecs.length)for(let n=0;n<e.permRecs.length;++n)W.naturalcloudsyncv2.PermissionRecord.encode(e.permRecs[n],t.uint32(42).fork()).ldelim();if(null!=e.updateResMsg&&Object.hasOwnProperty.call(e,"updateResMsg")&&W.naturalcloudsyncv2.UpdateResponseMessage.encode(e.updateResMsg,t.uint32(50).fork()).ldelim(),null!=e.queryResMsg&&Object.hasOwnProperty.call(e,"queryResMsg")&&W.naturalcloudsyncv2.QueryResponseMessage.encode(e.queryResMsg,t.uint32(58).fork()).ldelim(),null!=e.subResMsg&&e.subResMsg.length)for(let n=0;n<e.subResMsg.length;++n)W.naturalcloudsyncv2.SubscribeResponseMessage.encode(e.subResMsg[n],t.uint32(66).fork()).ldelim();if(null!=e.unSubResMsg&&e.unSubResMsg.length)for(let n=0;n<e.unSubResMsg.length;++n)W.naturalcloudsyncv2.UnsubscribeResponseMessage.encode(e.unSubResMsg[n],t.uint32(74).fork()).ldelim();if(null!=e.subPushMsg&&Object.hasOwnProperty.call(e,"subPushMsg")&&W.naturalcloudsyncv2.SubscribePushMessage.encode(e.subPushMsg,t.uint32(82).fork()).ldelim(),null!=e.enResInfo&&e.enResInfo.length)for(let n=0;n<e.enResInfo.length;++n)W.naturalcloudsyncv2.EncryptionInfo.encode(e.enResInfo[n],t.uint32(90).fork()).ldelim();return t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.SyncResponseMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.msgInfo=W.naturalcloudsyncv2.MessageInfo.decode(e,e.uint32());break;case 2:r.resInfo=W.naturalcloudsyncv2.ResponseInfo.decode(e,e.uint32());break;case 3:r.schemas&&r.schemas.length||(r.schemas=[]),r.schemas.push(W.naturalcloudsyncv2.Schema.decode(e,e.uint32()));break;case 4:r.opData&&r.opData.length||(r.opData=[]),r.opData.push(W.naturalcloudsyncv2.OperationData.decode(e,e.uint32()));break;case 5:r.permRecs&&r.permRecs.length||(r.permRecs=[]),r.permRecs.push(W.naturalcloudsyncv2.PermissionRecord.decode(e,e.uint32()));break;case 6:r.updateResMsg=W.naturalcloudsyncv2.UpdateResponseMessage.decode(e,e.uint32());break;case 7:r.queryResMsg=W.naturalcloudsyncv2.QueryResponseMessage.decode(e,e.uint32());break;case 8:r.subResMsg&&r.subResMsg.length||(r.subResMsg=[]),r.subResMsg.push(W.naturalcloudsyncv2.SubscribeResponseMessage.decode(e,e.uint32()));break;case 9:r.unSubResMsg&&r.unSubResMsg.length||(r.unSubResMsg=[]),r.unSubResMsg.push(W.naturalcloudsyncv2.UnsubscribeResponseMessage.decode(e,e.uint32()));break;case 10:r.subPushMsg=W.naturalcloudsyncv2.SubscribePushMessage.decode(e,e.uint32());break;case 11:r.enResInfo&&r.enResInfo.length||(r.enResInfo=[]),r.enResInfo.push(W.naturalcloudsyncv2.EncryptionInfo.decode(e,e.uint32()));break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.msgInfo&&e.hasOwnProperty("msgInfo")){let t=W.naturalcloudsyncv2.MessageInfo.verify(e.msgInfo);if(t)return"msgInfo."+t}if(null!=e.resInfo&&e.hasOwnProperty("resInfo")){let t=W.naturalcloudsyncv2.ResponseInfo.verify(e.resInfo);if(t)return"resInfo."+t}if(null!=e.schemas&&e.hasOwnProperty("schemas")){if(!Array.isArray(e.schemas))return"schemas: array expected";for(let t=0;t<e.schemas.length;++t){let n=W.naturalcloudsyncv2.Schema.verify(e.schemas[t]);if(n)return"schemas."+n}}if(null!=e.opData&&e.hasOwnProperty("opData")){if(!Array.isArray(e.opData))return"opData: array expected";for(let t=0;t<e.opData.length;++t){let n=W.naturalcloudsyncv2.OperationData.verify(e.opData[t]);if(n)return"opData."+n}}if(null!=e.permRecs&&e.hasOwnProperty("permRecs")){if(!Array.isArray(e.permRecs))return"permRecs: array expected";for(let t=0;t<e.permRecs.length;++t){let n=W.naturalcloudsyncv2.PermissionRecord.verify(e.permRecs[t]);if(n)return"permRecs."+n}}if(null!=e.updateResMsg&&e.hasOwnProperty("updateResMsg")){let t=W.naturalcloudsyncv2.UpdateResponseMessage.verify(e.updateResMsg);if(t)return"updateResMsg."+t}if(null!=e.queryResMsg&&e.hasOwnProperty("queryResMsg")){let t=W.naturalcloudsyncv2.QueryResponseMessage.verify(e.queryResMsg);if(t)return"queryResMsg."+t}if(null!=e.subResMsg&&e.hasOwnProperty("subResMsg")){if(!Array.isArray(e.subResMsg))return"subResMsg: array expected";for(let t=0;t<e.subResMsg.length;++t){let n=W.naturalcloudsyncv2.SubscribeResponseMessage.verify(e.subResMsg[t]);if(n)return"subResMsg."+n}}if(null!=e.unSubResMsg&&e.hasOwnProperty("unSubResMsg")){if(!Array.isArray(e.unSubResMsg))return"unSubResMsg: array expected";for(let t=0;t<e.unSubResMsg.length;++t){let n=W.naturalcloudsyncv2.UnsubscribeResponseMessage.verify(e.unSubResMsg[t]);if(n)return"unSubResMsg."+n}}if(null!=e.subPushMsg&&e.hasOwnProperty("subPushMsg")){let t=W.naturalcloudsyncv2.SubscribePushMessage.verify(e.subPushMsg);if(t)return"subPushMsg."+t}if(null!=e.enResInfo&&e.hasOwnProperty("enResInfo")){if(!Array.isArray(e.enResInfo))return"enResInfo: array expected";for(let t=0;t<e.enResInfo.length;++t){let n=W.naturalcloudsyncv2.EncryptionInfo.verify(e.enResInfo[t]);if(n)return"enResInfo."+n}}return null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.SyncResponseMessage)return e;let t=new W.naturalcloudsyncv2.SyncResponseMessage;if(null!=e.msgInfo){if("object"!=typeof e.msgInfo)throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.msgInfo: object expected");t.msgInfo=W.naturalcloudsyncv2.MessageInfo.fromObject(e.msgInfo)}if(null!=e.resInfo){if("object"!=typeof e.resInfo)throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.resInfo: object expected");t.resInfo=W.naturalcloudsyncv2.ResponseInfo.fromObject(e.resInfo)}if(e.schemas){if(!Array.isArray(e.schemas))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.schemas: array expected");t.schemas=[];for(let n=0;n<e.schemas.length;++n){if("object"!=typeof e.schemas[n])throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.schemas: object expected");t.schemas[n]=W.naturalcloudsyncv2.Schema.fromObject(e.schemas[n])}}if(e.opData){if(!Array.isArray(e.opData))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.opData: array expected");t.opData=[];for(let n=0;n<e.opData.length;++n){if("object"!=typeof e.opData[n])throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.opData: object expected");t.opData[n]=W.naturalcloudsyncv2.OperationData.fromObject(e.opData[n])}}if(e.permRecs){if(!Array.isArray(e.permRecs))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.permRecs: array expected");t.permRecs=[];for(let n=0;n<e.permRecs.length;++n){if("object"!=typeof e.permRecs[n])throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.permRecs: object expected");t.permRecs[n]=W.naturalcloudsyncv2.PermissionRecord.fromObject(e.permRecs[n])}}if(null!=e.updateResMsg){if("object"!=typeof e.updateResMsg)throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.updateResMsg: object expected");t.updateResMsg=W.naturalcloudsyncv2.UpdateResponseMessage.fromObject(e.updateResMsg)}if(null!=e.queryResMsg){if("object"!=typeof e.queryResMsg)throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.queryResMsg: object expected");t.queryResMsg=W.naturalcloudsyncv2.QueryResponseMessage.fromObject(e.queryResMsg)}if(e.subResMsg){if(!Array.isArray(e.subResMsg))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.subResMsg: array expected");t.subResMsg=[];for(let n=0;n<e.subResMsg.length;++n){if("object"!=typeof e.subResMsg[n])throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.subResMsg: object expected");t.subResMsg[n]=W.naturalcloudsyncv2.SubscribeResponseMessage.fromObject(e.subResMsg[n])}}if(e.unSubResMsg){if(!Array.isArray(e.unSubResMsg))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.unSubResMsg: array expected");t.unSubResMsg=[];for(let n=0;n<e.unSubResMsg.length;++n){if("object"!=typeof e.unSubResMsg[n])throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.unSubResMsg: object expected");t.unSubResMsg[n]=W.naturalcloudsyncv2.UnsubscribeResponseMessage.fromObject(e.unSubResMsg[n])}}if(null!=e.subPushMsg){if("object"!=typeof e.subPushMsg)throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.subPushMsg: object expected");t.subPushMsg=W.naturalcloudsyncv2.SubscribePushMessage.fromObject(e.subPushMsg)}if(e.enResInfo){if(!Array.isArray(e.enResInfo))throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.enResInfo: array expected");t.enResInfo=[];for(let n=0;n<e.enResInfo.length;++n){if("object"!=typeof e.enResInfo[n])throw TypeError(".naturalcloudsyncv2.SyncResponseMessage.enResInfo: object expected");t.enResInfo[n]=W.naturalcloudsyncv2.EncryptionInfo.fromObject(e.enResInfo[n])}}return t},e.toObject=function(e,t){t||(t={});let n={};if((t.arrays||t.defaults)&&(n.schemas=[],n.opData=[],n.permRecs=[],n.subResMsg=[],n.unSubResMsg=[],n.enResInfo=[]),t.defaults&&(n.msgInfo=null,n.resInfo=null,n.updateResMsg=null,n.queryResMsg=null,n.subPushMsg=null),null!=e.msgInfo&&e.hasOwnProperty("msgInfo")&&(n.msgInfo=W.naturalcloudsyncv2.MessageInfo.toObject(e.msgInfo,t)),null!=e.resInfo&&e.hasOwnProperty("resInfo")&&(n.resInfo=W.naturalcloudsyncv2.ResponseInfo.toObject(e.resInfo,t)),e.schemas&&e.schemas.length){n.schemas=[];for(let r=0;r<e.schemas.length;++r)n.schemas[r]=W.naturalcloudsyncv2.Schema.toObject(e.schemas[r],t)}if(e.opData&&e.opData.length){n.opData=[];for(let r=0;r<e.opData.length;++r)n.opData[r]=W.naturalcloudsyncv2.OperationData.toObject(e.opData[r],t)}if(e.permRecs&&e.permRecs.length){n.permRecs=[];for(let r=0;r<e.permRecs.length;++r)n.permRecs[r]=W.naturalcloudsyncv2.PermissionRecord.toObject(e.permRecs[r],t)}if(null!=e.updateResMsg&&e.hasOwnProperty("updateResMsg")&&(n.updateResMsg=W.naturalcloudsyncv2.UpdateResponseMessage.toObject(e.updateResMsg,t)),null!=e.queryResMsg&&e.hasOwnProperty("queryResMsg")&&(n.queryResMsg=W.naturalcloudsyncv2.QueryResponseMessage.toObject(e.queryResMsg,t)),e.subResMsg&&e.subResMsg.length){n.subResMsg=[];for(let r=0;r<e.subResMsg.length;++r)n.subResMsg[r]=W.naturalcloudsyncv2.SubscribeResponseMessage.toObject(e.subResMsg[r],t)}if(e.unSubResMsg&&e.unSubResMsg.length){n.unSubResMsg=[];for(let r=0;r<e.unSubResMsg.length;++r)n.unSubResMsg[r]=W.naturalcloudsyncv2.UnsubscribeResponseMessage.toObject(e.unSubResMsg[r],t)}if(null!=e.subPushMsg&&e.hasOwnProperty("subPushMsg")&&(n.subPushMsg=W.naturalcloudsyncv2.SubscribePushMessage.toObject(e.subPushMsg,t)),e.enResInfo&&e.enResInfo.length){n.enResInfo=[];for(let r=0;r<e.enResInfo.length;++r)n.enResInfo[r]=W.naturalcloudsyncv2.EncryptionInfo.toObject(e.enResInfo[r],t)}return n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.ResponseInfo=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.resCode=0,e.prototype.resInfo="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.resCode&&Object.hasOwnProperty.call(e,"resCode")&&t.uint32(8).int32(e.resCode),null!=e.resInfo&&Object.hasOwnProperty.call(e,"resInfo")&&t.uint32(18).string(e.resInfo),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.ResponseInfo;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.resCode=e.int32();break;case 2:r.resInfo=e.string();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.resCode&&e.hasOwnProperty("resCode")&&!H.isInteger(e.resCode)?"resCode: integer expected":null!=e.resInfo&&e.hasOwnProperty("resInfo")&&!H.isString(e.resInfo)?"resInfo: string expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.ResponseInfo)return e;let t=new W.naturalcloudsyncv2.ResponseInfo;return null!=e.resCode&&(t.resCode=0|e.resCode),null!=e.resInfo&&(t.resInfo=String(e.resInfo)),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.resCode=0,n.resInfo=""),null!=e.resCode&&e.hasOwnProperty("resCode")&&(n.resCode=e.resCode),null!=e.resInfo&&e.hasOwnProperty("resInfo")&&(n.resInfo=e.resInfo),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.PermissionRecord=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.tableName="",e.prototype.roleType="",e.prototype.readPerm=!1,e.prototype.upsertPerm=!1,e.prototype.deletePerm=!1,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.tableName&&Object.hasOwnProperty.call(e,"tableName")&&t.uint32(10).string(e.tableName),null!=e.roleType&&Object.hasOwnProperty.call(e,"roleType")&&t.uint32(18).string(e.roleType),null!=e.readPerm&&Object.hasOwnProperty.call(e,"readPerm")&&t.uint32(24).bool(e.readPerm),null!=e.upsertPerm&&Object.hasOwnProperty.call(e,"upsertPerm")&&t.uint32(32).bool(e.upsertPerm),null!=e.deletePerm&&Object.hasOwnProperty.call(e,"deletePerm")&&t.uint32(40).bool(e.deletePerm),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.PermissionRecord;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.tableName=e.string();break;case 2:r.roleType=e.string();break;case 3:r.readPerm=e.bool();break;case 4:r.upsertPerm=e.bool();break;case 5:r.deletePerm=e.bool();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.tableName&&e.hasOwnProperty("tableName")&&!H.isString(e.tableName)?"tableName: string expected":null!=e.roleType&&e.hasOwnProperty("roleType")&&!H.isString(e.roleType)?"roleType: string expected":null!=e.readPerm&&e.hasOwnProperty("readPerm")&&"boolean"!=typeof e.readPerm?"readPerm: boolean expected":null!=e.upsertPerm&&e.hasOwnProperty("upsertPerm")&&"boolean"!=typeof e.upsertPerm?"upsertPerm: boolean expected":null!=e.deletePerm&&e.hasOwnProperty("deletePerm")&&"boolean"!=typeof e.deletePerm?"deletePerm: boolean expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.PermissionRecord)return e;let t=new W.naturalcloudsyncv2.PermissionRecord;return null!=e.tableName&&(t.tableName=String(e.tableName)),null!=e.roleType&&(t.roleType=String(e.roleType)),null!=e.readPerm&&(t.readPerm=Boolean(e.readPerm)),null!=e.upsertPerm&&(t.upsertPerm=Boolean(e.upsertPerm)),null!=e.deletePerm&&(t.deletePerm=Boolean(e.deletePerm)),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.tableName="",n.roleType="",n.readPerm=!1,n.upsertPerm=!1,n.deletePerm=!1),null!=e.tableName&&e.hasOwnProperty("tableName")&&(n.tableName=e.tableName),null!=e.roleType&&e.hasOwnProperty("roleType")&&(n.roleType=e.roleType),null!=e.readPerm&&e.hasOwnProperty("readPerm")&&(n.readPerm=e.readPerm),null!=e.upsertPerm&&e.hasOwnProperty("upsertPerm")&&(n.upsertPerm=e.upsertPerm),null!=e.deletePerm&&e.hasOwnProperty("deletePerm")&&(n.deletePerm=e.deletePerm),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.UpdateResponseMessage=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.successRecCount=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.successRecCount&&Object.hasOwnProperty.call(e,"successRecCount")&&t.uint32(8).int32(e.successRecCount),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.UpdateResponseMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.successRecCount=e.int32();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.successRecCount&&e.hasOwnProperty("successRecCount")&&!H.isInteger(e.successRecCount)?"successRecCount: integer expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.UpdateResponseMessage)return e;let t=new W.naturalcloudsyncv2.UpdateResponseMessage;return null!=e.successRecCount&&(t.successRecCount=0|e.successRecCount),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.successRecCount=0),null!=e.successRecCount&&e.hasOwnProperty("successRecCount")&&(n.successRecCount=e.successRecCount),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.QueryResponseMessage=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.queryType=0,e.prototype.isComplete=!1,e.prototype.aggQueryRes=null,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.queryType&&Object.hasOwnProperty.call(e,"queryType")&&t.uint32(8).int32(e.queryType),null!=e.isComplete&&Object.hasOwnProperty.call(e,"isComplete")&&t.uint32(16).bool(e.isComplete),null!=e.aggQueryRes&&Object.hasOwnProperty.call(e,"aggQueryRes")&&W.naturalcloudsyncv2.AggregateQueryResult.encode(e.aggQueryRes,t.uint32(26).fork()).ldelim(),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.QueryResponseMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.queryType=e.int32();break;case 2:r.isComplete=e.bool();break;case 3:r.aggQueryRes=W.naturalcloudsyncv2.AggregateQueryResult.decode(e,e.uint32());break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";if(null!=e.queryType&&e.hasOwnProperty("queryType")&&!H.isInteger(e.queryType))return"queryType: integer expected";if(null!=e.isComplete&&e.hasOwnProperty("isComplete")&&"boolean"!=typeof e.isComplete)return"isComplete: boolean expected";if(null!=e.aggQueryRes&&e.hasOwnProperty("aggQueryRes")){let t=W.naturalcloudsyncv2.AggregateQueryResult.verify(e.aggQueryRes);if(t)return"aggQueryRes."+t}return null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.QueryResponseMessage)return e;let t=new W.naturalcloudsyncv2.QueryResponseMessage;if(null!=e.queryType&&(t.queryType=0|e.queryType),null!=e.isComplete&&(t.isComplete=Boolean(e.isComplete)),null!=e.aggQueryRes){if("object"!=typeof e.aggQueryRes)throw TypeError(".naturalcloudsyncv2.QueryResponseMessage.aggQueryRes: object expected");t.aggQueryRes=W.naturalcloudsyncv2.AggregateQueryResult.fromObject(e.aggQueryRes)}return t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.queryType=0,n.isComplete=!1,n.aggQueryRes=null),null!=e.queryType&&e.hasOwnProperty("queryType")&&(n.queryType=e.queryType),null!=e.isComplete&&e.hasOwnProperty("isComplete")&&(n.isComplete=e.isComplete),null!=e.aggQueryRes&&e.hasOwnProperty("aggQueryRes")&&(n.aggQueryRes=W.naturalcloudsyncv2.AggregateQueryResult.toObject(e.aggQueryRes,t)),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.AggregateQueryResult=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}let t;return e.prototype.isNull=!1,e.prototype.longRes=H.Long?H.Long.fromBits(0,0,!1):0,e.prototype.doubleRes=0,Object.defineProperty(e.prototype,"result",{get:H.oneOfGetter(t=["longRes","doubleRes"]),set:H.oneOfSetter(t)}),e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.isNull&&Object.hasOwnProperty.call(e,"isNull")&&t.uint32(8).bool(e.isNull),null!=e.longRes&&Object.hasOwnProperty.call(e,"longRes")&&t.uint32(16).int64(e.longRes),null!=e.doubleRes&&Object.hasOwnProperty.call(e,"doubleRes")&&t.uint32(25).double(e.doubleRes),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.AggregateQueryResult;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.isNull=e.bool();break;case 2:r.longRes=e.int64();break;case 3:r.doubleRes=e.double();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){if("object"!=typeof e||null===e)return"object expected";let t={};if(null!=e.isNull&&e.hasOwnProperty("isNull")&&"boolean"!=typeof e.isNull)return"isNull: boolean expected";if(null!=e.longRes&&e.hasOwnProperty("longRes")&&(t.result=1,!(H.isInteger(e.longRes)||e.longRes&&H.isInteger(e.longRes.low)&&H.isInteger(e.longRes.high))))return"longRes: integer|Long expected";if(null!=e.doubleRes&&e.hasOwnProperty("doubleRes")){if(1===t.result)return"result: multiple values";if(t.result=1,"number"!=typeof e.doubleRes)return"doubleRes: number expected"}return null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.AggregateQueryResult)return e;let t=new W.naturalcloudsyncv2.AggregateQueryResult;return null!=e.isNull&&(t.isNull=Boolean(e.isNull)),null!=e.longRes&&(H.Long?(t.longRes=H.Long.fromValue(e.longRes)).unsigned=!1:"string"==typeof e.longRes?t.longRes=parseInt(e.longRes,10):"number"==typeof e.longRes?t.longRes=e.longRes:"object"==typeof e.longRes&&(t.longRes=new H.LongBits(e.longRes.low>>>0,e.longRes.high>>>0).toNumber())),null!=e.doubleRes&&(t.doubleRes=Number(e.doubleRes)),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.isNull=!1),null!=e.isNull&&e.hasOwnProperty("isNull")&&(n.isNull=e.isNull),null!=e.longRes&&e.hasOwnProperty("longRes")&&("number"==typeof e.longRes?n.longRes=t.longs===String?String(e.longRes):e.longRes:n.longRes=t.longs===String?H.Long.prototype.toString.call(e.longRes):t.longs===Number?new H.LongBits(e.longRes.low>>>0,e.longRes.high>>>0).toNumber():e.longRes,t.oneofs&&(n.result="longRes")),null!=e.doubleRes&&e.hasOwnProperty("doubleRes")&&(n.doubleRes=t.json&&!isFinite(e.doubleRes)?String(e.doubleRes):e.doubleRes,t.oneofs&&(n.result="doubleRes")),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.SubscribeResponseMessage=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.subRecId="",e.prototype.subId="",e.prototype.subKey=0,e.prototype.subResCode=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.subRecId&&Object.hasOwnProperty.call(e,"subRecId")&&t.uint32(10).string(e.subRecId),null!=e.subId&&Object.hasOwnProperty.call(e,"subId")&&t.uint32(18).string(e.subId),null!=e.subKey&&Object.hasOwnProperty.call(e,"subKey")&&t.uint32(24).int32(e.subKey),null!=e.subResCode&&Object.hasOwnProperty.call(e,"subResCode")&&t.uint32(32).int32(e.subResCode),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.SubscribeResponseMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.subRecId=e.string();break;case 2:r.subId=e.string();break;case 3:r.subKey=e.int32();break;case 4:r.subResCode=e.int32();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.subRecId&&e.hasOwnProperty("subRecId")&&!H.isString(e.subRecId)?"subRecId: string expected":null!=e.subId&&e.hasOwnProperty("subId")&&!H.isString(e.subId)?"subId: string expected":null!=e.subKey&&e.hasOwnProperty("subKey")&&!H.isInteger(e.subKey)?"subKey: integer expected":null!=e.subResCode&&e.hasOwnProperty("subResCode")&&!H.isInteger(e.subResCode)?"subResCode: integer expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.SubscribeResponseMessage)return e;let t=new W.naturalcloudsyncv2.SubscribeResponseMessage;return null!=e.subRecId&&(t.subRecId=String(e.subRecId)),null!=e.subId&&(t.subId=String(e.subId)),null!=e.subKey&&(t.subKey=0|e.subKey),null!=e.subResCode&&(t.subResCode=0|e.subResCode),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.subRecId="",n.subId="",n.subKey=0,n.subResCode=0),null!=e.subRecId&&e.hasOwnProperty("subRecId")&&(n.subRecId=e.subRecId),null!=e.subId&&e.hasOwnProperty("subId")&&(n.subId=e.subId),null!=e.subKey&&e.hasOwnProperty("subKey")&&(n.subKey=e.subKey),null!=e.subResCode&&e.hasOwnProperty("subResCode")&&(n.subResCode=e.subResCode),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.UnsubscribeResponseMessage=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.unSubRecId="",e.prototype.unSubResCode=0,e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.unSubRecId&&Object.hasOwnProperty.call(e,"unSubRecId")&&t.uint32(10).string(e.unSubRecId),null!=e.unSubResCode&&Object.hasOwnProperty.call(e,"unSubResCode")&&t.uint32(16).int32(e.unSubResCode),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.UnsubscribeResponseMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.unSubRecId=e.string();break;case 2:r.unSubResCode=e.int32();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.unSubRecId&&e.hasOwnProperty("unSubRecId")&&!H.isString(e.unSubRecId)?"unSubRecId: string expected":null!=e.unSubResCode&&e.hasOwnProperty("unSubResCode")&&!H.isInteger(e.unSubResCode)?"unSubResCode: integer expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.UnsubscribeResponseMessage)return e;let t=new W.naturalcloudsyncv2.UnsubscribeResponseMessage;return null!=e.unSubRecId&&(t.unSubRecId=String(e.unSubRecId)),null!=e.unSubResCode&&(t.unSubResCode=0|e.unSubResCode),t},e.toObject=function(e,t){t||(t={});let n={};return t.defaults&&(n.unSubRecId="",n.unSubResCode=0),null!=e.unSubRecId&&e.hasOwnProperty("unSubRecId")&&(n.unSubRecId=e.unSubRecId),null!=e.unSubResCode&&e.hasOwnProperty("unSubResCode")&&(n.unSubResCode=e.unSubResCode),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e.SubscribePushMessage=function(){function e(e){if(e)for(let t=Object.keys(e),n=0;n<t.length;++n)null!=e[t[n]]&&(this[t[n]]=e[t[n]])}return e.prototype.subRecId="",e.prototype.pushSeq=H.Long?H.Long.fromBits(0,0,!1):0,e.prototype.subKey=0,e.prototype.subId="",e.create=function(t){return new e(t)},e.encode=function(e,t){return t||(t=Q.create()),null!=e.subRecId&&Object.hasOwnProperty.call(e,"subRecId")&&t.uint32(10).string(e.subRecId),null!=e.pushSeq&&Object.hasOwnProperty.call(e,"pushSeq")&&t.uint32(16).int64(e.pushSeq),null!=e.subKey&&Object.hasOwnProperty.call(e,"subKey")&&t.uint32(24).int32(e.subKey),null!=e.subId&&Object.hasOwnProperty.call(e,"subId")&&t.uint32(34).string(e.subId),t},e.encodeDelimited=function(e,t){return this.encode(e,t).ldelim()},e.decode=function(e,t){e instanceof Y||(e=Y.create(e));let n=void 0===t?e.len:e.pos+t,r=new W.naturalcloudsyncv2.SubscribePushMessage;for(;e.pos<n;){let t=e.uint32();switch(t>>>3){case 1:r.subRecId=e.string();break;case 2:r.pushSeq=e.int64();break;case 3:r.subKey=e.int32();break;case 4:r.subId=e.string();break;default:e.skipType(7&t)}}return r},e.decodeDelimited=function(e){return e instanceof Y||(e=new Y(e)),this.decode(e,e.uint32())},e.verify=function(e){return"object"!=typeof e||null===e?"object expected":null!=e.subRecId&&e.hasOwnProperty("subRecId")&&!H.isString(e.subRecId)?"subRecId: string expected":null!=e.pushSeq&&e.hasOwnProperty("pushSeq")&&!(H.isInteger(e.pushSeq)||e.pushSeq&&H.isInteger(e.pushSeq.low)&&H.isInteger(e.pushSeq.high))?"pushSeq: integer|Long expected":null!=e.subKey&&e.hasOwnProperty("subKey")&&!H.isInteger(e.subKey)?"subKey: integer expected":null!=e.subId&&e.hasOwnProperty("subId")&&!H.isString(e.subId)?"subId: string expected":null},e.fromObject=function(e){if(e instanceof W.naturalcloudsyncv2.SubscribePushMessage)return e;let t=new W.naturalcloudsyncv2.SubscribePushMessage;return null!=e.subRecId&&(t.subRecId=String(e.subRecId)),null!=e.pushSeq&&(H.Long?(t.pushSeq=H.Long.fromValue(e.pushSeq)).unsigned=!1:"string"==typeof e.pushSeq?t.pushSeq=parseInt(e.pushSeq,10):"number"==typeof e.pushSeq?t.pushSeq=e.pushSeq:"object"==typeof e.pushSeq&&(t.pushSeq=new H.LongBits(e.pushSeq.low>>>0,e.pushSeq.high>>>0).toNumber())),null!=e.subKey&&(t.subKey=0|e.subKey),null!=e.subId&&(t.subId=String(e.subId)),t},e.toObject=function(e,t){t||(t={});let n={};if(t.defaults){if(n.subRecId="",H.Long){let e=new H.Long(0,0,!1);n.pushSeq=t.longs===String?e.toString():t.longs===Number?e.toNumber():e}else n.pushSeq=t.longs===String?"0":0;n.subKey=0,n.subId=""}return null!=e.subRecId&&e.hasOwnProperty("subRecId")&&(n.subRecId=e.subRecId),null!=e.pushSeq&&e.hasOwnProperty("pushSeq")&&("number"==typeof e.pushSeq?n.pushSeq=t.longs===String?String(e.pushSeq):e.pushSeq:n.pushSeq=t.longs===String?H.Long.prototype.toString.call(e.pushSeq):t.longs===Number?new H.LongBits(e.pushSeq.low>>>0,e.pushSeq.high>>>0).toNumber():e.pushSeq),null!=e.subKey&&e.hasOwnProperty("subKey")&&(n.subKey=e.subKey),null!=e.subId&&e.hasOwnProperty("subId")&&(n.subId=e.subId),n},e.prototype.toJSON=function(){return this.constructor.toObject(this,G.util.toJSONOptions)},e}(),e})();var Z,J,$,ee=X.Obj,te=X.Field,ne=X.Schema,re=X.SchemaField,oe=X.FieldType,se=new T("ObjectWrapper"),ie=function(){function e(t,n,r){var o;if(this.creator="",this.objectVersion=0,this.objectTypeName="",this.values=n,this.operationType=r,r===m.DELETE){if(!n||0===n.length||!n[0].l)return void se.warn("invalid object version of delete wrapper object");this.objectVersion=n[0].l.toNumber()}else this.schema=ne.fromObject(ne.toObject(t,new Ne)),e.addSystemSchemaField(this.schema),this.objectTypeName=t.n,this.creator=null===(o=n[t.fs.indexOf(t.fs.find((function(e){return"naturalbase_creator"===e.n})))])||void 0===o?void 0:o.s,this.objectVersion=n[t.fs.indexOf(t.fs.find((function(e){return"naturalbase_version"===e.n})))].l.toNumber()}return e.findSchemaIndex=function(e,t){var n=-1,r=e.find((function(e,r){return e.n===t&&(n=r,!0)}));return[n,r]},e.addSystemSchemaField=function(e){var t=e.fs.find((function(e){return"naturalbase_creator"===e.n})),n=e.fs.find((function(e){return"naturalbase_version"===e.n})),r=e.fs.find((function(e){return"naturalbase_deleted"===e.n}));t||e.fs.push(re.create({n:"naturalbase_creator",t:oe.TYPE_STRING})),n||e.fs.push(re.create({n:"naturalbase_version",t:oe.TYPE_LONG})),r||e.fs.push(re.create({n:"naturalbase_deleted",t:oe.TYPE_BOOLEAN}))},e.buildObjs=function(t,n,r){var o,s,i=[];try{for(var a=p(t),u=a.next();!u.done;u=a.next()){var c=u.value,l=e.getClassName(c),d=f(this.findSchemaIndex(n,l),2),h=d[0],y=d[1];if(h<0||!y)throw E.build(1003);i.push(this.buildObj(c,y,r,h))}}catch(e){o={error:e}}finally{try{u&&!u.done&&(s=a.return)&&s.call(a)}finally{if(o)throw o.error}}return i},e.buildSubObjs=function(e,t){var n,r,s,i,a=[];try{for(var u=p(e),c=u.next();!c.done;c=u.next()){var l=c.value,d=l.getUserObject(),f=[];try{for(var h=(s=void 0,p(t.fs)),y=h.next();!y.done;y=h.next()){var b=y.value;if("naturalbase_version"!==b.n){var g=te.create(),v=b.t;g[ae.get(v)]=d[b.n],f.push(g)}else f.push(te.create({l:o.fromNumber(l.objectVersion)}))}}catch(e){s={error:e}}finally{try{y&&!y.done&&(i=h.return)&&i.call(h)}finally{if(s)throw s.error}}a.push(ee.create({fs:f}))}}catch(e){n={error:e}}finally{try{c&&!c.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}return a},e.buildObj=function(t,n,r,o){var s,i,a=[];try{for(var u=p(n.fs),c=u.next();!c.done;c=u.next()){var l=c.value,d=l.n,f=l.p;if("naturalbase_creator"===d)a.push(te.create({n:!0}));else if("naturalbase_version"===d)a.push(te.create({n:!0}));else if("naturalbase_deleted"===d)a.push(te.create({n:!1,bl:r}));else{var h=t[d],y=l.t,b=void 0;b=!(f||!r)||e.isNullValue(h,y);var g=te.create({n:b});b||(g[ae.get(y)]=y===oe.TYPE_DATE?h.getTime():h),a.push(g)}}}catch(e){s={error:e}}finally{try{c&&!c.done&&(i=u.return)&&i.call(u)}finally{if(s)throw s.error}}return ee.create({fs:a,i:o})},e.isNullValue=function(e,t){var n;return null==e||(t===oe.TYPE_DATE?!(e instanceof Date):t===oe.TYPE_LONG&&"Long"!==(null===(n=null==e?void 0:e.constructor)||void 0===n?void 0:n.name))},e.getClassName=function(e){return e.constructor.className?e.constructor.className:e.constructor.name},e.prototype.toSyncObject=function(){var e=ee.create();return e.fs=this.values,e},e.prototype.setObjectTypeName=function(e){this.objectTypeName=e.className?e.className:e.name},e.prototype.getUserObject=function(){return this.userObject},e.prototype.setUserObject=function(e){this.userObject=e},e.prototype.getObject=function(){for(var e=ne.toObject(this.schema,new Ne),t=this.values.map((function(e){return te.toObject(e,{longs:o,defaults:!0})})),n={},r=0;r<t.length;r++){var s=e.fs[r],i=s.n,a=s.e?oe.TYPE_BYTE_ARRAY:s.t,u=t[r],c=u.n,l=ae.get(a);n[i]=c?void 0:u[l]}return n},e.prototype.clone=function(){var t,n,r=[];try{for(var o=p(this.values),s=o.next();!s.done;s=o.next()){var i=s.value,a=te.toObject(i,new Ne);r.push(te.fromObject(a))}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return new e(this.schema,r)},e.prototype.isValidVersion=function(){return 0!==this.objectVersion},e}(),ae=new Map;ae.set(oe.TYPE_BOOLEAN,"bl"),ae.set(oe.TYPE_BYTE,"b"),ae.set(oe.TYPE_BYTE_ARRAY,"ba"),ae.set(oe.TYPE_DATE,"l"),ae.set(oe.TYPE_DOUBLE,"d"),ae.set(oe.TYPE_FLOAT,"f"),ae.set(oe.TYPE_INT32,"i"),ae.set(oe.TYPE_LONG,"l"),ae.set(oe.TYPE_SHORT,"st"),ae.set(oe.TYPE_STRING,"s"),ae.set(oe.TYPE_TEXT,"s"),ae.set(oe.TYPE_AUTO_INCREMENT_INT,"i"),ae.set(oe.TYPE_AUTO_INCREMENT_LONG,"l"),function(e){e[e.PASS=0]="PASS",e[e.FAIL=1]="FAIL",e[e.RETRY=2]="RETRY"}(Z||(Z={})),function(e){e[e.QUERY_SUCCESS=0]="QUERY_SUCCESS",e[e.QUERY_FAILED=1]="QUERY_FAILED",e[e.QUERY_FAILED_FOR_BIG_RECORD=2]="QUERY_FAILED_FOR_BIG_RECORD",e[e.QUERY_FAILED_FOR_ENCRYPT_FIELD=3]="QUERY_FAILED_FOR_ENCRYPT_FIELD",e[e.QUERY_FAILED_FOR_LARGE_RESULT_SET=4]="QUERY_FAILED_FOR_LARGE_RESULT_SET",e[e.QUERY_FAILED_FOR_NO_INDEX=5]="QUERY_FAILED_FOR_NO_INDEX"}(J||(J={})),function(e){e[e.CONVENTIONAL_QUERY=0]="CONVENTIONAL_QUERY",e[e.AVG_QUERY=1]="AVG_QUERY"}($||($={}));var ue,ce=function(){};!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.NORMAL=1]="NORMAL",e[e.UPDATING=2]="UPDATING",e[e.INTERRUPT=3]="INTERRUPT"}(ue||(ue={}));var le,de=function(){function e(){this.keyStatus_=ue.DEFAULT,this.keyVersion_=0}return Object.defineProperty(e.prototype,"firstSaltValue",{get:function(){return this.firstSaltValue_},set:function(e){this.firstSaltValue_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"secondSaltValue",{get:function(){return this.secondSaltValue_},set:function(e){this.secondSaltValue_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rootKeyToken",{get:function(){return this.rootKeyToken_},set:function(e){this.rootKeyToken_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dataKeyCipherText",{get:function(){return this.dataKeyCipherText_},set:function(e){this.dataKeyCipherText_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"oldDataKeyCipherText",{get:function(){return this.oldDataKeyCipherText_},set:function(e){this.oldDataKeyCipherText_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keyStatus",{get:function(){return this.keyStatus_},set:function(e){this.keyStatus_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"keyVersion",{get:function(){return this.keyVersion_},set:function(e){this.keyVersion_=e},enumerable:!1,configurable:!0}),e.prototype.clear=function(){var e,t,n,r,o;null===(e=this.firstSaltValue_)||void 0===e||e.set([],0),null===(t=this.secondSaltValue_)||void 0===t||t.set([],0),null===(n=this.rootKeyToken_)||void 0===n||n.set([],0),null===(r=this.dataKeyCipherText_)||void 0===r||r.set([],0),null===(o=this.oldDataKeyCipherText_)||void 0===o||o.set([],0)},e}(),pe=function(){function e(e,t){this.encryptInfo_=[],this.resultCode_=0,this.resultCode_=e,this.encryptInfo_=t}return Object.defineProperty(e.prototype,"resultCode",{get:function(){return this.resultCode_},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"encryptInfo",{get:function(){return this.encryptInfo_},enumerable:!1,configurable:!0}),e}(),fe=X.ClientInfo,he=X.EncryptionInfo,ye=X.SyncResponseMessage,be=X.SyncRequestMessage,ge=X.MessageInfo,ve=X.Store,Se=X.OperationData,me=X.SubscribePushMessage,Te=X.Schema,Ie=X.SchemaField,Re=X.FieldType,Ee=X.QueryRequestMessage,we=X.Field,Oe=X.SubscribeRequestMessage,Ce=X.UnsubscribeRequestMessage,Ne=function(){this.longs=String,this.defaults=!0},Ae=new T("ProtoHelper"),De=function(){function e(){}return e.serializeMessage=function(t,n){var r=be.create(),o=ge.create();o.id=t.taskId;var s=ve.create();if(s.storeName=t.naturalStoreName||"",o.opStore=s,o.type=t.requestType,o.subType=t.requestSubType,r.clientInfo=e.buildClientInfo(n),r.msgInfo=o,r.clientInfo.enVer=t.encryptionVersion,o.type===g.QUERY_SUB)r.schemas=t.schemas.map((function(t){return e.schemaSub2Proto(t)}));else{var i=o.type!==g.SCHEMA_NEGOTIATE;r.schemas=t.schemas.map((function(t){return e.schema2Proto(t,i)}))}var a=h(e.serializationActions())[o.type];if(!a)throw Ae.warn("unknown message type"+o.type),E.build(1008);if(a.call(null,t,r),e.isWebSocketMessageType(t))return be.toObject(r,new Ne);var u=be.encode(r).finish();return u.buffer.slice(u.byteOffset,u.byteOffset+u.length)},e.deserializeMessage=function(t){var n,r,o=ye.decode(new Uint8Array(t)),s=o.msgInfo,i=s.type,a=s.id,u={storeName:(null===(n=s.opStore)||void 0===n?void 0:n.storeName)||"",taskId:a,responseCode:(null===(r=o.resInfo)||void 0===r?void 0:r.resCode)||0,type:i,subType:s.subType||0,response:void 0};0!==u.responseCode&&Ae.warn("cloud sync not execute success , responseCode =  "+u.responseCode);var c=h(e.deserializationActions())[s.type];if(!c)throw Ae.warn("unknown message type"+i),E.build(1008);return u.response=c.call(null,u,o),u},e.parseValue=function(e,t){var n,r;if(!e||0===e.length)return[];var o=[];try{for(var s=p(e),i=s.next();!i.done;i=s.next()){i.value.os.forEach((function(e){o.push(new ie(t[e.i],e.fs))}))}}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return o},e.groupBy=function(e,t){for(var n={},r=0;r<e.length;r++){var o=e[r],s=o[t];n[s]=n[s]||[],n[s].push(o)}return Object.values(n)},e.buildOperationData=function(t,n){var r,o,s,i=[],a=e.groupBy(t,"i");try{for(var u=p(a),c=u.next();!c.done;c=u.next()){var l=c.value,d=null===(s=l[0])||void 0===s?void 0:s.i;i.push(Se.create({os:l,t:n,i:d}))}}catch(e){r={error:e}}finally{try{c&&!c.done&&(o=u.return)&&o.call(u)}finally{if(r)throw r.error}}return i},e.schemaSub2Proto=function(e){var t=[];return h(e.getFieldInfos().values()).forEach((function(e){e.isPrimaryKey&&t.push(Ie.fromObject({n:e.fieldName,t:e.fieldType}))})),t.push(Ie.fromObject({n:"naturalbase_version",t:Re.TYPE_LONG})),Te.create({n:e.name,fs:t})},e.schema2Proto=function(e,t){var n=[],r=h(e.getFieldInfos().values()).map((function(e){var r=e.fieldType;t&&e.isEncryptField&&n.push(Ie.create({n:e.fieldName+"#ope",t:Re.TYPE_STRING}));var o=Ie.create({n:e.fieldName,t:t&&e.isEncryptField?Re.TYPE_BYTE_ARRAY:r,p:e.isPrimaryKey,e:e.isEncryptField,nn:e.isNotNull,df:e.hasDefaultValue});return o.defaultValue=e.defaultValue,o[ae.get(r)]=e.defaultValue,o}));return Te.create({n:e.name,fs:r.concat(n)})},e.isWebSocketMessageType=function(e){var t=e.requestType;return t===g.QUERY_SUB||t===g.QUERY_UNSUB||t===g.ENCRYPTION_TASK&&(e.requestSubType===v.MONITOR_USER_COMMAND_CHANGE||e.requestSubType===v.MONITOR_DATA_KEY_CHANGE)},e.buildClientInfo=function(e){var t=e.getContext(),n=new Object({appVer:t.appVersion,msgVer:2,pid:t.productId,cid:t.clientId,aid:t.appId}),r=fe.verify(n);if(null!=r)throw Ae.warn(r),E.build(1003);return fe.fromObject(n)},e.negotiateDeserialization=function(e,t){var n,r=[];return null===(n=t.permRecs)||void 0===n||n.forEach((function(e){r.push({tableName:e.tableName,roleType:e.roleType,readPermission:e.readPerm,upsertPermission:e.upsertPerm,deletePermission:e.deletePerm})})),{negoResult:t.resInfo.resCode,permissions:r}},e.negotiateSerialization=function(e,t){},e.objectUpdateDeserialization=function(e,t){return{queryId:t.msgInfo.id.toString(),successNumber:t.updateResMsg.successRecCount}},e.objectUpdateSerialization=function(e,t){t.schemas.forEach((function(e){ie.addSystemSchemaField(e)}));var n=e.operationType===S.SYNC_DELETE,r=ie.buildObjs(e.objList,t.schemas,n),o=Se.create({os:r,t:e.operationType,i:0});t.opData=[o]},e.encryptionDeserialization=function(e,t){var n=null==t?void 0:t.enResInfo;if(!n)throw Ae.error("ProtoHelper:deserializationActions encryption get invalid encryptionResponseMessage"),E.build("ProtoHelper:deserializationActions encryption get invalid encryptionResponseMessage");return{encryptionMessageType:t.msgInfo.subType,encryptionInfoList:n.map((function(e){var t=new de;return t.keyStatus=e.keyStatus,t.firstSaltValue=e.firstSalt,t.secondSaltValue=e.secondSalt,t.rootKeyToken=e.rootToken,t.dataKeyCipherText=e.cipherText,t.oldDataKeyCipherText=e.oldCipherText,t.keyVersion=e.keyVer,t}))}},e.encryptionSerialization=function(e,t){t.msgInfo.subType=e.requestSubType,t.msgInfo.type=g.ENCRYPTION_TASK,t.enReqInfo=e.requestInfo.map((function(e){return he.create({keyStatus:e.keyStatus,firstSalt:e.firstSaltValue,secondSalt:e.secondSaltValue,rootToken:e.rootKeyToken,cipherText:e.dataKeyCipherText,oldCipherText:e.oldDataKeyCipherText,keyVer:e.keyVersion})}))},e.objectQueryDeserialization=function(t,n){var r,o=n.queryResMsg,s=n.opData,i=n.schemas;return{tableName:null===(r=i[0])||void 0===r?void 0:r.n,queryResult:o.isComplete,queryType:o.queryType,totalLength:s.length,aggreResult:o.aggQueryRes,responseObject:e.parseValue(s,i)}},e.objectQuerySerialization=function(e,t){t.queryReqMsg=Ee.create({queryType:e.queryType,queryTable:e.tableName,queryCond:e.queryCondition})},e.transactionDeserialization=function(e,t){var n;return{transactionId:t.msgInfo.id.toString(),transactionResult:null===(n=t.resInfo)||void 0===n?void 0:n.resCode}},e.transactionSerialization=function(t,n){var r,o,s,i,a,u,c,l;n.schemas.forEach((function(e){ie.addSystemSchemaField(e)}));var d=n.schemas,y=t.verifyObjects,b=[];try{for(var g=p(y),v=g.next();!v.done;v=g.next()){var m=v.value,T=f(ie.findSchemaIndex(d,m.objectTypeName),2),I=T[0],R=T[1],w=m.toSyncObject();if(I<0||!R)throw E.build(1003);w.i=I,w.fs.push(we.create({n:!1,bl:!1}));try{for(var O=(s=void 0,p(R.fs)),C=O.next();!C.done;C=O.next()){C.value.n.indexOf("#ope")>-1&&w.fs.splice(-3,0,we.create({n:!0}))}}catch(e){s={error:e}}finally{try{C&&!C.done&&(i=O.return)&&i.call(O)}finally{if(s)throw s.error}}b.push(w)}}catch(e){r={error:e}}finally{try{v&&!v.done&&(o=g.return)&&o.call(g)}finally{if(r)throw r.error}}var N=e.buildOperationData(b,S.VERIFY);(a=n.opData).push.apply(a,h(N));var A=t.transactionDatas;try{for(var D=p(A),_=D.next();!_.done;_=D.next()){var P=_.value,k=P.objectTypeName,M=P.operationType,j=P.operationType===S.SYNC_DELETE,x=P.objects,U=f(ie.findSchemaIndex(d,k),2);I=U[0],R=U[1];if(I<0||!R)throw E.build(1003);var q=ie.buildObjs(x,d,j),L=e.buildOperationData(q,M);(l=n.opData).push.apply(l,h(L))}}catch(e){u={error:e}}finally{try{_&&!_.done&&(c=D.return)&&c.call(D)}finally{if(u)throw u.error}}},e.querySubscribeDeserialization=function(e,t){return{subscribeResults:t.subResMsg.map((function(e){return e.toJSON()}))}},e.querySubscribeSerialization=function(e,t){var n=[];t.subReqMsg=e.subscribeDatas.map((function(e){if(e.snapshotObjs&&e.snapshotObjs.length>0){var r=f(ie.findSchemaIndex(t.schemas,e.tableName),2),o=r[0],s=r[1];if(o<0||!s)throw E.build(1003);var i=ie.buildSubObjs(e.snapshotObjs,s);n.push(Se.create({os:i}))}return Oe.create({subId:e.subscribeId,subTable:e.tableName,subCond:e.subscribeCondition,subStore:e.naturalStoreName})})),t.opData=n},e.queryUnsubscribeDeserialization=function(e,t){return{unSubScribeResults:t.unSubResMsg.map((function(e){return e.toJSON()}))}},e.queryUnSubscribeSerialization=function(e,t){t.unSubReqMsg=e.unSubscribeDatas.map((function(e){return Ce.create({subRecId:e.cloudSubRecordId,unSubStore:e.naturalStoreName,unSubTable:e.tableName,subKey:e.cloudSubKey})}))},e.querySubPushDeserialization=function(e,t){var n,r,o=me.toObject(t.subPushMsg,new Ne),s=t.schemas,i=t.opData.map((function(e){var t=Se.toObject(e,new Ne);return t.tableName=s[e.i].n,t})),a=(null===(r=null===(n=t.msgInfo)||void 0===n?void 0:n.opStore)||void 0===r?void 0:r.storeName)||"";return{pushSeq:o.pushSeq,storeName:a,subRecId:o.subRecId,subKey:o.subKey,subscribeId:o.subId,responseObject:i}},e.emptyFuncDeserialization=function(e,t){Ae.error("Call empty function.")},e.emptyFuncSerialization=function(e,t){Ae.error("Call empty function.")},e.deserializationActions=function(){return[e.emptyFuncDeserialization,e.negotiateDeserialization,e.emptyFuncDeserialization,e.objectUpdateDeserialization,e.transactionDeserialization,e.objectQueryDeserialization,e.querySubscribeDeserialization,e.queryUnsubscribeDeserialization,e.querySubPushDeserialization,e.encryptionDeserialization]},e.serializationActions=function(){return[e.emptyFuncSerialization,e.negotiateSerialization,e.emptyFuncSerialization,e.objectUpdateSerialization,e.transactionSerialization,e.objectQuerySerialization,e.querySubscribeSerialization,e.queryUnSubscribeSerialization,e.emptyFuncSerialization,e.encryptionSerialization]},e}();!function(e){e[e.PROTOBUF=3]="PROTOBUF",e[e.JSON=4]="JSON"}(le||(le={}));var _e,Pe,ke,Me,je,xe,Ue="1.3.2",qe=new T("ContextWrapper"),Le=function(){function e(){}return e.setApplicationType=function(t){e.appType=t},e.getApplicationType=function(){return e.appType},e.setApplicationVersion=function(t){e.appVersion=t},e.getApplicationVersion=function(){return e.appVersion},e.getWSocketMessageType=function(e){var t,n,r,o;if(Object.prototype.hasOwnProperty.call(e,"msgInfo"))switch(qe.log("getWSocketMessageType responseType: "+(null===(t=e.msgInfo)||void 0===t?void 0:t.type)+" errorCode: "+(null===(n=e.resInfo)||void 0===n?void 0:n.resCode)),null===(r=e.msgInfo)||void 0===r?void 0:r.type){case g.QUERY_SUB:return"SubscribeResponse";case g.QUERY_SUB_PUSH:return"SnapshotUpdate";case g.QUERY_UNSUB:return"UnsubscribeResponse";case g.ENCRYPTION_TASK:return"EncryptionResponse";default:qe.warn("unknown WSocket message type "+(null===(o=e.msgInfo)||void 0===o?void 0:o.type))}return"ErrorMessage"},e.appType="Unknown",e.appVersion=Ue,e}(),Ke=new Map([["CN",1],["SG",4],["RU",3],["DE",2]]),Be=new Map([[1,["CN","CN_back"]],[4,["SG","SG_back"]],[3,["RU","RU_back"]],[2,["DE","DE_back"]]]),Ve=new T("CertificateService"),Fe=function(){function e(t){if(this.websocketUrl="",this.websocketBackUrl="",this.httpUrl="",this.httpBackUrl="",O.isNullOrUndefined(t))this.agcRoutePolicy=Ke.get(e.agcConfig.region),this.loadAgcGwAddress(e.agcConfig.agcgw);else{if(this.agcRoutePolicy=t,!this.isValidAgcGwAllAddress(e.agcConfig.agcgw_all,t))throw Ve.warn("The agconnect service config agcgw_all is invalid."),E.build("The agconnect service config agcgw_all is invalid.");if(!this.isValidAgcGwAllAddress(e.agcConfig.websocketgw_all,t))throw Ve.warn("The agconnect service config websocketgw_all is invalid."),E.build("The agconnect service config websocketgw_all is invalid.");this.loadAgcGwAllAddress(e.agcConfig.agcgw_all,e.agcConfig.websocketgw_all,this.agcRoutePolicy)}this.setContext(e.agcConfig)}return e.loadAgcConfig=function(e){if(!this.isValidContext(e))throw Ve.warn("The agconnect service config is invalid."),E.build("The agconnect service config is invalid.");this.agcConfig=e,this.agcInstance=n.instance().configInstance(this.agcConfig),this.credentialsProvider=this.agcInstance.getService("CredentialsService")},e.getUserInfo=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,n.auth().getCurrentUser()];case 1:return[2,e.sent()]}}))}))},e.isValidContext=function(e){return!!e&&(!!(e.agcgw&&e.client&&e.region)&&(!!Ke.has(e.region)&&!!(e.agcgw.url&&e.agcgw.backurl&&e.agcgw.websocketurl&&e.agcgw.websocketbackurl&&e.client.product_id&&e.client.app_id&&e.client.client_id&&e.client.cp_id)))},e.getAuthorization=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:if(!this.credentialsProvider)throw Ve.error("The credentialsProvider is null."),E.build(1012);return[4,this.credentialsProvider.getToken()];case 1:return[2,"Bearer "+e.sent().tokenString]}}))}))},e.prototype.getHeaderParam=function(t){return l(this,void 0,void 0,(function(){var r,o,s,i,a;return d(this,(function(u){switch(u.label){case 0:return[4,n.auth().getCurrentUser()];case 1:return r=u.sent(),[4,e.getAuthorization()];case 2:return o=u.sent(),s=this.createHeader(o,t),r?(i=s,a=this.escapeHeader,[4,r.getToken(!1)]):[3,4];case 3:i.access_token=a.apply(this,[u.sent().getToken()]),u.label=4;case 4:return[2,s]}}))}))},e.prototype.isValidAgcGwAllAddress=function(e,t){return!!e&&!(!e[Be.get(t)[0]]||!e[Be.get(t)[1]])},e.prototype.createHeader=function(t,n){return{"Content-Type":n?"application/octet-stream":"application/json; charset=UTF-8",authorization:this.escapeHeader(t),client_id:this.escapeHeader(this.context.clientId),productId:this.escapeHeader(this.context.productId),sdkPlatform:Le.getApplicationType(),sdkVersion:Le.getApplicationVersion(),appVersion:e.APP_VERSION}},e.prototype.escapeHeader=function(e){return null==e?void 0:e.replace(/^\w /g,"")},e.prototype.loadAgcGwAddress=function(e){this.websocketUrl="wss://"+e.websocketurl+"/agc/websocket/connection",this.websocketBackUrl="wss://"+e.websocketbackurl+"/agc/websocket/connection",this.httpUrl="https://"+e.url+"/agc/apigw/clouddb/clouddbservice/sync",this.httpBackUrl="https://"+e.backurl+"/agc/apigw/clouddb/clouddbservice/sync"},e.prototype.loadAgcGwAllAddress=function(e,t,n){this.websocketUrl="wss://"+t[Be.get(n)[0]]+"/agc/websocket/connection",this.websocketBackUrl="wss://"+t[Be.get(n)[1]]+"/agc/websocket/connection",this.httpUrl="https://"+e[Be.get(n)[0]]+"/agc/apigw/clouddb/clouddbservice/sync",this.httpBackUrl="https://"+e[Be.get(n)[1]]+"/agc/apigw/clouddb/clouddbservice/sync"},e.prototype.setAppVersion=function(e){this.context.appVersion=e},e.prototype.getSubscribeOptions=function(){return{url:this.websocketUrl}},e.prototype.getSubscribeBackOptions=function(){return{url:this.websocketBackUrl}},e.prototype.getContext=function(){return this.context},e.prototype.getUrl=function(){return this.httpUrl},e.prototype.getBackUrl=function(){return this.httpBackUrl},e.prototype.getAGCRoutePolicy=function(){return this.agcRoutePolicy},e.prototype.setContext=function(e){this.context={productId:e.client.product_id,appId:e.client.app_id,clientId:e.client.client_id,userId:e.client.cp_id,appVersion:0,clientVersion:2}},e.APP_VERSION="003",e}();!function(e){e[e.Boolean=1]="Boolean",e[e.Byte=2]="Byte",e[e.Short=3]="Short",e[e.Integer=4]="Integer",e[e.Long=5]="Long",e[e.Float=6]="Float",e[e.Double=7]="Double",e[e.ByteArray=8]="ByteArray",e[e.String=9]="String",e[e.Date=10]="Date",e[e.Text=11]="Text",e[e.IntAutoIncrement=12]="IntAutoIncrement",e[e.LongAutoIncrement=13]="LongAutoIncrement",e[e.Unknown=14]="Unknown"}(_e||(_e={})),function(e){e.getFieldType=function(e){var t=_e[e];return t||_e.Unknown},e.valueOf=function(e){return e},e.toString=function(e){switch(e){case 1:return"Boolean";case 2:return"Byte";case 3:return"Short";case 4:return"Integer";case 5:return"Long";case 6:return"Float";case 7:return"Double";case 8:return"ByteArray";case 9:return"String";case 10:return"Date";case 11:return"Text";case 12:return"IntAutoIncrement";case 13:return"LongAutoIncrement";default:return"Unknown"}}}(Pe||(Pe={})),function(e){e.World="World",e.Authenticated="Authenticated",e.Creator="Creator",e.Administrator="Administrator"}(ke||(ke={})),function(e){e.getUserRole=function(e){var t=ke[e];return t||ke.World}}(Me||(Me={})),function(e){e[e.None=0]="None",e[e.Read=1]="Read",e[e.Upsert=2]="Upsert",e[e.Delete=4]="Delete"}(je||(je={})),function(e){e.getUserRight=function(e){switch(e){case"Read":return je.Read;case"Upsert":return je.Upsert;case"Delete":return je.Delete;default:return je.None}},e.getAllUserRight=function(t){var n=0;return t.forEach((function(t){var r=e.getUserRight(t);n|=r})),n},e.checkUserRight=function(e,t){return 0!=(e&t)},e.composeUserRight=function(e){var t=0;return e.forEach((function(e){t|=e})),t}}(xe||(xe={}));var ze,Ge=new Set(["rowid","naturalbase_version","naturalbase_syncstatus","naturalbase_deleted","naturalbase_operationtype","naturalbase_accesstime","naturalbase_operationtime","naturalbase_creator","naturalbase_lastmodifier"]),Ye=new Set(["objecttypeinfohelper","t_data_upgrade_info","naturalbase_metadata"]);!function(e){e[e.VALID_VALUE=0]="VALID_VALUE",e[e.INVALID_TYPE=1]="INVALID_TYPE",e[e.INVALID_VALUE=2]="INVALID_VALUE"}(ze||(ze={}));var Qe=new T("SchemaValidators"),He=/(^[a-zA-Z][A-Za-z0-9_]{0,28}[A-Za-z0-9]$)|(^[a-zA-Z]$)/,We=/^[a-zA-Z][A-Za-z0-9_]{0,29}$/,Xe={};function Ze(e,t){Xe[e]=t}function Je(e){var t=e.length;return t<=30&&t>=1?!!He.test(e)||(Qe.warn("[Rule Invalidation] field-name-validation => Field Name is invalid."),!1):(Qe.warn("[Rule Invalidation] Field Name length should not exceed 30"),!1)}Ze("object-has-fields-validation",(function(e){if(0===e.getFieldInfos().size)throw E.build("The object type does not define any field.")})),Ze("field-not-support-notnull-validation",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if(s.isNotNull){if(s.fieldType===_e.Date)throw E.build("Date type can not be set as not null value.");if(s.fieldType===_e.ByteArray)throw E.build("ByteArray type can not be set as not null value.")}}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("field-not-support-default-validation",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if(s.hasDefaultValue){if(s.fieldType===_e.Date)throw E.build("Date type can not be set as default value.");if(s.fieldType===_e.ByteArray)throw E.build("ByteArray type can not be set as default value.")}}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("field-primarykey-not-support-default-validation",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if(s.isPrimaryKey&&s.hasDefaultValue)throw E.build("The primary key is forbidden to set default value.")}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("field-default-not-support-null-validation",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if(s.fieldType!==_e.IntAutoIncrement&&s.fieldType!==_e.LongAutoIncrement&&!s.isPrimaryKey&&s.isNotNull&&!s.hasDefaultValue)throw E.build("The field should be set default value while it is set not null.")}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("field-autoincrement-must-not-null-validation",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if(!s.isNotNull){if(s.fieldType===_e.IntAutoIncrement)throw E.build("IntAutoIncrement type must be set as not null value.");if(s.fieldType===_e.LongAutoIncrement)throw E.build("LongAutoIncrement type must be set as not null value.")}}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("string-text-value-length-validation",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if((s.fieldType===_e.String||s.fieldType===_e.Text)&&!O.isNullOrUndefined(s.defaultValue)&&s.defaultValue.length>200)throw E.build("String default value length cannot be greater than 200.")}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("no-system-property-column",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if(Ge.has(s.fieldName.toLowerCase()))throw E.build("Field name "+s.fieldName+" is invalid.")}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("no-system-table-name",(function(e){var t;if(Ye.has(null===(t=e.name)||void 0===t?void 0:t.toLowerCase()))throw E.build("The object name is invalid.")})),Ze("field-type-validation",(function(e){var t,n,r;try{for(var o=p(e.getFieldInfos().values()),s=o.next();!s.done;s=o.next()){var i=s.value;if((r=i.fieldType)!==_e.Short&&r!==_e.Long&&r!==_e.Integer&&r!==_e.Float&&r!==_e.Double&&r!==_e.String&&r!==_e.Date&&r!==_e.Byte&&r!==_e.ByteArray&&r!==_e.Text&&r!==_e.Boolean&&r!==_e.IntAutoIncrement&&r!==_e.LongAutoIncrement)throw E.build("The type of "+i.fieldName+" field is not supported.")}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}})),Ze("primarykey-require",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){if(o.value.isPrimaryKey)return}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}throw E.build("The class does not have primary key.")})),Ze("field-not-support-primarykey",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if((s.fieldType===_e.Date||s.fieldType===_e.ByteArray||s.fieldType===_e.Text)&&s.isPrimaryKey)throw E.build(Pe.toString(s.fieldType)+" type can not be set as primary key.")}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("no-non-defaultvalue",(function(e){var t,n;try{for(var r=p(e.getFieldInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if(s.hasDefaultValue&&O.isNullOrUndefined(s.defaultValue))throw E.build("The field should be set default value while it is set not null.")}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("index-size-limitation",(function(e){var t,n;try{for(var r=p(e.getIndexInfos().values()),o=r.next();!o.done;o=r.next()){var s=o.value;if(s.indexList.length>5)throw E.build("The count of field for "+s.name+" index exceeds the limit.")}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("index-count-limitation",(function(e){if(h(e.getIndexInfos().values()).length>16)throw E.build("The count of index exceeds the limit.")})),Ze("primarykey-count-limitation",(function(e){if(h(e.getFieldInfos().values()).filter((function(e){return e.isPrimaryKey})).length>5)throw E.build("The count of primary key exceeds the limit.")})),Ze("string-fields-count-limitation",(function(e){if(h(e.getFieldInfos().values()).filter((function(e){return e.fieldType===_e.String})).length>100)throw E.build("The count of string type field exceeds the limit.")})),Ze("field-name-validation",(function(e){var t,n;try{for(var r=p(e.getFieldNames()),o=r.next();!o.done;o=r.next()){var s=o.value;if(!Je(s))throw E.build("Field name "+s+" is invalid.")}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("index-name-validation",(function(e){var t,n;try{for(var r=p(e.getIndexNames()),o=r.next();!o.done;o=r.next()){var s=o.value;if(!We.test(s))throw E.build("Index name "+s+" is invalid.")}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}})),Ze("objecttype-name-validation",(function(e){if(!function(e){if(e.length>30||e.length<1)return Qe.warn("[Rule Invalidation] Table Name length should not exceed 30\n         and less than 1."),!1;if(!He.test(e))return Qe.warn("[Rule Invalidation] Table Name is invalid."),!1;return!0}(e.name))throw E.build("The object name is invalid.")}));var $e={};function et(e,t){$e[e]=t}et(_e.Integer,(function(e){return Number.isInteger(e)?e<-2147483648||e>2147483647?ze.INVALID_VALUE:ze.VALID_VALUE:ze.INVALID_TYPE})),et(_e.String,(function(e){if("string"!=typeof e)return ze.INVALID_TYPE;if(e.length>200)throw E.build("String type length cannot be greater than 200.");if(-1!==e.indexOf("\0")||-1!==e.indexOf("\0"))throw E.build("The string contains illegal character, use the ByteArray type if you intend to send raw bytes.");return ze.VALID_VALUE})),et(_e.Short,(function(e){return Number.isSafeInteger(e)?e<-32768||e>32767?ze.INVALID_VALUE:ze.VALID_VALUE:ze.INVALID_TYPE})),et(_e.Long,(function(e){var t;return O.isNullOrUndefined(e)||"Long"===(null===(t=e.constructor)||void 0===t?void 0:t.name)?ze.VALID_VALUE:ze.INVALID_TYPE})),et(_e.Boolean,(function(e){return"boolean"==typeof e?ze.VALID_VALUE:ze.INVALID_TYPE})),et(_e.Byte,(function(e){return Number.isSafeInteger(e)?e<-128||e>127?ze.INVALID_VALUE:ze.VALID_VALUE:ze.INVALID_TYPE})),et(_e.Float,(function(e){return"number"!=typeof e?ze.INVALID_TYPE:e<-3402823e32||e>3402823e32?ze.INVALID_VALUE:ze.VALID_VALUE})),et(_e.Double,(function(e){return"number"!=typeof e?ze.INVALID_TYPE:Number.isFinite(e)?ze.VALID_VALUE:ze.INVALID_VALUE})),et(_e.ByteArray,(function(e){return e instanceof ArrayBuffer||e instanceof Uint8Array?ze.VALID_VALUE:ze.INVALID_TYPE})),et(_e.Date,(function(e){return e instanceof Date?isNaN(e.getTime())?ze.INVALID_VALUE:ze.VALID_VALUE:ze.INVALID_TYPE})),et(_e.Text,(function(e){if("string"==typeof e){if(-1!==e.indexOf("\0")||-1!==e.indexOf("\0"))throw E.build("The string contains illegal character, use the ByteArray type if you intend to send raw bytes.");return ze.VALID_VALUE}return ze.INVALID_TYPE})),et(_e.IntAutoIncrement,(function(e){return Number.isInteger(e)?e<1||e>2147483647?ze.INVALID_VALUE:ze.VALID_VALUE:ze.INVALID_TYPE})),et(_e.LongAutoIncrement,(function(e){var t;return O.isNullOrUndefined(e)||"Long"===(null===(t=e.constructor)||void 0===t?void 0:t.name)?-1===e.compare(o.fromString("1"))?ze.INVALID_VALUE:ze.VALID_VALUE:ze.INVALID_TYPE}));var tt,nt,rt=function(){function e(t){this.isNeedEncrypt=!1,this.notNull=!1,this.belongPrimaryKey=!1,this.fieldName="",this.fieldType=_e.Unknown,this.signature=-1,this.hasDefaultValue=!1,this.opeName="",t&&(this.parseFieldInfo(t),this.signature=e.hash(this.fieldName))}return e.hash=function(e){for(var t=""+e,n=5381,r=t.length;r;)n=33*n^t.charCodeAt(--r);return Math.abs(n>>>0)},e.prototype.parseFieldInfo=function(e){this.isNeedEncrypt=e.isNeedEncrypt,this.fieldName=e.fieldName,this.notNull=e.notNull,this.belongPrimaryKey=e.belongPrimaryKey,this.fieldType=Pe.getFieldType(e.fieldType),this.isEncryptField&&null!==e.fieldName&&void 0!==e.fieldName&&(this.opeName=-1===e.fieldName.indexOf("#ope")?e.fieldName+"#ope":e.fieldName),Object.prototype.hasOwnProperty.call(e,"defaultValue")&&this.setDefaultValue(e.defaultValue)},e.prototype.setDefaultValue=function(e){switch(this.hasDefaultValue=!0,this.fieldType){case _e.Boolean:this.defaultValue="true"===e;break;case _e.Byte:case _e.Double:case _e.Float:case _e.Integer:case _e.Short:this.defaultValue=Number(e);break;case _e.Long:this.defaultValue=o.fromString(e);break;case _e.String:case _e.Text:this.defaultValue=e}},Object.defineProperty(e.prototype,"isEncryptField",{get:function(){return this.isNeedEncrypt},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isNotNull",{get:function(){return this.notNull},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isPrimaryKey",{get:function(){return this.belongPrimaryKey},enumerable:!1,configurable:!0}),e.prototype.equalTo=function(e){var t,n;if(!e)return!1;var r=Object.getOwnPropertyNames(e);try{for(var s=p(r),i=s.next();!i.done;i=s.next()){var a=i.value;if(this[a]instanceof o&&e[a]instanceof o){var u=this[a],c=e[a];if(!u.equals(c))return!1}else if(this[a]!==e[a])return!1}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}return!0},e}(),ot=function(){function e(e){var t,n;if(this.name="",this.fields=[],this.tableName="",e){this.name=e.indexName;try{for(var r=p(e.indexList),o=r.next();!o.done;o=r.next()){var s=o.value;s.fieldName?this.fields.push(s.fieldName):this.fields.push(s)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}}}return Object.defineProperty(e.prototype,"indexList",{get:function(){return this.fields},enumerable:!1,configurable:!0}),e.prototype.equalTo=function(e){var t,n;if(!e||!this.hasSameBasicInfo(e))return!1;try{for(var r=p(this.fields),o=r.next();!o.done;o=r.next()){var s=o.value;if(e.fields.indexOf(s)<0)return!1}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return!0},e.prototype.hasSameBasicInfo=function(e){return this.name===e.name&&this.tableName===e.tableName&&this.fields.length===e.fields.length},e}(),st=new T("NaturalStoreObjectSchema");!function(e){e[e.MORE_TABLES=1]="MORE_TABLES",e[e.LESS_TABLES=2]="LESS_TABLES",e[e.EQUAL_TABLES=3]="EQUAL_TABLES",e[e.DIFF_TABLES=4]="DIFF_TABLES"}(tt||(tt={})),function(e){e[e.MORE_FIELDS=1]="MORE_FIELDS",e[e.LESS_FIELDS=2]="LESS_FIELDS",e[e.EQUAL_FIELDS=3]="EQUAL_FIELDS",e[e.DIFF_FIELDS=4]="DIFF_FIELDS",e[e.INVALID_INDEX=5]="INVALID_INDEX",e[e.INVALID_SCHEMA=6]="INVALID_SCHEMA"}(nt||(nt={}));var it,at=function(){function e(e,t){var n=this;(this.name_="",this.primaryKeyList=[],this.fieldInfos=new Map,this.indexInfos=new Map,this.permissions=new Map,e)&&(this.name_=t.objectTypeName,t.fields.forEach((function(e){var t=new rt(e);n.fieldInfos.set(t.fieldName,t),t.isPrimaryKey&&n.primaryKeyList.push(t)})),t.indexes.forEach((function(e){var t=new ot(e);n.indexInfos.set(t.name,t)})),e.permissions.forEach((function(e){n.permissions.set(Me.getUserRole(e.role),xe.getAllUserRight(e.rights))})))}return Object.defineProperty(e.prototype,"name",{get:function(){return this.name_},enumerable:!1,configurable:!0}),e.validateObjectSchema=function(e){var t,n;try{for(var r=p(Object.getOwnPropertyNames(Xe)),o=r.next();!o.done;o=r.next()){var s=o.value;Xe[s](e)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return!0},e.prototype.compareFields=function(e){if(!e)return nt.INVALID_SCHEMA;var t=this.compareFieldInfo(e);if(t===nt.DIFF_FIELDS)return nt.INVALID_SCHEMA;var n=this.compareIndexInfo(e);return n===nt.INVALID_INDEX?nt.INVALID_SCHEMA:t===nt.EQUAL_FIELDS&&n===nt.EQUAL_FIELDS?nt.EQUAL_FIELDS:nt.MORE_FIELDS},e.prototype.compareFieldInfo=function(e){var t,n;if(this.fieldInfos.size<e.fieldInfos.size)return nt.MORE_FIELDS;try{for(var r=p(this.fieldInfos.values()),o=r.next();!o.done;o=r.next()){var s=o.value;if(!s.equalTo(e.fieldInfos.get(s.fieldName)))return nt.DIFF_FIELDS}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return nt.EQUAL_FIELDS},e.prototype.compareIndexInfo=function(e){return this.indexInfos.size<e.indexInfos.size?nt.MORE_FIELDS:this.hasSameIndexInfo(e)?nt.EQUAL_FIELDS:nt.INVALID_INDEX},e.prototype.hasSameIndexInfo=function(e){var t,n,r=e.getIndexInfos();try{for(var o=p(this.indexInfos.values()),s=o.next();!s.done;s=o.next()){var i=s.value;if(!i.equalTo(r.get(i.name)))return st.error("HasSameIndexInfo: can not change index of field."),!1}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return!0},e.prototype.getFieldInfo=function(e){return this.fieldInfos.get(e)},e.prototype.getIndexInfo=function(e){return this.indexInfos.get(e)},e.prototype.checkPermission=function(e,t){var n=this.permissions.get(e);return!!n&&xe.checkUserRight(n,t)},e.prototype.getPrimaryKeys=function(){return h(this.fieldInfos.values()).filter((function(e){return e.isPrimaryKey})).map((function(e){return e.fieldName})).sort()},e.prototype.getPrimaryKeyFieldTypes=function(){return this.primaryKeyList},e.prototype.getFieldNames=function(){return h(this.fieldInfos.keys())},e.prototype.getIndexNames=function(){return h(this.indexInfos.keys())},e.prototype.hasCompositePrimaryKey=function(){return this.getPrimaryKeys().length>1},e.prototype.getFieldInfos=function(){return this.fieldInfos},e.prototype.getIndexInfos=function(){return this.indexInfos},e.prototype.setPermission=function(e,t){this.permissions.set(e,t)},e.prototype.isLegalOpeFieldName=function(e){return-1!==e.indexOf("#ope")},e.prototype.isEncryptTable=function(){var e,t;try{for(var n=p(this.fieldInfos.values()),r=n.next();!r.done;r=n.next()){if(r.value.isEncryptField)return!0}}catch(t){e={error:t}}finally{try{r&&!r.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}return!1},e.prototype.getEncryptFieldList=function(){return h(this.fieldInfos.values()).filter((function(e){return e.isEncryptField})).sort()},e}(),ut=new T("SchemaUtils"),ct=function(){function e(){}return e.validateFieldValue=function(e,t){var n=$e[e](t);if(n===ze.INVALID_TYPE)throw E.build("The field type mismatches the value type.");if(n===ze.INVALID_VALUE){var r=Pe.toString(e);throw E.build("The value for a "+r+" column is invalid.")}},e.validateFieldValueForQuery=function(e,t){e===_e.LongAutoIncrement?e=_e.Long:e===_e.IntAutoIncrement&&(e=_e.Integer),this.validateFieldValue(e,t)},e.validateObjectSchema=function(e){var t,n;try{for(var r=p(Object.getOwnPropertyNames(Xe)),o=r.next();!o.done;o=r.next()){var s=o.value;Xe[s](e)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return!0},e.compareSchemas=function(e,t,n,r){if(e>n)throw ut.error("compareSchemas: Object version downgrade is not support. current version: "+e),E.build(21);var o=this.compareTables(t,r);if(e===n){if(o===tt.EQUAL_TABLES)return ut.warn("compareSchemas: ObjectType version and ObjectType has not changed."),!0;throw ut.error("compareSchemas: ObjectType version has not changed, but ObjectType has changed."),E.build(17)}switch(o){case tt.EQUAL_TABLES:throw ut.error("compareSchemas: ObjectType version has changed, but ObjectType has not changed."),E.build(17);case tt.LESS_TABLES:throw ut.error("compareSchemas: Remove ObjectType is not supported."),E.build(17);case tt.DIFF_TABLES:throw ut.error("compareSchemas: cannot modify existing schema when upgrade."),E.build(17);case tt.MORE_TABLES:default:return!1}},e.compareTables=function(e,t){var n,r;if(e.size>t.size)return tt.LESS_TABLES;var o=!1;try{for(var s=p(e.values()),i=s.next();!i.done;i=s.next()){var a=i.value,u=a.name,c=t.get(u),l=a.compareFields(c);if(l!==nt.MORE_FIELDS){if(l===nt.EQUAL_FIELDS)continue;return tt.DIFF_TABLES}o=!0}}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return e.size<t.size||o?tt.MORE_TABLES:tt.EQUAL_TABLES},e}(),lt=new T("NaturalStore"),dt=new Set(["Limit","OrderBy"]),pt=new Set(["Limit","Or","BeginGroup","EndGroup","And"]),ft=new Set(["Or","BeginGroup","EndGroup","EqualTo","And"]),ht=new Set(["BeginGroup","EndGroup","Or","And"]),yt=new Set(["In","Average","Contain","BeginWith","EndWith"]),bt=new Set(["EqualTo","NotEqualTo","GreaterThan","GreaterThanOrEqualTo","LessThan","LessThanOrEqualTo"]),gt=new Set(["IsNull","IsNotNull","OrderBy","Count"]),vt=function(){function e(e,t){this.references=new Set,this.listenerManager=null,this.naturalStoreId=e,this.cloudStorage=t.getNaturalCloudStorage(),this.naturalBaseRef=t,this.listenerManager=new z(t,e)}return e.prototype.releaseNaturalStoreResource=function(){this.listenerManager=null},e.prototype.getNaturalStoreName=function(){return this.naturalStoreId},e.prototype.close=function(){this.releaseNaturalStoreResource()},e.prototype.hasSubscriber=function(){return!(!this.listenerManager||!this.listenerManager.hasListener())},e.prototype.executeUpsert=function(e){return l(this,void 0,void 0,(function(){var t,n;return d(this,(function(r){switch(r.label){case 0:return[4,this.verifyUserInfo()];case 1:r.sent(),r.label=2;case 2:return r.trys.push([2,5,,6]),[4,this.naturalBaseRef.getEntireEncryption().encryptEntireEncryptedFields(e)];case 3:return t=r.sent(),[4,this.cloudStorage.executeUpsert(t,this.naturalStoreId)];case 4:return[2,r.sent()];case 5:return n=r.sent(),[2,Promise.reject(O.isErrorObject(n)?n:E.build(n))];case 6:return[2]}}))}))},e.prototype.executeDelete=function(e){return l(this,void 0,void 0,(function(){var t;return d(this,(function(n){switch(n.label){case 0:return[4,this.verifyUserInfo()];case 1:return n.sent(),[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(O.getClassName(e[0]))];case 2:n.sent(),n.label=3;case 3:return n.trys.push([3,5,,6]),[4,this.cloudStorage.executeDelete(e,this.naturalStoreId)];case 4:return[2,n.sent()];case 5:return t=n.sent(),[2,Promise.reject(O.isErrorObject(t)?t:E.build(t))];case 6:return[2]}}))}))},e.prototype.executeQuery=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o;return d(this,(function(s){switch(s.label){case 0:return this.checkQueryClass(e),[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(e.getClassName())];case 1:s.sent(),s.label=2;case 2:return s.trys.push([2,6,,7]),[4,this.getQueryConditionByString(e.getClassName(),e.getQueryConditions())];case 3:return t=s.sent(),[4,this.cloudStorage.executeQuery(this.naturalStoreId,e.getClassName(),t)];case 4:return n=s.sent(),[4,this.naturalBaseRef.getEntireEncryption().decryptEntireEncryptedFields(e,n)];case 5:return r=s.sent(),[2,new A(r,[],[])];case 6:return o=s.sent(),[2,Promise.reject(O.isErrorObject(o)?o:E.build(o))];case 7:return[2]}}))}))},e.prototype.executeTransactionQuery=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o;return d(this,(function(s){switch(s.label){case 0:return[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(e.getClassName())];case 1:s.sent(),s.label=2;case 2:return s.trys.push([2,6,,7]),[4,this.getQueryConditionByString(e.getClassName(),e.getQueryConditions())];case 3:return t=s.sent(),[4,this.cloudStorage.executeQuery(this.naturalStoreId,e.getClassName(),t)];case 4:return n=s.sent(),[4,this.naturalBaseRef.getEntireEncryption().decryptEntireEncryptedFields(e,n)];case 5:return r=s.sent(),[2,Promise.resolve({objects:n,decryptObjects:r})];case 6:return o=s.sent(),[2,Promise.reject(O.isErrorObject(o)?o:E.build(o))];case 7:return[2]}}))}))},e.prototype.executeAggregateQuery=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s;return d(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),this.verifyAvgQuery(e,n),r=O.deepCopy(e.getQueryConditions()),this.addCondition(r,t,n),[4,this.getQueryConditionByString(e.getClassName(),r)];case 1:return o=i.sent(),[4,this.cloudStorage.executeAggregateQuery(this.naturalStoreId,e.getClassName(),o)];case 2:return[2,i.sent()];case 3:return s=i.sent(),[2,Promise.reject(O.isErrorObject(s)?s:E.build(s))];case 4:return[2]}}))}))},e.prototype.runTransaction=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o;return d(this,(function(s){switch(s.label){case 0:return[4,this.verifyUserInfo()];case 1:return s.sent(),[4,this.getTransactionOperation(n)];case 2:return r=s.sent(),o=O.deepCopy(t),[2,this.cloudStorage.runTransaction(e,o,r)]}}))}))},e.prototype.addSnapshotListener=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s;return d(this,(function(i){switch(i.label){case 0:return this.checkSubscribeQuery(e),[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(e.getClassName())];case 1:i.sent(),i.label=2;case 2:return i.trys.push([2,7,,8]),[4,this.getQueryConditionByString(e.getClassName(),e.getQueryConditions())];case 3:return r=i.sent(),this.listenerManager?[4,this.listenerManager.addListener(e,r,t,n)]:[3,5];case 4:return o=i.sent(),[3,6];case 5:o=0,i.label=6;case 6:return[2,o];case 7:return s=i.sent(),[2,Promise.reject(O.isErrorObject(s)?s:E.build(s))];case 8:return[2]}}))}))},e.prototype.removeSnapshotListener=function(e){var t;return l(this,void 0,void 0,(function(){return d(this,(function(n){switch(n.label){case 0:return[4,null===(t=this.listenerManager)||void 0===t?void 0:t.removeListener(e)];case 1:return n.sent(),[2,0]}}))}))},e.prototype.getAllSubscribeInfo=function(){return this.listenerManager?this.listenerManager.getAllSubscribeInfo():new Map},e.prototype.getSubscribeInfoByCloudSubRecordId=function(e){var t;return null===(t=this.listenerManager)||void 0===t?void 0:t.getSubscribeInfoByRecordId(e)},e.prototype.isSubscribeNotResponsed=function(e){var t=Number(e);return!(""===e||isNaN(t)||!this.listenerManager)&&this.listenerManager.isSubscribeNotResponsed(t)},e.prototype.handleSubscribeRes=function(e,t,n,r){var o,s=null===(o=this.listenerManager)||void 0===o?void 0:o.getSubscribeInfo(t);return s instanceof B&&(s.cloudSubRecordId=n,s.cloudSubKey=r,0!==e)?(s.notify(e,[]),e):0},e.prototype.handleUnsubscribeRes=function(e,t){var n;return 0!==t?t:(null===(n=this.listenerManager)||void 0===n||n.cleanSubscribeInfo(e),0)},e.prototype.handleSubPushRes=function(e,t,n,r){e.notify(t,n,r)},e.prototype.getQueryConditionByString=function(e,t){return l(this,void 0,void 0,(function(){var n,r,s,i,a,u,c,l,f,h,y;return d(this,(function(d){switch(d.label){case 0:n=[],d.label=1;case 1:d.trys.push([1,8,9,10]),r=p(t),s=r.next(),d.label=2;case 2:if(s.done)return[3,7];if("And"===(i=s.value).conditionType)return[3,6];if(this.isInvalidCondition(i))throw lt.error("getQueryConditionByString fail for invalid query condition!"),E.build("Invalid query conditions.");if(a={fieldName:i.fieldName,conditionType:i.conditionType,value:void 0},!(u=this.naturalBaseRef.getDataModelHelper().getFieldInfoByName(e,i.fieldName))&&!pt.has(i.conditionType))throw E.build("The field name does not exist.");if(!(null==u?void 0:u.isEncryptField))return a.fieldType=null==u?void 0:u.fieldType,i.value instanceof Date?a.value=i.value.getTime():i.value instanceof o?a.value=i.value.toString():O.isArray(i.value)?a.value=this.arrayToString(i.value):a.value=i.value,n.push(a),[3,6];if(c=i.conditionType,yt.has(c))throw E.build("Encrypted field does not support "+c+".");return a.fieldName=i.fieldName+"#ope",a.fieldType=_e.String,bt.has(c)?(l=a,[4,this.naturalBaseRef.getEntireEncryption().conditionEntireEncryptedField(e,i.fieldName,u.fieldType,i.value)]):[3,4];case 3:return l.value=d.sent(),[3,5];case 4:a.value=i.value,d.label=5;case 5:n.push(a),d.label=6;case 6:return s=r.next(),[3,2];case 7:return[3,10];case 8:return f=d.sent(),h={error:f},[3,10];case 9:try{s&&!s.done&&(y=r.return)&&y.call(r)}finally{if(h)throw h.error}return[7];case 10:return[2,JSON.stringify({queryConditions:n})]}}))}))},e.prototype.arrayToString=function(e){var t,n,r=[];try{for(var s=p(e),i=s.next();!i.done;i=s.next()){var a=i.value,u=a;a instanceof Date?u=a.getTime():a instanceof o&&(u=a.toString()),r.push(u)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}return r},e.prototype.isInvalidCondition=function(e){return!e.conditionType||!pt.has(e.conditionType)&&!e.fieldName},e.prototype.getTransactionOperation=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o,s,i,a,u,c;return d(this,(function(l){switch(l.label){case 0:t=[],l.label=1;case 1:l.trys.push([1,6,7,8]),n=p(e),r=n.next(),l.label=2;case 2:return r.done?[3,5]:(o=r.value,[4,this.naturalBaseRef.getEntireEncryption().encryptEntireEncryptedFields(o.objects)]);case 3:s=l.sent(),i={operationType:o.operationType,objectTypeName:o.objectTypeName,objects:s},t.push(i),l.label=4;case 4:return r=n.next(),[3,2];case 5:return[3,8];case 6:return a=l.sent(),u={error:a},[3,8];case 7:try{r&&!r.done&&(c=n.return)&&c.call(n)}finally{if(u)throw u.error}return[7];case 8:return[2,Promise.resolve(t)]}}))}))},e.prototype.verifyUserInfo=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,Fe.getUserInfo()];case 1:if(!e.sent())throw lt.error("user is null."),E.build(15);return[2]}}))}))},e.prototype.getAllSubscribeInfos=function(){var e=[],t=0;return this.getAllSubscribeInfo().forEach((function(n){e[t++]=[n.queryId,n.cloudSubRecordId,n.cloudSubKey,n.cloudDBZoneQuery.getClassName()]})),e},e.prototype.verifyAvgQuery=function(e,t){O.checkNotNull(t,"The field name must not be null."),this.checkQueryClass(e);var n=e.getClassName(),r=this.naturalBaseRef.getDataModelHelper().getFieldInfoByName(n,t);if(!r)throw E.build("The field name does not exist.");if(r.isEncryptField)throw E.build("Encrypted field does not support AVG.");switch(r.fieldType){case _e.Byte:case _e.Short:case _e.Integer:case _e.Long:case _e.Float:case _e.Double:case _e.LongAutoIncrement:case _e.IntAutoIncrement:return;default:throw E.build("The field type is not numeric.")}},e.prototype.checkQueryClass=function(e){var t,n;if(O.isNullOrUndefined(e))throw E.build("CloudDBZoneQuery must not be null.");if(!(e instanceof N))throw E.build("The type of input must be CloudDBZoneQuery.");var r=e.getClazz();if("function"!=typeof r)throw E.build("The input parameter is not a class.");if(!e.getQueryConditions())throw lt.warn("checkSubscribeQuery: failed to get conditions array."),E.build("Invalid query conditions.");var o=Object.getOwnPropertyNames(new r);if(O.isEmpty(e.getClassName())||!this.naturalBaseRef.getDataModelHelper().validate(new r))throw E.build(16);var s=this.naturalBaseRef.getDataModelHelper().getFieldInfosByClassName(e.getClassName());if(o.length!==(null==s?void 0:s.size))throw E.build("The field size of input object is different with that of the imported class.");try{for(var i=p(o),a=i.next();!a.done;a=i.next()){var u=a.value;if(!s.has(u))throw E.build("The field does not exist.")}}catch(e){t={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}this.checkConditions(e)},e.prototype.checkConditions=function(e){var t,n;if(0!==e.getDepth())throw E.build("The query beginGroup and endGroup should come in pairs with right direction.");var r=e.getQueryConditions().length;if(r>30)throw E.build("Query type exceeds the limit.");for(var o=0,s=e.getClassName(),i=e.getQueryConditions(),a=0;a<r;a++){var u=i[a];if(ht.has(u.conditionType)&&(o=this.validBeginOrEndGroup(u,i,a,o),this.validOrAndCondition(u,i,a)),dt.has(u.conditionType)&&(0!==o||0!==a&&("And"===i[a-1].conditionType||"Or"===i[a-1].conditionType))){if("OrderBy"===u.conditionType)throw E.build('near "'+u.value+'": syntax error.');throw E.build('near "'+u.conditionType+'": syntax error.')}if(!pt.has(u.conditionType)){O.checkNotNull(u.fieldName,"The field name must not be null.");var c=this.naturalBaseRef.getDataModelHelper().getFieldInfoByName(s,u.fieldName);if(!c)throw E.build("The field name does not exist.");if(!gt.has(u.conditionType)){if(!this.checkConditionTypeAndFieldType(u.conditionType,c.fieldType))throw E.build("The "+_e[c.fieldType]+" type does not support the "+u.conditionType+" operation.");var l=O.convertArray(u.value);try{for(var d=(t=void 0,p(l)),f=d.next();!f.done;f=d.next()){var h=f.value;ct.validateFieldValueForQuery(c.fieldType,h)}}catch(e){t={error:e}}finally{try{f&&!f.done&&(n=d.return)&&n.call(d)}finally{if(t)throw t.error}}}}}},e.prototype.checkConditionTypeAndFieldType=function(e,t){switch(e){case"EqualTo":case"NotEqualTo":return t!==_e.ByteArray;case"GreaterThan":case"GreaterThanOrEqualTo":case"LessThan":case"LessThanOrEqualTo":case"In":return t!==_e.Boolean&&t!==_e.ByteArray;case"BeginWith":case"EndWith":case"Contain":return t===_e.Text||t===_e.String;default:return!1}},e.prototype.checkSubscribeQuery=function(e){this.checkQueryClass(e),this.checkSubscribeCondition(e.getQueryConditions(),e.getClassName())},e.prototype.checkSubscribeCondition=function(e,t){var n,r;this.checkSubscribeConditionSize(e);try{for(var o=p(e),s=o.next();!s.done;s=o.next()){var i=s.value;this.checkSubscribeConditionType(i,t)}}catch(e){n={error:e}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}},e.prototype.checkSubscribeConditionSize=function(e){var t,n,r=e.length;if(r<1||r>30)throw lt.warn("checkSubscribeCondition: invalid condition count: "+r),E.build("Query type exceeds the limit.");var o=0;try{for(var s=p(e),i=s.next();!i.done;i=s.next()){"EqualTo"===i.value.conditionType&&o++}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}if(o<1||o>5)throw lt.warn("checkSubscribeCondition: invalid equalTo condition count: "+o),E.build("Invalid query object. Only support 1 to 5 equalTo conditions.")},e.prototype.checkSubscribeConditionType=function(e,t){if(!ft.has(e.conditionType))throw lt.warn("checkSubscribeConditionType: not support condition: "+e.conditionType),E.build('Invalid query object. Only support EqualTo, BeginGroup, EndGroup, Or and "And" condition.');if(!pt.has(e.conditionType)){var n=this.naturalBaseRef.getDataModelHelper().getFieldInfoByName(t,e.fieldName);if(!n)throw E.build("The field name does not exist.");if(n.fieldType===_e.Text)throw lt.warn("checkSubscribeQuery: not support EqualTo condition on text field."),E.build("Invalid query object. Not support EqualTo condition on text field.")}},e.prototype.getDataModelHelper=function(){return this.naturalBaseRef.getDataModelHelper()},e.prototype.validOrAndCondition=function(e,t,n){if(!("Or"!==e.conditionType&&"And"!==e.conditionType||0!==n&&n!==t.length-1&&"BeginGroup"!==t[n-1].conditionType&&"Or"!==t[n-1].conditionType&&"And"!==t[n-1].conditionType))throw E.build('near "'+e.conditionType+'": syntax error.')},e.prototype.validBeginOrEndGroup=function(e,t,n,r){if("BeginGroup"===e.conditionType&&r++,"EndGroup"===e.conditionType){if(--r<0)throw E.build("The query beginGroup and endGroup should come in pairs with right direction.");var o=t[n-1].conditionType;if("BeginGroup"===o||"Or"===o||"And"===o)throw E.build('near "'+e.conditionType+'": syntax error.')}return r},e.prototype.addCondition=function(e,t,n,r){if(e.length>=30)throw E.build("Query type exceeds the limit.");var o={conditionType:t,fieldName:n,value:r};e.push(o)},e}(),St=new T("CommunicateTask"),mt=function(){function e(e,t,n){this.delayMs=0,this.isCanceled=!1,this.task=e,this.func=e.request,this.delayMs=t,this.handle=n}return e.prototype.execute=function(){var e=this.handle;if(!this.isCanceled)try{this.func.call(this.task)}catch(t){St.error(t),null==e||e.handle(!1,t)}},e.prototype.getDelayMs=function(){return this.delayMs},e.prototype.cleanDelayMs=function(){this.delayMs=0},e.prototype.cancel=function(){this.isCanceled=!0},e}(),Tt=new T("CommunicateTaskQueue"),It=function(){function e(){this.tasks=[],this.taskId=0,this.head=0,this.isShutdown=!1,this.isExecuting=!1}return e.prototype.enqueueTask=function(e){if(this.isShutdown)return Tt.log("[CommunicateTaskQueue] enqueueTask fail due to shutdown!"),-1;var t=++this.taskId;return this.tasks.push(e),this.isExecuting||this.process(),t},e.prototype.process=function(){var e=this;this.isExecuting=!0;var t=this.tasks.splice(0,1);if(0===t.length)this.isExecuting=!1;else{this.head++;var n=t[0];this.timerHandle=setTimeout((function(){return l(e,void 0,void 0,(function(){return d(this,(function(e){return this.timerHandle||clearTimeout(this.timerHandle),n.execute(),this.process(),[2]}))}))}),n.getDelayMs())}},e}(),Rt=function(){function e(e,t){this.listeners=e,this.agcWebsocket=n.instance(t).getService("AGCWebSocketService")}return e.prototype.connect=function(e){if(!e)throw E.build(1003);this.agcWebsocket.connect(e.url,e.header),this.agcWebsocket.onOpen(this.listeners._onopen),this.agcWebsocket.onMessage(this.listeners._onmessage),this.agcWebsocket.onClose(this.listeners._onclose),this.agcWebsocket.onError(this.listeners._onerror)},e.prototype.close=function(e){this.agcWebsocket&&this.agcWebsocket.close((null==e?void 0:e.eventCode)||1e3,e)},e.prototype.sendMessage=function(e){this.agcWebsocket&&this.agcWebsocket.send(e.data)},e}(),Et=new T("WebSocketClient"),wt=0,Ot=45e3,Ct=new Map([[1,"CN"],[2,"DE"],[3,"RU"],[4,"SG"]]);!function(e){e[e.Disconnected=0]="Disconnected",e[e.RequestToConnect=1]="RequestToConnect",e[e.Connecting=2]="Connecting",e[e.Connected=3]="Connected",e[e.Disconnecting=4]="Disconnecting"}(it||(it={}));var Nt,At,Dt=function(){function e(e){this.msgId=0,this.connectionState=it.Disconnected,this.isHeartBeatHasResp=0,this.isReconnecting=!1,this.isInitiativeStop=!1,this.keepaliveTimer=null,this.currentBaseMs=0,this.lastAttemptTime=Date.now(),this.backoffFactor=1.5,this.timerHandler=null,this.deviceId=0,this.currentVersion=0,this.isEnableBackUrl=!1,this.subscribeDatas=new Set,this.encryptRequest=new Set,this.unsubscribeCallbacks=new Map,this.isConnected=new k(!1),this.certificateService=e}return e.prototype.registerConnectCallback=function(e){e&&(this.connectCallback=e)},e.prototype.registerDisconnectCallback=function(e){e&&(this.disconnectCallback=e)},e.prototype.start=function(e,t){if(this.isInitiativeStop=!1,this.keepaliveTimer||this.resetKeepAlive(),this.connectionState!==it.Connected&&this.connectionState!==it.Connecting){Et.info("start enter"),this.connectionState=it.Connecting;var n=this.getWebSocketListeners(t);this.websocketAdapter=new Rt(n,Ct.get(this.certificateService.getAGCRoutePolicy())),this.websocketAdapter.connect(e)}else Et.info("websocket's already started, connectionState: "+this.connectionState)},e.prototype.stop=function(){return l(this,void 0,void 0,(function(){var e,t;return d(this,(function(n){switch(n.label){case 0:return this.connectionState===it.Disconnecting||this.connectionState===it.Disconnected?[2]:[4,this.certificateService.getHeaderParam()];case 1:return e=n.sent(),t={websocketMsgType:"UNREGISTER",websocketMsgId:this.msgId++,websocketMsgBody:{method:"POST",path:"/agc/apigw/clouddb/clouddbservice/sync/unregister",headers:e,body:""}},this.connectionState===it.Connected&&this.simplifiedSendMessage(JSON.stringify(t)),this.connectionState=it.Disconnecting,Et.info("start to stop"),this.websocketAdapter.close(),this.clearKeepAliveTimer(),[2]}}))}))},e.prototype.registerResponseCallback=function(e){e&&(this.responseCallback=e)},e.prototype.notifyResponseCallback=function(e,t){this.responseCallback&&this.responseCallback(e,t)},e.prototype.sendSubscribeRequest=function(e){return l(this,void 0,void 0,(function(){var t;return d(this,(function(n){switch(n.label){case 0:return O.isNotNullObject(e)?(Et.info("sendSubscribeRequest state:"+this.connectionState),this.start(this.certificateService.getSubscribeOptions()),this.connectionState!==it.Connected?(Et.log("sendSubscribeRequest: network is not available, schedule to sendMessages!"),this.subscribeDatas.add(e),[2]):((t=new Set).add(e),Et.log("sendSubscribeRequest start sendMessages"),[4,this.sendMessages(t)])):(Et.error("sendSubscribeRequest: Invalid request, stop to send!"),[2]);case 1:return n.sent(),[2]}}))}))},e.prototype.sendUnsubscribeRequest=function(e,t){return l(this,void 0,void 0,(function(){var n;return d(this,(function(r){switch(r.label){case 0:return O.isNotNullObject(e)?(Et.info("sendUnsubscribeRequest state:"+this.connectionState),this.connectionState===it.Disconnecting||this.connectionState===it.Disconnected?(Et.info("sendUnsubscribeRequest it is not connect state, skip to send unsubscribe request!"),t.call(null),[2]):this.connectionState!==it.Connected?[3,2]:((n=new Set).add(e),Et.log("sendUnsubscribeRequest start sendMessages"),this.unsubscribeCallbacks.set(e.taskId.toString(),t),[4,this.sendMessages(n)])):(Et.error("sendUnsubscribeRequest: Invalid request, stop to send!"),[2]);case 1:return r.sent(),[3,3];case 2:Et.log("sendUnsubscribeRequest connectionState: "+this.connectionState+", skip to send request."),r.label=3;case 3:return[2]}}))}))},e.prototype.getWebSocketListeners=function(e){var t,n=this;return t=this,{_onopen:function(){n.onOpen(t,e)},_onerror:function(e){n.onError(t)},_onclose:function(r,o,s){n.onClose(t,r,e)},_onmessage:function(e){n.onMessage(t,e)}}},e.prototype.onOpen=function(e,t){return l(this,void 0,void 0,(function(){var n,r;return d(this,(function(o){switch(o.label){case 0:return[4,this.certificateService.getHeaderParam()];case 1:return n=o.sent(),Et.info("onOpen enter"),e.connectionState=it.Connected,e.currentVersion=e.currentVersion+1,r={websocketMsgType:"REGISTER",websocketMsgId:this.msgId++,websocketMsgBody:{method:"POST",path:"/agc/apigw/clouddb/clouddbservice/sync/register",params:{_v:le.JSON},headers:n,body:""}},e.simplifiedSendMessage(JSON.stringify(r)),t&&t(),[2]}}))}))},e.prototype.subEncryption=function(e,t){return l(this,void 0,void 0,(function(){var n;return d(this,(function(r){switch(r.label){case 0:return Et.info("subEncryption enter: connectionState: "+this.connectionState),this.start(this.certificateService.getSubscribeOptions()),this.connectionState!==it.Connected?(this.encryptRequest.add(e),Et.info("subEncryption: websocket has not established yet, schedule to add encryption listener!"),[2]):((n=new Set).add(e),[4,this.sendMessages(n)]);case 1:return r.sent(),t&&t(),Et.debug("subEncryption: sendMessages done!"),[2]}}))}))},e.prototype.sendMessages=function(e){return l(this,void 0,void 0,(function(){var t,n=this;return d(this,(function(r){switch(r.label){case 0:return e.size?[4,this.certificateService.getHeaderParam()]:[2];case 1:return t=r.sent(),e.forEach((function(r){r.deviceId=n.deviceId;var o={websocketMsgType:"COMMON_MSG",websocketMsgId:n.msgId++,websocketMsgBody:{method:"POST",path:"/agc/apigw/clouddb/clouddbservice/sync/message",params:{_v:le.JSON},headers:t,body:JSON.stringify(De.serializeMessage(r,n.certificateService))}};e.delete(r),n.simplifiedSendMessage(JSON.stringify(o))})),e.clear(),[2]}}))}))},e.prototype.onError=function(e){Et.info("onError enter"),e.resetConnectionState(),this.disconnectCallback&&this.disconnectCallback(this.isInitiativeStop),Et.debug("onError done")},e.prototype.onClose=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s,i;return d(this,(function(a){Et.info("onClose enter"),e.resetConnectionState(),Et.info("onClose message.code: "+t+" isReconnecting: "+e.isReconnecting),n&&n(),this.disconnectCallback&&(Et.info("onClose disconnectCallback is called"),this.disconnectCallback(this.isInitiativeStop)),Et.info("onClose done"),this.msgId=0,Et.info("Start release all unsubscribeCallbacks.");try{for(r=p(this.unsubscribeCallbacks.values()),o=r.next();!o.done;o=r.next())o.value.call()}catch(e){s={error:e}}finally{try{o&&!o.done&&(i=r.return)&&i.call(r)}finally{if(s)throw s.error}}return this.unsubscribeCallbacks.clear(),Et.info("Release all unsubscribeCallbacks success."),[2]}))}))},e.prototype.resetConnectionState=function(){this.clearKeepAliveTimer(),this.connectionState=it.Disconnected,this.isConnected.value=!1},e.prototype.isReconnectingState=function(){return this.isReconnecting},e.prototype.sizeof=function(e){var t,n,r,o=0;for(n=0,r=e.length;n<r;n++)o+=(t=e.charCodeAt(n))<=127?1:t<=2047?2:t<=65535?3:4;return o},e.prototype.onMessage=function(e,t){if(Et.info("onMessage enter"),t){var n=void 0;try{n=JSON.parse(t)}catch(e){return void Et.error("onMessage: fail ,parse data failed, type =  "+typeof t+".")}Object.prototype.hasOwnProperty.call(n,"websocketMsgType")?this.handleAGCMessage(n,e,this):Et.warn("Unknown websocket message length = "+(null==t?void 0:t.length))}},e.prototype.handleAGCMessage=function(e,t,n){Et.info("receive agc push message msgId: "+e.websocketMsgId);var r=this.getAGCMsgHandlerMap().find((function(t){return t.agcMessageType===e.websocketMsgType}));r?(Et.info("handleAGCMessage websocketMsgType: "+e.websocketMsgType),r.handler(e,t,n)):Et.debug("handleAGCMessage: useless agcMessage responseType: "+(null==e?void 0:e.websocketMsgType))},e.prototype.getAGCMsgHandlerMap=function(){var e=this;return[{agcMessageType:"REGISTER_RSP",handler:function(t,n,r){var o=e.parseJson(t.websocketMsgBody.body).channelId;o&&(r.setDeviceId(o),r.resubscribeAll(),r.connectCallback&&r.connectCallback())}},{agcMessageType:"HEARTBEAT_RSP",handler:function(e,t,n){n.isHeartBeatHasResp=0;var r=1e3*Math.floor(e.websocketChannelIdleTimeout/3);Ot!==r&&(Ot=r,n.resetKeepAlive())}},{agcMessageType:"NOTIFY_MSG",handler:function(t,n,r){r.simplifiedSendMessage(JSON.stringify({websocketMsgType:"NOTIFY_MSG_RSP",websocketMsgId:t.websocketMsgId,websocketMsgBody:{status:200,body:"ok"}}));var o=e.parseJson(t.websocketMsgBody.body),s=o.msgInfo,i=s.id,a=s.type;a&&(e.unsubscribeCallbacks.delete(i),a!==g.QUERY_SUB&&a!==g.QUERY_UNSUB||Et.debug("TrafficStatistics:"+wt+++".Receiver                         "+e.sizeof(t.websocketMsgBody.body)+"B."),n.notifyResponseCallback(!0,o))}}]},e.prototype.sendHeartBeatMessage=function(){var e=this,t=this;if(t.isHeartBeatHasResp++,this.connectionState===it.Connected){var n={websocketMsgType:"HEARTBEAT",websocketMsgId:this.msgId++};setTimeout((function(){Et.debug("start check heartBeat response."),t.isHeartBeatHasResp>2&&(Et.warn("heartBeat timeout, lost "+t.isHeartBeatHasResp+" package."),e.connectionState=it.Disconnecting,e.websocketAdapter.close({eventCode:3001})),Et.debug("check heartBeat response finish.")}),1e4),this.simplifiedSendMessage(JSON.stringify(n))}},e.prototype.resetKeepAlive=function(){var e=this;this.clearKeepAliveTimer(),Et.debug("resetKeepAlive enter."),this.sendHeartBeatMessage(),this.keepaliveTimer=setInterval((function(){e.sendHeartBeatMessage()}),Math.floor(Ot))},e.prototype.parseJson=function(e){var t={};if("string"!=typeof e)return Et.warn("parse json type error for"+typeof e),t;try{t=JSON.parse(e)}catch(t){Et.warn("Parse json error for"+t+",message length ="+(null==e?void 0:e.length))}return t},e.prototype.needReconnect=function(){return this.connectionState!==it.Connected&&!this.isInitiativeStop},e.prototype.reconnect=function(){var e=this,t=Math.floor(1.5*this.currentBaseMs),n=Math.max(0,Date.now()-this.lastAttemptTime),r=Math.max(0,t-n);this.lastAttemptTime=Date.now(),Et.info("reconnect enter: remainingDelayMs: "+r+" connState: "+this.connectionState);var o=this.isEnableBackUrl?this.certificateService.getSubscribeBackOptions():this.certificateService.getSubscribeOptions();this.isEnableBackUrl=!this.isEnableBackUrl,this.timerHandler=setTimeout((function(){e.start(o,(function(){e.needReconnect()?(clearTimeout(e.timerHandler),e.isReconnecting=!0,e.reconnect()):(e.currentBaseMs=0,e.isReconnecting=!1)}))}),r),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<1e3&&(this.currentBaseMs=1e3),this.currentBaseMs>6e4&&(this.currentBaseMs=6e4)},e.prototype.clearKeepAliveTimer=function(){this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null)},e.prototype.stopHeartBeat=function(){this.isInitiativeStop=!0,this.clearKeepAliveTimer()},e.prototype.resubscribeAll=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return Et.info("schedule to resubscribeAll: "+this.encryptRequest.size+" "+this.subscribeDatas.size),[4,this.sendMessages(this.encryptRequest)];case 1:return e.sent(),[4,this.sendMessages(this.subscribeDatas)];case 2:return e.sent(),[2]}}))}))},e.prototype.simplifiedSendMessage=function(e,t,n){var r={data:e,success:t||function(){},fail:n||function(){}};Et.info("simplifiedSendMessage sendMessage"),this.websocketAdapter.sendMessage(r)},e.prototype.setDeviceId=function(e){this.deviceId=e,this.currentVersion++},e}(),_t=X.SyncResponseMessage,Pt=new T("SyncRequestProcessor"),kt=function(){function e(e){var t=this;this.webSocketResponse=new Map,this.taskMap=new Map,this.communicateTaskQueue=new It,this.subscribeTaskIdSet=new Set,this.subscribeRecordSet=new Set,this.certificateService=e,this.webSocketClient=new Dt(e),this.webSocketClient.registerResponseCallback((function(e,n){t.onWebSocketResponse(e,n)}))}return e.generateTaskId=function(){return this.taskId=this.taskId.add(1),this.taskId},e.prototype.registerConnectCallback=function(e){var t=this;this.webSocketClient.registerConnectCallback((function(){t.hasSubscriber()&&(Pt.info("do clear subscribes onConnect."),t.clearSubscriber()),e.call(null)}))},e.prototype.registerDisconnectCallback=function(e){var t=this;this.webSocketClient.registerDisconnectCallback((function(n){t.needToConnectWebSocket()&&!t.webSocketClient.isReconnectingState()&&(Pt.info("do reconnect when there is Subscriber or encryptionMonitor onDisconnect."),t.webSocketClient.reconnect()),e.call(null,n)}))},e.prototype.registerWebSocketCallBack=function(e,t){var n,r;t.syncRequest&&t.syncRequest.taskId?this.taskMap.set((null===(r=null===(n=t.syncRequest)||void 0===n?void 0:n.taskId)||void 0===r?void 0:r.toString())||-1,t):this.webSocketResponse.set(e,t)},e.prototype.process=function(e){if(0!==this.verifyRequest())return Pt.warn("invalid request!"),void e.handle(1,new ce);this.communicateTaskQueue.enqueueTask(new mt(e,0,e.handle))},e.prototype.verifyRequest=function(){var e=this.certificateService.getContext();return O.isEmpty(e)?1014:e.productId?0:1014},e.prototype.onWebSocketResponse=function(e,t){var n,r,o,s,i,a=this;if(e){var u=_t.fromObject(t),c=Le.getWSocketMessageType(u),l={responseCode:(null===(n=u.resInfo)||void 0===n?void 0:n.resCode)||0,responseType:null===(r=u.msgInfo)||void 0===r?void 0:r.type,taskId:null===(o=u.msgInfo)||void 0===o?void 0:o.id,storeName:null===(i=null===(s=u.msgInfo)||void 0===s?void 0:s.opStore)||void 0===i?void 0:i.storeName},d=O.isNullOrUndefined(l.taskId)||l.taskId<=0?-1:l.taskId;Pt.info("onWebSocketResponse taskId: "+d+" responseType: "+l.responseType+"            dataType:"+c),(-1===d?h(this.webSocketResponse).filter((function(e){var t=f(e,2),n=t[0];t[1];return n===c})):h(this.taskMap).filter((function(e){var t=f(e,2),n=t[0];t[1];return n===d.toString()}))).forEach((function(e){var t=f(e,2);t[0];t[1].onResponse(u,l,a)})),-1!==d&&this.taskMap.delete(d.toString())}else Pt.error("onWebSocketResponse: fail!")},e.prototype.getSubscribeTaskIdSet=function(){return this.subscribeTaskIdSet},e.prototype.getSubscribeRecordSet=function(){return this.subscribeRecordSet},e.prototype.clearSubscriber=function(){this.subscribeRecordSet.clear(),this.subscribeTaskIdSet.clear()},e.prototype.hasSubscriber=function(){return 0!==this.subscribeRecordSet.size||0!==this.subscribeTaskIdSet.size},e.prototype.needToDisconnectWebsocket=function(){return!this.hasSubscriber()&&!this.encryptionInfoPush},e.prototype.needToConnectWebSocket=function(){return this.hasSubscriber()||!!this.encryptionInfoPush},e.prototype.disConnectWebSocket=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,this.webSocketClient.stop()];case 1:return e.sent(),[2]}}))}))},e.prototype.tryToDisconnectWebsocket=function(){this.encryptionInfoPush=void 0,this.hasSubscriber()?Pt.info("[tryToDisconnectWebsocket] won't disconnect websocket since there's subscriber!"):(this.webSocketClient.stop(),Pt.info("[tryToDisconnectWebsocket] since has no subscriber!"))},e.prototype.addEncryptStatusMonitor=function(e){this.encryptionInfoPush=e},e.prototype.getEncryptionInfoPush=function(){return this.encryptionInfoPush},e.prototype.getWebSocketClient=function(){return this.webSocketClient},e.taskId=o.fromNumber(1),e}(),Mt=function(){function e(){this.taskId_=kt.generateTaskId(),this.encryptionVersion_=0,this.schemas_=[]}return Object.defineProperty(e.prototype,"schemas",{get:function(){return this.schemas_},set:function(e){this.schemas_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"requestSubType",{get:function(){return this.requestSubType_},set:function(e){this.requestSubType_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"requestType",{get:function(){return this.requestType_},set:function(e){this.requestType_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"naturalStoreName",{get:function(){return this.naturalStoreName_},set:function(e){this.naturalStoreName_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"taskId",{get:function(){return this.taskId_},set:function(e){this.taskId_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"encryptionVersion",{get:function(){return this.encryptionVersion_},set:function(e){this.encryptionVersion_=e},enumerable:!1,configurable:!0}),e}(),jt=function(e){function t(){var t=e.call(this)||this;return t.requestType=g.SCHEMA_NEGOTIATE,t}return c(t,e),t}(Mt),xt=function(e){function t(){var t=e.call(this)||this;return t.subscribeDatas_=[],t.requestType=g.QUERY_SUB,t}return c(t,e),Object.defineProperty(t.prototype,"subscribeDatas",{get:function(){return this.subscribeDatas_},set:function(e){this.subscribeDatas_=e},enumerable:!1,configurable:!0}),t}(Mt),Ut=function(){function e(){this.snapshotObjs_=[]}return Object.defineProperty(e.prototype,"naturalStoreName",{get:function(){return this.naturalStoreName_},set:function(e){this.naturalStoreName_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tableName",{get:function(){return this.tableName_},set:function(e){this.tableName_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subscribeId",{get:function(){return this.subscribeId_},set:function(e){this.subscribeId_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subscribeCondition",{get:function(){return this.subscribeCondition_},set:function(e){this.subscribeCondition_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"snapshotObjs",{get:function(){return this.snapshotObjs_},set:function(e){this.snapshotObjs_=e},enumerable:!1,configurable:!0}),e}(),qt=function(e){function t(){var t=e.call(this)||this;return t.objectList_=[],t.requestType=g.OBJECT_UPDATE,t}return c(t,e),Object.defineProperty(t.prototype,"objList",{get:function(){return this.objectList_},set:function(e){this.objectList_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"operationType",{get:function(){return this.operationType_},set:function(e){this.operationType_=e},enumerable:!1,configurable:!0}),t}(Mt),Lt=function(e){function t(){var t=e.call(this)||this;return t.requestType=g.OBJECT_QUERY,t}return c(t,e),Object.defineProperty(t.prototype,"tableName",{get:function(){return this.tableName_},set:function(e){this.tableName_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"queryCondition",{get:function(){return this.queryCondition_},set:function(e){this.queryCondition_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"queryType",{get:function(){return this.queryType_},set:function(e){this.queryType_=e},enumerable:!1,configurable:!0}),t}(Mt),Kt=function(e){function t(){var t=e.call(this)||this;return t.verifyObjects_=[],t.transactionDatas_=[],t.requestType=g.TRANSACTION,t}return c(t,e),Object.defineProperty(t.prototype,"verifyObjects",{get:function(){return this.verifyObjects_},set:function(e){this.verifyObjects_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"transactionDatas",{get:function(){return this.transactionDatas_},set:function(e){this.transactionDatas_=e},enumerable:!1,configurable:!0}),t}(Mt),Bt=function(e){function t(){var t=e.call(this)||this;return t.unSubscribeDatas_=[],t.requestType=g.QUERY_UNSUB,t}return c(t,e),Object.defineProperty(t.prototype,"unSubscribeDatas",{get:function(){return this.unSubscribeDatas_},set:function(e){this.unSubscribeDatas_=e},enumerable:!1,configurable:!0}),t}(Mt),Vt=function(){function e(){}return Object.defineProperty(e.prototype,"naturalStoreName",{get:function(){return this.naturalStoreName_},set:function(e){this.naturalStoreName_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"tableName",{get:function(){return this.tableName_},set:function(e){this.tableName_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cloudSubRecordId",{get:function(){return this.cloudSubRecordId_},set:function(e){this.cloudSubRecordId_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cloudSubKey",{get:function(){return this.cloudSubKey_},set:function(e){this.cloudSubKey_=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"subscribeId",{get:function(){return this.subscribeId_},set:function(e){this.subscribeId_=e},enumerable:!1,configurable:!0}),e}(),Ft=function(){},zt=function(e){function t(t,n,r){var o=e.call(this)||this;return o.syncRequest=t,o.handle=n,o.syncProcessor=r,o}return c(t,e),t}(Ft),Gt=new T("SubscribeTask"),Yt=function(e){function t(t,n,r,o){var s=e.call(this,t,r,o)||this;return s.syncRequest.encryptionVersion=n,s.onSubscribeResponse=r,s}return c(t,e),t.prototype.onResponse=function(e,t,n){var r,o=[];e.subResMsg.forEach((function(t){var r,s;s=1004008===(null===(r=e.resInfo)||void 0===r?void 0:r.resCode)?1004008:t.subResCode,o.push({cloudSubRecordId:null==t?void 0:t.subRecId,subscribeId:null==t?void 0:t.subId,subKey:null==t?void 0:t.subKey,result:s,subResponseCode:t.subResCode}),(null==t?void 0:t.subRecId)&&n.getSubscribeRecordSet().add(null==t?void 0:t.subRecId)})),t.response={subscribeResults:o},n.getSubscribeTaskIdSet().has(e.msgInfo.id.toString())&&(Gt.info("[onResponse] subscribeTaskIdSet size : "+n.getSubscribeTaskIdSet().size),n.getSubscribeTaskIdSet().delete(e.msgInfo.id.toString())),Gt.info("[onResponse] subscribeResults size : "+o.length),null===(r=this.onSubscribeResponse)||void 0===r||r.call(null,0,t)},t.prototype.request=function(){var e,t,n;Gt.info("[request] taskId: "+this.syncRequest.taskId+"             requestType: "+this.syncRequest.requestType),this.syncRequest.taskId&&(null===(e=this.syncProcessor)||void 0===e||e.getSubscribeTaskIdSet().add(this.syncRequest.taskId.toString())),Gt.info("[request] subscribeRecordSet len: "+(null===(t=this.syncProcessor)||void 0===t?void 0:t.getSubscribeRecordSet().size)),null===(n=this.syncProcessor)||void 0===n||n.getWebSocketClient().sendSubscribeRequest(this.syncRequest)},t}(zt),Qt=function(){function e(){}return e.prototype.request=function(e){var t=e;this.realRequest(t)},e}(),Ht=new T("AGCHttpsAdapter"),Wt=new(function(e){function t(){return e.call(this)||this}return c(t,e),t.prototype.getService=function(){return this.service||(this.service=n.instance().getService("AGCNetworkService")),this.service},t.prototype.realRequest=function(e){var t=this,n=e.url,r=e.backUrl,o=e.method,s=e.header,i=e.data,a=e.success?e.success:function(e){},u=e.fail?e.fail:function(e){};this.internalRequest(n,o,s,i).then((function(e){var n=e.status;n>=200&&n<300?a({statusCode:n,data:e.data}):(Ht.warn("[AGC Http Adapter fail] =>"+n+" "+e.statusText),t.retryRequest(r,o,s,i,a,u))})).catch((function(e){t.retryRequest(r,o,s,i,a,u)}))},t.prototype.internalRequest=function(e,t,n,r){var o=r instanceof ArrayBuffer?{responseType:"arraybuffer",timeout:6e4}:{};switch(t){case"DELETE":return this.getService().delete(e,void 0,n,o);case"GET":return this.getService().get(e,void 0,n,o);case"POST":return this.getService().post(e,r,n,o);case"PUT":return this.getService().put(e,r,n,o);default:return Promise.reject({status:405})}},t.prototype.retryRequest=function(e,t,n,r,o,s){this.internalRequest(e,t,n,r).then((function(e){var t=e.status;t>=200&&t<300?o({statusCode:t,data:e.data}):(Ht.warn("[AGC Http Adapter fail] =>"+t+" "+e.statusText),s({status:t,statusText:e.statusText}))})).catch((function(e){s(e)}))},t}(Qt)),Xt=new T("HttpClient"),Zt=function(){function e(e){this.productId="",this.certificateService=e}return e.prototype.send=function(e,t,n,r){return l(this,void 0,void 0,(function(){return d(this,(function(o){switch(o.label){case 0:return O.isEmpty(this.certificateService.getContext())?(r(!1,E.build(1003)),[2]):(this.productId=this.certificateService.getContext().productId,!this.productId?(r(!1,E.build(1003)),[2]):[4,this.processRequest(this.certificateService.getUrl()+e,this.certificateService.getBackUrl()+e,t,n,r)]);case 1:return o.sent(),[2]}}))}))},e.prototype.processRequest=function(e,t,n,r,o){return l(this,void 0,void 0,(function(){var s,i,a;return d(this,(function(u){switch(u.label){case 0:return s=r instanceof ArrayBuffer,i=s?r:JSON.stringify(r),[4,this.certificateService.getHeaderParam(s)];case 1:return void 0===(a=u.sent())?(o(!1,E.build(1013)),[2]):(this.requestForSync(e,t,n,i,a,o),[2])}}))}))},e.prototype.requestForSync=function(e,t,n,r,o,s){var i={url:e,backUrl:t,method:n,header:o,data:r,success:function(e){s(!0,e.data),Xt.log("requestForSync: success!")},fail:function(e){if(Xt.error("HTTPS request process failed."),"string"!=typeof e)if(413!==e.status)s(!1,E.build(1011));else{Xt.error("Request entity is too large.");var t=E.build(1006);s(!1,t)}else s(!1,E.build(e))}};Xt.info("HTTP_ADAPTER send request"),Wt.request(i)},e}(),Jt=new T("HttpRequestTask"),$t=new Map([[g.SCHEMA_NEGOTIATE,"/negotiate"],[g.OBJECT_UPDATE,"/upsert"],[g.CACHE_UPDATE,"/upsert"],[g.OBJECT_QUERY,"/query"],[g.TRANSACTION,"/transaction"],[g.ENCRYPTION_TASK,"/encryption"]]),en=function(e){function t(t,n,r,o){var s=e.call(this)||this;return s.syncRequest=t,s.certificateService=r,s.syncRequest.encryptionVersion=n,s.handle=o,s}return c(t,e),t.prototype.request=function(){var e=this;Jt.info("[request] taskId:"+this.syncRequest.taskId+"             requestType: "+this.syncRequest.requestType+" encryptType: "+this.syncRequest.requestSubType);var n=$t.get(this.syncRequest.requestType);this.syncRequest.requestType!==g.STORE_CLOSING&&t.httpResponseMap.set(this.syncRequest.taskId.toString(),this.handle),n?new Zt(this.certificateService).send(n.toString()+"?_v="+le.PROTOBUF,"POST",De.serializeMessage(this.syncRequest,this.certificateService),(function(n,r){var o;Jt.info("[request] isSuccess: "+n),n?O.isArrayBuffer(r)?e.onResponse(r):(Jt.warn("[request] Illegal http response content type = "+typeof r),Jt.warn(""+E.build(1010))):(null===(o=t.httpResponseMap.get(e.syncRequest.taskId.toString()))||void 0===o||o.call(null,r.code,new ce),t.httpResponseMap.delete(e.syncRequest.taskId.toString()))})):Jt.warn("request: requestType is not contained in REQUEST_URL_MAP!")},t.prototype.onResponse=function(e){var n,r=De.deserializeMessage(e);0!==r.responseCode&&Jt.warn("[request] CloudSyncResultCode = "+r.responseCode),Jt.info("[request] taskId: "+r.taskId+" responseType: "+r.type+"             httpResponseMap size: "+t.httpResponseMap.size),t.httpResponseMap.has(r.taskId.toString())?(null===(n=t.httpResponseMap.get(r.taskId.toString()))||void 0===n||n.call(null,r.responseCode,r),t.httpResponseMap.delete(r.taskId.toString())):Jt.warn("[request]: callback of the taskId has no register")},t.httpResponseMap=new Map,t}(Ft),tn=new T("UnSubscribeTask"),nn=function(e){function t(t,n,r,o){var s=e.call(this,t,r,o)||this;return s.syncRequest.encryptionVersion=n,s.onUnSubscribeResponse=s.handle,s}return c(t,e),t.prototype.onResponse=function(e,t,n){var r,o,s=[];null===(r=e.unSubResMsg)||void 0===r||r.forEach((function(e){s.push({cloudSubRecordId:null==e?void 0:e.unSubRecId,ExceptionCode:null==e?void 0:e.unSubResCode})})),t.response={unSubScribeResults:s},tn.info("[onResponse] unSubScribeResults size: "+s.length+"             subscribeRecordSet.size "+n.getSubscribeRecordSet().size),null===(o=this.onUnSubscribeResponse)||void 0===o||o.call(null,0,t),n.needToDisconnectWebsocket()&&(tn.info("[onResponse] stopHeartBeat since there is no subscriber."),n.getWebSocketClient().stopHeartBeat())},t.prototype.request=function(){var e,t,n,r,o,s=this;tn.info("[request] taskId: "+this.syncRequest.taskId+"             requestType:"+this.syncRequest.requestType);try{for(var i=p(this.syncRequest.unSubscribeDatas),a=i.next();!a.done;a=i.next()){var u=a.value;null===(n=this.syncProcessor)||void 0===n||n.getSubscribeRecordSet().delete(u.cloudSubRecordId)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}tn.info("[request] subscribeRecordSet.size "+(null===(r=this.syncProcessor)||void 0===r?void 0:r.getSubscribeRecordSet().size));var c=[];null===(o=this.syncProcessor)||void 0===o||o.getWebSocketClient().sendUnsubscribeRequest(this.syncRequest,(function(){s.syncRequest.unSubscribeDatas.forEach((function(e){c.push({cloudSubRecordId:e.cloudSubRecordId,errorCode:0})}));var e={responseCode:0,responseType:s.syncRequest.requestType,taskId:s.syncRequest.taskId,storeName:s.syncRequest.naturalStoreName,response:{unSubScribeResults:c}};s.onUnSubscribeResponse.call(null,0,e)}))},t}(zt),rn=new T("CallbackTask"),on=function(){function e(){this.timerHandler=void 0,this.timeoutMs=0,this.isDone=!1}return e.prototype.timeoutMonitor=function(e){var t=this;rn.debug("timeoutMonitor: enter"),this.timeoutMs>0&&(this.timerHandler=setTimeout((function(){t.timerHandler&&clearTimeout(t.timerHandler),rn.log("timeoutMonitor: setTimeout reject isDone:"+t.isDone),t.isDone||(rn.log("timeoutMonitor: setTimeout reject"),e(1004))}),this.timeoutMs))},e.prototype.execute=function(e){return l(this,void 0,void 0,(function(){var t=this;return d(this,(function(n){return[2,new Promise((function(n,r){t.timeoutMonitor(r),l(t,void 0,void 0,(function(){return d(this,(function(t){return rn.log("executeWithTimeout: handle start calling"),[2,null==e?void 0:e.call(null)]}))})).then((function(e){t.isDone=!0,t.timerHandler&&clearTimeout(t.timerHandler),rn.debug("executeWithTimeout: handle finished calling: resultCode = "+e.resultCode),n(e)})).catch((function(e){t.isDone=!0,r(e)}))}))]}))}))},e.prototype.executeWithTimeout=function(e,t){return l(this,void 0,void 0,(function(){var n,r;return d(this,(function(o){switch(o.label){case 0:this.timeoutMs=e,rn.debug("executeWithTimeout: enter"),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.execute(t)];case 2:return n=o.sent(),[3,4];case 3:return r=o.sent(),this.isDone||rn.error("executeWithTimeout: timeout!"),n=r,[3,4];case 4:return rn.debug("executeWithTimeout: execute done resultCode = "+n.resultCode),[2,n]}}))}))},e}(),sn=function(e){function t(t,n,r){var o=e.call(this)||this;return o.requestInfo_=[],o.taskId_=r,o.requestType=g.ENCRYPTION_TASK,o.requestSubType=t,o.requestInfo_=n,o}return c(t,e),Object.defineProperty(t.prototype,"requestInfo",{get:function(){return this.requestInfo_},enumerable:!1,configurable:!0}),t}(Mt),an=new T("MonitorTask"),un=function(e){function t(t,n,r,o){var s=e.call(this,t,r,o)||this;return s.syncRequest.encryptionVersion=n,s}return c(t,e),t.prototype.onResponse=function(e,t,n){var r=e.msgInfo;if(r){var o=r.subType,s=e.enResInfo,i=null==s?void 0:s.length;an.info("[onResponse] messageType: "+o+" encryptionInfoList size:"+i),t.response={encryptionInfoList:e.enResInfo,encryptionMessageType:o},o===v.MONITOR_USER_COMMAND_CHANGE?this.userCommandMonitorResponse(0,t):o===v.MONITOR_DATA_KEY_CHANGE&&this.userKeyMonitorResponse(0,t)}else an.error("[onResponse] invalid encryptionResponseMessage!")},t.prototype.request=function(){an.info("MonitorTask taskId: "+this.syncRequest.taskId+"             encryptType: "+this.syncRequest.requestSubType),this.syncRequest.requestSubType===v.MONITOR_USER_COMMAND_CHANGE?this.commandMonitor(this.syncRequest,this.handle):this.syncRequest.requestSubType===v.MONITOR_DATA_KEY_CHANGE?this.userKeyMonitor(this.syncRequest,this.handle):an.warn("MonitorTask taskId: "+this.syncRequest.taskId+" is not need to call")},t.prototype.commandMonitor=function(e,t){var n;null===(n=this.syncProcessor)||void 0===n||n.getWebSocketClient().subEncryption(e,(function(){an.info("commandMonitorTask: add user command changed monitor success!")})),this.userCommandMonitorResponse=t},t.prototype.userKeyMonitor=function(e,t){var n;null===(n=this.syncProcessor)||void 0===n||n.getWebSocketClient().subEncryption(e,(function(){an.info("userKeyMonitorTask: add user key changed monitor success!")})),this.userKeyMonitorResponse=t},t}(zt),cn=new T("EncryptTaskManager"),ln=function(){function e(e,t){this.encryptTaskCacheMap=new Map,this.syncProcess=e,this.naturalBaseRef=t,this.naturalBaseRef.getEntireEncryptInterval().saveEncryptTaskManager(this)}return e.prototype.clearEncryptInfo=function(e){e.forEach((function(e){e.clear()})),e.length=0},e.prototype.addEncryptionListener=function(e){return l(this,void 0,void 0,(function(){var t,n=this;return d(this,(function(r){switch(r.label){case 0:return[4,this.processEncryptionTask(v.MONITOR_USER_COMMAND_CHANGE,[])];case 1:return 0!==(t=r.sent()).resultCode?(cn.error("addEncryptionListener: add user command monitor fail: "+t.resultCode),[2]):[4,this.processEncryptionTask(v.MONITOR_DATA_KEY_CHANGE,[])];case 2:return 0!==(t=r.sent()).resultCode?(cn.error("addEncryptionListener: add data key monitor fail: "+t.resultCode),[2]):(this.syncProcess.addEncryptStatusMonitor((function(t,r){0===t?(cn.info("addEncryptionListener: receive notification success."),n.handleEncryptPushMessage(r,e)):cn.warn("addEncryptionListener: get notification fail for "+t+".")})),cn.info("addEncryptionListener: add user encryption changed monitor success!"),[2])}}))}))},e.prototype.tryToDisconnectWhenClearUserKey=function(){this.syncProcess.tryToDisconnectWebsocket()},e.prototype.processEncryptionTask=function(t,n){return l(this,void 0,void 0,(function(){var r,o,s,i=this;return d(this,(function(a){switch(a.label){case 0:return r=kt.generateTaskId(),o=new dn(t,r,n),this.encryptTaskCacheMap.set(r.toString(),o),cn.info("processEncryptionTask: taskId: "+r+" encryptType: "+t),[4,o.executeWithTimeout(e.ENCRYPT_TASK_TIMEOUT_IN_MILLISECOND,(function(){return l(i,void 0,void 0,(function(){var e;return d(this,(function(t){switch(t.label){case 0:return e=new sn(o.requestSubType,o.requestInfo,o.taskId),[4,this.onEncryptTask(e)];case 1:return[2,t.sent()]}}))}))}))];case 1:return s=a.sent(),cn.info("processEncryptionTask resultCode:"+s.resultCode),[2,s]}}))}))},e.prototype.onEncryptTask=function(e){return l(this,void 0,void 0,(function(){var t=this;return d(this,(function(n){switch(n.label){case 0:return[4,new Promise((function(n,r){var o,s=function(e,o){if(cn.debug("onWebsocketTask: handle encrypt resultCode: "+e),0!==e)return cn.error("onWebsocketTask: fail to send encrypt task!"),void r(new pe(e,[]));n(t.handleEncryptTaskResult(o))};e.requestSubType===v.MONITOR_USER_COMMAND_CHANGE||e.requestSubType===v.MONITOR_DATA_KEY_CHANGE?(o=new un(e,t.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),s,t.syncProcess),t.syncProcess.registerWebSocketCallBack("EncryptionResponse",o)):o=new en(e,t.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),t.naturalBaseRef.getCertificateService(),s),t.syncProcess.process(o)}))];case 1:return[2,n.sent()]}}))}))},e.prototype.querySaltValue=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){return cn.debug("querySaltValue start"),[2,this.processEncryptionTask(v.QUERY_SALT_VALUE,[])]}))}))},e.prototype.queryDataKeyCipherText=function(e){var t;return l(this,void 0,void 0,(function(){return d(this,(function(n){return cn.info("queryDataKeyCipherText start"),0===(null===(t=e.rootKeyToken)||void 0===t?void 0:t.length)?(cn.error("queryDataKeyCipherText fail: requestInfo rootKeyToken is empty!"),[2,Promise.reject(1e6)]):[2,this.processEncryptionTask(v.QUERY_CIPHER_TEST,[e])]}))}))},e.prototype.insertEncryptedInfo=function(e){var t,n,r,o;return l(this,void 0,void 0,(function(){return d(this,(function(s){return cn.info("insertEncryptedInfo start"),0===(null===(t=e.firstSaltValue)||void 0===t?void 0:t.length)||0===(null===(n=e.secondSaltValue)||void 0===n?void 0:n.length)||0===(null===(r=e.rootKeyToken)||void 0===r?void 0:r.length)||0===(null===(o=e.dataKeyCipherText)||void 0===o?void 0:o.length)?(cn.error("insertEncryptedInfo fail: insert encrypt info contains empty buffer!"),[2,Promise.reject(1e6)]):[2,this.processEncryptionTask(v.INSERT_ENCRYPTION_INFO,[e])]}))}))},e.prototype.updateEncryptedInfo=function(e,t){var n,r,o,s,i;return l(this,void 0,void 0,(function(){return d(this,(function(a){return cn.info("updateEncryptedInfo start"),0===(null===(n=e.rootKeyToken)||void 0===n?void 0:n.length)?(cn.error("updateEncryptedInfo: old encrypt rootKeyToken is null!"),[2,Promise.reject(1e6)]):0===(null===(r=t.firstSaltValue)||void 0===r?void 0:r.length)||0===(null===(o=t.secondSaltValue)||void 0===o?void 0:o.length)||0===(null===(s=t.rootKeyToken)||void 0===s?void 0:s.length)||0===(null===(i=t.dataKeyCipherText)||void 0===i?void 0:i.length)?(cn.error("updateEncryptedInfo: new encrypt contains empty buffer!"),[2,Promise.reject(1e6)]):[2,this.processEncryptionTask(v.UPDATE_ENCRYPTION_INFO,[e,t])]}))}))},e.prototype.handleEncryptTaskResult=function(e){var t,n,r=e.responseCode;if(0!==r)return cn.warn("handleEncryptTaskResult: cloud encryption exception occurs!"),new pe(r,[]);var o=this.encryptTaskCacheMap.get(e.taskId.toString());if(!o)return cn.error("handleEncryptTaskResult: invalid encryptTask, taskId: "+e.taskId),new pe(1007,[]);var s=e.response;if(cn.info("handleEncryptTaskResult: taskId: "+e.taskId+"             encryptType: "+s.encryptionMessageType+"             responseInfo size:"+(null===(t=s.encryptionInfoList)||void 0===t?void 0:t.length)),o.requestSubType!==s.encryptionMessageType)return cn.error("handleEncryptTaskResult: response encrypt type does not matched with task encrypt type"),this.clearEncryptInfo(o.requestInfo),this.encryptTaskCacheMap.delete(e.taskId.toString()),new pe(1007,[]);var i=[];return null===(n=s.encryptionInfoList)||void 0===n||n.forEach((function(e){i.push(e)})),this.clearEncryptInfo(o.requestInfo),this.encryptTaskCacheMap.delete(e.taskId.toString()),cn.debug("handleEncryptTaskResult: encryptTaskCacheMap size: "+this.encryptTaskCacheMap.size),new pe(0,i)},e.prototype.handleEncryptPushMessage=function(e,t){var n;if(!t)return cn.error("handleEncryptPushMessage: no encryption monitor registered!"),0;var r=new Map([[v.NOTIFY_ENCRYPTION_COMMAND_CHANGED,function(e){e.onUserCommandChanged()}],[v.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_NORMAL,function(e){e.onKeyChanged(ue.NORMAL)}],[v.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATING,function(e){e.onKeyChanged(ue.UPDATING)}],[v.NOTIFY_ENCRYPTION_KEY_CHANGE_TO_UPDATE_INTERRUPT,function(e){e.onKeyChanged(ue.INTERRUPT)}]]),o=e.response.encryptionMessageType;return cn.info("handleEncryptPushMessage: notificationType: "+o),r.has(o)?(null===(n=r.get(o))||void 0===n||n.call(null,t),0):(cn.error("handleEncryptPushMessage: invalid encryption push type!"),1007)},e.ENCRYPT_TASK_TIMEOUT_IN_MILLISECOND=6e4,e}(),dn=function(e){function t(t,n,r){var s=e.call(this)||this;return s.taskId_=o.fromNumber(0),s.resultCode_=0,s.requestInfo_=[],s.taskId_=n,s.requestSubType_=t,r.forEach((function(e){s.requestInfo_.push(e)})),s}return c(t,e),Object.defineProperty(t.prototype,"requestSubType",{get:function(){return this.requestSubType_},set:function(e){this.requestSubType_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"taskId",{get:function(){return this.taskId_},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"resultCode",{get:function(){return this.resultCode_},set:function(e){this.resultCode_=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"requestInfo",{get:function(){return this.requestInfo_},enumerable:!1,configurable:!0}),t.prototype.clearRequestInfo=function(){this.requestInfo_=[]},t}(on),pn=new T("SnapshotUpdateTask"),fn=function(){function e(e){this.onPush=e}return e.prototype.onResponse=function(e,t){var n,r,o=e.opData,s=e.schemas,i=s?null===(n=s[0])||void 0===n?void 0:n.n:void 0,a=[],u=e.subPushMsg,c={pushSeq:u.pushSeq.toNumber(),storeName:e.msgInfo.opStore.storeName,subKey:u.subKey,subRecId:u.subRecId,subscribeId:u.subId,responseObject:a,tableName:i,operationType:(null==o?void 0:o.length)>0?null===(r=o[0])||void 0===r?void 0:r.t:void 0};o.forEach((function(e){e.os.forEach((function(t){var n=t.fs;a.push(new ie(s[0],n,e.t))}))}));var l=a.length;pn.info("[onResponse] enter, responseObjects size:"+(l||0)),t.response=c,this.onPush(t.responseCode,t)},e}(),hn=new T("EncryptionInfoPushTask"),yn=function(){function e(){}return e.prototype.onResponse=function(e,t,n){var r,o=e.msgInfo;if(o){var s=o.subType,i=e.enResInfo,a=null==i?void 0:i.length;hn.info("[onResponse] messageType: "+s+" encryptionInfoList size:"+a),t.response={encryptionInfoList:e.enResInfo,encryptionMessageType:s},null===(r=null==n?void 0:n.getEncryptionInfoPush())||void 0===r||r.call(null,0,t)}else hn.error("[onResponse] invalid encryptionResponseMessage!")},e}();!function(e){e[e.UNNEGOTIATED=1]="UNNEGOTIATED",e[e.NEGOTIATING=2]="NEGOTIATING",e[e.NEGOTIATE_FAIL=3]="NEGOTIATE_FAIL",e[e.NEGOTIATE_SUCCESS=4]="NEGOTIATE_SUCCESS"}(Nt||(Nt={})),function(e){e[e.ALL_STORE=1]="ALL_STORE",e[e.STORE=2]="STORE",e[e.DEFAULT_SUBSCRIBE=3]="DEFAULT_SUBSCRIBE"}(At||(At={}));var bn=new T("NaturalCloudSyncModule"),gn=function(){function e(e){var t=this;this.nego_retry_time=0,this.subTunnelFail=!1,this.isInitiativeStop=!1,this.negotiated=Nt.UNNEGOTIATED,this.naturalBaseRef=e,this.syncInstance=new kt(e.getCertificateService()),this.syncInstance.registerWebSocketCallBack("SnapshotUpdate",new fn((function(e,n){t.handleQuerySubPushRes(n)}))),this.syncInstance.registerWebSocketCallBack("EncryptionResponse",new yn),this.syncInstance.registerConnectCallback((function(){return l(t,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,this.onConnect()];case 1:return e.sent(),[2]}}))}))})),this.syncInstance.registerDisconnectCallback((function(e){t.onDisconnect(e)})),this.encryptTaskManager=new ln(this.syncInstance,this.naturalBaseRef)}return e.prototype.getSubscribeInfos=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o,s,i,a,u,c,l,f,h,y;return d(this,(function(d){switch(d.label){case 0:t=[],n=0,r=e.getAllSubscribeInfo(),d.label=1;case 1:d.trys.push([1,7,8,9]),o=p(r.values()),s=o.next(),d.label=2;case 2:return s.done?[3,6]:(i=s.value,[4,this.naturalBaseRef.getEntireEncryption().isValidEncryptionOperation(i.cloudDBZoneQuery.getClassName()).catch((function(e){return(null==e?void 0:e.getCode())||0}))]);case 3:return a=d.sent(),u=t,c=n++,l=[i.queryId,i.cloudDBZoneQuery.getClassName()],[4,e.getQueryConditionByString(i.cloudDBZoneQuery.getClassName(),i.cloudDBZoneQuery.getQueryConditions())];case 4:u[c]=l.concat([d.sent(),a,i.cloudSubRecordId]),i.pushSeq=0,d.label=5;case 5:return s=o.next(),[3,2];case 6:return[3,9];case 7:return f=d.sent(),h={error:f},[3,9];case 8:try{s&&!s.done&&(y=o.return)&&y.call(o)}finally{if(h)throw h.error}return[7];case 9:return[2,t]}}))}))},e.prototype.getSubInfoByRange=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s,i,a,u,c,l;return d(this,(function(d){switch(d.label){case 0:switch(r=new Map,o=[],e){case At.ALL_STORE:return[3,1];case At.STORE:return[3,9];case At.DEFAULT_SUBSCRIBE:return[3,11]}return[3,12];case 1:d.trys.push([1,6,7,8]),s=p(this.naturalBaseRef.getAllNaturalStore()),i=s.next(),d.label=2;case 2:return i.done?[3,5]:(a=i.value,[4,this.getSubscribeInfos(a)]);case 3:if(0===(o=d.sent()).length)return[3,4];r.set(a.getNaturalStoreName(),o),d.label=4;case 4:return i=s.next(),[3,2];case 5:return[3,8];case 6:return u=d.sent(),c={error:u},[3,8];case 7:try{i&&!i.done&&(l=s.return)&&l.call(s)}finally{if(c)throw c.error}return[7];case 8:return[3,12];case 9:return t?[4,this.getSubscribeInfos(t)]:(bn.warn("STORE subscribe should pass store"),[3,12]);case 10:return 0===(o=d.sent()).length||r.set(t.getNaturalStoreName(),o),[3,12];case 11:return t&&n?(r.set(t.getNaturalStoreName(),[n]),[3,12]):(bn.warn("DEFAULT_SUBSCRIBE subscribe should pass store and defaultSubscribeInfo"),[3,12]);case 12:return[2,r]}}))}))},e.prototype.getUnSubInfoByRange=function(e,t,n){var r=new Map,o=[];switch(e){case At.ALL_STORE:this.naturalBaseRef.getAllNaturalStore().forEach((function(e){0!==(o=e.getAllSubscribeInfos()).length&&r.set(e.getNaturalStoreName(),o)}));break;case At.STORE:if(!t){bn.warn("STORE subscribe should pass store");break}if(0===(o=t.getAllSubscribeInfos()).length)break;r.set(t.getNaturalStoreName(),o);break;case At.DEFAULT_SUBSCRIBE:if(!t||!n){bn.warn("DEFAULT_SUBSCRIBE unsubscribe should pass store and defaultSubscribeInfo");break}r.set(t.getNaturalStoreName(),[n])}return r},e.prototype.onConnect=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return this.negotiated!==Nt.NEGOTIATE_SUCCESS&&(this.nego_retry_time=0,this.onSchemaNegotiate()),bn.info("onConnect: subTunnelFail: "+this.subTunnelFail),this.subTunnelFail?(this.subTunnelFail=!1,this.isInitiativeStop=!1,[4,this.naturalBaseRef.onConnect()]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},e.prototype.subscribeForRekey=function(){return l(this,void 0,void 0,(function(){var e,t,n=this;return d(this,(function(r){switch(r.label){case 0:return bn.info("subscribeForRekey start"),[4,this.checkStatus()];case 1:return r.sent(),[4,this.getSubInfoByRange(At.ALL_STORE)];case 2:return 0===(e=r.sent()).size?(bn.warn("subscribeForRekey: no subscriber in all store!"),[2,Promise.resolve(0)]):(t=0,e.forEach((function(e,r){return l(n,void 0,void 0,(function(){var n,o,s,i=this;return d(this,(function(a){switch(a.label){case 0:return(n=new xt).naturalStoreName=r,o=[],e.forEach((function(e){var n=f(e,4),s=n[0],a=n[1],u=n[2],c=n[3],l=i.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(a);if(void 0!==c&&0!==c)t=c,bn.error("get subscribeInfo fail for "+c+",queryId = "+s);else if(null==l?void 0:l.isEncryptTable()){var d=new Ut;d.subscribeId=s.toString(),d.subscribeCondition=u,d.tableName=a,d.naturalStoreName=r,o.push(d)}})),n.subscribeDatas=o,n.subscribeDatas&&n.subscribeDatas.length?[3,1]:(bn.info("subscribeForRekey: subscribeData is empty, no need to send request!"),[3,3]);case 1:return[4,this.processSubRequest(n,this.handleQuerySubRes)];case 2:s=a.sent(),t=0!==s?s:t,bn.info("subscribeForRekey result = "+t),a.label=3;case 3:return[2]}}))}))})),[2,Promise.resolve(t)])}}))}))},e.prototype.unsubscribeForRekey=function(){return l(this,void 0,void 0,(function(){var e,t,n=this;return d(this,(function(r){switch(r.label){case 0:return bn.info("unsubscribeForRekey start"),[4,this.checkStatus()];case 1:return r.sent(),0===(e=this.getUnSubInfoByRange(At.ALL_STORE)).size?(bn.warn("unsubscribeForRekey: no subscriber in all store!"),[2,Promise.resolve(0)]):(t=0,e.forEach((function(e,r){return l(n,void 0,void 0,(function(){var n,o,s,i=this;return d(this,(function(a){switch(a.label){case 0:return(n=new Bt).naturalStoreName=r,o=[],e.forEach((function(e){var t=e[3],n=i.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(t);if(null==n?void 0:n.isEncryptTable()){var s=new Vt;s.subscribeId=e[0].toString(),s.cloudSubRecordId=e[1],s.cloudSubKey=e[2],s.tableName=t,s.naturalStoreName=r,o.push(s)}})),n.unSubscribeDatas=o,n.unSubscribeDatas&&n.unSubscribeDatas.length?[3,1]:(bn.info("unsubscribeForRekey: subscribeData is empty, no need to send request!"),[3,3]);case 1:return[4,this.processSubRequest(n,this.handleQueryUnsubRes)];case 2:s=a.sent(),t=0!==s?s:t,bn.info("unsubscribeForRekey result = "+t),a.label=3;case 3:return[2]}}))}))})),[2,Promise.resolve(t)])}}))}))},e.prototype.onDisconnect=function(e){this.isInitiativeStop=e,bn.warn("onDisconnect isInitiativeStop:"+this.isInitiativeStop),this.isInitiativeStop||(this.subTunnelFail=!0)},e.prototype.disconnectWebSocket=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,this.syncInstance.disConnectWebSocket()];case 1:return e.sent(),[2]}}))}))},e.prototype.needToDisconnectWebsocket=function(){return this.syncInstance.needToDisconnectWebsocket()},e.prototype.handleSchemaNegotiateRes=function(e){if(0!==e.responseCode)return this.negotiated=Nt.NEGOTIATE_FAIL,1001;var t=e.response,n=1001;switch(t.negoResult){case Z.PASS:this.negotiated=Nt.NEGOTIATE_SUCCESS,n=0,this.handlePermissionInfo(t.permissions);break;case Z.RETRY:n=1001,this.nego_retry_time++,this.onSchemaNegotiate();break;case Z.FAIL:this.negotiated=Nt.NEGOTIATE_FAIL,n=1002}return n},e.prototype.handlePermissionInfo=function(e){return l(this,void 0,void 0,(function(){var t,n=this;return d(this,(function(r){return t=new Map,e.forEach((function(e){var r,o=Me.getUserRole(e.roleType),s=n.fetchUserRight(e.readPermission,e.upsertPermission,e.deletePermission);t.get(e.tableName)?null===(r=t.get(e.tableName))||void 0===r||r.push([o,s]):t.set(e.tableName,[[o,s]])})),this.naturalBaseRef.getDefaultNaturalStore().freshPermissionInfo(t),[2]}))}))},e.prototype.fetchUserRight=function(e,t,n){var r=new Array(3);return e&&r.push(je.Read),t&&r.push(je.Upsert),n&&r.push(je.Delete),xe.composeUserRight(r)},e.prototype.handleQuerySubRes=function(e,t){var n=0,r=e.response;return t?(r.subscribeResults.forEach((function(e){var r=t.handleSubscribeRes(e.subResponseCode,Number(e.subscribeId),e.cloudSubRecordId,e.subKey);n=0!==r?r:n})),n):(bn.error("NaturalCloudSyncModule: handleQuerySubRes store is null!"),1)},e.prototype.handleQueryUnsubRes=function(e,t){var n,r=0,o=e.response;return 0!==e.responseCode&&bn.warn("handleQueryUnsubRes receive an error from cloud side,"+e.responseCode+",\n                unSubScribeResults size = "+(null===(n=null==o?void 0:o.unSubScribeResults)||void 0===n?void 0:n.length)),t instanceof vt&&(null==o||o.unSubScribeResults.forEach((function(e){var n=t.handleUnsubscribeRes(e.unSubRecId,e.unSubResCode);r=0!==n?n:r}))),r},e.prototype.handleQuerySubPushRes=function(e){var t=e.response,n=this.naturalBaseRef.getNaturalStore(e.storeName);if(n){var r=n.getSubscribeInfoByCloudSubRecordId(t.subRecId);if(!r){if(!n.isSubscribeNotResponsed(t.subscribeId)){bn.warn("unknown subscribe push of "+t.subRecId);var o=[0,t.subRecId,t.subKey,t.tableName];return void this.onUnSubscribe(At.DEFAULT_SUBSCRIBE,n,o)}if(!this.handlePushWithQueryId(t))return void bn.warn("handlePushWithQueryId failed and ignore response");if(!(r=n.getSubscribeInfoByCloudSubRecordId(t.subRecId)))return void bn.warn("retry set response for subscribe failed and ignore sub push")}if(0!==e.responseCode)return bn.log("SubPush errorCode for "+e.responseCode),void n.handleSubPushRes(r,e.responseCode);r.pushSeq>=Number(t.pushSeq)?bn.log("ignore old pushSeq from cloud local:"+r.pushSeq+"                 >= received:"+t.pushSeq):(r.pushSeq=t.pushSeq,bn.log("Subscribe Info Push Sequence Number: "+r.pushSeq),n.handleSubPushRes(r,0,t.responseObject,t.operationType))}else bn.error("NaturalCloudSyncModule: handleQuerySubPushRes store is null!")},e.prototype.handlePushWithQueryId=function(e){var t=this.naturalBaseRef.getNaturalStore(e.storeName);return t?(t instanceof vt&&t.handleSubscribeRes(0,Number(e.subscribeId),e.subRecId,e.subKey),!0):(bn.error("handlePushWithQueryId failed for store is null!"),!1)},e.prototype.resetNegoStatus=function(){this.negotiated=Nt.UNNEGOTIATED},e.prototype.onSchemaNegotiate=function(){return l(this,void 0,void 0,(function(){var t,n,r=this;return d(this,(function(o){return 0===(t=this.naturalBaseRef.getDefaultNaturalStore().getSchemaToNegotiate()).length||this.negotiated===Nt.NEGOTIATE_SUCCESS?(this.negotiated=Nt.NEGOTIATE_SUCCESS,[2,Promise.resolve(0)]):this.negotiated===Nt.NEGOTIATING?[2,Promise.resolve(1001)]:this.nego_retry_time>=e.SCHEMA_NEGO_MAX_TIME?(bn.warn("schema nego reach max "+e.SCHEMA_NEGO_MAX_TIME+" times and return error"),[2,Promise.reject(1)]):(this.negotiated=Nt.NEGOTIATING,n=this.createNegotiateRequest(t),[2,new Promise((function(e,t){r.syncInstance.process(new en(n,r.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),r.naturalBaseRef.getCertificateService(),(function(n,o){if(0!==n)return r.negotiated=Nt.NEGOTIATE_FAIL,void t(n);var s=r.handleSchemaNegotiateRes(o);0===s?e(0):t(s)})))}))])}))}))},e.prototype.createNegotiateRequest=function(e){var t=new jt;t.naturalStoreName=void 0;var n=[];return e.forEach((function(e){n.push(e)})),t.schemas=n,t},e.prototype.onOpenStore=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return this.negotiated===Nt.NEGOTIATE_SUCCESS?[3,2]:(this.nego_retry_time=0,[4,this.onSchemaNegotiate()]);case 1:return[2,e.sent()];case 2:return[2,Promise.resolve(0)]}}))}))},e.prototype.onCloseStore=function(e){return l(this,void 0,void 0,(function(){var t;return d(this,(function(n){return(t=new Mt).requestType=g.STORE_CLOSING,t.naturalStoreName=e.getNaturalStoreName(),this.syncInstance.process(new en(t,this.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),this.naturalBaseRef.getCertificateService(),(function(t){0!==t&&bn.warn("send close store "+e.getNaturalStoreName()+" request result "+t)}))),[2]}))}))},e.prototype.onQuery=function(e,t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.processCRUDRequest(this.createSyncQueryRequest(e,t,n,$.CONVENTIONAL_QUERY))];case 1:return[2,r.sent().responseObject]}}))}))},e.prototype.onAggregateQuery=function(e,t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.processCRUDRequest(this.createSyncQueryRequest(e,t,n,$.AVG_QUERY))];case 1:return[2,r.sent().aggreResult]}}))}))},e.prototype.createSyncQueryRequest=function(e,t,n,r){var o=new Lt;return o.naturalStoreName=e,o.tableName=t,o.queryCondition=n,o.queryType=r,o},e.prototype.onUpsert=function(e,t){return l(this,void 0,void 0,(function(){return d(this,(function(n){switch(n.label){case 0:return[4,this.processCRUDRequest(this.createSyncObjectRequest(e,g.OBJECT_UPDATE,S.SYNC_UPSERT,t))];case 1:return[2,n.sent().successNumber]}}))}))},e.prototype.onDelete=function(e,t){return l(this,void 0,void 0,(function(){return d(this,(function(n){switch(n.label){case 0:return[4,this.processCRUDRequest(this.createSyncObjectRequest(e,g.OBJECT_UPDATE,S.SYNC_DELETE,t))];case 1:return[2,n.sent().successNumber]}}))}))},e.prototype.createSyncObjectRequest=function(e,t,n,r){var o=new qt;o.naturalStoreName=e,o.requestType=t,o.operationType=n,o.objList=r;var s=new Set;return r.forEach((function(e){s.add(O.getClassName(e))})),o.schemas=this.buildSchemas(h(s)),o},e.prototype.buildSchemas=function(e){var t,n,r=[];try{for(var o=p(e),s=o.next();!s.done;s=o.next()){var i=s.value,a=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(i);a&&r.push(a)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r},e.prototype.processCRUDRequest=function(t){return l(this,void 0,void 0,(function(){var n=this;return d(this,(function(r){switch(r.label){case 0:return[4,this.waitingForSyncModuleReady(e.TIMEOUT_REF)];case 1:return 1004===r.sent()?[2,Promise.reject(1004)]:[2,new Promise((function(e,r){n.syncInstance.process(new en(t,n.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),n.naturalBaseRef.getCertificateService(),(function(t,n){0===t?e(n.response):r(t)})))}))]}}))}))},e.prototype.onSubscribe=function(e,t,n,r){return l(this,void 0,void 0,(function(){var o,s,i=this;return d(this,(function(a){switch(a.label){case 0:return[4,this.checkStatus(e,n)];case 1:return a.sent(),[4,this.getSubInfoByRange(e,t,n)];case 2:return 0===(o=a.sent()).size?[2,Promise.resolve(0)]:(s=[],o.forEach((function(e,t){return l(i,void 0,void 0,(function(){var n,o;return d(this,(function(i){return n=new Set,(o=new xt).naturalStoreName=t,o.subscribeDatas=this.buildSubscribeData(e,t,n,r),o.schemas=this.buildSchemas(h(n)),o.subscribeDatas&&o.subscribeDatas.length?s.push(o):bn.info("onSubscribe: subscribeData is empty, no need to send request!"),[2]}))}))})),[4,Promise.all(s.map((function(e){return i.processSubRequest(e,i.handleQuerySubRes)})))]);case 3:return a.sent().forEach((function(e){bn.info("Subscribe store "+(null==t?void 0:t.getNaturalStoreName())+",result = "+e)})),[2,Promise.resolve(0)]}}))}))},e.prototype.buildSubscribeData=function(e,t,n,r){var o=this.naturalBaseRef.getNaturalStore(t),s=[];return e.forEach((function(e){var i=f(e,5),a=i[0],u=i[1],c=i[2],l=i[3],d=i[4];if(void 0===l||0===l){var p=new Ut;if(p.subscribeId=a.toString(),p.tableName=u,r&&d){n.add(u);var h=o.getSubscribeInfoByCloudSubRecordId(d);p.snapshotObjs=h.getSnapshotCache()}p.subscribeCondition=c,p.naturalStoreName=t,s.push(p)}})),s},e.prototype.processSubRequest=function(e,t){return l(this,void 0,void 0,(function(){var n=this;return d(this,(function(r){return[2,new Promise((function(r){var o,s=function(e,o){r(0===e?t(o,n.naturalBaseRef.getNaturalStore(o.storeName)):e)};e.requestType===g.QUERY_SUB?(o=new Yt(e,n.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),s,n.syncInstance),n.syncInstance.registerWebSocketCallBack("SubscribeResponse",o)):(o=new nn(e,n.naturalBaseRef.getEntireEncryption().GetEncryptVersion(),s,n.syncInstance),n.syncInstance.registerWebSocketCallBack("UnsubscribeResponse",o)),n.syncInstance.process(o)}))]}))}))},e.prototype.onUnSubscribe=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s,i,a,u,c,l,f,h;return d(this,(function(d){switch(d.label){case 0:return n&&!n[1]?(bn.info("Skip to unsubscribe to cloud since cloudSyncSubrecordId is invalid."),this.syncInstance.needToDisconnectWebsocket()&&(bn.info("Stop heartbeat since there is no subscriber."),this.syncInstance.getWebSocketClient().stopHeartBeat()),[2,Promise.resolve(0)]):[4,this.checkStatus(e,n)];case 1:if(d.sent(),0===(r=this.getUnSubInfoByRange(e,t,n)).size)return[2,Promise.resolve(0)];o=0,d.label=2;case 2:d.trys.push([2,8,9,10]),s=p(r),i=s.next(),d.label=3;case 3:return i.done?[3,7]:(a=i.value,(u=this.createUnSubscribeRequest(a)).unSubscribeDatas&&u.unSubscribeDatas.length?[3,4]:(bn.info("onUnSubscribe: subscribeData is empty, no need to send request!"),[3,6]));case 4:return[4,this.processSubRequest(u,this.handleQueryUnsubRes)];case 5:c=d.sent(),o=0!==c?c:o,d.label=6;case 6:return i=s.next(),[3,3];case 7:return[3,10];case 8:return l=d.sent(),f={error:l},[3,10];case 9:try{i&&!i.done&&(h=s.return)&&h.call(s)}finally{if(f)throw f.error}return[7];case 10:return[2,Promise.resolve(o)]}}))}))},e.prototype.createUnSubscribeRequest=function(e){var t=new Bt;t.naturalStoreName=e[0];var n=[];return e[1].forEach((function(t){var r=new Vt;r.subscribeId=t[0].toString(),r.cloudSubRecordId=t[1],r.cloudSubKey=t[2],r.tableName=t[3],r.naturalStoreName=e[0],n.push(r)})),t.unSubscribeDatas=n,t},e.prototype.checkStatus=function(t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.waitingForSyncModuleReady(e.TIMEOUT_REF)];case 1:return 1004===r.sent()?[2,Promise.reject(1004)]:this.subTunnelFail?[2,Promise.reject(1e3)]:t!==At.DEFAULT_SUBSCRIBE||n?[2]:(bn.warn("DEFAULT_SUBSCRIBE should pass defaultSubscribeInfo"),[2,Promise.reject(1)])}}))}))},e.prototype.onTransaction=function(e,t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.processCRUDRequest(this.createTransactionRequest(e,t,n))];case 1:if(0!==r.sent().transactionResult)throw 1;return[2]}}))}))},e.prototype.createTransactionRequest=function(e,t,n){var r=new Kt;r.naturalStoreName=e,r.verifyObjects=t,r.transactionDatas=n;var o=new Set;return r.verifyObjects.forEach((function(e){o.add(e.objectTypeName)})),r.transactionDatas.forEach((function(e){o.add(e.objectTypeName)})),r.schemas=this.buildSchemas(h(o)),r},e.prototype.waitingForSyncModuleReady=function(t){return l(this,void 0,void 0,(function(){var n;return d(this,(function(r){switch(r.label){case 0:n=t,r.label=1;case 1:return n>0?this.negotiated===Nt.NEGOTIATE_SUCCESS?[2,0]:[4,this.timeOut(2*e.MODULE_STATE_CHECK_INTERVAl)]:[3,4];case 2:r.sent(),r.label=3;case 3:return n-=e.MODULE_STATE_CHECK_INTERVAl,[3,1];case 4:return[2,1004]}}))}))},e.prototype.timeOut=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){return[2,new Promise((function(t){return setTimeout(t,e)}))]}))}))},e.prototype.getEncryptTaskManager=function(){return this.encryptTaskManager},e.TIMEOUT_REF=2e4,e.MODULE_STATE_CHECK_INTERVAl=100,e.SCHEMA_NEGO_MAX_TIME=5,e}(),vn={},Sn={};function mn(e,t){vn[e]=t}function Tn(e,t){if(!O.isNullOrUndefined(e))return"number"==typeof e?Number(e.toPrecision(t)).valueOf():void 0}function In(e,t){Sn[e]=t}mn(_e.Date,(function(e){if(e instanceof Date)return o.fromNumber(e.getTime())})),mn(_e.Float,(function(e){return Tn(e,6)})),mn(_e.Double,(function(e){return Tn(e,15)})),In(_e.Date,(function(e){if(!O.isNullOrUndefined(e))return e instanceof o?new Date(e.toNumber()):void 0})),In(_e.ByteArray,(function(e){if(e instanceof Uint8Array)return e;if("string"==typeof e){var t=new ArrayBuffer(e.length),n=new Uint8Array(t),r=s.decode(e,n,0);return n.slice(0,r)}})),In(_e.Float,(function(e){return Tn(e,6)})),In(_e.Double,(function(e){return Tn(e,15)}));var Rn={};function En(e,t){Rn[e]=t}function wn(e){if(O.isNullOrUndefined(e))return 0;for(var t=0,n=e,r=0;r<n.length;r+=1)t+=On(n,r);return t}function On(e,t){var n=e.charCodeAt(t);return n>>11>0?3:n>>7>0?2:1}En(_e.Integer,(function(e){return 4})),En(_e.String,(function(e){return wn(e)})),En(_e.Short,(function(e){return 2})),En(_e.Long,(function(e){return 8})),En(_e.Boolean,(function(e){return 1})),En(_e.Byte,(function(e){return 1})),En(_e.Float,(function(e){return 4})),En(_e.Double,(function(e){return 8})),En(_e.ByteArray,(function(e){return e?e.byteLength:0})),En(_e.Date,(function(e){return 8})),En(_e.Text,(function(e){return wn(e)}));var Cn,Nn=new T("DataModelProcessor"),An=function(){function e(e){this.fieldsInfos=e.getFieldInfos(),this.primaryKeys=e.getPrimaryKeyFieldTypes(),this.name_=e.name}return Object.defineProperty(e.prototype,"name",{get:function(){return this.name_},enumerable:!1,configurable:!0}),e.prototype.getFieldsInfos=function(){return this.fieldsInfos},e.prototype.getFieldInfo=function(e){return this.fieldsInfos.get(e)},e.prototype.getPrimaryKeys=function(){return this.primaryKeys},e.prototype.deserialize=function(e,t){var n,r,o=new e;try{for(var s=p(this.fieldsInfos.keys()),i=s.next();!i.done;i=s.next()){var a=i.value,u=this.fieldsInfos.get(a);if(u){var c=u.fieldType;null===t[a]?o[a]=void 0:(null==u?void 0:u.isEncryptField)?o[a]=t[a]:o[a]=Sn[c]?Sn[c](t[a]):t[a]}else Nn.warn("DataModelHelper: deserialize invalid fieldInfo.")}}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(n)throw n.error}}return o},e.prototype.serialize=function(e){var t,n,r={};try{for(var o=p(this.fieldsInfos.keys()),s=o.next();!s.done;s=o.next()){var i=s.value,a=this.fieldsInfos.get(i);if(a){var u=a.fieldType;if(null===e[i])r[i]=void 0;else if(null==a?void 0:a.isEncryptField){if(r[i]=e[i],(null==a?void 0:a.opeName)&&e[null==a?void 0:a.opeName]){var c=null==a?void 0:a.opeName;r[c]=vn[_e.String]?vn[_e.String](e[c]):e[c]}}else r[i]=vn[u]?vn[u](e[i]):e[i]}else Nn.warn("DataModelHelper: serialize invalid fieldInfo key.")}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r},e.prototype.serializeDeletedObject=function(e){var t,n,r={};try{for(var o=p(this.fieldsInfos.keys()),s=o.next();!s.done;s=o.next()){var i=s.value,a=this.fieldsInfos.get(i);a?a.isPrimaryKey&&(r[i]=vn[a.fieldType]?vn[a.fieldType](e[i]):e[i]):Nn.warn("DataModelHelper: serializeDeletedObject invalid fieldInfo key.")}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r},e.prototype.calculate=function(e){var t,n,r=0;try{for(var o=p(this.fieldsInfos.keys()),s=o.next();!s.done;s=o.next()){var i=s.value,a=this.fieldsInfos.get(i).fieldType;if(!O.isNullOrUndefined(e[i]))r+=Rn[a]?Rn[a](e[i]):0}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r},e.prototype.validate=function(e){var t,n,r=Object.getOwnPropertyNames(e);if(r.length!==this.fieldsInfos.size)return Nn.warn("The number of fields in the object is inconsistent with that in the schema."),!1;try{for(var o=p(r),s=o.next();!s.done;s=o.next()){var i=s.value;if(!this.validateFieldValue(this.fieldsInfos.get(i),e[i]))return!1}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return!0},e.prototype.validateFieldValue=function(e,t){return e?(O.isNullOrUndefined(t)||ct.validateFieldValue(e.fieldType,t),!0):(Nn.warn("The field info not found in DataModelHelper."),!1)},e}(),Dn=function(){function e(e){this.processors=new Map,this.loadAppSchema(e)}return e.prototype.loadAppSchema=function(e){var t,n;try{for(var r=p(e.values()),o=r.next();!o.done;o=r.next()){var s=o.value,i=new An(s);this.processors.set(i.name,i)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}},e.prototype.deserialize=function(e,t){var n=O.getClassName(e);if(!O.isClass(e)||!this.containProcessor(n))throw E.build("clz is not valid data model class!");if(!O.isNotNullObject(t))throw E.build("object is not valid data model object!");return this.processors.get(n).deserialize(e,t)},e.prototype.serialize=function(e,t){var n=O.getClassName(e);if(!O.isClass(e)||!this.containProcessor(n))throw E.build("clz is not valid data model class!");if(!O.isNotNullObject(t))throw E.build("object is not valid data model object!");return this.processors.get(n).serialize(t)},e.prototype.serializeDeletedObject=function(e,t){var n=O.getClassName(e);if(!O.isClass(e)||!this.containProcessor(n))throw E.build("serializeDeletedObject: clz is not valid data model class!");if(!O.isNotNullObject(t))throw E.build("serializeDeletedObject: object is not valid data model object!");return this.processors.get(n).serializeDeletedObject(t)},e.prototype.calculate=function(e,t){var n=O.getClassName(e);if(!O.isClass(e)||!this.containProcessor(n))throw E.build("clz is not valid data model class!");if(!O.isNotNullObject(t))throw E.build("object is not valid data model object!");return this.processors.get(n).calculate(t)+16},e.prototype.calculateObject=function(e){if(!O.isNotNullObject(e))throw E.build("The object is invalid data model.");var t=O.getClassName(e);if(!this.containProcessor(t))throw E.build("The object type is not loaded yet.");return this.processors.get(t).calculate(e)+16},e.prototype.getFieldInfosByClassName=function(e){var t=this.processors.get(e);return t?t.getFieldsInfos():new Map},e.prototype.getFieldInfoByName=function(e,t){var n=this.processors.get(e);if(n)return n.getFieldInfo(t)},e.prototype.getPrimaryKeyByClassName=function(e){var t=this.processors.get(e);return t?t.getPrimaryKeys():[]},e.prototype.validate=function(e){if(O.isNotNullObject(e)){var t=O.getClassName(e),n=this.processors.get(t);return!!n&&n.validate(e)}return!1},e.prototype.containProcessor=function(e){return this.processors.has(e)},e}(),_n=function(){function e(){this.version=-1,this.schemas=new Map}return e.prototype.createObjectType=function(e,t){this.version=e,this.schemas=t,this.dataModelHelper=new Dn(t)},e.prototype.getAppSchema=function(){return this.schemas},e.prototype.getAppVersion=function(){return this.version},e.prototype.getSchemaToNegotiate=function(){return h(this.schemas.values())},e.prototype.freshPermissionInfo=function(e){var t,n,r=function(t){var n=e.get(t),r=o.schemas.get(t);null==n||n.forEach((function(e){var t=f(e,2),n=t[0],o=t[1];null==r||r.setPermission(n,o)}))},o=this;try{for(var s=p(e.keys()),i=s.next();!i.done;i=s.next()){r(i.value)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=s.return)&&n.call(s)}finally{if(t)throw t.error}}},e.prototype.getDataModelHelper=function(){return this.dataModelHelper},e}(),Pn=function(e,t){this.onUserCommandChanged=e,this.onKeyChanged=t},kn=function(){function e(){this.inEdge=o.UZERO,this.inSize=o.UZERO,this.outEdge=o.UZERO,this.outSize=o.UZERO,this.value=o.UZERO,this.outLen=0}return e.copy=function(t){var n=new e;return n.inEdge=t.inEdge,n.inSize=t.inSize,n.outEdge=t.outEdge,n.outSize=t.outSize,n.value=t.value,n.outLen=t.outLen,n},e.prototype.toString=function(){return"inEdge: "+this.inEdge.toString(10)+", inSize: "+this.inSize.toString(10)+", outEdge: "+this.outEdge.toString(10)+", outSize: "+this.outSize.toString(10)+", value: "+this.value.toString(10)+", outLen: "+this.outLen},e}(),Mn=function(){function e(){this.inEdge=new i(0),this.inSize=new i(0),this.outSize=new i(0),this.outEdge=new i(0),this.value=new i(0),this.outLen=0}return e.copy=function(t){var n=new e;return n.value=t.value,n.inSize=t.inSize,n.inEdge=t.inEdge,n.outEdge=t.outEdge,n.outSize=t.outSize,n.outLen=t.outLen,n},e.prototype.toString=function(){return"inEdge: "+this.inEdge.toString(10)+", inSize: "+this.inSize.toString(10)+", outEdge: "+this.outEdge.toString(10)+", outSize: "+this.outSize.toString(10)+", value: "+this.value.toString(10)+", outLen: "+this.outLen},e}(),jn=function(){function e(){this.radixSign=0,this.radixLen=0,this.expSign=0,this.expLen=0,this.normalizedExp=0,this.normalizedSize=1,this.effectiveLen=0}return e.prototype.toString=function(){return"radixSign: "+this.radixSign+", radixLen: "+this.radixLen+", expSign: "+this.expSign+", expLen: "+this.expLen+", normalizedExp: "+this.normalizedExp+", normalizedSize: "+this.normalizedSize+", effectiveLen: "+this.effectiveLen},e}(),xn=new T("OpeTypeConversion"),Un=function(){function e(){}return e.convertToOpeDataSpaceUint64=function(e,t,n){if(null==e||null==n)return xn.warn("convertToOpeDataSpaceUint64: input parameter is invalid"),this.OPE_FAIL;switch(t){case 1:case 2:return this.convertInt8ToOpeDataSpace(e,n);case 3:return this.convertInt16ToOpeDataSpace(e,n);case 4:return this.convertInt32ToOpeDataSpace(e,n);case 6:return this.convertFloatToOpeDataSpace(e,n);default:return xn.warn("convertToOpeDataSpaceUint64: input type is error to Uint64Space, type: "+t),this.OPE_FAIL}},e.convertToOpeDataSpaceBigNum=function(e,t,n,r){if(null==e||null==t||t<=0)return xn.warn("convertToOpeDataSpaceBigNum: input parameter is invalid."),this.OPE_FAIL;switch(n){case 5:case 9:return"string"==typeof e?this.convertInt64ToOpeDataSpace(e,r):(xn.warn("convertToOpeDataSpaceBigNum: input type should be string but got: ."+typeof e),this.OPE_FAIL);case 7:return"string"==typeof e?this.convertDoubleToOpeDataSpace(e,r):(xn.warn("convertToOpeDataSpaceBigNum: input type should be string but got: ."+typeof e),this.OPE_FAIL);case 8:return"string"!=typeof e?this.convertStringToOpeDataSpace(e,t,r):(xn.warn("convertToOpeDataSpaceBigNum: input type should be Uint8Array but got: ."+typeof e),this.OPE_FAIL);default:return xn.warn("convertToOpeDataSpaceBigNum: input type is error to BigNumSpace, type: "+n),this.OPE_FAIL}},e.convertInt8ToOpeDataSpace=function(e,t){var n=o.fromString(e,!0,this.NUMBER_RADIX_DECIMAL);n=n.multiply(this.PLAIN_TEXT_REDUNDANCY);var r=this.INT8_DEFAULT_DIGIT+this.PLAIN_TEXT_REDUNDANCY_LOG2,s=this.INT8_NEGATIVE_EDGE-this.PLAIN_TEXT_REDUNDANCY_LOG2;return this.convertToUint64Space(n,r,s,t)},e.convertInt16ToOpeDataSpace=function(e,t){var n=o.fromString(e,!0,this.NUMBER_RADIX_DECIMAL);n=n.multiply(this.PLAIN_TEXT_REDUNDANCY);var r=this.INT16_DEFAULT_DIGIT+this.PLAIN_TEXT_REDUNDANCY_LOG2,s=this.INT16_NEGATIVE_EDGE-this.PLAIN_TEXT_REDUNDANCY_LOG2;return this.convertToUint64Space(n,r,s,t)},e.convertInt32ToOpeDataSpace=function(e,t){var n=o.fromString(e,!0,this.NUMBER_RADIX_DECIMAL);n=n.multiply(this.PLAIN_TEXT_REDUNDANCY);var r=this.INT32_DEFAULT_DIGIT+this.PLAIN_TEXT_REDUNDANCY_LOG2,s=this.INT32_NEGATIVE_EDGE-this.PLAIN_TEXT_REDUNDANCY_LOG2;return this.convertToUint64Space(n,r,s,t)},e.convertInt64ToOpeDataSpace=function(e,t){var n=new i(e);n=n.times(this.PLAIN_TEXT_REDUNDANCY);var r=this.INT64_DEFAULT_DIGIT+this.PLAIN_TEXT_REDUNDANCY_LOG2,o=this.INT64_NEGATIVE_EDGE-this.PLAIN_TEXT_REDUNDANCY_LOG2;return this.convertToBigNumSpace(n,r,o,t)},e.convertFloatToOpeDataSpace=function(e,t){var n=parseFloat(e).toExponential(this.FLOAT_VALID_DIGITS),r=this.convertFloatToUint64(n,n.length+1,this.FLOAT_EXPONENT_MAX_RANGE,this.FLOAT_DEFAULT_PRECISION);r=r.multiply(this.PLAIN_TEXT_REDUNDANCY);var o=(this.FLOAT_DEFAULT_PRECISION+this.FLOAT_EXPONENT_MAX_LEN)*this.NUMBER_RADIX_DECIMAL_LOG2+this.PLAIN_TEXT_REDUNDANCY_LOG2-1;o=Math.floor(o);return this.convertToUint64Space(r,o,0,t)},e.convertDoubleToOpeDataSpace=function(e,t){var n=parseFloat(e).toExponential(this.DOUBLE_VALID_DIGITS),r=this.convertDoubleToBigNum(n,n.length+1,this.DOUBLE_EXPONENT_MAX_RANGE,this.DOUBLE_DEFAULT_PRECISION);r=r.times(this.PLAIN_TEXT_REDUNDANCY);var o=(this.DOUBLE_DEFAULT_PRECISION+this.DOUBLE_EXPONENT_MAX_LEN)*this.NUMBER_RADIX_DECIMAL_LOG2+this.PLAIN_TEXT_REDUNDANCY_LOG2-1;o=Math.floor(o);return this.convertToBigNumSpace(r,o,0,t)},e.convertStringToOpeDataSpace=function(e,t,n){var r=this.convertCharToBigNum(e,t,this.STRING_VALID_BYTE_LEN);r=r.times(this.PLAIN_TEXT_REDUNDANCY);var o=this.STRING_VALID_BYTE_LEN*Math.log2(this.CHAR_SPACE_SIZE)+this.PLAIN_TEXT_REDUNDANCY_LOG2+1;return this.convertToBigNumSpace(r,o,0,n)},e.convertFloatToUint64=function(e,t,n,r){if(null==e||t<=0)throw xn.warn("convertFloatToUint64: text is null"),Error("convertFloatToUint64: text is null");var s=new jn;this.calculateFloatingPointParameter(e,t,s),this.calculateNormalizedExp(e,n,s);var i=s.expLen+r,a=this.translateFloatingPointToChar(e,r,s,i);return o.fromString(a)},e.convertDoubleToBigNum=function(e,t,n,r){if(null==e||t<=0)throw xn.warn("convertDoubleToBigNum: text is null"),Error("convertDoubleToBigNum: text is null");var o=new jn;this.calculateFloatingPointParameter(e,t,o),this.calculateNormalizedExp(e,n,o);var s=o.expLen+r,a=this.translateFloatingPointToChar(e,r,o,s);return new i(a)},e.convertCharToBigNum=function(e,t,n){var r,o=new i(0),s=new i(1);t>=n&&(o=new i(e[n-1]));for(var a=n-1;a>0;a--)s=s.times(this.CHAR_SPACE_SIZE),t>=a&&(r=(r=s).times(void 0===e[a-1]?0:e[a-1]),o=o.plus(r));return o},e.calculateFloatingPointParameter=function(e,t,n){var r=0;for("-"===e.charAt(r)&&(n.radixSign=1);"e"!==e.charAt(r);)r++;for(n.radixLen=r,"-"===e.charAt(r+1)&&(n.expSign=1),r+=2;"0"===e.charAt(r);)r++;for(;r<t&&e.charCodeAt(r)>="0".charCodeAt(0)&&e.charCodeAt(r)<="9".charCodeAt(0);)r++,n.expLen++;n.effectiveLen=r,n.expLen=0===n.expLen?1:n.expLen},e.calculateNormalizedExp=function(e,t,n){var r,o=n.normalizedSize;if("0"===e.charAt(0))r=2*t+1,o*=this.NUMBER_RADIX_DECIMAL;else if(1===n.radixSign){r=t;for(var s=0;s<n.expLen;s++)1===n.expSign?r+=(e.charCodeAt(n.effectiveLen-1-s)-"0".charCodeAt(0))*o:r-=(e.charCodeAt(n.effectiveLen-1-s)-"0".charCodeAt(0))*o,o*=this.NUMBER_RADIX_DECIMAL}else{r=3*t+1;for(s=0;s<n.expLen;s++)1===n.expSign?r-=(e.charCodeAt(n.effectiveLen-1-s)-"0".charCodeAt(0))*o:r+=(e.charCodeAt(n.effectiveLen-1-s)-"0".charCodeAt(0))*o,o*=this.NUMBER_RADIX_DECIMAL}if(0===parseInt((r/o).toString(10),10))for(o=Math.floor(o/this.NUMBER_RADIX_DECIMAL);0===parseInt((r/o).toString(10),10);){if(1===o){n.expLen--;break}o=Math.floor(o/this.NUMBER_RADIX_DECIMAL),n.expLen--}else{for(;0!==parseInt((r/o).toString(10),10);)o*=this.NUMBER_RADIX_DECIMAL,n.expLen++;o=Math.floor(o/this.NUMBER_RADIX_DECIMAL)}n.normalizedSize=o,n.normalizedExp=r},e.translateFloatingPointToChar=function(e,t,n,r){if(r<n.expLen+t)throw xn.warn("translateFloatingPointToChar: formatText length is not enough."),Error("translateFloatingPointToChar: formatText length is not enough.");for(var o=[],s=0;s<n.expLen;s++)o[s]="0".charCodeAt(0)+Math.floor(n.normalizedExp/n.normalizedSize),n.normalizedExp%=n.normalizedSize,n.normalizedSize=Math.floor(n.normalizedSize/this.NUMBER_RADIX_DECIMAL);var i=0,a=0;if(1===n.radixSign)for(i++;a<t;)i>=n.radixLen?(o[a+n.expLen]="0".charCodeAt(0),a++):("."!==e.charAt(i)&&(o[a+n.expLen]="0".charCodeAt(0)+9-e.charCodeAt(i)+"0".charCodeAt(0),a++),i++);else for(;a<t;)i>=n.radixLen?(o[a+n.expLen]="0".charCodeAt(0),a++):("."!==e.charAt(i)&&(o[a+n.expLen]=e.charCodeAt(i),a++),i++);return String.fromCharCode.apply(String,h(o))},e.convertToUint64Space=function(e,t,n,r){var s=Math.floor(t*this.CIPHER_SPACE_RATE/this.CIPHER_SPACE_RATE_BASE);return s-t<this.CIPHER_SPACE_LIMIT_LOG2&&(s=t+this.CIPHER_SPACE_LIMIT_LOG2),r.inSize=o.fromNumber(Math.pow(2,t),!0),r.inEdge=n<0?o.MAX_UNSIGNED_VALUE.divide(2).add(1).subtract(o.fromNumber(Math.pow(2,-n),!0)):0===n?o.UZERO:o.fromNumber(Math.pow(2,n),!0),r.outEdge=o.UONE,s>=this.INT64_DEFAULT_DIGIT?(r.outSize=o.MAX_UNSIGNED_VALUE,r.outLen=16):(r.outSize=o.fromNumber(Math.pow(2,s)),r.outLen=Math.floor((s-1)/4)+1,r.outLen%2!=0&&r.outLen++),n<0?e.greaterThan(o.MAX_UNSIGNED_VALUE.divide(2))?r.value=e.subtract(o.MAX_UNSIGNED_VALUE.divide(2)).subtract(1).toUnsigned():r.value=e.add(o.MAX_UNSIGNED_VALUE.divide(2)).add(1).toUnsigned():r.value=e,this.OPE_SUCCESS},e.convertToBigNumSpace=function(e,t,n,r,o){return null==o?this.convertToBigNumSpaceWithoutOutSize(e,t,n,r):(r.outEdge=new i(1),r.value=e,n<=0?(r.inEdge=new i(0),r.value=this.setBitLenToOneInBigNum(r.value,-n)):r.inEdge=new i(2).pow(n),r.inSize=new i(2).pow(t),r.outSize=new i(2).pow(o),r.outLen=Math.floor((o-1)/4)+1,r.outLen%2!=0&&r.outLen++,this.OPE_SUCCESS)},e.convertToBigNumSpaceWithoutOutSize=function(e,t,n,r){if(null==e)throw xn.warn("convertToBigNumSpace: plaintext is null."),Error("convertToBigNumSpace: plaintext is null.");r.inEdge=new i(0),r.inSize=new i(0),r.outEdge=new i(0),r.outSize=new i(0);var o=Math.floor(t*this.CIPHER_SPACE_RATE/this.CIPHER_SPACE_RATE_BASE);return o-t<this.CIPHER_SPACE_LIMIT_LOG2&&(o=t+this.CIPHER_SPACE_LIMIT_LOG2),this.convertToBigNumSpace(e,t,n,r,o)},e.setBitLenToOneInBigNum=function(e,t){if(t<=0)return e;var n=new i(2).pow(t);return e.plus(n)},e.NUMBER_RADIX_DECIMAL=10,e.NUMBER_RADIX_DECIMAL_LOG2=Math.log2(e.NUMBER_RADIX_DECIMAL),e.INT8_DEFAULT_DIGIT=8,e.INT16_DEFAULT_DIGIT=16,e.INT32_DEFAULT_DIGIT=32,e.INT64_DEFAULT_DIGIT=64,e.INT8_NEGATIVE_EDGE=-7,e.INT16_NEGATIVE_EDGE=-15,e.INT32_NEGATIVE_EDGE=-31,e.INT64_NEGATIVE_EDGE=-63,e.FLOAT_DEFAULT_PRECISION=8,e.FLOAT_EXPONENT_MAX_RANGE=38,e.FLOAT_EXPONENT_MAX_LEN=3,e.DOUBLE_DEFAULT_PRECISION=17,e.DOUBLE_EXPONENT_MAX_RANGE=308,e.DOUBLE_EXPONENT_MAX_LEN=4,e.PLAIN_TEXT_REDUNDANCY=8,e.PLAIN_TEXT_REDUNDANCY_LOG2=Math.log2(e.PLAIN_TEXT_REDUNDANCY),e.CIPHER_SPACE_RATE=13e3,e.CIPHER_SPACE_RATE_BASE=1e4,e.CIPHER_SPACE_LIMIT=1024,e.CIPHER_SPACE_LIMIT_LOG2=Math.log2(e.CIPHER_SPACE_LIMIT),e.STRING_VALID_BYTE_LEN=16,e.CHAR_SPACE_SIZE=256,e.FLOAT_VALID_DIGITS=7,e.DOUBLE_VALID_DIGITS=16,e.OPE_FAIL=-1,e.OPE_SUCCESS=1,e}(),qn=new T("OpeGenerator"),Ln=function(){function e(){}return e.prototype.generateOpeValue=function(e,t,n,r){if(null==e||null==t||t<=0||null==r||null==n)throw qn.warn("generateOpeValue: input parameter is invalid."),Error("generateOpeValue: input parameter is invalid.");var o;switch(this.inputVerification(e,n),n){case 1:case 2:case 3:case 4:case 6:o=this.generateOpeValueByUint64(e,n,r);break;case 5:case 9:case 7:o=this.generateOpeValueByBigNum(e,t,n,r);break;case 8:o=this.generateOpeValueForString(e,t,n,r);break;default:throw qn.warn("generateOpeValue: type: "+n+" is error."),Error("generateOpeValue: type: "+n+" is error.")}if(o.length<=0)throw qn.warn("generateOpeValue: generate ope value failed"),Error("generateOpeValue: generate ope value failed");return o},e.prototype.generateOpeValueByUint64=function(e,t,n){var r=new kn;if(Un.convertToOpeDataSpaceUint64(e,t,r)!==Un.OPE_SUCCESS)throw qn.warn("generateOpeValueByUint64: convert to uint64 space failed"),Error("generateOpeValueByUint64: convert to uint64 space failed");return this.getOpeValueByUint64(n,r)},e.prototype.generateOpeValueByBigNum=function(e,t,n,r){var o=new Mn;if(Un.convertToOpeDataSpaceBigNum(e,t,n,o)!==Un.OPE_SUCCESS)throw qn.warn("generateOpeValueByUint64: convert to bigNum space failed"),Error("generateOpeValueByUint64: convert to bigNum space failed");var s=this.getOpeValueByBigNum(r,o);if(s.length<=0)throw qn.warn("generateOpeValueByBigNum: generate ope value by bigNum failed"),Error("generateOpeValueByBigNum: generate ope value by bigNum failed");return s},e.prototype.generateOpeValueForString=function(t,n,r,o){var s=O.stringToUint8Array(t),i=0===s.length?1:s.length,a=i,u=(i-1)/e.STRING_TRUNCATED_BYTE_LEN+1;u=Math.floor(u);for(var c,l=0,d="",p=0;p<u;p++){a>e.STRING_TRUNCATED_BYTE_LEN?(a-=e.STRING_TRUNCATED_BYTE_LEN,c=e.STRING_TRUNCATED_BYTE_LEN):c=a;var f=s.subarray(p*e.STRING_TRUNCATED_BYTE_LEN,(p+1)*e.STRING_TRUNCATED_BYTE_LEN),h=this.generateOpeValueByBigNum(f,c,r,o);if(h.length<=0||l+h.length>e.MAX_ENTIRE_OPE_LEN)throw qn.warn("generateOpeValueForString: generate ope value by bigNum failed, opeValueLen: "+h.length+" truncateCnt: "+u),Error("generateOpeValueForString: generate ope value by bigNum failed, opeValueLen: "+h.length+" truncateCnt: "+u);d+=h,l+=h.length}return d},e.prototype.getOpeValueByUint64=function(t,n){var r=this.calculateOpeValueByUint64(n,t);if(r.equals(e.OPE_UINT64_ERROR))throw qn.warn("getOpeValueByUint64: calculate ope value by uint64 fail."),Error("getOpeValueByUint64: calculate ope value by uint64 fail.");return(Array(n.outLen).join("0")+r.toString(16).toUpperCase()).slice(-n.outLen)},e.prototype.getOpeValueByBigNum=function(e,t){var n=this.calculateOpeValueByBigNum(t,e).toString(16);return(Array(t.outLen).join("0")+n.toUpperCase()).slice(-t.outLen)},e.prototype.calculateOpeValueByUint64=function(e,t){for(var n=o.fromNumber(0);e.inSize.greaterThanOrEqual(1);){if(e.value.lessThan(e.inEdge)||e.value.greaterThanOrEqual(e.inEdge.add(e.inSize)))throw qn.warn("calculateOpeValueByUint64: value out of range by uint64."),Error("calculateOpeValueByUint64: value out of range by uint64.");if(e.inSize.equals(e.outSize))return e.outEdge.add(e.value).subtract(e.inEdge);if(e.inSize.equals(1))return this.uniformSampleInUint64(e.value,e,t);var r=e.inEdge.add(e.inSize.subtract(1).divide(2)),s=this.uniformSampleInUint64(r,kn.copy(e),t);e.value.lessThanOrEqual(r)?(e.inSize=r.subtract(e.inEdge).add(1),e.outSize=s.subtract(e.outEdge).add(1)):(e.inSize=e.inEdge.add(e.inSize).subtract(1).subtract(r),e.outSize=e.outEdge.add(e.outSize).subtract(1).subtract(s),e.inEdge=r.add(1),e.outEdge=s.add(1))}return n},e.prototype.uniformSampleInUint64=function(t,n,r){if(!n.inSize.equals(1)){var o=n.inSize.multiply(e.CIPHER_TEXT_SAMPLE_REDUNDANCY).divide(e.NUMBER_RADIX_DECIMAL);o.greaterThan(n.outSize)?(n.outEdge=n.outEdge.add(t).subtract(n.inEdge),n.outSize=n.outSize.subtract(n.inSize).subtract(1)):(n.outSize=n.outSize.add(1).subtract(o),n.outEdge=n.outEdge.add(t.subtract(n.inEdge).multiply(e.CIPHER_TEXT_SAMPLE_REDUNDANCY).divide(e.NUMBER_RADIX_DECIMAL)))}if(n.outSize.equals(1))return n.outEdge;for(var s,i=this.calculateCoinByUint64(t,n,r),a=0;n.outSize.greaterThan(1);)s=n.outEdge.add(n.outSize.subtract(1).divide(2)),"0"===i.charAt(a)?n.outSize=s.subtract(n.outEdge).add(1):(n.outSize=n.outEdge.add(n.outSize.subtract(1)).subtract(s),n.outEdge=s.add(1)),a++;return n.outEdge},e.prototype.calculateCoinByUint64=function(t,n,r){for(var o=a.enc.Utf8.parse(t.toString(10)).concat(r),s=a.SHA256(o).toString(a.enc.Hex),i=Math.floor((Math.floor(Math.log2(n.outSize.toNumber()))+1)/e.INT8_DEFAULT_DIGIT)+1,u="",c=0;c<i;c++)u+=this.hex2binForUint64(s.substring(2*c,2*(c+1)));return u},e.prototype.calculateOpeValueByBigNum=function(e,t){for(var n=new i(0);e.inSize.gte(1);){if(e.value.lt(e.inEdge)||e.value.gte(e.inEdge.plus(e.inSize)))throw qn.warn("calculateOpeValueByBigNum: value out of range by bigNum"),Error("calculateOpeValueByBigNum: value out of range by bigNum");if(e.inSize.eq(e.outSize))return e.outEdge.plus(e.value).minus(e.inEdge);if(e.inSize.eq(1))return this.uniformSampleInBigNum(e.value,e,t);var r=e.inEdge.plus(e.inSize.minus(1).dividedToIntegerBy(2)),o=this.uniformSampleInBigNum(r,e,t);e.value.lte(r)?(e.inSize=r.minus(e.inEdge).plus(1),e.outSize=o.minus(e.outEdge).plus(1)):(e.inSize=e.inSize.plus(e.inEdge).minus(1).minus(r),e.outSize=e.outSize.plus(e.outEdge).minus(1).minus(o),e.inEdge=r.plus(1),e.outEdge=o.plus(1))}return n},e.prototype.uniformSampleInBigNum=function(e,t,n){var r=Mn.copy(t);if(this.calculateSampleSpaceWithRedundancy(r,e),r.outSize.eq(1))return r.outEdge;var o=this.calculateSampleCoinInBigNum(e,n);return r.outEdge.plus(o.mod(r.outSize))},e.prototype.calculateSampleSpaceWithRedundancy=function(t,n){if(!t.inSize.eq(1)){var r=this.calculateRedundancySize(t);if(r.gt(t.outSize))t.outEdge=t.outEdge.plus(n).minus(t.inEdge),t.outSize=t.outSize.plus(1).minus(t.inSize);else{t.outSize=t.outSize.plus(1).minus(r);var o=n.minus(t.inEdge);o=o.times(e.CIPHER_TEXT_SAMPLE_REDUNDANCY).dividedToIntegerBy(10),t.outEdge=t.outEdge.plus(o)}}},e.prototype.calculateRedundancySize=function(t){var n=t.inSize;return n=(n=n.times(e.CIPHER_TEXT_SAMPLE_REDUNDANCY)).dividedToIntegerBy(e.NUMBER_RADIX_DECIMAL)},e.prototype.calculateSampleCoinInBigNum=function(e,t){var n=e.toString(16).toUpperCase();"0"!==n&&n.length%2!=0&&(n="0"+n);var r=a.enc.Utf8.parse(n).concat(t),o=a.SHA256(r);return new i("0x"+this.changeOrder(o.toString(a.enc.Hex)))},e.prototype.hex2binForUint64=function(e){return("00000000"+parseInt(e,16).toString(2)).substr(-8).split("").reverse().join("")},e.prototype.changeOrder=function(e){for(var t=e.length,n="";t>=0;)n+=e.substring(t-2,t),t-=2;return n},e.prototype.inputVerification=function(e,t){if(0===t)throw qn.warn("generateOpeValue: ope type input is invalid, type: OPE_TYPE_NULL."),Error("generateOpeValue: ope type input is invalid, OPE_TYPE_NULL.");if(1===t&&"1"!==e&&"0"!==e)throw qn.warn("generateOpeValue: boolean type input is invalid, input is not a boolean value."),Error("generateOpeValue: boolean type input is invalid.");if(8!==t&&1!==t){if(""===e||""===e.trim())throw qn.warn("generateOpeValue: Number type input is invalid, input is empty."),Error("generateOpeValue: Number type input is invalid.");if(isNaN(Number(e)))throw qn.warn("generateOpeValue: Number type input is invalid, input is NaN."),Error("generateOpeValue: Number type input is invalid.")}},e.NUMBER_RADIX_DECIMAL=10,e.INT8_DEFAULT_DIGIT=8,e.CIPHER_TEXT_SAMPLE_REDUNDANCY=11,e.MAX_ENTIRE_OPE_LEN=2400,e.OPE_UINT64_ERROR=o.UZERO,e.STRING_TRUNCATED_BYTE_LEN=16,e}(),Kn=require("crypto-js"),Bn=new T("EntireEncryption"),Vn=function(){function e(t){this.encryptInstance=e.encryptor,this.userKeysInfo=new Fn,this.naturalBaseRef=t}return e.setEncryptor=function(t){e.encryptor=t},e.prototype.aesGcm256Encrypt=function(e,t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.encryptInstance.encrypt(e,t,n)];case 1:return[2,r.sent()]}}))}))},e.prototype.aesGcm256Decrypt=function(e,t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.encryptInstance.decrypt(e,t,n)];case 1:return[2,r.sent()]}}))}))},e.prototype.generateRandom=function(e){return this.encryptInstance.generateRandom(e)},e.prototype.setKeys=function(e,t,n,r,o,s){return l(this,void 0,void 0,(function(){return d(this,(function(i){if(O.isNullOrUndefined(t)||O.isNullOrUndefined(r)||n<=0||o<0||s<=0)return Bn.error("setKeys: input dataKey or oldDataKey is invalid."),[2,Promise.reject(51)];Bn.log("setKeys: set iv key and encrypted key."),O.isStringEmpty(this.userKeysInfo.userId)||this.clearUserKeysInfo();try{this.generateKeys(t,r,o)}catch(e){return Bn.error("setKeys: set keys failed."),this.clearUserKeysInfo(),[2,Promise.reject(e.getCode())]}return this.userKeysInfo.userId=e,this.userKeysInfo.dataKeyVersion=s,[2]}))}))},e.prototype.conditionEntireEncryptedField=function(e,t,n,r){return l(this,void 0,void 0,(function(){var o;return d(this,(function(s){switch(s.label){case 0:return this.naturalBaseRef.getEntireEncryptInterval().setIntervalCleanKey(!0),o=this.getPlainText(n,r),[4,this.getOpeFieldDataValue(e,t,n,o)];case 1:return[2,s.sent()]}}))}))},e.prototype.encryptEntireEncryptedFields=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o,s,i,a,u,c,l,f;return d(this,(function(d){switch(d.label){case 0:Bn.debug("encryptEntireEncryptedFields: objectItems size: "+e.length),t=[],n=O.deepCopy(e),d.label=1;case 1:d.trys.push([1,7,8,9]),r=p(n),o=r.next(),d.label=2;case 2:return o.done?[3,6]:(s=o.value,i=O.getClassName(s),[4,this.isValidEncryptionOperation(i)]);case 3:return d.sent(),u=(a=t).push,[4,this.handleEntireEncryptedField(i,s)];case 4:u.apply(a,[d.sent()]),d.label=5;case 5:return o=r.next(),[3,2];case 6:return[3,9];case 7:return c=d.sent(),l={error:c},[3,9];case 8:try{o&&!o.done&&(f=r.return)&&f.call(r)}finally{if(l)throw l.error}return[7];case 9:return Bn.debug("encryptEntireEncryptedFields done"),[2,Promise.resolve(t)]}}))}))},e.prototype.handleEntireEncryptedField=function(e,t){return l(this,void 0,void 0,(function(){var n,r,o,s,i,a,u,c,l;return d(this,(function(d){switch(d.label){case 0:n=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(e),r=n.getEncryptFieldList(),o=t,d.label=1;case 1:d.trys.push([1,6,7,8]),s=p(r),i=s.next(),d.label=2;case 2:return i.done?[3,5]:(a=i.value,this.naturalBaseRef.getEntireEncryptInterval().setIntervalCleanKey(!0),[4,this.encryptEntireEncryptedField(e,a.fieldName,a.fieldType,t)]);case 3:o=d.sent(),d.label=4;case 4:return i=s.next(),[3,2];case 5:return[3,8];case 6:return u=d.sent(),c={error:u},[3,8];case 7:try{i&&!i.done&&(l=s.return)&&l.call(s)}finally{if(c)throw c.error}return[7];case 8:return[2,Promise.resolve(o)]}}))}))},e.prototype.encryptEntireEncryptedField=function(e,t,n,r){return l(this,void 0,void 0,(function(){var o,s,i,a,u,c;return d(this,(function(l){switch(l.label){case 0:return o=r[t],O.isNullOrUndefined(o)?[2,r]:[4,this.checkUserId()];case 1:return l.sent(),s=this.getPlainText(n,o),i=r,a=t,[4,this.encryptFieldData(e,t,s)];case 2:return i[a]=l.sent(),[4,this.getOpeFieldDataValue(e,t,n,s)];case 3:return u=l.sent(),c=-1!==t.indexOf("#ope")?t:t+"#ope",r[c]=u,[2,Promise.resolve(r)]}}))}))},e.prototype.getPlainText=function(e,t){var n="",r=Pe.toString(e);switch(e){case _e.Boolean:n=!0===t?"1":"0";break;case _e.Integer:case _e.Short:case _e.Float:case _e.Double:case _e.Byte:case _e.Long:case _e.IntAutoIncrement:case _e.LongAutoIncrement:n=t.toString();break;case _e.Date:n=t.getTime().toString();break;case _e.String:n=t;break;default:throw Bn.error("getPlainText: inputValue fieldType:"+r+" is error."),E.build(1003)}if(n.length>800)throw Bn.error("Plaintext length cannot be greater than 800."),E.build(1003);return n},e.prototype.encryptFieldData=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s,i,a,u,c;return d(this,(function(l){switch(l.label){case 0:if(r=e+":"+t,o=this.calculateGcmIv(r,O.stringToUint8Array(n)),!((s=this.userKeysInfo.encryptedKeyMap.get(r))||(Bn.warn("encryptFieldData: this field has not encryptKey."),this.generateEncryptedKey(r,this.userKeysInfo.dataKeyPlaintext),s=this.userKeysInfo.encryptedKeyMap.get(r))))throw Bn.error("encryptFieldData: not found regenerate field encryptKey."),E.build(1);return[4,this.aesGcm256Encrypt(O.stringToUint8Array(n),s,o)];case 1:if(!(i=l.sent()))throw Bn.error("encryptFieldData: encrypt failed."),E.build(52);return a=i.slice(0,i.length-Qn),u=i.slice(i.length-Qn,i.length),c=Array.from(o).concat(Array.from(u)).concat(Array.from(a)),[2,Promise.resolve(new Uint8Array(c))]}}))}))},e.prototype.calculateGcmIv=function(e,t){var n=this.userKeysInfo.ivKeyMap.get(e);if(!n){if(!this.userKeysInfo.dataKeyPlaintext)throw Bn.error("calculateGcmIv: this field has not encryptedKey."),E.build(1);if(this.generateIvKey(e,this.userKeysInfo.dataKeyPlaintext),!(n=this.userKeysInfo.ivKeyMap.get(e)))throw Bn.error("calculateGcmIv: GenerateIvKey not found."),E.build(1)}var r=this.calculateHmacSha256(n,O.uint8ArrayToString(t));return O.wordArrayToUint8Array(r).slice(0,Hn)},e.prototype.getOpeFieldDataValue=function(e,t,n,r){return l(this,void 0,void 0,(function(){var o,s,i,a,u;return d(this,(function(c){if(o=r.length>0?r.length:1,s=e+":"+t,!((i=this.userKeysInfo.opeKeyMap.get(s))||(Bn.warn("getOpeFieldDataValue: this field has not opeKey."),this.generateOpeKey(s,this.userKeysInfo.dataKeyPlaintext),i=this.userKeysInfo.opeKeyMap.get(s))))throw Bn.error("getOpeFieldDataValue: not found regenerate field opeKey."),E.build(1);a=this.convertFieldToOpeDataType(n);try{return u=(new Ln).generateOpeValue(r,o,a,i),[2,Promise.resolve(u)]}catch(e){throw Bn.error("Encrypt data failed, please check user key validity.for"+e),E.build(52)}return[2]}))}))},e.prototype.convertFieldToOpeDataType=function(e){var t=8;switch(e){case _e.Integer:t=4;break;case _e.Byte:t=2;break;case _e.Short:t=3;break;case _e.Long:t=5;break;case _e.Float:t=6;break;case _e.Double:t=7;break;case _e.String:case _e.Text:t=8;break;case _e.Date:t=9;break;case _e.Boolean:t=1;break;default:Bn.error("convertFieldToOpeDataType: fieldType is Unknown")}return t},e.prototype.decryptEntireEncryptedFields=function(e,t){return l(this,void 0,void 0,(function(){var n,r,o,s,i,a,u,c,l,f,h;return d(this,(function(d){switch(d.label){case 0:d.trys.push([0,9,,10]),n=[],r=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(e.getClassName()),o=r.getEncryptFieldList(),d.label=1;case 1:d.trys.push([1,6,7,8]),s=p(t),i=s.next(),d.label=2;case 2:return i.done?[3,5]:(a=i.value,[4,this.innerDecryptEntireEncryptedFields(e,o,a)]);case 3:u=d.sent(),n.push(u),d.label=4;case 4:return i=s.next(),[3,2];case 5:return[3,8];case 6:return c=d.sent(),f={error:c},[3,8];case 7:try{i&&!i.done&&(h=s.return)&&h.call(s)}finally{if(f)throw f.error}return[7];case 8:return[2,Promise.resolve(n)];case 9:return l=d.sent(),[2,Promise.reject(l)];case 10:return[2]}}))}))},e.prototype.innerDecryptEntireEncryptedFields=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s,i,a,u,c,l,f,h=this;return d(this,(function(y){switch(y.label){case 0:return n.setObjectTypeName(e.getClazz()),r=this.naturalBaseRef.getDefaultNaturalStore().getDataModelHelper().deserialize(e.getClazz(),n.getObject()),t&&0!==t.length?[4,this.checkUserId()]:(n.setUserObject(r),[2,Promise.resolve(r)]);case 1:y.sent(),o=function(t){var n,o,i,a,u,c,l;return d(this,(function(d){switch(d.label){case 0:if(n=t.fieldName,!(o=r[n]))return[2,"continue"];if(!(i=s.userKeysInfo.encryptedKeyMap.get(e.getClassName()+":"+n)))throw Bn.error("innerDecryptEntireEncryptedFields: get encryptKey failed."),E.build(1);return s.naturalBaseRef.getEntireEncryptInterval().setIntervalCleanKey(!0),"string"==typeof o&&(o=O.wordArrayToUint8Array(O.decode(o))),a=o.slice(0,Hn),u=o.slice(Hn,Hn+Qn),c=o.slice(Hn+Qn,o.length),l=Array.from(c).concat(Array.from(u)),[4,s.aesGcm256Decrypt(new Uint8Array(l),i,a).then((function(e){h.decryptFieldData(e,n,t.fieldType,r)})).catch((function(){throw Bn.error("innerDecryptEntireEncryptedFields: decrypt text failed."),E.build(53)}))];case 1:return d.sent(),[2]}}))},s=this,y.label=2;case 2:y.trys.push([2,7,8,9]),i=p(t),a=i.next(),y.label=3;case 3:return a.done?[3,6]:(u=a.value,[5,o(u)]);case 4:y.sent(),y.label=5;case 5:return a=i.next(),[3,3];case 6:return[3,9];case 7:return c=y.sent(),l={error:c},[3,9];case 8:try{a&&!a.done&&(f=i.return)&&f.call(i)}finally{if(l)throw l.error}return[7];case 9:return n.setUserObject(r),[2,Promise.resolve(r)]}}))}))},e.prototype.decryptFieldData=function(e,t,n,r){var s=O.uint8ArrayToString(e);switch(n){case _e.Boolean:r[t]="1"===s;break;case _e.Byte:case _e.Short:case _e.Integer:r[t]=parseInt(s,10);break;case _e.Float:case _e.Double:r[t]=parseFloat(s);break;case _e.String:case _e.Text:r[t]=s;break;case _e.Date:r[t]=new Date(parseInt(s,10));break;case _e.Long:r[t]=o.fromString(s)}return r},e.prototype.clearUserKeysInfo=function(){Bn.log("clearUserKeysInfo: clear userKeys."),this.userKeysInfo.userId="",this.userKeysInfo.dataKeyVersion=0,this.clearUserKey(this.userKeysInfo.ivKeyMap),this.clearUserKey(this.userKeysInfo.encryptedKeyMap),this.clearUserKey(this.userKeysInfo.oldEncryptedKeyMap),this.clearUserKey(this.userKeysInfo.opeKeyMap)},e.prototype.clearUserKey=function(e){e.clear()},e.prototype.generateKeys=function(e,t,n){var r,o,s,i,a=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema();if(0===a.size)throw Bn.error("generateKeys: schemas have not been loaded."),E.build(1);try{for(var u=p(a),c=u.next();!c.done;c=u.next()){var l=c.value,d=l[1].getEncryptFieldList();try{for(var f=(s=void 0,p(d)),h=f.next();!h.done;h=f.next()){var y=h.value,b=l[0]+":"+y.fieldName;this.generateColumnKeys(b,e,t,n)}}catch(e){s={error:e}}finally{try{h&&!h.done&&(i=f.return)&&i.call(f)}finally{if(s)throw s.error}}}}catch(e){r={error:e}}finally{try{c&&!c.done&&(o=u.return)&&o.call(u)}finally{if(r)throw r.error}}},e.prototype.generateColumnKeys=function(e,t,n,r){this.generateEncryptedKey(e,t),r>0&&this.generateOldEncryptedKey(e,n),this.generateIvKey(e,t),this.generateOpeKey(e,t)},e.prototype.generateEncryptedKey=function(e,t){if(this.userKeysInfo.encryptedKeyMap.has(e))Bn.log("generateEncryptedKey: encryptedKey of the tableFieldName already existed.");else{var n=e;n+=" generate encryption key with encryption algorithm AES_256_GCM_HMAC_SHA256";var r=this.calculateHmacSha256(t,n);this.userKeysInfo.encryptedKeyMap.set(e,O.wordArrayToUint8Array(r))}},e.prototype.generateOldEncryptedKey=function(e,t){if(this.userKeysInfo.oldEncryptedKeyMap.has(e))Bn.log("generateOldEncryptedKey: oldEncryptedKey of the tableFieldName already existed.");else{var n=e+" generate encryption key with encryption algorithm AES_256_GCM_HMAC_SHA256",r=this.calculateHmacSha256(t,n);this.userKeysInfo.oldEncryptedKeyMap.set(e,O.wordArrayToUint8Array(r))}},e.prototype.generateIvKey=function(e,t){if(this.userKeysInfo.ivKeyMap.has(e))Bn.log("generateIvKey: ivKey of the tableFieldName already existed.");else{var n=e+" generate IV key with encryption algorithm AES_256_GCM_HMAC_SHA256",r=this.calculateHmacSha256(t,n);this.userKeysInfo.ivKeyMap.set(e,O.wordArrayToUint8Array(r))}},e.prototype.generateOpeKey=function(e,t){if(this.userKeysInfo.opeKeyMap.has(e))Bn.log("generateOpeKey: opeKey of the tableFieldName already existed.");else{var n=e+" generate Order-preserving key with encryption algorithm AES_256_GCM_HMAC_SHA256",r=this.calculateHmacSha256(t,n);this.userKeysInfo.opeKeyMap.set(e,r)}},e.prototype.calculateHmacSha256=function(e,t){var n=O.uint8ArrayToWordArray(e),r=O.uint8ArrayToWordArray(O.stringToUint8Array(t)),o=Kn.HmacSHA256(r,n);if(!o)throw Bn.error("calculateHmacSha256: calculate hmac failed."),E.build(1);return o},e.prototype.isValidEncryptionOperation=function(e){return l(this,void 0,void 0,(function(){var t,n;return d(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),(null==(t=this.naturalBaseRef.getDefaultNaturalStore().getAppSchema().get(e))?void 0:t.isEncryptTable())?[4,this.checkUserId()]:[2];case 1:return r.sent(),[3,3];case 2:return n=r.sent(),[2,Promise.reject(O.isErrorObject(n)?n:E.build(n))];case 3:return[2]}}))}))},e.prototype.checkUserId=function(){return l(this,void 0,void 0,(function(){var e,t;return d(this,(function(r){switch(r.label){case 0:return[4,n.auth().getCurrentUser()];case 1:return e=r.sent(),(t=null==e?void 0:e.getUid())&&0!==t.length?0===this.userKeysInfo.dataKeyVersion?(Bn.error("checkUserId: data key version is invalid."),[2,Promise.reject(51)]):t!==this.userKeysInfo.userId?(Bn.error("checkUserId: this user is not the current user, please verify user key first."),[2,Promise.reject(15)]):[2]:(Bn.error("checkUserId: this user is not authenticated."),[2,Promise.reject(15)])}}))}))},e.prototype.GetEncryptVersion=function(){return this.userKeysInfo.dataKeyVersion},e}(),Fn=function(){this.ivKeyMap=new Map,this.encryptedKeyMap=new Map,this.oldEncryptedKeyMap=new Map,this.opeKeyMap=new Map,this.userId="",this.dataKeyVersion=0,this.dataKeyPlaintext=new Uint8Array,this.oldDataKeyPlaintext=new Uint8Array,this.dataKeyPlaintextLen=0,this.oldDataKeyPlaintextLen=0},zn=require("crypto-js"),Gn=/^[0-9a-zA-Z`~!@#$%^&*()-_=+\\\\|\\[{\]};:'",<.>/? ]{6,32}$/,Yn=/^(?![0-9]+$)(?![a-z]+$)(?![A-Z]+$)(?![^a-zA-Z0-9]+$)[0-9a-zA-Z`~!@#$%^&*()-_=+\\\\|\\[{\]};:'",<.>? ]{8,32}$/,Qn=16,Hn=12,Wn=Hn+Qn+32,Xn=new T("SecretKeyManager"),Zn=function(){function e(e){this.userDataKeyInfo=new Jn,this.cloudStorage=e.getNaturalCloudStorage(),this.entireEncryption=new Vn(e),this.entireEncryptInterval=e.getEntireEncryptInterval(),this.entireEncryptInterval.saveSecretKeyManager(this)}return e.prototype.getEntireEncryption=function(){return this.entireEncryption},e.prototype.setUserKey=function(e,t){return l(this,void 0,void 0,(function(){var n,r,o,s;return d(this,(function(i){switch(i.label){case 0:return this.checkUserKeyFormat(e,!1),[4,this.getUserId()];case 1:return n=i.sent(),r=new Jn,[4,this.getSaltFromCloud()];case 2:return o=i.sent(),0!==(s=o.resultCode)?[3,4]:(Xn.log("setUserKey: user key has been created, need to verify it."),r.rootKeySalt=o.encryptInfo[0].firstSaltValue,r.rootKeyTokenSalt=o.encryptInfo[0].secondSaltValue,[4,this.verifyUserKey(n,e,r)]);case 3:return i.sent(),this.entireEncryptInterval.setIntervalCleanKey(!1),[3,7];case 4:return 54!==s?[3,6]:(Xn.log("setUserKey: the first time to set user key."),[4,this.createUserKey(n,e,r,t)]);case 5:return i.sent(),this.entireEncryptInterval.setIntervalCleanKey(!1),[3,7];case 6:return Xn.error("setUserKey: get salt failed, ret: "+s+"."),this.clearDataKeyInfo(),this.entireEncryption.clearUserKeysInfo(),[2,Promise.reject(s)];case 7:return this.userDataKeyInfo.copy(r),[2]}}))}))},e.prototype.modifyUserKey=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s;return d(this,(function(i){switch(i.label){case 0:return this.checkUserKeyFormat(e,!1),this.checkUserKeyFormat(t,n),[4,this.getUserId()];case 1:return r=i.sent(),o=new Jn,[4,this.getSaltFromCloud()];case 2:return 0!==(s=i.sent()).resultCode?(Xn.error("ModifyUserKey: get user salt failed."),[2,Promise.reject(s.resultCode)]):(o.rootKeySalt=s.encryptInfo[0].firstSaltValue,o.rootKeyTokenSalt=s.encryptInfo[0].secondSaltValue,[4,this.modifyUserKeyInner(r,e,t,o)]);case 3:return i.sent(),this.userDataKeyInfo.copy(o),this.entireEncryptInterval.setIntervalCleanKey(!1),[2]}}))}))},e.prototype.verifyUserKey=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s,i,a;return d(this,(function(u){switch(u.label){case 0:this.clearDataKeyInfo(),u.label=1;case 1:return u.trys.push([1,4,,5]),[4,this.queryDataKeyCipher(t,n)];case 2:return r=u.sent(),o=r[0],s=r[1],n.userId=e,i=this.saveUserDataKey(o,s,n),[4,this.entireEncryption.setKeys(e,o,8,s,i,n.dataKeyVersion)];case 3:return u.sent(),[3,5];case 4:return a=u.sent(),Xn.error("verifyUserKey: verify user key failed, ret: "+a+"."),this.clearDataKeyInfo(),this.entireEncryption.clearUserKeysInfo(),[2,Promise.reject(a)];case 5:return[2]}}))}))},e.prototype.createUserKey=function(e,t,n,r){return l(this,void 0,void 0,(function(){var o,s,i,a;return d(this,(function(u){switch(u.label){case 0:r&&this.checkUserKeyFormat(t,!0),this.clearDataKeyInfo(),u.label=1;case 1:return u.trys.push([1,5,,6]),o=this.generateRandom(32),[4,this.generateUserKey(t,n,o)];case 2:return u.sent(),[4,this.InsertEncryptionInfoToCloud(n)];case 3:return u.sent(),n.userId=e,s=O.uint8ArrayToWordArray(o),n.userDataKey=O.stringToUint8Array(this.encodeDataKey(s)),n.userDataKeyLen=44,i=new Uint8Array(8),[4,this.entireEncryption.setKeys(n.userId,o,8,i,0,++n.dataKeyVersion)];case 4:return u.sent(),[3,6];case 5:return a=u.sent(),Xn.error("createUserKey: create user key failed, ret: "+a+"."),this.clearDataKeyInfo(),this.entireEncryption.clearUserKeysInfo(),[2,Promise.reject(a)];case 6:return[2]}}))}))},e.prototype.modifyUserKeyInner=function(e,t,n,r){return l(this,void 0,void 0,(function(){var o,s,i,a;return d(this,(function(u){switch(u.label){case 0:return this.clearDataKeyInfo(),[4,this.queryDataKeyCipher(t,r)];case 1:return o=u.sent(),Xn.log("SecretKeyManager: query data key cipher success."),s=o[0],i=o[1],a=r.userRootKeyToken,[4,this.reGenerateUserKey(n,r,s,i)];case 2:return u.sent(),[4,this.updateEncryptionInfoToCloud(a,r)];case 3:return u.sent(),r.userId=e,this.saveUserDataKey(s,i,r),[2]}}))}))},e.prototype.queryDataKeyCipher=function(e,t){return l(this,void 0,void 0,(function(){var n,r,o,s;return d(this,(function(i){switch(i.label){case 0:return n={keySize:8,hasher:zn.algo.SHA256.create(),iterations:1e5},r=zn.PBKDF2(e,O.uint8ArrayToWordArray(t.rootKeySalt),n),O.isNullOrUndefined(r)?(Xn.error("queryDataKeyCipher: derive root key failed."),[2,Promise.reject(1)]):(t.userRootKey=O.wordArrayToUint8Array(r),t.userRootKeyLen=8,o={keySize:8,hasher:zn.algo.SHA256.create(),iterations:1e4},s=zn.PBKDF2(r,O.uint8ArrayToWordArray(t.rootKeyTokenSalt),o),O.isNullOrUndefined(s)?(Xn.error("QueryDataKeyCipher: derive root key token failed."),[2,Promise.reject(1)]):(t.userRootKeyToken=O.wordArrayToUint8Array(s),t.userRootKeyTokenLen=8,[4,this.queryDataKeyCipherFromCloud(t)]));case 1:return i.sent(),[4,this.decryptQueryCipherText(t)];case 2:return[2,i.sent()]}}))}))},e.prototype.reGenerateUserKey=function(e,t,n,r){return l(this,void 0,void 0,(function(){var o,s;return d(this,(function(i){switch(i.label){case 0:return[4,this.generateUserKey(e,t,n)];case 1:return i.sent(),t.userOldDataKeyCipherLen>0?(o=this.generateRandom(Hn))?[4,this.entireEncryption.aesGcm256Encrypt(r,t.userRootKey,o)]:(Xn.warn("reGenerateUserKey: random to generate gcmIv failed."),[2,Promise.reject(1)]):[3,3];case 2:if((s=i.sent()).length<=0)return Xn.warn("reGenerateUserKey: encrypt old dataKey failed."),[2,Promise.reject(52)];t.userOldDataKeyCipher={iv:o,tag:s.slice(32,s.length),cipherText:s.slice(0,32)},i.label=3;case 3:return[2]}}))}))},e.prototype.generateUserKey=function(e,t,n){return l(this,void 0,void 0,(function(){var r,o,s,i,a,u,c,l,p;return d(this,(function(d){switch(d.label){case 0:return t.rootKeySalt=this.generateRandom(16),r={keySize:8,hasher:zn.algo.SHA256.create(),iterations:1e5},o=O.uint8ArrayToWordArray(t.rootKeySalt),[4,zn.PBKDF2(e,o,r)];case 1:return s=d.sent(),O.isNullOrUndefined(s)?(Xn.warn("GenerateUserKey: derive root key failed."),[2,Promise.reject(1)]):(i=O.wordArrayToUint8Array(s),t.userRootKey=i,t.userRootKeyLen=8,t.rootKeyTokenSalt=this.generateRandom(16),a={keySize:8,hasher:zn.algo.SHA256.create(),iterations:1e4},u=O.uint8ArrayToWordArray(t.rootKeyTokenSalt),[4,zn.PBKDF2(s,u,a)]);case 2:return c=d.sent(),O.isNullOrUndefined(c)?(Xn.warn("GenerateUserKey: derive root key token failed."),[2,Promise.reject(1)]):(t.userRootKeyToken=O.wordArrayToUint8Array(c),t.userRootKeyTokenLen=8,(l=this.generateRandom(Hn))?[4,this.entireEncryption.aesGcm256Encrypt(n,i,l)]:(Xn.warn("GenerateUserKey: random to generate gcmIv failed."),[2,Promise.reject(1)]));case 3:return(p=d.sent())?(t.userDataKeyCipher={iv:l,tag:p.slice(32,p.length),cipherText:p.slice(0,32)},[2]):(Xn.warn("GenerateUserKey: encrypt dataKey failed."),[2,Promise.reject(52)])}}))}))},e.prototype.onKeyStatusChanged=function(e){return l(this,void 0,void 0,(function(){var t;return d(this,(function(n){switch(n.label){case 0:return Xn.log("onKeyStatusChanged: process call back with dataKey changed, keyStatus: "+e),(t=e)!==ue.INTERRUPT&&t!==ue.NORMAL?[2,Promise.resolve(0)]:[4,this.queryDataKeyAfterReKey()];case 1:return n.sent(),[2,Promise.resolve(0)]}}))}))},e.prototype.queryDataKeyAfterReKey=function(){var e;return l(this,void 0,void 0,(function(){var t,n,r;return d(this,(function(o){switch(o.label){case 0:return[4,this.checkDataKeyCache()];case 1:return o.sent(),(t=new de).rootKeyToken=this.userDataKeyInfo.userRootKeyToken,[4,this.cloudStorage.queryDataKeyCipherText(t)];case 2:return 0!==(n=o.sent()).resultCode?(Xn.warn("queryDataKeyAfterReKey: query data key cipher failed from cloud,\n             ret:"+n.resultCode+"."),[2,Promise.reject(n.resultCode)]):(r=n.encryptInfo[0]).dataKeyCipherText&&r.dataKeyCipherText.length===Wn?this.userDataKeyInfo.dataKeyVersion<r.keyVersion?[4,this.refreshDataKeyCache(r)]:[3,4]:(Xn.warn("queryDataKeyAfterReKey: cloud saved dataKeyCipherText is invalid,\n             dataKeyCipherText length: "+(null===(e=r.dataKeyCipherText)||void 0===e?void 0:e.length)),[2,Promise.reject(51)]);case 3:o.sent(),o.label=4;case 4:return[2]}}))}))},e.prototype.checkKeyIfNetworkReconnect=function(){return l(this,void 0,void 0,(function(){var e,t;return d(this,(function(n){switch(n.label){case 0:return Xn.log("CheckKeyIfNetworkReconnect: check userKey or dataKey changed after reconnect."),[4,this.checkDataKeyCache()];case 1:return n.sent(),(e=new de).rootKeyToken=this.userDataKeyInfo.userRootKeyToken,[4,this.cloudStorage.queryDataKeyCipherText(e)];case 2:return 0!==(t=n.sent()).resultCode?(Xn.warn("CheckKeyIfNetworkReconnect: query data key cipher failed from cloud,\n             ret:"+t.resultCode+"."),[2,Promise.reject(t.resultCode)]):[2,this.processDataKeyChangedByReconnect(t.encryptInfo[0])]}}))}))},e.prototype.processDataKeyChangedByReconnect=function(e){return l(this,void 0,void 0,(function(){var t;return d(this,(function(n){switch(n.label){case 0:return e?(t=e.keyStatus,Xn.info("ProcessDataKeyChangedByReconnect: process reconnect with dataKey changed,' +\n            ' keyStatus: "+t+"."),t===ue.INTERRUPT||t===ue.NORMAL&&this.userDataKeyInfo.dataKeyVersion<e.keyVersion?[4,this.refreshDataKeyCache(e)]:[2,Promise.resolve(0)]):(Xn.warn("ProcessDataKeyChangedByReconnect: encryptionInfo is null"),[2,Promise.reject(1003)]);case 1:return n.sent(),Xn.log("processDataKeyChangedByReconnect success"),[2,Promise.resolve(0)]}}))}))},e.prototype.refreshDataKeyCache=function(e){var t;return l(this,void 0,void 0,(function(){var n,r,o,s;return d(this,(function(i){switch(i.label){case 0:return this.clearOldDataKeyInfo(),e.dataKeyCipherText&&e.dataKeyCipherText.byteLength===Wn?(this.saveDataKeyCipher(e,this.userDataKeyInfo),[4,this.decryptQueryCipherText(this.userDataKeyInfo)]):(Xn.warn("refreshDataKeyCache: cloud saved dataKeyCipherText is invalid,\n             dataKeyCipherText length: "+(null===(t=e.dataKeyCipherText)||void 0===t?void 0:t.length)),[2,Promise.reject(51)]);case 1:return n=i.sent(),r=n[0],o=n[1],s=this.saveUserDataKey(r,o,this.userDataKeyInfo),[4,this.entireEncryption.setKeys(this.userDataKeyInfo.userId,r,8,o,s,this.userDataKeyInfo.dataKeyVersion)];case 2:return i.sent(),[2]}}))}))},e.prototype.decryptQueryCipherText=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o,s,i,a,u,c;return d(this,(function(l){switch(l.label){case 0:t=[new Uint8Array(32),new Uint8Array(32)],n=Array.from(e.userDataKeyCipher.cipherText).concat(Array.from(e.userDataKeyCipher.tag)),r=e.userDataKeyCipher.iv,l.label=1;case 1:return l.trys.push([1,3,,4]),o=t,s=0,[4,this.entireEncryption.aesGcm256Decrypt(new Uint8Array(n),e.userRootKey,r)];case 2:return o[s]=l.sent(),[3,4];case 3:return l.sent(),Xn.error("decryptQueryCipherText:decrypt dataKeyCipher failed."),[2,Promise.reject(53)];case 4:if(!(e.userOldDataKeyCipherLen>0))return[3,8];i=Array.from(e.userOldDataKeyCipher.cipherText).concat(Array.from(e.userOldDataKeyCipher.tag)),a=e.userOldDataKeyCipher.iv,l.label=5;case 5:return l.trys.push([5,7,,8]),u=t,c=1,[4,this.entireEncryption.aesGcm256Decrypt(new Uint8Array(i),e.userRootKey,a)];case 6:return u[c]=l.sent(),[3,8];case 7:return l.sent(),Xn.error("QueryDataKeyCipher:decrypt oldDataKeyCipher failed."),[2,Promise.reject(53)];case 8:return[2,Promise.resolve(t)]}}))}))},e.prototype.saveDataKeyCipher=function(e,t){var n=e.dataKeyCipherText,r=n.slice(0,Hn),o=n.slice(Hn,Hn+Qn),s=n.slice(Hn+Qn,n.length);if(t.userDataKeyCipher={cipherText:s,tag:o,iv:r},t.userDataKeyCipherLen=Wn,t.dataKeyVersion=e.keyVersion,t.dataKeyStatus=e.keyStatus,e.oldDataKeyCipherText&&e.oldDataKeyCipherText.length===Wn){var i=e.oldDataKeyCipherText,a=i.slice(0,Hn),u=i.slice(Hn,Hn+Qn),c=i.slice(Hn+Qn,i.length);t.userOldDataKeyCipher={cipherText:c,tag:u,iv:a},t.userOldDataKeyCipherLen=Wn}},e.prototype.saveUserDataKey=function(e,t,n){var r=O.uint8ArrayToWordArray(e);n.userDataKey=O.stringToUint8Array(this.encodeDataKey(r)),n.userDataKeyLen=44;var o=0;if(n.userOldDataKeyCipherLen>0){var s=O.uint8ArrayToWordArray(t);n.userOldDataKey=O.stringToUint8Array(this.encodeDataKey(s)),n.userDataKeyLen=44,o=8}return o},e.prototype.getSaltFromCloud=function(){var e,t,n,r;return l(this,void 0,void 0,(function(){var o;return d(this,(function(s){switch(s.label){case 0:return[4,this.cloudStorage.querySaltValue()];case 1:return 0!==(o=s.sent()).resultCode?(Xn.warn("GetSaltFromCloud: cloud has not saved this user`s salt."),[2,o]):o.encryptInfo[0]&&o.encryptInfo[0].firstSaltValue&&o.encryptInfo[0].secondSaltValue?16!==(null===(e=o.encryptInfo[0].firstSaltValue)||void 0===e?void 0:e.length)||16!==(null===(t=o.encryptInfo[0].secondSaltValue)||void 0===t?void 0:t.length)?(Xn.warn("GetSaltFromCloud: cloud saved salt length is not effective length,             firstSalt length:"+(null===(n=o.encryptInfo[0].firstSaltValue)||void 0===n?void 0:n.length)+",              secondSalt length:"+(null===(r=o.encryptInfo[0].secondSaltValue)||void 0===r?void 0:r.length)),[2,new pe(1,[])]):[2,o]:(Xn.warn("GetSaltFromCloud: cloud saved salt value is null."),[2,new pe(54,[])])}}))}))},e.prototype.InsertEncryptionInfoToCloud=function(e){return l(this,void 0,void 0,(function(){var t,n,r;return d(this,(function(o){switch(o.label){case 0:return(t=new de).firstSaltValue=e.rootKeySalt,t.secondSaltValue=e.rootKeyTokenSalt,t.rootKeyToken=e.userRootKeyToken,n=Array.from(e.userDataKeyCipher.iv).concat(Array.from(e.userDataKeyCipher.tag)).concat(Array.from(e.userDataKeyCipher.cipherText)),t.dataKeyCipherText=new Uint8Array(n),[4,this.cloudStorage.insertEncryptedInfo(t)];case 1:return 0!==(r=o.sent()).resultCode?(Xn.warn("InsertEncryptionInfoToCloud: insert encrypt info failed."),[2,Promise.reject(r.resultCode)]):[2]}}))}))},e.prototype.queryDataKeyCipherFromCloud=function(e){var t;return l(this,void 0,void 0,(function(){var n,r,o;return d(this,(function(s){switch(s.label){case 0:return(n=new de).rootKeyToken=e.userRootKeyToken,[4,this.cloudStorage.queryDataKeyCipherText(n)];case 1:return 0!==(r=s.sent()).resultCode?(Xn.warn("QueryDataKeyCipherFromCloud: query dataKeyCipher failed."),[2,Promise.reject(r.resultCode)]):(o=r.encryptInfo[0]).dataKeyCipherText&&o.dataKeyCipherText.length===Wn?(this.saveDataKeyCipher(o,e),[2]):(Xn.warn("queryDataKeyCipherFromCloud: cloud saved dataKeyCipherText is invalid,\n             dataKeyCipherText length: "+(null===(t=o.dataKeyCipherText)||void 0===t?void 0:t.length)),[2,Promise.reject(1)])}}))}))},e.prototype.updateEncryptionInfoToCloud=function(e,t){return l(this,void 0,void 0,(function(){var n,r,o,s,i;return d(this,(function(a){switch(a.label){case 0:return(n=new de).rootKeyToken=e,r=Array.from(t.userDataKeyCipher.iv).concat(Array.from(t.userDataKeyCipher.tag)).concat(Array.from(t.userDataKeyCipher.cipherText)),(o=new de).firstSaltValue=t.rootKeySalt,o.secondSaltValue=t.rootKeyTokenSalt,o.rootKeyToken=t.userRootKeyToken,o.dataKeyCipherText=new Uint8Array(r),t.userOldDataKeyCipherLen>0&&(s=Array.from(t.userOldDataKeyCipher.iv).concat(Array.from(t.userOldDataKeyCipher.tag)).concat(Array.from(t.userOldDataKeyCipher.cipherText)),o.oldDataKeyCipherText=new Uint8Array(s)),[4,this.cloudStorage.updateEncryptedInfo(n,o)];case 1:return 0!==(i=a.sent()).resultCode?(Xn.warn("updateEncryptionInfoToCloud: update encrypt info failed."),[2,Promise.reject(i.resultCode)]):[2]}}))}))},e.prototype.getUserId=function(){return l(this,void 0,void 0,(function(){var e,t;return d(this,(function(r){switch(r.label){case 0:return[4,n.auth().getCurrentUser()];case 1:return e=r.sent(),t=null==e?void 0:e.getUid(),O.isNullOrUndefined(e)||O.isNullOrUndefined(t)?(Xn.error("getUserId: this user is not authenticated."),[2,Promise.reject(15)]):[2,t]}}))}))},e.prototype.checkDataKeyCache=function(){return l(this,void 0,void 0,(function(){var e;return d(this,(function(t){switch(t.label){case 0:return[4,this.getUserId()];case 1:return e=t.sent(),8!==this.userDataKeyInfo.userRootKeyLen||8!==this.userDataKeyInfo.userRootKeyTokenLen?(Xn.warn("checkDataKeyCache: user key is invalid, please verify user key first."),[2,Promise.reject(51)]):e!==this.userDataKeyInfo.userId?(Xn.warn("checkDataKeyCache: this user is not the current user, please verify user key first."),[2,Promise.reject(15)]):[2]}}))}))},e.prototype.checkUserKeyFormat=function(e,t){if(!(t?Yn.test(e):Gn.test(e)))throw Xn.error("checkUserKeyFormat: user key is invalid."),E.build(50)},e.prototype.encodeDataKey=function(e){return O.encode(e)},e.prototype.generateRandom=function(e){return this.entireEncryption.generateRandom(e)},e.prototype.clearDataKeyInfo=function(){Xn.log("clearDataKeyInfo: clear dataKey."),this.userDataKeyInfo.userId="",this.userDataKeyInfo.userRootKeyLen=0,this.userDataKeyInfo.userRootKeyTokenLen=0,this.userDataKeyInfo.userRootKey=new Uint8Array(0),this.userDataKeyInfo.userRootKeyToken=new Uint8Array(0),this.clearOldDataKeyInfo()},e.prototype.clearOldDataKeyInfo=function(){this.userDataKeyInfo.dataKeyVersion=0,this.userDataKeyInfo.dataKeyStatus=0,this.userDataKeyInfo.userDataKeyLen=0,this.userDataKeyInfo.userDataKeyCipherLen=0,this.userDataKeyInfo.userOldDataKeyLen=0,this.userDataKeyInfo.userOldDataKeyCipherLen=0,this.userDataKeyInfo.userDataKey=new Uint8Array(0),this.userDataKeyInfo.userDataKeyCipher={iv:new Uint8Array(0),tag:new Uint8Array(0),cipherText:new Uint8Array(0)},this.userDataKeyInfo.userOldDataKey=new Uint8Array(0),this.userDataKeyInfo.userOldDataKeyCipher={iv:new Uint8Array(0),tag:new Uint8Array(0),cipherText:new Uint8Array(0)}},e}(),Jn=function(){function e(){this.userId="",this.userRootKey=new Uint8Array(0),this.userRootKeyToken=new Uint8Array(0),this.userDataKey=new Uint8Array(0),this.userDataKeyCipher={iv:new Uint8Array(0),tag:new Uint8Array(0),cipherText:new Uint8Array(0)},this.userOldDataKey=new Uint8Array(0),this.userOldDataKeyCipher={iv:new Uint8Array(0),tag:new Uint8Array(0),cipherText:new Uint8Array(0)},this.userRootKeyLen=0,this.userRootKeyTokenLen=0,this.userDataKeyLen=0,this.userDataKeyCipherLen=0,this.dataKeyVersion=0,this.dataKeyStatus=0,this.userOldDataKeyLen=0,this.userOldDataKeyCipherLen=0,this.rootKeySalt=new Uint8Array(0),this.rootKeyTokenSalt=new Uint8Array(0)}return e.prototype.copy=function(e){this.userId=e.userId,this.userRootKey=new Uint8Array(e.userRootKey),this.userRootKeyToken=new Uint8Array(e.userRootKeyToken),this.userDataKey=new Uint8Array(e.userDataKey),this.userDataKeyCipher={iv:new Uint8Array(e.userDataKeyCipher.iv),tag:new Uint8Array(e.userDataKeyCipher.tag),cipherText:new Uint8Array(e.userDataKeyCipher.cipherText)},this.userOldDataKey=new Uint8Array(e.userOldDataKey),this.userOldDataKeyCipher={iv:new Uint8Array(e.userOldDataKeyCipher.iv),tag:new Uint8Array(e.userOldDataKeyCipher.tag),cipherText:new Uint8Array(e.userOldDataKeyCipher.cipherText)},this.userRootKeyLen=e.userRootKeyLen,this.userRootKeyTokenLen=e.userRootKeyTokenLen,this.userDataKeyLen=e.userDataKeyLen,this.userDataKeyCipherLen=e.userDataKeyCipherLen,this.dataKeyVersion=e.dataKeyVersion,this.dataKeyStatus=e.dataKeyStatus,this.userOldDataKeyLen=e.userOldDataKeyLen,this.userOldDataKeyCipherLen=e.userOldDataKeyCipherLen,this.rootKeySalt=new Uint8Array(e.rootKeySalt),this.rootKeyTokenSalt=new Uint8Array(e.rootKeyTokenSalt)},e}(),$n=function(){function e(e){this.naturalCloudSyncModule=new gn(e)}return e.prototype.executeUpsert=function(e,t){return l(this,void 0,void 0,(function(){return d(this,(function(n){switch(n.label){case 0:return[4,this.naturalCloudSyncModule.onUpsert(t,e)];case 1:return[2,n.sent()]}}))}))},e.prototype.executeDelete=function(e,t){return l(this,void 0,void 0,(function(){return d(this,(function(n){switch(n.label){case 0:return[4,this.naturalCloudSyncModule.onDelete(t,e)];case 1:return[2,n.sent()]}}))}))},e.prototype.executeQuery=function(e,t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.naturalCloudSyncModule.onQuery(e,t,n)];case 1:return[2,r.sent()]}}))}))},e.prototype.executeAggregateQuery=function(e,t,n){return l(this,void 0,void 0,(function(){var r;return d(this,(function(o){switch(o.label){case 0:return[4,this.naturalCloudSyncModule.onAggregateQuery(e,t,n)];case 1:return[2,(r=o.sent()).isNull?0:r.doubleRes]}}))}))},e.prototype.runTransaction=function(e,t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.naturalCloudSyncModule.onTransaction(e,t,n)];case 1:return[2,r.sent()]}}))}))},e.prototype.unsubscribeForRekey=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,this.naturalCloudSyncModule.unsubscribeForRekey()];case 1:return[2,e.sent()]}}))}))},e.prototype.subscribeForRekey=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,this.naturalCloudSyncModule.subscribeForRekey()];case 1:return[2,e.sent()]}}))}))},e.prototype.onSubscribe=function(e,t,n,r){return l(this,void 0,void 0,(function(){return d(this,(function(o){switch(o.label){case 0:return[4,this.naturalCloudSyncModule.onSubscribe(e,t,n,r)];case 1:return[2,o.sent()]}}))}))},e.prototype.onUnSubscribe=function(e,t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:return[4,this.naturalCloudSyncModule.onUnSubscribe(e,t,n)];case 1:return[2,r.sent()]}}))}))},e.prototype.onOpenStore=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.onOpenStore(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.onCloseStore=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.onCloseStore(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.needToDisconnectWebsocket=function(){return this.naturalCloudSyncModule.needToDisconnectWebsocket()},e.prototype.disconnectWebSocket=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,this.naturalCloudSyncModule.disconnectWebSocket()];case 1:return e.sent(),[2]}}))}))},e.prototype.resetNegoStatus=function(){this.naturalCloudSyncModule.resetNegoStatus()},e.prototype.addEncryptionListener=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().addEncryptionListener(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.querySaltValue=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().querySaltValue()];case 1:return[2,e.sent()]}}))}))},e.prototype.queryDataKeyCipherText=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().queryDataKeyCipherText(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.insertEncryptedInfo=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().insertEncryptedInfo(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.updateEncryptedInfo=function(e,t){return l(this,void 0,void 0,(function(){return d(this,(function(n){switch(n.label){case 0:return[4,this.naturalCloudSyncModule.getEncryptTaskManager().updateEncryptedInfo(e,t)];case 1:return[2,n.sent()]}}))}))},e}(),er=function(){function e(){this.timeoutTimeCount=0,this.intervalTimeOut=0,this.timeOutStateMachine=!1}return e.prototype.setIntervalCleanKey=function(e){var t=this;e||this.timeOutStateMachine?this.timeoutTimeCount=0:(this.intervalTimeOut=setInterval((function(){var e;t.timeoutTimeCount++,t.timeoutTimeCount>=30&&(t.secretKeyManager&&t.secretKeyManager.clearDataKeyInfo(),null===(e=t.secretKeyManager)||void 0===e||e.getEntireEncryption().clearUserKeysInfo(),t.encryptTaskManager.tryToDisconnectWhenClearUserKey(),t.timeoutTimeCount=0,t.timeOutStateMachine=!1,clearInterval(t.intervalTimeOut))}),3e4),this.timeOutStateMachine=!0)},e.prototype.saveSecretKeyManager=function(e){this.secretKeyManager=e},e.prototype.saveEncryptTaskManager=function(e){this.encryptTaskManager=e},e}(),tr=new T("NaturalBase"),nr=function(){function e(e){this.naturalStoreMap=new Map,this.isUserKeyValid=!1,this.onEventListener=void 0,this.certificateService=new Fe(e),this.entireEncryptInterval=new er,this.defaultNStore=new _n,this.cloudStorage=new $n(this),this.secretKeyManager=new Zn(this)}return e.prototype.getNaturalStore=function(e){if(!O.isEmpty(e))return this.naturalStoreMap.get(e)},e.prototype.getAllNaturalStore=function(){return h(this.naturalStoreMap.values())},e.prototype.createObjectType=function(e){this.validateSchemaInput(e);var t=this.convert(e);if(!this.defaultNStore)return tr.error("createObjectType: the default naturalStore is not inited."),1;if(0!==this.naturalStoreMap.size)return tr.warn("createObjectType: opening naturalStore exists."),8;var n=this.defaultNStore.getAppSchema();if(0!==n.size&&ct.compareSchemas(this.defaultNStore.getAppVersion(),n,e.schemaVersion,t))return 0;return this.certificateService.setAppVersion(e.schemaVersion),this.defaultNStore.createObjectType(e.schemaVersion,t),this.cloudStorage.resetNegoStatus(),0},e.prototype.openNaturalStore=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o;return d(this,(function(s){switch(s.label){case 0:if(t={naturalStore:void 0,exceptionCode:1},!(this.defaultNStore instanceof _n))return[3,6];if(this.naturalStoreMap.has(e))return[3,5];if(this.naturalStoreMap.size>=4)return tr.warn("the count of natural store exceeds 4"),t.exceptionCode=6,[2,t];n=new vt(e,this),s.label=1;case 1:return s.trys.push([1,3,,4]),r=t,[4,this.cloudStorage.onOpenStore(n)];case 2:return r.exceptionCode=s.sent(),[3,4];case 3:return o=s.sent(),t.exceptionCode=o,[3,4];case 4:if(0!==t.exceptionCode)return[2,t];this.naturalStoreMap.set(n.naturalStoreId,n),s.label=5;case 5:t.naturalStore=this.naturalStoreMap.get(e),t.exceptionCode=0,s.label=6;case 6:return[2,t]}}))}))},e.prototype.tryCloseNaturalStore=function(e,t){var n=this.naturalStoreMap.get(t);if(n)if(n.references.has(e))if(n.references.size>1)n.references.delete(e);else{if(n.hasSubscriber())throw tr.error("tryCloseNaturalStore: zone has snapshot subscriber."),E.build(10);n.close(),this.naturalStoreMap.delete(t),this.naturalStoreMap.size||(tr.log("tryCloseNaturalStore: will to disconnect websocket."),this.cloudStorage.disconnectWebSocket()),n.references.delete(e),tr.log("tryCloseNaturalStore: close zone success.")}else tr.warn("tryCloseNaturalStore: zone has been closed.");else tr.warn("tryCloseNaturalStore: zone has not been found.")},e.prototype.setUserKey=function(e,t,n){var r,o;return l(this,void 0,void 0,(function(){var s,i;return d(this,(function(a){switch(a.label){case 0:s=t.length,a.label=1;case 1:return a.trys.push([1,6,,7]),0!==s?[3,3]:(tr.log("SetUserKey: begin to set user key."),[4,null===(r=this.secretKeyManager)||void 0===r?void 0:r.setUserKey(e,n)]);case 2:return a.sent(),[3,5];case 3:return tr.log("SetUserKey: begin to modify user key."),[4,null===(o=this.secretKeyManager)||void 0===o?void 0:o.modifyUserKey(e,t,n)];case 4:a.sent(),a.label=5;case 5:return[3,7];case 6:return i=a.sent(),O.isErrorObject(i)?[2,Promise.reject(i)]:[2,Promise.reject(E.build(i))];case 7:return this.isUserKeyValid=!0,this.onEventListener?[4,this.addEncryptionMonitor()]:[3,9];case 8:a.sent(),a.label=9;case 9:return tr.log("setUserKey: set or modify user key success."),[2,Promise.resolve(!0)]}}))}))},e.prototype.addOnEventListener=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return this.onEventListener=e,this.isUserKeyValid?[4,this.addEncryptionMonitor()]:(tr.warn("user key is invalid, schedule to addEventListener when user key is valid"),[2]);case 1:return t.sent(),[2]}}))}))},e.prototype.addEncryptionMonitor=function(){return l(this,void 0,void 0,(function(){var e=this;return d(this,(function(t){switch(t.label){case 0:return this.monitor||(this.monitor=new Pn((function(){var t;tr.info("start onUserCommandChanged"),null===(t=e.onEventListener)||void 0===t||t.onEvent(exports.EventType.USER_KEY_CHANGED)}),(function(t){return l(e,void 0,void 0,(function(){var e;return d(this,(function(n){switch(n.label){case 0:return tr.info("start onKeyStatusChanged, status:"+t),[4,this.secretKeyManager.onKeyStatusChanged(t).catch((function(e){return e}))];case 1:return 0!==(e=n.sent())?(tr.error("onKeyStatusChanged process fail, resultCode:"+e),[2]):t!==ue.UPDATING?[3,3]:[4,this.cloudStorage.unsubscribeForRekey()];case 2:return n.sent(),[3,5];case 3:return t!==ue.NORMAL?[3,5]:[4,this.cloudStorage.subscribeForRekey()];case 4:n.sent(),n.label=5;case 5:return[2]}}))}))}))),[4,this.cloudStorage.addEncryptionListener(this.monitor)];case 1:return t.sent(),tr.info("addEncryptionMonitor done."),[2]}}))}))},e.prototype.onConnect=function(){var e;return l(this,void 0,void 0,(function(){var t,n;return d(this,(function(r){switch(r.label){case 0:return tr.log("start onConnect"),this.onEventListener?[4,this.secretKeyManager.checkKeyIfNetworkReconnect().catch((function(e){return e}))]:[3,4];case 1:return t=r.sent(),this.isUserKeyValid=0===t,this.isUserKeyValid?[4,this.addEncryptionMonitor()]:[3,3];case 2:r.sent(),r.label=3;case 3:1005001===t&&(tr.warn("user key has changed, need to set new user key."),null===(e=this.onEventListener)||void 0===e||e.onEvent(exports.EventType.USER_KEY_CHANGED)),r.label=4;case 4:return[4,this.cloudStorage.onSubscribe(At.ALL_STORE,void 0,void 0,!0)];case 5:return 0!==(n=r.sent())&&tr.error("Resubscribe fail for: "+n),!this.cloudStorage.needToDisconnectWebsocket()||this.isUserKeyValid?[3,7]:(tr.debug("need to disconnect"),[4,this.cloudStorage.disconnectWebSocket()]);case 6:r.sent(),r.label=7;case 7:return[2]}}))}))},e.prototype.validateSchemaInput=function(e){if(O.isNullOrUndefined(e))throw E.build("The object type info must not be null.");if(O.isNullOrUndefined(e.objectTypes)||O.isNullOrUndefined(e.permissions))throw E.build("The object type list and permissions must not be null.");if("number"!=typeof e.schemaVersion||isNaN(e.schemaVersion)||e.schemaVersion<=0)throw E.build("The version of object type should be greater than 0.");if(e.objectTypes.length!==e.permissions.length)throw E.build("The size of object type list should be the same as permissions.")},e.prototype.convert=function(e){var t=e.permissions,n=e.objectTypes,r=new Map,o=function(e,t){return e.objectTypeName===t.objectTypeName?0:e.objectTypeName>t.objectTypeName?1:-1};t.length>1&&t.sort(o),n.length>1&&n.sort(o);for(var s=0;s<t.length;s++){var i=new at(t[s],n[s]);ct.validateObjectSchema(i),r.set(i.name,i)}return r},e.prototype.getDataModelHelper=function(){var e;return null===(e=this.defaultNStore)||void 0===e?void 0:e.getDataModelHelper()},e.prototype.getDefaultNaturalStore=function(){return this.defaultNStore},e.prototype.getEntireEncryptInterval=function(){return this.entireEncryptInterval},e.prototype.getEntireEncryption=function(){return this.secretKeyManager.getEntireEncryption()},e.prototype.getNaturalCloudStorage=function(){return this.cloudStorage},e.prototype.getCertificateService=function(){return this.certificateService},e}(),rr=new T("ListenerHandlerImpl"),or=function(){function e(e,t,n){this.naturalStore=e,this.listenerId=t,this.callback=n}return e.prototype.remove=function(){return l(this,void 0,void 0,(function(){return d(this,(function(e){switch(e.label){case 0:return null!==this.callback&&(this.callback.remove(this),this.callback=null),this.naturalStore?[4,this.naturalStore.removeSnapshotListener(this.listenerId)]:[3,2];case 1:0!==e.sent()&&rr.error("remove registration failed."),e.label=2;case 2:return this.naturalStore=null,[2]}}))}))},e}(),sr=new T("TransactionImpl"),ir=function(){function e(e){this.transactionObjectsSize=0,this.needVerifyObjects=[],this.needVerifyObjectsMap=new Map,this.queryObjectsSize=0,this.transactionList=[],this.zone=e}return e.prototype.executeQuery=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o,s,i,a;return d(this,(function(u){switch(u.label){case 0:if(this.zone.getNaturalStore().checkQueryClass(e),this.transactionList.length>0)throw sr.warn("All transaction read need before all transaction write."),E.build("All transaction read need before all transaction write.");return[4,this.zone.getNaturalStore().executeTransactionQuery(e)];case 1:t=u.sent(),this.needVerifyObjectsMap.has(e.getClassName())?(n=this.needVerifyObjectsMap.get(e.getClassName()).objects,this.needVerifyObjectsMap.get(e.getClassName()).objects=n.concat(t.objects)):this.needVerifyObjectsMap.set(e.getClassName(),{objectTypeName:e.getClassName(),objects:t.objects});try{for(r=p(t.decryptObjects),o=r.next();!o.done;o=r.next())s=o.value,this.queryObjectsSize=this.queryObjectsSize+this.zone.getDataModelHelper().calculateObject(s)}catch(e){i={error:e}}finally{try{o&&!o.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return[2,t.decryptObjects]}}))}))},e.prototype.executeUpsert=function(e){if(!this.checkObjectList(e,"upsert"))return this;this.calculateObjectsSize(e);var t=O.getClassName(e[0]);return this.transactionList.push({operationType:S.SYNC_UPSERT,objectTypeName:t,objects:e}),this},e.prototype.executeDelete=function(e){return this.checkObjectList(e,"delete")?(this.calculateObjectsSize(e),this.transactionList.push({operationType:S.SYNC_DELETE,objectTypeName:O.getClassName(e[0]),objects:e}),this):this},e.prototype.calculateObjectsSize=function(e){var t,n;try{for(var r=p(e),o=r.next();!o.done;o=r.next()){var s=o.value;this.transactionObjectsSize=this.transactionObjectsSize+this.zone.getDataModelHelper().calculateObject(s)}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}},e.prototype.release=function(){this.needVerifyObjects=[],this.transactionList=[],this.transactionObjectsSize=0,this.queryObjectsSize=0,this.needVerifyObjectsMap.clear()},e.prototype.isTransactionEmpty=function(){var e,t;try{for(var n=p(this.transactionList),r=n.next();!r.done;r=n.next()){if(r.value.objects.length>0)return!1}}catch(t){e={error:t}}finally{try{r&&!r.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}return!0},e.prototype.getTransactionObjectsSize=function(){return this.transactionObjectsSize},e.prototype.getQueryObjectsSize=function(){return this.queryObjectsSize},e.prototype.getTransactionList=function(){return this.transactionList},e.prototype.getNeedVerifyObjects=function(){return this.needVerifyObjects},e.prototype.sortNeedVerifyObjects=function(){var e,t,n=Array.from(this.needVerifyObjectsMap.values()).sort((function(e,t){return e.objectTypeName.localeCompare(t.objectTypeName)})),r=function(e){var t=o.zone.getDataModelHelper().getPrimaryKeyByClassName(e.objectTypeName);e.objects.sort((function(e,n){var r,o,s=e.userObject,i=n.userObject;try{for(var a=(r=void 0,p(t)),u=a.next();!u.done;u=a.next()){var c=u.value,l=0;switch(c.fieldType){case _e.Byte:case _e.Short:case _e.Integer:l=s[c.fieldName]-i[c.fieldName];break;case _e.Long:l=s[c.fieldName].compare(i[c.fieldName]);break;case _e.String:l=s[c.fieldName].localeCompare(i[c.fieldName])}if(0!==l)return l}}catch(e){r={error:e}}finally{try{u&&!u.done&&(o=a.return)&&o.call(a)}finally{if(r)throw r.error}}return 0})),o.needVerifyObjects=o.needVerifyObjects.concat(e.objects)},o=this;try{for(var s=p(n),i=s.next();!i.done;i=s.next()){r(i.value)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}},e.prototype.checkObjectList=function(e,t){if(!e)throw E.build("The object list must not be null.");if(!O.isArray(e))throw E.build("The object list is invalid.");if(0===e.length)return sr.log("No objects to "+t+"."),!1;if(!O.isSameObjectType(e))throw E.build("Only one object type is supported for batch operations.");return!0},e}(),ar=new T("CloudDBZone"),ur=function(){function e(e,t,n){var r=this;this.listenerHandlers=new Set,this.callback={remove:function(e){r.listenerHandlers.delete(e)}},this.zoneId=e,this.zoneName=t,this.naturalStore=n,this.naturalStore.references.add(e)}return Object.defineProperty(e.prototype,"cloudDBZoneName",{get:function(){return this.zoneName},enumerable:!1,configurable:!0}),e.prototype.subscribeSnapshot=function(t,n){return l(this,void 0,void 0,(function(){var r,o,s;return d(this,(function(i){switch(i.label){case 0:return this.checkQuickGamePlatform(),this.checkCloudDBZoneHandle(),this.checkListener(n),r=++e.listenerId,[4,this.naturalStore.addSnapshotListener(t,n,r)];case 1:return 0!==(o=i.sent())?(ar.error("register listener failed."),[2,Promise.reject(E.build(o))]):(s=new or(this.naturalStore,r,this.callback),this.listenerHandlers.add(s),[2,s])}}))}))},e.prototype.checkListener=function(e){if(O.isNullOrUndefined(e))throw E.build("The listener must not be null.");if("object"!=typeof e||"function"!=typeof e.onSnapshot)throw E.build("The listener must be object or function.")},e.prototype.hasSnapshot=function(){return this.listenerHandlers.size>0},e.prototype.executeUpsert=function(e){return l(this,void 0,void 0,(function(){var t;return d(this,(function(n){switch(n.label){case 0:return this.isValidOperation(e),0===(t=O.convertArray(e)).length?(ar.warn("ObjectList is empty when executeUpsert."),[2,Promise.resolve(0)]):(this.validateObjectList(t),[4,this.naturalStore.executeUpsert(t)]);case 1:return[2,n.sent()]}}))}))},e.prototype.validateObjectType=function(e){var t,n;try{for(var r=p(e),o=r.next();!o.done;o=r.next()){var s=o.value;if(!this.naturalStore.getDataModelHelper().validate(s))return!1}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=r.return)&&n.call(r)}finally{if(t)throw t.error}}return!0},e.prototype.calculateObjectListSize=function(e){var t=this,n=0;return e.forEach((function(e){n+=t.naturalStore.getDataModelHelper().calculateObject(e)})),n},e.prototype.executeDelete=function(e){return l(this,void 0,void 0,(function(){var t;return d(this,(function(n){return this.isValidOperation(e),0===(t=O.convertArray(e)).length?(ar.warn("ObjectList is empty when executeDelete."),[2,Promise.resolve(0)]):(this.validateObjectList(t),[2,this.naturalStore.executeDelete(t)])}))}))},e.prototype.validateObjectList=function(e){if(e.length>1e3)throw E.build("The size of object list exceeds the limit.");if(!O.isSameObjectType(e))throw E.build("Only one object type is supported for batch operations.");if(!this.validateObjectType(e))throw E.build("The object type is not loaded yet.");if(this.calculateObjectListSize(e)>2097152)throw E.build("The capacity of objects exceeds the limit.")},e.prototype.executeQuery=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){return this.checkCloudDBZoneHandle(),[2,this.naturalStore.executeQuery(e)]}))}))},e.prototype.executeAverageQuery=function(e,t){return this.checkCloudDBZoneHandle(),this.naturalStore.executeAggregateQuery(e,"AVG",t)},e.prototype.runTransaction=function(e){return this.checkQuickGamePlatform(),this.checkCloudDBZoneHandle(),this.checkTransactionFunction(e),this.getCloudDBZoneResult(e)},e.prototype.checkTransactionFunction=function(e){if(O.isNullOrUndefined(e))throw E.build("Function must not be null.");if("object"!=typeof e||"function"!=typeof e.apply)throw E.build("Function is invalid.")},e.prototype.getCloudDBZoneResult=function(e){return l(this,void 0,void 0,(function(){var t,n,r,o,s;return d(this,(function(i){switch(i.label){case 0:t=new ir(this),n=!1,r=0,i.label=1;case 1:if(n||!(r<5))return[3,8];i.label=2;case 2:return i.trys.push([2,5,6,7]),[4,e.apply(t)];case 3:return(n=i.sent())?(t.sortNeedVerifyObjects(),this.verifyTransaction(t),[4,this.getTransactionResult(t)]):(ar.warn("user function return false, transaction failed."),[2,!1]);case 4:return i.sent(),n=!0,[3,7];case 5:return o=i.sent(),(s=this.handleUnrecoverableException(o))?[2,Promise.reject(s)]:(n=!1,++r>=5?[2,Promise.reject(E.build(o))]:[3,7]);case 6:return t.release(),[7];case 7:return[3,1];case 8:return[2,n]}}))}))},e.prototype.handleUnrecoverableException=function(e){if(O.isErrorObject(e))return e;switch(e){case 1004e3:case 1004001:case 1004002:case 1004003:case 1004004:case 1004005:case 1004006:case 1004007:case 1005e3:case 52:case 53:case 1005001:case 51:case 1001:case 1002:case 16:return E.build(e)}},e.prototype.verifyTransaction=function(e){if(this.verifyTransactionListLength(e),this.verifyTransactionData(e),e.getTransactionObjectsSize()>2097152)throw E.build("The capacity of objects exceeds the limit.");if(e.getNeedVerifyObjects().length>1e3)throw ar.warn("The size of object list to be verified exceeds the limit."),E.build("The size of object list to be verified exceeds the limit.");if(e.getQueryObjectsSize()>5242880)throw ar.warn("The capacity of objects to be verified exceeds the limit."),E.build("The capacity of objects to be verified exceeds the limit.")},e.prototype.verifyTransactionData=function(e){var t=this;e.getTransactionList().forEach((function(e){if(!t.validateObjectType(e.objects))throw E.build("The object type is not loaded yet.")}))},e.prototype.verifyTransactionListLength=function(e){var t,n,r=0;try{for(var o=p(e.getTransactionList()),s=o.next();!s.done;s=o.next()){var i=s.value;if((i.operationType===S.SYNC_UPSERT||i.operationType===S.SYNC_DELETE)&&(r+=i.objects.length)>1e3)throw E.build("The size of object list exceeds the limit.")}}catch(e){t={error:e}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}},e.prototype.getTransactionResult=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:return t.trys.push([0,,4,5]),e.isTransactionEmpty()?[3,2]:[4,this.naturalStore.runTransaction(this.zoneName,e.getNeedVerifyObjects(),e.getTransactionList())];case 1:return t.sent(),[3,3];case 2:ar.warn("nothing need to execute in this transaction, transaction succeed."),t.label=3;case 3:return[3,5];case 4:return e.release(),[7];case 5:return[2]}}))}))},e.prototype.checkCloudDBZoneHandle=function(){if(!this.naturalStore.references.has(this.zoneId))throw ar.warn("The CloudDBZone has not been created or opened."),E.build("The CloudDBZone has not been created or opened.")},e.prototype.isValidOperation=function(e){if(this.checkCloudDBZoneHandle(),!O.isValidObject(e))throw E.build("The object list is invalid.")},e.prototype.checkQuickGamePlatform=function(){if("FastGame"===Le.getApplicationType())throw E.build("QuickGame platform is not support transaction or subscribe")},e.prototype.getNaturalStore=function(){return this.naturalStore},e.prototype.getDataModelHelper=function(){return this.naturalStore.getDataModelHelper()},e.listenerId=0,e}(),cr=/^[a-zA-Z]{1}[a-zA-Z0-9]{0,19}$/,lr=function(){function e(e){this.checkInput(e),this.cloudDBZoneName_=e}return Object.defineProperty(e.prototype,"cloudDBZoneName",{get:function(){return this.cloudDBZoneName_},enumerable:!1,configurable:!0}),e.prototype.checkInput=function(e){if("string"!=typeof e||!this.isCloudDBZoneNameValid(e)||e.length>20)throw E.build("CloudDBZone name is invalid.")},e.prototype.isCloudDBZoneNameValid=function(e){return cr.test(e)},e}();(Cn=exports.EventType||(exports.EventType={}))[Cn.USER_KEY_CHANGED=0]="USER_KEY_CHANGED";var dr=new Set([1,3,2,4]),pr=new T("AGConnectCloudDB"),fr=function(){function e(e){this.isCreateObjectTypeSuccess=!1,this.naturalBase=e}return e.initialize=function(t){if(!e.sAGConnectCloudDB){Fe.loadAgcConfig(t);var n=new nr;this.sAGConnectCloudDB=new e(n)}},e.getInstance=function(t){if(O.isNullOrUndefined(t))return e.sAGConnectCloudDB;if(!dr.has(t))throw E.build("The agcRoutePolicy is invalid");var n=this.CLOUDDB_MAP.get(t);if(!O.isNullOrUndefined(n))return n;var r=new e(new nr(t));return this.CLOUDDB_MAP.set(t,r),r},e.prototype.createObjectType=function(e){if(!(this.naturalBase instanceof nr))throw E.build("Failed to create object type info into the AGConnectCloudDB.");var t=this.naturalBase.createObjectType(e);if(0!==t)throw E.build(t);this.isCreateObjectTypeSuccess=!0},e.prototype.openCloudDBZone=function(e){var t=this;if(!(e&&e instanceof lr))throw E.build("The config is invalid.");if(!this.isCreateObjectTypeSuccess)throw E.build("Failed to open the CloudDBZone because the object type has not been created.");return new Promise((function(n,r){t.naturalBase.openNaturalStore(e.cloudDBZoneName).then((function(t){if(0===t.exceptionCode){var o=new ur(O.generateUUID(),e.cloudDBZoneName,t.naturalStore);n(o)}else pr.error("openCloudDBZone: Failed to create or open a CloudDBZone."),r(E.build(t.exceptionCode))}))}))},e.prototype.closeCloudDBZone=function(e){this.validateCloudDBZone(e),this.naturalBase.tryCloseNaturalStore(e.zoneId,e.cloudDBZoneName)},e.prototype.setUserKey=function(e,t,n){return l(this,void 0,void 0,(function(){return d(this,(function(r){switch(r.label){case 0:if("string"!=typeof e||0===e.length)throw E.build("User key must not be null.");return t="string"!=typeof t?"":t,n="boolean"==typeof n&&n,[4,this.naturalBase.setUserKey(e,t,n)];case 1:return[2,r.sent()]}}))}))},e.prototype.addEventListener=function(e){return l(this,void 0,void 0,(function(){return d(this,(function(t){switch(t.label){case 0:if(!e)throw E.build("EventListener must not be null.");if(!O.isFunction(e.onEvent))throw E.build("EventListener is invalid.");return[4,Fe.getUserInfo()];case 1:return t.sent()?[4,this.naturalBase.addOnEventListener(e)]:(pr.error("User has not login, fail to addEventListener"),[2]);case 2:return t.sent(),[2]}}))}))},e.prototype.validateCloudDBZone=function(e){if(!e)throw E.build("CloudDBZone must not be null.");if(!(e instanceof ur))throw E.build("Input CloudDBZone is invalid.");if(e.hasSnapshot())throw E.build("Remove snapshot listener first.")},e.CLOUDDB_MAP=new Map,e}(),hr=function(){function e(){this.cipher=require("@system.cipher")}return e.prototype.decrypt=function(e,t,n){return l(this,void 0,void 0,(function(){var r;return d(this,(function(o){switch(o.label){case 0:return[4,this.cipher.aes({action:"decrypt",input:e,secretKey:t,transformation:"AES/GCM/NoPadding",initialVector:n,ivLen:12})];case 1:return r=o.sent(),[2,new Uint8Array(r.data.output)]}}))}))},e.prototype.encrypt=function(e,t,n){return l(this,void 0,void 0,(function(){var r;return d(this,(function(o){switch(o.label){case 0:return[4,this.cipher.aes({action:"encrypt",input:e,secretKey:t,transformation:"AES/GCM/NoPadding",initialVector:n,ivLen:12})];case 1:return r=o.sent(),[2,new Uint8Array(r.data.output)]}}))}))},e.prototype.generateRandom=function(e){return new Uint8Array(this.cipher.getRandomValues(e).match(/.{1,2}/g).map((function(e){return parseInt(e,16)})))},e}();Le.setApplicationType("FastApp"),Vn.setEncryptor(new hr),exports.AGConnectCloudDB=fr,exports.AGConnectCloudDBException=b,exports.CloudDBZone=ur,exports.CloudDBZoneConfig=lr,exports.CloudDBZoneQuery=N;
