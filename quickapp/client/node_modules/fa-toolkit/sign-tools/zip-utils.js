"use strict";var CONSTANTS=require("./constants"),ZIP_EOCD_REC_MIN_SIZE=22,ZIP_FH_REC_SIG=67324752,ZIP_DC_REC_SIG=33639248,ZIP_EOCD_REC_SIG=101010256,EOCD_CENTRAL_DIR_OFFSET_FIELD_OFFSET=16;function parserZip(e,t){var n,r,s={tag:!1,length:e.length,sections:{header:null,central:null,footer:null}};return s.sections.footer=readEOCD(e),s.sections.footer.tag&&(s.sections.central=readCD(e,s.sections.footer.previous,s.sections.footer.startIndex-s.sections.footer.previous),s.sections.central.tag&&(n=s.sections.central.previous,r=s.sections.central.startIndex-s.sections.central.previous,t&&(s.sections.sign=readSignBlock(e,n,r),n=s.sections.sign.previous,r=s.sections.sign.startIndex-s.sections.sign.previous),s.sections.header=readFH(e,n,r),s.sections.header.tag&&(s.tag=!0))),s}function readEOCD(e){var t={tag:!1};if(e&&!(e.length<ZIP_EOCD_REC_MIN_SIZE))for(var n=e.length-ZIP_EOCD_REC_MIN_SIZE;0<=n;n--)if(ZIP_EOCD_REC_SIG===e.readInt32LE(n)){t.tag=!0,t.startIndex=n,t.len=e.length-n,t.previous=e.readInt32LE(n+EOCD_CENTRAL_DIR_OFFSET_FIELD_OFFSET);break}return t}function readCD(e,t,n){var r={tag:!1};return!e||e.length<t||ZIP_DC_REC_SIG===e.readInt32LE(t)&&(r.tag=!0,r.startIndex=t,r.len=n,r.previous=e.readInt32LE(t+42)),r}function readFH(e,t,n){var r={tag:!1};return!e||e.length<t||ZIP_FH_REC_SIG===e.readInt32LE(t)&&(r.tag=!0,r.startIndex=t,r.len=n,r.previous=-1),r}function readSignBlock(e,t){var n,r={tag:!1};return!e||e.length<t||0<(t=e.indexOf(CONSTANTS.SIGN_MAGIC))&&(n=e.readInt32LE(t-8),e.readInt32LE(e=t+16-n-8)===n&&(r.tag=!0,r.len=n,r.startIndex=t+16,r.previous=e)),r}function checkZipBuffer(e,t){return!e||e.length<=4?(console.log("### Sign Failed, cannot open file: ",t),!1):ZIP_FH_REC_SIG===e.readInt32LE(0)||(console.log("### Sign Failed, zip file error: ",t),!1)}module.exports={parserZip:parserZip,checkZipBuffer:checkZipBuffer};